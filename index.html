<!DOCTYPE html>  <html lang="en">  
<head>  
<meta charset="UTF-8" />  
<meta name="viewport" content="width=device-width,initial-scale=1" />  
<title>Earnings Timer — Neon Build</title>  
<!-- Force fresh load but preserve LocalStorage data -->  
<script>  
(function () {  
  const APP_VERSION = "25";  // Bumped version
  const KEY = "ver_guard_seen";  
  try {  
    const url = new URL(location.href);  
    const curr = url.searchParams.get("v");  
    const seen = sessionStorage.getItem(KEY);  
    if (curr !== APP_VERSION) {  
      if (seen !== APP_VERSION) {  
        sessionStorage.setItem(KEY, APP_VERSION);  
        url.searchParams.set("v", APP_VERSION);  
        location.replace(url.toString());  
      }  
    }  
  } catch (e) {}  
})();  
</script>  
<style>  
:root{  
  --bg:#0b1020;  
  --panel:#111931;  
  --panel-2:#0f172a;  
  --text:#f8fafc;  
  --muted:#94a3b8;  
  --green:#22c55e;  
  --green-2:#16a34a;  
  --cyan:#22d3ee;  
  --blue:#60a5fa;  
  --purple:#a78bfa;  
  --amber:#f59e0b;  
  --red:#ef4444;  
}  
  
*{box-sizing:border-box;}  
  
body{  
  margin:0;  
  height:100vh;  
  display:flex;  
  flex-direction:column;  
  align-items:center;  
  justify-content:center;  
  background:radial-gradient(1200px 800px at 20% 10%, #0c1534 0%, #0b1020 40%, #070c19 100%);  
  color:var(--text);  
  font-family:system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;  
  overflow:hidden;  
}  
  
/* top rate input */  
.top{  
  position:absolute;  
  top:16px;  
  left:16px;  
  display:flex;  
  align-items:center;  
  gap:8px;  
  z-index:10;  
  font-size:14px;  
  color:var(--muted);  
}  
  
.rate-wrap{  
  display:flex;  
  align-items:center;  
  gap:8px;  
  background:linear-gradient(180deg,#1a2547,#121a35);  
  border:1px solid #334155;  
  border-radius:10px;  
  padding:4px 8px;  
  box-shadow:0 6px 18px rgba(0,0,0,.25);  
}  
.rate-wrap input{  
  width:110px;  
  border:none;  
  outline:none;  
  background:transparent;  
  color:var(--text);  
  text-align:right;  
  font-size:16px;  
}  
  
/* main displays */  
.timer{  
  font-size:3rem;  
  margin-bottom:4px;  
  text-shadow:0 0 12px rgba(96,165,250,.35);  
}  
.amount{  
  font-size:3rem;  
  color:var(--green);  
  margin-bottom:10px;  
  text-shadow:0 0 16px rgba(34,197,94,.55);  
}  
  
.break-timer{  
  display:none;  
  font-size:1.1rem;  
  color:var(--red);  
  margin-bottom:6px;  
  text-shadow:0 0 12px rgba(239,68,68,.5);  
}  
.break-timer.show{display:block;}  
  
.break-summary{  
  display:none;  
  font-size:.95rem;  
  color:#eab308;  
  background:linear-gradient(180deg,#3b3a1b,#2b2a12);  
  border:1px solid #534f1a;  
  border-radius:999px;  
  padding:6px 10px;  
  margin-bottom:8px;  
  box-shadow:0 8px 18px rgba(0,0,0,.25);  
}  
.break-summary.show{display:inline-block;}  
  
/* buttons */  
.buttons{  
  display:flex;  
  gap:10px;  
  margin-bottom:10px;  
}  
.buttons2{  
  display:grid;  
  grid-template-columns:repeat(2,1fr);  
  gap:10px;  
  width:min(460px,90vw);  
  margin-bottom:4px;  
}  
button{  
  border:none;  
  border-radius:12px;  
  padding:11px 22px;  
  font-size:15px;  
  cursor:pointer;  
  color:#f9fafb;  
  background:linear-gradient(180deg,#27457e,#1a2f59);  
  border:1px solid #314978;  
  box-shadow:0 8px 20px rgba(0,0,0,.25);  
  transition:transform .06s ease, filter .1s ease, box-shadow .1s ease;  
}  
button:active{  
  transform:translateY(1px);  
  filter:brightness(.95);  
}  
  
/* special buttons */  
#start{  
  background:linear-gradient(180deg,#22c55e,#15803d);  
  border-color:#16a34a;  
  box-shadow:0 10px 24px rgba(0,0,0,.25), 0 0 24px rgba(34,197,94,.35);  
}  
#stop{  
  background:linear-gradient(180deg,#b91c1c,#7f1d1d);  
  border-color:#b91c1c;  
}  
#clear{  
  background:linear-gradient(180deg,#475569,#334155);  
  border-color:#475569;  
}  
  
/* floating buttons */  
#historyBtn,#statsBtn,#menuBtn,#inboxBtn{  
  position:fixed;  
  bottom:18px;  
  border-radius:999px;  
  padding:10px 16px;  
  font-size:14px;  
  display:inline-flex;  
  align-items:center;  
  gap:8px;  
  background:linear-gradient(180deg,#17233f,#0f1a35);  
  border:1px solid #2a3a64;  
  color:#e5e7eb;  
  cursor:pointer;  
  z-index:20;  
}  
#historyBtn{  
  left:50%;  
  transform:translateX(-50%);  
}  
#historyBtn.flash{  
  background:#14532d !important;  
  box-shadow:0 0 0 6px rgba(34,197,94,.25);  
}  
#statsBtn{  
  right:16px;  
  box-shadow:0 0 16px rgba(34,197,94,.4);  
}  
#menuBtn{  
  left:16px;  
}  
#inboxBtn{  
  top:16px;  
  bottom:auto;  
  right:16px;  
}  
#historyBtn svg,  
#statsBtn svg,  
#menuBtn svg,  
#inboxBtn svg{  
  width:18px;  
  height:18px;  
}  
  
/* menu panel */  
#menuPanel{  
  position:fixed;  
  top:0;  
  left:-75%;  
  width:75%;  
  max-width:420px;  
  height:100%;  
  background:linear-gradient(180deg,#0e172d,#050816);  
  border-right:2px solid #1f2937;  
  border-radius:0 12px 12px 0;  
  box-shadow:0 0 40px rgba(0,0,0,.5);  
  display:flex;  
  flex-direction:column;  
  transition:left .28s ease;  
  z-index:30;  
}  
#menuPanel.show{left:0;}  
  
#menuHeader{  
  padding:10px 14px;  
  border-bottom:1px solid #1f2937;  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
  background:#020617;  
  border-radius:0 12px 0 0;  
}  
#menuHeader h3{  
  margin:0;  
  font-size:18px;  
}  
#closeMenu{  
  background:#ef4444;  
  padding:6px 10px;  
  border-radius:8px;  
  font-size:13px;  
}  
  
#menuContent{  
  padding:10px 14px;  
  display:flex;  
  flex-direction:column;  
  gap:10px;  
  flex:1;  
  overflow:auto;  
}  
  
.menu-item{  
  background:linear-gradient(180deg,#020617,#020617);  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px 12px;  
  font-size:15px;  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
  cursor:pointer;  
  box-shadow:0 10px 20px rgba(0,0,0,.35);  
}  
.menu-item .r{  
  color:#64748b;  
}  
  
/* settings floating button in menu */  
#settingsBtnFloat{  
  margin:10px 14px 14px;  
  align-self:flex-end;  
  background:#0ea5e9;  
  border-color:#0284c7;  
  color:#0f172a;  
  font-weight:600;  
}  
  
/* history bottom sheet */  
#historyPanel{  
  position:fixed;  
  left:0;  
  right:0;  
  bottom:-75%;  
  max-height:75%;  
  background:linear-gradient(180deg,#020617,#020617);  
  border-top:2px solid #1f2937;  
  border-radius:16px 16px 0 0;  
  box-shadow:0 -16px 32px rgba(0,0,0,.6);  
  display:flex;  
  flex-direction:column;  
  transition:bottom .28s ease;  
  z-index:25;  
}  
#historyPanel.show{bottom:0;}  
  
#historyHeader{  
  padding:10px 14px;  
  border-bottom:1px solid #1f2937;  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
}  
#historyHeader h3{  
  margin:0;  
  font-size:18px;  
}  
#closeHistory{  
  background:#6b7280;  
  border-color:#4b5563;  
  font-size:13px;  
  padding:6px 10px;  
}  
  
#totals{  
  padding:10px 14px 6px;  
  display:grid;  
  grid-template-columns:repeat(2,1fr);  
  gap:8px;  
}  
.card{  
  background:linear-gradient(180deg,#020617,#020617);  
  border:1px solid #1f2937;  
  border-radius:12px;  
  padding:8px 10px;  
}  
.card .k{  
  font-size:11px;  
  color:var(--muted);  
}  
.card .v{  
  font-size:17px;  
  font-weight:700;  
  color:var(--green);  
}  
  
#historyList{  
  list-style:none;  
  padding:10px 14px 14px;  
  margin:0;  
  flex:1;  
  overflow:auto;  
}  
#historyList li{  
  background:linear-gradient(180deg,#020617,#020617);  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:8px 10px;  
  margin-bottom:8px;  
  display:grid;  
  grid-template-columns:1fr auto;  
  gap:8px;  
}  
.meta{  
  font-size:11px;  
  color:var(--muted);  
  margin-bottom:4px;  
}  
.dur{  
  font-size:14px;  
  font-weight:600;  
}  
.amt{  
  font-size:16px;  
  font-weight:700;  
  color:var(--green);  
}  
.tag{  
  display:inline-block;  
  margin-top:4px;  
  padding:2px 6px;  
  border-radius:999px;  
  border:1px solid #eab308;  
  background:#422006;  
  font-size:11px;  
}  
  
.row-actions{  
  display:flex;  
  flex-direction:column;  
  gap:4px;  
}  
.btn-small{  
  padding:5px 9px;  
  font-size:11px;  
  border-radius:8px;  
  background:#1f2937;  
  border:1px solid #334155;  
}  
.btn-danger{background:#7f1d1d;border-color:#b91c1c;}  
.btn-export{background:#0ea5e9;border-color:#0284c7;color:#0f172a;font-weight:600;}  
  
/* generic backdrop + modal */  
.backdrop{  
  position:fixed;  
  inset:0;  
  background:rgba(0,0,0,.6);  
  display:none;  
  align-items:center;  
  justify-content:center;  
  z-index:40;  
  opacity:0;  
  transition:opacity .2s ease;  
}  
.backdrop.show{  
  display:flex;  
  opacity:1;  
}  
.modal{  
  width:340px;  
  max-width:92vw;  
  background:linear-gradient(180deg,#020617,#020617);  
  border-radius:16px;  
  border:1px solid #1f2937;  
  box-shadow:0 20px 40px rgba(0,0,0,.7);  
  padding:14px 14px 10px;  
}  
.modal h3{  
  margin:0 0 10px;  
  font-size:17px;  
  text-align:center;  
}  
.field{  
  display:flex;  
  align-items:center;  
  gap:8px;  
  padding:8px 10px;  
  border-radius:10px;  
  background:#020617;  
  border:1px solid #1f2937;  
  margin-top:8px;  
}  
.field label{  
  font-size:13px;  
  color:var(--muted);  
}  
.field input,  
.field select{  
  border:none;  
  outline:none;  
  flex:1;  
  background:transparent;  
  color:var(--text);  
  font-size:14px;  
}  
.actions{  
  display:flex;  
  gap:10px;  
  margin-top:12px;  
}  
.actions button{  
  flex:1;  
  padding:9px 0;  
  border-radius:10px;  
  font-size:14px;  
}  
  
/* settings rows */  
.setting-row{  
  margin-top:8px;  
  padding:8px 10px;  
  border-radius:10px;  
  background:#020617;  
  border:1px solid #1f2937;  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
  font-size:14px;  
}  
.setting-row .field{  
  margin:0;  
  padding:4px 6px;  
}  
  
/* simple switch */  
.switch{  
  position:relative;  
  display:inline-block;  
  width:42px;  
  height:22px;  
}  
.switch input{display:none;}  
.switch .slider{  
  position:absolute;  
  inset:0;  
  background:#4b5563;  
  border-radius:999px;  
}  
.switch .slider:before{  
  content:"";  
  position:absolute;  
  height:18px;  
  width:18px;  
  left:2px;  
  top:2px;  
  border-radius:50%;  
  background:#e5e7eb;  
  transition:transform .16s ease;  
}  
.switch input:checked + .slider{  
  background:#22c55e;  
}  
.switch input:checked + .slider:before{  
  transform:translateX(18px);  
}  
  
/* inbox panel */  
#inboxPanel{  
  position:fixed;  
  top:0;  
  right:-75%;  
  width:75%;  
  max-width:400px;  
  height:100%;  
  background:linear-gradient(180deg,#020617,#020617);  
  border-left:2px solid #1f2937;  
  border-radius:12px 0 0 12px;  
  box-shadow:0 0 40px rgba(0,0,0,.5);  
  display:flex;  
  flex-direction:column;  
  transition:right .28s ease;  
  z-index:28;  
}  
#inboxPanel.show{right:0;}  
#inboxHeader{  
  padding:10px 14px;  
  border-bottom:1px solid #1f2937;  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
}  
#inboxHeader h3{  
  margin:0;  
  font-size:18px;  
}  
#inboxBody{  
  flex:1;  
  display:flex;  
  align-items:center;  
  justify-content:center;  
  padding:14px;  
}  
.inbox-empty{  
  padding:12px 14px;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  background:linear-gradient(180deg,#020617,#020617);  
  color:var(--muted);  
  font-size:14px;  
}  
  
/* expenses panel layout */  
#expensesPanel{  
  position:fixed;  
  top:0;  
  right:-75%;  
  width:75%;  
  max-width:520px;  
  height:100%;  
  background:linear-gradient(180deg,#020617,#020617);  
  border-left:2px solid #1f2937;  
  border-radius:12px 0 0 12px;  
  box-shadow:0 0 40px rgba(0,0,0,.5);  
  display:flex;  
  flex-direction:column;  
  transition:right .28s ease;  
  z-index:27;  
}  
#expensesPanel.show{right:0;}  
#expensesHeader{  
  padding:10px 14px;  
  border-bottom:1px solid #1f2937;  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
}  
#expensesBody{  
  flex:1;  
  overflow:auto;  
  padding:10px 14px 14px;  
  display:flex;  
  flex-direction:column;  
  gap:10px;  
}  
.xp-form{  
  display:grid;  
  grid-template-columns:1fr 1fr;  
  gap:8px;  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
}  
.xp-form label{  
  font-size:11px;  
  color:var(--muted);  
}  
.xp-form input,  
.xp-form select,  
.xp-form textarea{  
  width:100%;  
  margin-top:2px;  
  padding:7px 8px;  
  border-radius:8px;  
  border:1px solid #1f2937;  
  background:#020617;  
  color:var(--text);  
  font-size:13px;  
}  
.xp-form textarea{  
  min-height:60px;  
  resize:vertical;  
}  
.xp-form .full{  
  grid-column:1/-1;  
}  
.xp-actions{  
  display:flex;  
  gap:8px;  
  margin-top:2px;  
}  
.xp-primary{  
  background:#22c55e;  
  border-color:#16a34a;  
  color:#022c22;  
  font-weight:700;  
}  
.xp-secondary{  
  background:#0ea5e9;  
  border-color:#0284c7;  
  color:#022c22;  
  font-weight:600;  
}  
.xp-card{  
  flex:1;  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
}  
.xp-card .k{  
  font-size:11px;  
  color:var(--muted);  
}  
.xp-card .v{  
  font-size:17px;  
  font-weight:700;  
}  
.xp-cards{  
  display:flex;  
  gap:8px;  
}  
.xp-chart{  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
}  
.xp-note{  
  font-size:11px;  
  color:var(--muted);  
}  
.xp-list{  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
}  
.xp-item{  
  border-radius:10px;  
  border:1px solid #1f2937;  
  padding:7px 9px;  
  margin-bottom:6px;  
  display:grid;  
  grid-template-columns:1fr auto;  
  gap:6px;  
}  
.xp-item .m{  
  font-size:13px;  
  font-weight:600;  
}  
.xp-item .c{  
  font-size:11px;  
  color:var(--muted);  
}  
.xp-item .amt{  
  font-size:14px;  
  font-weight:700;  
  color:#ef4444;  
}  
.xp-row-actions{  
  display:flex;  
  flex-direction:column;  
  gap:4px;  
}  
.btn-mini{  
  padding:4px 7px;  
  font-size:11px;  
  border-radius:8px;  
  border:1px solid #1f2937;  
  background:#111827;  
}  
.btn-mini.edit{background:#15803d;border-color:#16a34a;}  
.btn-mini.danger{background:#7f1d1d;border-color:#b91c1c;color:#fee2e2;}  
  
/* prediction panel */  
#predictionPanel{  
  position:fixed;  
  inset:0;  
  background:radial-gradient(1200px 800px at 10% 0%, #102044 0%, #050814 55%, #030712 100%);  
  display:none;  
  flex-direction:column;  
  z-index:33;  
}  
#predictionPanel.show{display:flex;}  
#predictionHeader{  
  padding:10px 14px;  
  border-bottom:1px solid #1f2937;  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
  background:#020617;  
}  
#predictionBody{  
  padding:10px 14px 14px;  
  flex:1;  
  overflow:auto;  
}  
.pred-subtitle{  
  margin:0 0 6px;  
  font-size:12px;  
  color:var(--muted);  
}  
.pred-grid{  
  display:grid;  
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));  
  gap:10px;  
  margin-top:4px;  
}  
.pred-card{  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
}  
.pred-label{  
  font-size:11px;  
  color:var(--muted);  
  text-transform:uppercase;  
  letter-spacing:.05em;  
  margin-bottom:2px;  
}  
/* NEW: Date range style inside prediction cards */
.pred-dates{
  font-size:11px;
  color:#60a5fa;
  font-style:italic;
  margin-bottom:4px;
}
.pred-value{  
  font-size:19px;  
  font-weight:800;  
  margin-bottom:3px;  
}  
.pred-goal{  
  font-size:11px;  
  color:var(--muted);  
  margin-bottom:3px;  
}  
.pred-status{  
  display:inline-block;  
  padding:3px 8px;  
  border-radius:999px;  
  font-size:11px;  
  font-weight:700;  
}  
.pred-status.good{  
  background:rgba(34,197,94,.12);  
  color:#4ade80;  
  border:1px solid rgba(34,197,94,.5);  
}  
.pred-status.bad{  
  background:rgba(239,68,68,.12);  
  color:#fecaca;  
  border:1px solid rgba(248,113,113,.6);  
}  
.pred-status.neutral{  
  background:rgba(148,163,184,.12);  
  color:#cbd5f5;  
  border:1px solid rgba(148,163,184,.6);  
}  
  
/* payday inputs block inside prediction */  
.pred-payday-wrap{  
  margin-top:8px;  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
}  
.pred-payday-row{  
  display:flex;  
  flex-wrap:wrap;  
  gap:8px;  
  font-size:11px;  
  color:var(--muted);  
}  
.pred-payday-row label input{  
  margin-top:2px;  
  width:70px;  
  padding:6px 6px;  
  border-radius:8px;  
  border:1px solid #1f2937;  
  background:#020617;  
  color:var(--text);  
  font-size:13px;  
}  
  
/* goals panel (liquid bars) */  
#goalsPanel{  
  position:fixed;  
  inset:0;  
  background:radial-gradient(1200px 800px at 80% 0%, #0e1b3a 0%, #050816 50%, #030712 100%);  
  display:none;  
  flex-direction:column;  
  z-index:32;  
}  
#goalsPanel.show{display:flex;}  
#goalsHeader{  
  padding:10px 14px;  
  border-bottom:1px solid #1f2937;  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
  background:#020617;  
}  
#goalsBody{  
  padding:10px 14px 14px;  
  flex:1;  
  overflow:auto;  
  display:flex;  
  flex-direction:column;  
  gap:10px;  
}  
.goal-card{  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
  box-shadow:0 16px 32px rgba(0,0,0,.55);  
}  
.goal-top{  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
  margin-bottom:6px;  
}  
.goal-title{  
  font-size:14px;  
  font-weight:700;  
}  
.goal-values{  
  font-size:12px;  
  color:var(--muted);  
}  
.goal-bar{  
  height:18px;  
  border-radius:999px;  
  background:#020617;  
  border:1px solid #1f2937;  
  overflow:hidden;  
  margin-bottom:6px;  
}  
.goal-fill{  
  height:100%;  
  width:0%;  
  background:linear-gradient(90deg,#22c55e 0%,#4ade80 40%,#bbf7d0 100%);  
  box-shadow:0 0 18px rgba(34,197,94,.55);  
  transition:width .08s linear;  
}  
.goal-edit{  
  display:flex;  
  align-items:center;  
  gap:6px;  
}  
.goal-edit input{  
  flex:1;  
  border-radius:8px;  
  border:1px solid #1f2937;  
  background:#020617;  
  color:var(--text);  
  padding:7px 9px;  
  font-size:13px;  
}  
.goal-edit button{  
  padding:7px 10px;  
  background:#22c55e;  
  border-color:#16a34a;  
  color:#022c22;  
  font-size:13px;  
  font-weight:700;  
}  
  
/* stats backdrop */  
#statsBackdrop{  
  position:fixed;  
  inset:0;  
  background:rgba(3,7,18,.72);  
  display:none;  
  align-items:center;  
  justify-content:center;  
  z-index:34;  
}  
#statsBackdrop.show{display:flex;}  
#statsModal{  
  width:95%;  
  max-width:820px;  
  max-height:92vh;  
  background:linear-gradient(180deg,#020617,#020617);  
  border-radius:18px;  
  border:1px solid #1f2937;  
  box-shadow:0 30px 60px rgba(0,0,0,.85);  
  padding:16px 16px 12px;  
  overflow:auto;  
}  
.stats-header{  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
  border-bottom:1px solid #1f2937;  
  padding-bottom:8px;  
  margin-bottom:8px;  
}  
.stat-summary{  
  display:grid;  
  grid-template-columns:repeat(3,1fr);  
  gap:8px;  
  margin-bottom:8px;  
}  
.stat-card{  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
}  
.stat-title{  
  font-size:12px;  
  color:var(--muted);  
}  
.stat-value{  
  font-size:18px;  
  font-weight:800;  
}  
  
/* simple break analytics section (tag effectiveness) */  
.break-section{  
  margin-top:8px;  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
}  
.break-title{  
  margin:0 0 6px;  
  font-size:15px;  
  font-weight:700;  
}  
  
/* bill forecast panel */  
#billForecastPanel{  
  position:fixed;  
  top:0;  
  right:-75%;  
  width:75%;  
  max-width:520px;  
  height:100%;  
  background:linear-gradient(180deg,#020617,#020617);  
  border-left:2px solid #1f2937;  
  border-radius:12px 0 0 12px;  
  box-shadow:0 0 40px rgba(0,0,0,.6);  
  display:flex;  
  flex-direction:column;  
  transition:right .28s ease;  
  z-index:29;  
}  
#billForecastPanel.show{right:0;}  
#billForecastHeader{  
  padding:10px 14px;  
  border-bottom:1px solid #1f2937;  
  display:flex;  
  align-items:center;  
  justify-content:space-between;  
}  
#billForecastBody{  
  flex:1;  
  overflow:auto;  
  padding:10px 14px 14px;  
  display:flex;  
  flex-direction:column;  
  gap:10px;  
}  
.bf-section{  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:10px;  
}  
.bf-row{  
  display:flex;  
  flex-wrap:wrap;  
  gap:8px;  
  font-size:11px;  
  color:var(--muted);  
}  
.bf-row input,  
.bf-row select{  
  margin-top:2px;  
  padding:7px 8px;  
  border-radius:8px;  
  border:1px solid #1f2937;  
  background:#020617;  
  color:var(--text);  
  font-size:13px;  
}  
.bf-cards{  
  display:grid;  
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));  
  gap:8px;  
  margin-top:4px;  
}  
.bf-card{  
  background:#020617;  
  border-radius:12px;  
  border:1px solid #1f2937;  
  padding:8px 10px;  
}  
.bf-card .k{  
  font-size:11px;  
  color:var(--muted);  
}  
.bf-card .v{  
  font-size:17px;  
  font-weight:700;  
}  
.bf-left.good{color:#4ade80;}  
.bf-left.bad{color:#fca5a5;}  
  
/* Calculator Panel */
#calcPanel{
  position:fixed;
  top:0;
  right:-75%;
  width:75%;
  max-width:360px;
  height:100%;
  background:linear-gradient(180deg,#020617,#020617);
  border-left:2px solid #1f2937;
  border-radius:12px 0 0 12px;
  box-shadow:0 0 40px rgba(0,0,0,.6);
  display:flex;
  flex-direction:column;
  transition:right .28s ease;
  z-index:35;
}
#calcPanel.show{right:0;}
#calcHeader{
  padding:10px 14px;
  border-bottom:1px solid #1f2937;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
#calcBody{
  flex:1;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
#calcDisplay{
  background:#0f172a;
  border:1px solid #1f2937;
  border-radius:12px;
  padding:16px;
  text-align:right;
  font-size:32px;
  font-family:monospace;
  color:#22c55e;
  margin-bottom:10px;
  word-wrap:break-word;
  min-height:70px;
}
.calc-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  flex:1;
}
.calc-btn{
  background:#1e293b;
  border:1px solid #334155;
  border-radius:12px;
  font-size:20px;
  color:#f8fafc;
  cursor:pointer;
  transition:background .1s;
}
.calc-btn:active{background:#334155;}
.calc-btn.op{background:#3b82f6;border-color:#2563eb;}
.calc-btn.eq{background:#22c55e;border-color:#16a34a;grid-column:span 2;}
.calc-btn.clr{background:#ef4444;border-color:#dc2626;}

/* invisible blocker for overlays */  
#globalBlocker{  
  position:fixed;  
  inset:0;  
  background:transparent;  
  display:none;  
  z-index:19;  
  pointer-events:auto;  
}  
</style>  </head>  
<body>
<div id="globalBlocker" aria-hidden="true"></div>

<div class="top">
  <span>Rate $/hr:</span>
  <div class="rate-wrap">
    <input id="rate" type="number" value="25" step="0.01" min="0">
  </div>
</div>

<div class="timer" id="timeDisplay">00:00:00.00</div>
<div class="amount" id="moneyDisplay">$0.00</div>
<div class="break-timer" id="breakDisplay">Break: 00:00:00</div>
<div class="break-summary" id="breakSummary"></div>

<div class="buttons">
  <button id="start">Start</button>
  <button id="stop">Stop</button>
  <button id="clear">Clear</button>
</div>

<div class="buttons2">
  <button id="startAtBtn">Start At</button>
  <button id="stopAtBtn">Stop At</button>
  <button id="takeBreakBtn">Take Break</button>
  <button id="endBreakBtn">End Break</button>
</div>

<button id="menuBtn">
  <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">
    <path d="M4 7h16"></path><path d="M4 12h16"></path><path d="M4 17h16"></path>
  </svg>
  Menu
</button>

<button id="historyBtn">
  <svg viewBox="0 0 24 24" fill="#e5e7eb">
    <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22V4.5zM6.5 4A.5.5 0 0 0 6 4.5v15a.5.5 0 0 0 .5.5H18V4H6.5z"/>
  </svg>
  History
</button>

<button id="statsBtn">
  <svg viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 21h16M7 17V9m5 8V5m5 12v-7"></path>
  </svg>
  Stats
</button>

<button id="inboxBtn">
  <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">
    <path d="M4 5h16v14H4z"></path><path d="M22 6l-10 7L2 6"></path>
  </svg>
  Inbox
</button>

<div id="menuPanel" aria-hidden="true">
  <div id="menuHeader">
    <h3>Menu</h3>
    <button id="closeMenu">Close</button>
  </div>
  <div id="menuContent">
    <div class="menu-item" id="menuGoals"><span>Goals</span><span class="r">›</span></div>
    <div class="menu-item" id="menuSummary"><span>Summary</span><span class="r">›</span></div>
    <div class="menu-item" id="menuCalc"><span>Calculator</span><span class="r">›</span></div>
    <div class="menu-item" id="menuExpenses"><span>Expenses</span><span class="r">›</span></div>
    <div class="menu-item" id="menuPrediction"><span>Predictions</span><span class="r">›</span></div>
    <div class="menu-item" id="menuBillForecast"><span>Bill Forecast</span><span class="r">›</span></div>
  </div>
  <button id="settingsBtnFloat">Settings</button>
</div>

<div id="historyPanel" aria-hidden="true">
  <div id="historyHeader">
    <h3>History</h3>
    <button id="closeHistory">Close</button>
  </div>
  <div id="totals">
    <div class="card">
      <div class="k">This week</div>
      <div class="v" id="weekTotal">$0.00</div>
    </div>
    <div class="card">
      <div class="k">This month</div>
      <div class="v" id="monthTotal">$0.00</div>
    </div>
  </div>
  <ul id="historyList"></ul>
</div>

<div id="inboxPanel" aria-hidden="true">
  <div id="inboxHeader">
    <h3>Inbox</h3>
    <button id="closeInbox">Close</button>
  </div>
  <div id="inboxBody">
    <div class="inbox-empty">No messages yet.</div>
  </div>
</div>

<div id="calcPanel" aria-hidden="true">
  <div id="calcHeader">
    <h3>Calculator</h3>
    <button id="calcClose">Close</button>
  </div>
  <div id="calcBody">
    <div id="calcDisplay">0</div>
    <div class="calc-grid">
      <button class="calc-btn clr" id="calcC">C</button>
      <button class="calc-btn clr" id="calcCE">CE</button>
      <button class="calc-btn op" data-op="/">÷</button>
      <button class="calc-btn" data-num="7">7</button>
      <button class="calc-btn" data-num="8">8</button>
      <button class="calc-btn" data-num="9">9</button>
      <button class="calc-btn op" data-op="*">×</button>
      <button class="calc-btn" data-num="4">4</button>
      <button class="calc-btn" data-num="5">5</button>
      <button class="calc-btn" data-num="6">6</button>
      <button class="calc-btn op" data-op="-">−</button>
      <button class="calc-btn" data-num="1">1</button>
      <button class="calc-btn" data-num="2">2</button>
      <button class="calc-btn" data-num="3">3</button>
      <button class="calc-btn op" data-op="+">+</button>
      <button class="calc-btn" data-num="0">0</button>
      <button class="calc-btn" data-num=".">.</button>
      <button class="calc-btn eq" id="calcEq">=</button>
    </div>
  </div>
</div>

<div id="expensesPanel" aria-hidden="true">
  <div id="expensesHeader">
    <h3>Expenses</h3>
    <button id="closeExpenses">Close</button>
  </div>
  <div id="expensesBody">
    <div class="xp-form">
      <div>
        <label for="xpAmount">Amount</label>
        <input id="xpAmount" type="number" step="0.01" min="0" placeholder="e.g. 14.99">
      </div>
      <div>
        <label for="xpDate">Date</label>
        <input id="xpDate" type="date">
      </div>
      <div>
        <label for="xpMerchant">Merchant</label>
        <input id="xpMerchant" type="text" placeholder="e.g. Walmart">
      </div>
      <div>
        <label for="xpCategory">Category</label>
        <select id="xpCategory">
          <option>Auto & Gas</option>
          <option>Groceries</option>
          <option>Restaurants</option>
          <option>Bars & Nightlife</option>
          <option>Subscriptions</option>
          <option>Shopping</option>
          <option>Bills & Utilities</option>
          <option>Healthcare</option>
          <option>Entertainment</option>
          <option>Travel</option>
          <option>Other</option>
        </select>
      </div>
      <div class="full">
        <label for="xpNote">Note</label>
        <textarea id="xpNote" placeholder="Optional note"></textarea>
      </div>
      <div class="full xp-actions">
        <button id="xpAddBtn" class="xp-primary">Add Expense</button>
        <button id="xpImportBtn" class="xp-secondary">Quick Import</button>
        <button id="xpClearMonthBtn" class="btn-mini danger" style="margin-left:auto;">Clear Month</button>
      </div>
    </div>

    <div class="xp-cards">
      <div class="xp-card">
        <div class="k">This Month</div>
        <div class="v" id="xpMonthSpend">$0.00</div>
        <div class="xp-note" id="xpBudgetHint">No budget set</div>
      </div>
      <div class="xp-card">
        <div class="k">Top Category</div>
        <div class="v" id="xpTopCat">—</div>
        <div class="xp-note" id="xpTopCatShare">—</div>
      </div>
    </div>

    <div class="xp-chart">
      <h4 style="margin:0 0 6px;">Category Breakdown</h4>
      <canvas id="xpPie" height="170"></canvas>
      <div class="xp-note">Shows where the month’s money went.</div>
    </div>

    <div class="xp-chart">
      <h4 style="margin:0 0 6px;">Monthly Trend</h4>
      <canvas id="xpTrend" height="170"></canvas>
      <div class="xp-note">Last 6 months.</div>
    </div>

    <div class="xp-list">
      <h4 style="margin:0 0 6px;">Entries</h4>
      <div id="xpList"></div>
    </div>

    <div class="xp-list">
      <h4 style="margin:0 0 6px;">Suggestions</h4>
      <ul id="xpSuggestions" style="margin:0;padding-left:18px;"></ul>
    </div>
  </div>
</div>

<div id="billForecastPanel" aria-hidden="true">
  <div id="billForecastHeader">
    <h3>Bill Forecast</h3>
    <button id="billForecastClose">Close</button>
  </div>
  <div id="billForecastBody">
    <div class="bf-section">
      <h4 style="margin:0 0 4px;">Forecast settings</h4>
      <div class="bf-row">
        <label>Period
          <select id="bfPeriod">
            <option value="month">This month</option>
            <option value="week">This week</option>
            <option value="30d">Next 30 days</option>
            <option value="year">This year</option>
          </select>
        </label>
        <label>Extra fixed bills
          <input id="bfFixedBills" type="number" step="0.01" min="0" placeholder="e.g. 650">
        </label>
      </div>
      <label style="font-size:11px;color:var(--muted);display:flex;align-items:center;gap:6px;margin-top:6px;">
        <input type="checkbox" id="bfIncludeExpenses" checked>
        Include tracked Expenses
      </label>
      <p style="font-size:11px;color:var(--muted);margin:4px 0 0;">
        Uses your current earnings pace + expenses to estimate how much you’ll keep after bills.
      </p>
    </div>

    <div class="bf-section">
      <h4 style="margin:0 0 4px;">Forecast</h4>
      <div class="bf-cards">
        <div class="bf-card">
          <div class="k">Projected income</div>
          <div class="v" id="bfIncome">$0.00</div>
        </div>
        <div class="bf-card">
          <div class="k">Expected bills</div>
          <div class="v" id="bfBills">$0.00</div>
        </div>
        <div class="bf-card">
          <div class="k">Left after bills</div>
          <div class="v bf-left" id="bfLeft">$0.00</div>
        </div>
      </div>
      <ul id="bfHints" style="margin:6px 0 0;padding-left:18px;font-size:11px;color:var(--muted);"></ul>
    </div>
  </div>
</div>

<div id="goalsPanel" aria-hidden="true">
  <div id="goalsHeader">
    <h3>Goals</h3>
    <button id="goalsClose">Back</button>
  </div>
  <div id="goalsBody">
    <div class="goal-card">
      <div class="goal-top">
        <div class="goal-title">Yearly Target</div>
        <div class="goal-values" id="yearlyValues">$0 / $0 (0%)</div>
      </div>
      <div class="goal-bar">
        <div id="yearlyBar" class="goal-fill"></div>
      </div>
      <div class="goal-edit">
        <input id="yearlyInput" type="number" min="0" step="0.01" placeholder="e.g. 50000">
        <button id="yearlySave">Save</button>
      </div>
    </div>

    <div class="goal-card">
      <div class="goal-top">
        <div class="goal-title">Monthly Target</div>
        <div class="goal-values" id="monthlyValues">$0 / $0 (0%)</div>
      </div>
      <div class="goal-bar">
        <div id="monthlyBar" class="goal-fill"></div>
      </div>
      <div class="goal-edit">
        <input id="monthlyInput" type="number" min="0" step="0.01" placeholder="e.g. 4000">
        <button id="monthlySave">Save</button>
      </div>
    </div>

    <div class="goal-card">
      <div class="goal-top">
        <div class="goal-title">Weekly Target</div>
        <div class="goal-values" id="weeklyValues">$0 / $0 (0%)</div>
      </div>
      <div class="goal-bar">
        <div id="weeklyBar" class="goal-fill"></div>
      </div>
      <div class="goal-edit">
        <input id="weeklyInput" type="number" min="0" step="0.01" placeholder="e.g. 1000">
        <button id="weeklySave">Save</button>
      </div>
    </div>

    <div class="goal-card">
      <div class="goal-top">
        <div class="goal-title">Daily Target</div>
        <div class="goal-values" id="dailyValues">$0 / $0 (0%)</div>
      </div>
      <div class="goal-bar">
        <div id="dailyBar" class="goal-fill"></div>
      </div>
      <div class="goal-edit">
        <input id="dailyInput" type="number" min="0" step="0.01" placeholder="e.g. 200">
        <button id="dailySave">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="predictionPanel" aria-hidden="true">
  <div id="predictionHeader">
    <h3>Predictions</h3>
    <button id="predictionClose">Back</button>
  </div>
  <div id="predictionBody">
    <p class="pred-subtitle">Based on your recent earnings, this is what you’re on track to make.</p>
    <p class="pred-subtitle" id="predDateRange"></p>

    <div class="pred-grid">
      <div class="pred-card">
        <div class="pred-label">Daily</div>
        <div class="pred-value" id="predDailyValue">$0.00</div>
        <div class="pred-goal" id="predDailyGoal">Goal: —</div>
        <div class="pred-status neutral" id="predDailyStatus">No goal set</div>
      </div>
      <div class="pred-card">
        <div class="pred-label">Weekly</div>
        <div class="pred-dates" id="predWeeklyDates">Mon 1 – Sun 7</div>
        <div class="pred-value" id="predWeeklyValue">$0.00</div>
        <div class="pred-goal" id="predWeeklyGoal">Goal: —</div>
        <div class="pred-status neutral" id="predWeeklyStatus">No goal set</div>
      </div>
      <div class="pred-card">
        <div class="pred-label">Bi-Weekly</div>
        <div class="pred-dates" id="predBiWeeklyDates">Sep 1 – Sep 15</div>
        <div class="pred-value" id="predBiWeeklyValue">$0.00</div>
        <div class="pred-goal" id="predBiWeeklyGoal">Goal: —</div>
        <div class="pred-status neutral" id="predBiWeeklyStatus">No goal set</div>
      </div>
      <div class="pred-card">
        <div class="pred-label">Monthly</div>
        <div class="pred-dates" id="predMonthlyDates">Sep 1 – Sep 30</div>
        <div class="pred-value" id="predMonthlyValue">$0.00</div>
        <div class="pred-goal" id="predMonthlyGoal">Goal: —</div>
        <div class="pred-status neutral" id="predMonthlyStatus">No goal set</div>
      </div>
      <div class="pred-card">
        <div class="pred-label">Yearly</div>
        <div class="pred-dates" id="predYearlyDates">Jan 1 – Dec 31</div>
        <div class="pred-value" id="predYearlyValue">$0.00</div>
        <div class="pred-goal" id="predYearlyGoal">Goal: —</div>
        <div class="pred-status neutral" id="predYearlyStatus">No goal set</div>
      </div>
    </div>

    <div class="pred-payday-wrap">
      <div class="pred-label">Payday</div>
      <div class="pred-payday-row">
        <label>Day of month 1
          <input id="predPayDay1" type="number" min="1" max="31" placeholder="1">
        </label>
        <label>Day of month 2 (optional)
          <input id="predPayDay2" type="number" min="1" max="31" placeholder="15">
        </label>
      </div>
      <p class="pred-subtitle" id="predPaydayInfo">
        Example: enter 1 and 15 if you’re paid the 1st and 15th. Predictions reset each time you pass a payday.
      </p>
    </div>

    <p class="pred-subtitle">
      Yearly predictions are capped at December 31 and automatically reset on January 1.
    </p>
  </div>
</div>

<div id="statsBackdrop" class="backdrop" aria-hidden="true">
  <div id="statsModal">
    <div class="stats-header">
      <h3>Performance Dashboard</h3>
      <button id="statsClose" style="background:#22c55e;border-color:#16a34a;color:#022c22;font-weight:700;">Close</button>
    </div>
    <div class="stat-summary">
      <div class="stat-card">
        <div class="stat-title">Today</div>
        <div class="stat-value" id="todayEarned">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">This Week</div>
        <div class="stat-value" id="weekEarned">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">This Month</div>
        <div class="stat-value" id="monthEarned">$0.00</div>
      </div>
    </div>

    <canvas id="earningsChart" height="170"></canvas>
    <canvas id="hoursChart" height="170"></canvas>

    <div class="break-section">
      <p class="break-title">Tag Effectiveness (7 days)</p>
      <canvas id="breakChart" height="190"></canvas>
    </div>

    <p style="font-size:12px;color:var(--muted);margin-top:6px;">
      Quick insight: <span id="trend" style="font-weight:600;color:#e5e7eb;">Stable</span>.
      Average rate: <span id="avgRate">$0/hr</span>,
      average daily earnings (7d): <span id="avgDay">$0</span>.
    </p>
  </div>
</div>

<div id="settingsBackdrop" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Settings</h3>
    <div class="setting-row">
      <span>Theme</span>
      <div class="field" style="max-width:130px;">
        <select id="themeSelect">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>
    </div>
    <div class="setting-row">
      <span>Sound</span>
      <label class="switch">
        <input type="checkbox" id="soundToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="setting-row">
      <span>Haptics</span>
      <label class="switch">
        <input type="checkbox" id="hapticsToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="actions" style="margin-top:14px;">
      <button id="settingsClose" style="background:#6b7280;">Close</button>
      <button id="settingsSave" style="background:#22c55e;">Save</button>
    </div>
  </div>
</div>

<div id="saveBackdrop" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Save this session?</h3>
    <div class="field">
      <label>Tag</label>
      <input id="tagInput" type="text" placeholder="Optional tag">
    </div>
    <div class="actions">
      <button id="discardBtn" style="background:#6b7280;">Discard</button>
      <button id="saveBtn" style="background:#22c55e;">Save</button>
    </div>
  </div>
</div>

<div id="editBackdrop" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Edit entry</h3>
    <div class="field">
      <label>Start</label>
      <input id="editStart" type="datetime-local">
    </div>
    <div class="field">
      <label>End</label>
      <input id="editEnd" type="datetime-local">
    </div>
    <div class="field">
      <label>Tag</label>
      <input id="editTag" type="text">
    </div>
    <div class="actions">
      <button id="editCancel" style="background:#6b7280;">Cancel</button>
      <button id="editSave" style="background:#22c55e;">Save</button>
    </div>
  </div>
</div>

<div id="confirmBackdrop" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Delete this entry?</h3>
    <div class="actions">
      <button id="confirmNo" style="background:#6b7280;">No</button>
      <button id="confirmYes" style="background:#ef4444;">Yes</button>
    </div>
  </div>
</div>

<div id="startAtBackdrop" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Start At</h3>
    <div class="field">
      <label>Date/Time</label>
      <input id="startAtInput" type="datetime-local">
    </div>
    <div class="actions">
      <button id="startAtCancel" style="background:#6b7280;">Cancel</button>
      <button id="startAtSave" style="background:#22c55e;">Set</button>
    </div>
  </div>
</div>

<div id="stopAtBackdrop" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Stop At</h3>
    <div class="field">
      <label>Date/Time</label>
      <input id="stopAtInput" type="datetime-local">
    </div>
    <div class="actions">
      <button id="stopAtCancel" style="background:#6b7280;">Cancel</button>
      <button id="stopAtSave" style="background:#22c55e;">Set</button>
    </div>
  </div>
</div>

<div id="exportBackdrop" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Export</h3>
    <p style="text-align:center;margin:6px 0 0;font-size:13px;color:var(--muted);">
      Coming soon.
    </p>
    <div class="actions" style="margin-top:10px;">
      <button id="exportClose" style="background:#22c55e;">OK</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  /* ===== State ===== */
let running = false;
let startTime = 0;
let elapsed = 0;
let interval = null;

let startWallTs = null;
let endWallTs = null;

let onBreak = false;
let breakStartTs = null;
let breakTicker = null;
let sessionBreakMs = 0;

let scheduledStartTs = null;
let scheduledStopTs = null;

let history = [];
let editingId = null;
let pendingDeleteId = null;

let expenses = [];
let budgets = {
  "Groceries":600,
  "Restaurants":300,
  "Bars & Nightlife":150,
  "Subscriptions":80,
  "Shopping":250,
  "Bills & Utilities":400,
  "Auto & Gas":220,
  "Healthcare":120,
  "Entertainment":120,
  "Travel":0,
  "Other":100
};

let prefs = { theme:"dark", sound:true, haptics:true };

let goals = { yearly:0, monthly:0, weekly:0, daily:0 };

let paydays = { day1:null, day2:null };

/*
 * NOTE on Storage Keys:
 * These keys (e.g., 'earningsTimer_history_v3') are kept IDENTICAL
 * to your previous version. As long as you run this code on the
 * same domain (e.g., localhost, or your GitHub Pages site),
 * the browser will find the existing data.
 */
const STORE_KEY_STATE    = "earningsTimer_state_v8";
const STORE_KEY_HISTORY  = "earningsTimer_history_v3";
const STORE_KEY_PREFS    = "earningsTimer_prefs_v2";
const STORE_KEY_GOALS    = "earningsTimer_goals_v2";
const STORE_KEY_EXPENSES = "earningsTimer_expenses_v2";
const STORE_KEY_BUDGETS  = "earningsTimer_budgets_v2";
const STORE_KEY_PAYDAYS  = "earningsTimer_paydays_v1";

/* ===== Elements ===== */
const timeDisplay  = document.getElementById("timeDisplay");
const moneyDisplay = document.getElementById("moneyDisplay");
const breakDisplay = document.getElementById("breakDisplay");
const breakSummary = document.getElementById("breakSummary");

const rateInput = document.getElementById("rate");
const startBtn  = document.getElementById("start");
const stopBtn   = document.getElementById("stop");
const clearBtn  = document.getElementById("clear");

const startAtBtn = document.getElementById("startAtBtn");
const stopAtBtn  = document.getElementById("stopAtBtn");
const takeBreakBtn = document.getElementById("takeBreakBtn");
const endBreakBtn  = document.getElementById("endBreakBtn");

const historyBtn   = document.getElementById("historyBtn");
const historyPanel = document.getElementById("historyPanel");
const closeHistory = document.getElementById("closeHistory");
const historyList  = document.getElementById("historyList");
const weekTotalEl  = document.getElementById("weekTotal");
const monthTotalEl = document.getElementById("monthTotal");

const saveBackdrop   = document.getElementById("saveBackdrop");
const discardBtn     = document.getElementById("discardBtn");
const saveBtn        = document.getElementById("saveBtn");
const tagInput       = document.getElementById("tagInput");
const editBackdrop   = document.getElementById("editBackdrop");
const editStart      = document.getElementById("editStart");
const editEnd        = document.getElementById("editEnd");
const editTag        = document.getElementById("editTag");
const editCancel     = document.getElementById("editCancel");
const editSave       = document.getElementById("editSave");
const confirmBackdrop= document.getElementById("confirmBackdrop");
const confirmYes     = document.getElementById("confirmYes");
const confirmNo      = document.getElementById("confirmNo");

const menuBtn        = document.getElementById("menuBtn");
const menuPanel      = document.getElementById("menuPanel");
const closeMenu      = document.getElementById("closeMenu");
const settingsBtnFloat = document.getElementById("settingsBtnFloat");

const menuGoals        = document.getElementById("menuGoals");
const menuSummary      = document.getElementById("menuSummary");
const menuCalc         = document.getElementById("menuCalc");
const menuExpenses     = document.getElementById("menuExpenses");
const menuPrediction   = document.getElementById("menuPrediction");
const menuBillForecast = document.getElementById("menuBillForecast");

const settingsBackdrop = document.getElementById("settingsBackdrop");
const settingsClose    = document.getElementById("settingsClose");
const settingsSave     = document.getElementById("settingsSave");
const themeSelect      = document.getElementById("themeSelect");
const soundToggle      = document.getElementById("soundToggle");
const hapticsToggle    = document.getElementById("hapticsToggle");

const startAtBackdrop  = document.getElementById("startAtBackdrop");
const startAtInput     = document.getElementById("startAtInput");
const startAtCancel    = document.getElementById("startAtCancel");
const startAtSave      = document.getElementById("startAtSave");

const stopAtBackdrop   = document.getElementById("stopAtBackdrop");
const stopAtInput      = document.getElementById("stopAtInput");
const stopAtCancel     = document.getElementById("stopAtCancel");
const stopAtSave       = document.getElementById("stopAtSave");

const exportBackdrop = document.getElementById("exportBackdrop");
const exportClose    = document.getElementById("exportClose");

const goalsPanel    = document.getElementById("goalsPanel");
const goalsClose    = document.getElementById("goalsClose");
const yearlyValues  = document.getElementById("yearlyValues");
const monthlyValues = document.getElementById("monthlyValues");
const weeklyValues  = document.getElementById("weeklyValues");
const dailyValues   = document.getElementById("dailyValues");
const yearlyBar     = document.getElementById("yearlyBar");
const monthlyBar    = document.getElementById("monthlyBar");
const weeklyBar     = document.getElementById("weeklyBar");
const dailyBar      = document.getElementById("dailyBar");
const yearlyInput   = document.getElementById("yearlyInput");
const monthlyInput  = document.getElementById("monthlyInput");
const weeklyInput   = document.getElementById("weeklyInput");
const dailyInput    = document.getElementById("dailyInput");
const yearlySave    = document.getElementById("yearlySave");
const monthlySave   = document.getElementById("monthlySave");
const weeklySave    = document.getElementById("weeklySave");
const dailySave     = document.getElementById("dailySave");

const statsBtn      = document.getElementById("statsBtn");
const statsBackdrop = document.getElementById("statsBackdrop");
const statsClose    = document.getElementById("statsClose");
const todayEarned   = document.getElementById("todayEarned");
const weekEarned    = document.getElementById("weekEarned");
const monthEarned   = document.getElementById("monthEarned");
const trendEl       = document.getElementById("trend");
const avgRateEl     = document.getElementById("avgRate");
const avgDayEl      = document.getElementById("avgDay");

const inboxBtn   = document.getElementById("inboxBtn");
const inboxPanel = document.getElementById("inboxPanel");
const closeInbox = document.getElementById("closeInbox");

const calcPanel = document.getElementById("calcPanel");
const calcClose = document.getElementById("calcClose");
const calcDisplay = document.getElementById("calcDisplay");

const expensesPanel   = document.getElementById("expensesPanel");
const closeExpenses   = document.getElementById("closeExpenses");
const xpAmount        = document.getElementById("xpAmount");
const xpDate          = document.getElementById("xpDate");
const xpMerchant      = document.getElementById("xpMerchant");
const xpCategory      = document.getElementById("xpCategory");
const xpNote          = document.getElementById("xpNote");
const xpAddBtn        = document.getElementById("xpAddBtn");
const xpImportBtn     = document.getElementById("xpImportBtn");
const xpClearMonthBtn = document.getElementById("xpClearMonthBtn");
const xpMonthSpend    = document.getElementById("xpMonthSpend");
const xpBudgetHint    = document.getElementById("xpBudgetHint");
const xpTopCat        = document.getElementById("xpTopCat");
const xpTopCatShare   = document.getElementById("xpTopCatShare");
const xpList          = document.getElementById("xpList");
const xpSuggestions   = document.getElementById("xpSuggestions");
const xpPieCanvas     = document.getElementById("xpPie");
const xpTrendCanvas   = document.getElementById("xpTrend");

const predictionPanel = document.getElementById("predictionPanel");
const predictionClose = document.getElementById("predictionClose");
const predDateRange   = document.getElementById("predDateRange");
const predDailyValue  = document.getElementById("predDailyValue");
const predDailyGoal   = document.getElementById("predDailyGoal");
const predDailyStatus = document.getElementById("predDailyStatus");
const predWeeklyDates = document.getElementById("predWeeklyDates");
const predWeeklyValue  = document.getElementById("predWeeklyValue");
const predWeeklyGoal   = document.getElementById("predWeeklyGoal");
const predWeeklyStatus = document.getElementById("predWeeklyStatus");
const predBiWeeklyDates = document.getElementById("predBiWeeklyDates");
const predBiWeeklyValue  = document.getElementById("predBiWeeklyValue");
const predBiWeeklyGoal   = document.getElementById("predBiWeeklyGoal");
const predBiWeeklyStatus = document.getElementById("predBiWeeklyStatus");
const predMonthlyDates = document.getElementById("predMonthlyDates");
const predMonthlyValue  = document.getElementById("predMonthlyValue");
const predMonthlyGoal   = document.getElementById("predMonthlyGoal");
const predMonthlyStatus = document.getElementById("predMonthlyStatus");
const predYearlyDates = document.getElementById("predYearlyDates");
const predYearlyValue  = document.getElementById("predYearlyValue");
const predYearlyGoal   = document.getElementById("predYearlyGoal");
const predYearlyStatus = document.getElementById("predYearlyStatus");
const predPayDay1     = document.getElementById("predPayDay1");
const predPayDay2     = document.getElementById("predPayDay2");
const predPaydayInfo  = document.getElementById("predPaydayInfo");

const billForecastPanel = document.getElementById("billForecastPanel");
const billForecastClose = document.getElementById("billForecastClose");
const bfPeriod          = document.getElementById("bfPeriod");
const bfFixedBills      = document.getElementById("bfFixedBills");
const bfIncludeExpenses = document.getElementById("bfIncludeExpenses");
const bfIncome          = document.getElementById("bfIncome");
const bfBills           = document.getElementById("bfBills");
const bfLeft            = document.getElementById("bfLeft");
const bfHints           = document.getElementById("bfHints");

const blocker = document.getElementById("globalBlocker");

let earningsChart = null;
let hoursChart    = null;
let breakChart    = null;
let xpPie         = null;
let xpTrend       = null;

const pad2 = n => String(n).padStart(2,"0");
const fmtMoney = n => "$" + (n || 0).toFixed(2);
/* NEW: Date formatter */
const dateFmt = new Intl.DateTimeFormat(undefined, { month: 'short', day: 'numeric' });
const formatShortDate = (ts) => dateFmt.format(new Date(ts));

function formatMain(ms){
  const t = Math.max(0, ms|0);
  const h = Math.floor(t/3600000);
  const m = Math.floor((t%3600000)/60000);
  const s = Math.floor((t%60000)/1000);
  const c = Math.floor((t%1000)/10);
  return `${pad2(h)}:${pad2(m)}:${pad2(s)}.${pad2(c)}`;
}
function humanShort(ms){
  const t = Math.max(0, ms|0);
  const h = Math.floor(t/3600000);
  const m = Math.floor((t%3600000)/60000);
  const s = Math.floor((t%60000)/1000);
  if (h) return `${h}h ${m}m`;
  if (m) return `${m}m ${s}s`;
  return `${s}s`;
}
function humanDate(ts){
  const d = new Date(ts);
  return d.toLocaleDateString();
}

function startOfDay(ts){
  const d = new Date(ts);
  d.setHours(0,0,0,0);
  return +d;
}
function startOfWeek(ts){
  const d = new Date(ts);
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  // Adjust to Monday. getDay() is 0=Sun, 1=Mon...
  const dow = x.getDay() || 7; // Treat Sunday as 7
  if (dow !== 1) {
    x.setDate(x.getDate() - (dow - 1));
  }
  x.setHours(0,0,0,0);
  return +x;
}
function startOfMonth(ts){
  const d = new Date(ts);
  const x = new Date(d.getFullYear(), d.getMonth(), 1);
  x.setHours(0,0,0,0);
  return +x;
}

function toLocalInput(ts){
  const d = new Date(ts);
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function fromLocalInput(v){
  if (!v) return NaN;
  return new Date(v).getTime();
}

/* haptics + sound */
let audioCtx = null;
function vibrate(ms=20){
  if (!prefs.haptics) return;
  if (navigator.vibrate){
    try{ navigator.vibrate(ms); }catch(e){}
  }
}
function playSound(freq=880, durMs=70){
  if (!prefs.sound) return;
  try{
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = freq;
    g.gain.value = 0.0001;
    o.connect(g);
    g.connect(audioCtx.destination);
    const t = audioCtx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.16, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + durMs/1000);
    o.start();
    o.stop(t + durMs/1000 + 0.02);
  }catch(e){}
}

/* persistence helpers */
function savePrefs(){
  try{ localStorage.setItem(STORE_KEY_PREFS, JSON.stringify(prefs)); }catch(e){}
}
function loadPrefs(){
  try{
    const raw = localStorage.getItem(STORE_KEY_PREFS);
    if (!raw) return;
    const obj = JSON.parse(raw) || {};
    prefs.theme   = obj.theme === "light" ? "light" : "dark";
    prefs.sound   = obj.sound !== false;
    prefs.haptics = obj.haptics !== false;
  }catch(e){}
}
function applyTheme(){
  document.body.classList.toggle("light", prefs.theme === "light");
}

function saveGoals(){
  try{ localStorage.setItem(STORE_KEY_GOALS, JSON.stringify(goals)); }catch(e){}
}
function loadGoals(){
  try{
    const raw = localStorage.getItem(STORE_KEY_GOALS);
    if (!raw) return;
    const g = JSON.parse(raw) || {};
    goals.yearly  = +g.yearly  || 0;
    goals.monthly = +g.monthly || 0;
    goals.weekly  = +g.weekly  || 0;
    goals.daily   = +g.daily   || 0;
  }catch(e){}
}

function saveHistoryStore(){
  try{ localStorage.setItem(STORE_KEY_HISTORY, JSON.stringify(history)); }catch(e){}
}
function loadHistoryStore(){
  try{
    const raw = localStorage.getItem(STORE_KEY_HISTORY);
    if (!raw) return;
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) history = arr;
  }catch(e){}
}

function saveExpenses(){
  try{ localStorage.setItem(STORE_KEY_EXPENSES, JSON.stringify(expenses)); }catch(e){}
}
function loadExpenses(){
  try{
    const raw = localStorage.getItem(STORE_KEY_EXPENSES);
    if (!raw) return;
    const arr = JSON.parse(raw)||[];
    if (Array.isArray(arr)) expenses = arr;
  }catch(e){}
}
function saveBudgets(){
  try{ localStorage.setItem(STORE_KEY_BUDGETS, JSON.stringify(budgets)); }catch(e){}
}
function loadBudgets(){
  try{
    const raw = localStorage.getItem(STORE_KEY_BUDGETS);
    if (!raw) return;
    const obj = JSON.parse(raw)||{};
    budgets = Object.assign(budgets, obj);
  }catch(e){}
}

/* paydays */
function clampPayday(n){
  const v = Math.floor(+n);
  if (!isFinite(v) || v<=0) return null;
  return Math.max(1, Math.min(31, v));
}
function savePaydays(){
  try{ localStorage.setItem(STORE_KEY_PAYDAYS, JSON.stringify(paydays)); }catch(e){}
}
function loadPaydays(){
  try{
    const raw = localStorage.getItem(STORE_KEY_PAYDAYS);
    if (!raw) return;
    const obj = JSON.parse(raw)||{};
    paydays.day1 = clampPayday(obj.day1);
    paydays.day2 = clampPayday(obj.day2);
  }catch(e){}
}
function updatePaydayInfoText(){
  if (!predPaydayInfo) return;
  const d1 = paydays.day1;
  const d2 = paydays.day2;
  if (d1 || d2){
    if (d1 && d2){
      predPaydayInfo.textContent =
        `Current paydays: ${d1} and ${d2} each month. Predictions reset after each payday.`;
    }else{
      const d = d1 || d2;
      predPaydayInfo.textContent =
        `Current payday: day ${d} of each month. Predictions reset after payday.`;
    }
  }else{
    predPaydayInfo.textContent =
      "Example: enter 1 and 15 if you’re paid the 1st and 15th. Predictions reset each time you pass a payday.";
  }
}
function applyPaydayInputsFromState(){
  if (predPayDay1) predPayDay1.value = paydays.day1 || "";
  if (predPayDay2) predPayDay2.value = paydays.day2 || "";
  updatePaydayInfoText();
}
function handlePaydayChange(){
  if (predPayDay1) paydays.day1 = clampPayday(predPayDay1.value);
  if (predPayDay2) paydays.day2 = clampPayday(predPayDay2.value);
  savePaydays();
  updatePaydayInfoText();
  computePredictions();
}
if (predPayDay1) predPayDay1.addEventListener("change", handlePaydayChange);
if (predPayDay2) predPayDay2.addEventListener("change", handlePaydayChange);

/* break display */
function showBreak(){
  breakDisplay.classList.add("show");
}
function startBreakTicker(){
  if (breakTicker) clearInterval(breakTicker);
  breakTicker = setInterval(()=>{
    if (!onBreak || !breakStartTs) return;
    const now = Date.now();
    const ms = now - breakStartTs;
    breakDisplay.textContent = "Break: " + humanShort(ms);
  },250);
}

/* live contributions helpers */
function currentSessionContributionSince(tsFloor){
  if (!running || onBreak || !startWallTs) return { amount:0, ms:0 };
  const rate = parseFloat(rateInput.value)||0;
  const now = Date.now();
  const start = Math.max(startWallTs, tsFloor);
  if (now <= start) return { amount:0, ms:0 };
  const ms = now - start;
  return { amount: rate*(ms/3600000), ms };
}
function sumEntriesBetween(startMs, endMs){
  let ms=0, amount=0, sessions=0, breakMs=0;
  for (const h of history){
    if (h.endTs >= startMs && h.endTs < endMs){
      ms += h.elapsedMs||0;
      amount += h.amount||0;
      sessions++;
      breakMs += h.breakMs||0;
    }
  }
  return { ms, amount, sessions, breakMs };
}

/* Timer core */
function updateDisplays(ms){
  const rate = parseFloat(rateInput.value)||0;
  const earned = rate * (ms/3600000);
  timeDisplay.textContent  = formatMain(ms);
  moneyDisplay.textContent = fmtMoney(earned);
}
function startInterval(){
  if (interval) clearInterval(interval);
  interval = setInterval(tick, 50);
}
function tick(){
  const now = Date.now();

  if (scheduledStartTs && now >= scheduledStartTs && !running && !onBreak){
    scheduledStartTs = null;
    startTimer();
  }
  if (scheduledStopTs && now >= scheduledStopTs && running){
    scheduledStopTs = null;
    stopTimer(true);
    return;
  }

  if (running){
    elapsed = now - startTime;
    endWallTs = now;
    updateDisplays(elapsed);
  }
}

function startTimer(){
  if (running) return;
  const now = Date.now();
  if (!startWallTs) startWallTs = now;
  startTime = now - elapsed;
  running = true;
  startInterval();
  vibrate(12);
  playSound(1200,80);
  saveState();
}
function finalizeActiveBreak(){
  if (!onBreak) return;
  const now = Date.now();
  const dur = now - breakStartTs;
  sessionBreakMs += Math.max(0,dur);
  onBreak = false;
  if (breakTicker){
    clearInterval(breakTicker);
    breakTicker=null;
  }
  breakDisplay.classList.remove("show");
  breakSummary.textContent = "Break taken: " + humanShort(sessionBreakMs);
  breakSummary.classList.add("show");
}
function stopTimer(fromSchedule=false){
  if (!running && !fromSchedule) return;
  finalizeActiveBreak();
  running = false;
  if (interval){ clearInterval(interval); interval=null; }
  endWallTs = Date.now();
  elapsed = Math.max(0, endWallTs - (startWallTs||endWallTs));
  updateDisplays(elapsed);
  saveState();
  saveBackdrop.classList.add("show");
  vibrate(16);
  playSound(650,90);
  syncOverlays();
}
function clearTimer(){
  if (running){
    alert("Stop the timer first before clearing.");
    vibrate(8);
    playSound(400,60);
    return;
  }
  elapsed = 0;
  startWallTs = null;
  endWallTs = null;
  sessionBreakMs = 0;
  onBreak = false;
  if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
  breakDisplay.classList.remove("show");
  breakSummary.classList.remove("show");
  breakSummary.textContent = "";
  updateDisplays(0);
  saveState();
  vibrate(10);
  playSound(520,70);
}

/* ====== History ====== */
function flashHistoryBtn(){
  historyBtn.classList.add("flash");
  setTimeout(()=>historyBtn.classList.remove("flash"), 900);
}
function updateTotals(){
  const now = Date.now();
  const w0 = startOfWeek(now);
  const m0 = startOfMonth(now);
  const wSum = history.filter(h=>h.endTs>=w0).reduce((a,b)=>a+(b.amount||0),0);
  const mSum = history.filter(h=>h.endTs>=m0).reduce((a,b)=>a+(b.amount||0),0);
  weekTotalEl.textContent  = fmtMoney(wSum);
  monthTotalEl.textContent = fmtMoney(mSum);
  computePredictions();
}
function renderHistory(){
  historyList.innerHTML = "";
  history.forEach(item=>{
    const li = document.createElement("li");
    const startStr = new Date(item.startTs).toLocaleString();
    const endStr   = new Date(item.endTs).toLocaleString();
    li.innerHTML = `
      <div>
        <div class="meta">Start: ${startStr} • End: ${endStr}${item.tag ? " • #"+item.tag : ""}</div>
        <div class="dur">Duration: ${formatMain(item.elapsedMs)}</div>
        ${item.breakMs ? `<div class="meta">Break: ${humanShort(item.breakMs)}</div>` : ""}
        <div class="amt">${fmtMoney(item.amount)}</div>
        ${item.tag ? `<div class="tag">#${item.tag}</div>` : ""}
      </div>
      <div class="row-actions">
        <button class="btn-small btn-danger" data-del="${item.id}">Delete</button>
        <button class="btn-small" data-edit="${item.id}">Edit</button>
        <button class="btn-small btn-export" data-export="${item.id}">Export</button>
      </div>
    `;
    historyList.appendChild(li);
  });

  historyList.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      pendingDeleteId = btn.getAttribute("data-del");
      confirmBackdrop.classList.add("show");
      syncOverlays();
    };
  });
  historyList.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-edit");
      const item = history.find(h=>String(h.id)===String(id));
      if (!item) return;
      editingId = item.id;
      editStart.value = toLocalInput(item.startTs);
      editEnd.value   = toLocalInput(item.endTs);
      editTag.value   = item.tag || "";
      editBackdrop.classList.add("show");
      syncOverlays();
    };
  });
  historyList.querySelectorAll("[data-export]").forEach(btn=>{
    btn.onclick = ()=>{
      exportBackdrop.classList.add("show");
      syncOverlays();
    };
  });
}

function saveHistory(){
  if (!startWallTs || !endWallTs || elapsed<=0){
    saveBackdrop.classList.remove("show");
    syncOverlays();
    return;
  }
  const rate = parseFloat(rateInput.value)||0;
  const amount = rate*(elapsed/3600000);
  const tag = (tagInput.value||"").trim();
  const entry = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
    startTs: startWallTs,
    endTs: endWallTs,
    elapsedMs: elapsed,
    breakMs: sessionBreakMs,
    amount,
    tag
  };
  history.unshift(entry);
  saveHistoryStore();

  // reset session
  elapsed = 0;
  startWallTs = null;
  endWallTs = null;
  sessionBreakMs = 0;
  breakSummary.classList.remove("show");
  breakSummary.textContent = "";
  breakDisplay.classList.remove("show");
  updateDisplays(0);
  saveState();

  tagInput.value = "";
  saveBackdrop.classList.remove("show");
  renderHistory();
  updateTotals();
  flashHistoryBtn();
  vibrate(14);
  playSound(950,80);
  syncOverlays();
}

function applyEdit(){
  if (!editingId){
    editBackdrop.classList.remove("show");
    syncOverlays();
    return;
  }
  const s = fromLocalInput(editStart.value);
  const e = fromLocalInput(editEnd.value);
  if (!(isFinite(s) && isFinite(e) && e>s)){
    alert("Invalid start/end time.");
    return;
  }
  const item = history.find(h=>String(h.id)===String(editingId));
  if (!item) return;
  const rate = item.elapsedMs>0 ? item.amount / (item.elapsedMs/3600000) : (parseFloat(rateInput.value)||0);
  const newElapsed = e - s;
  item.startTs = s;
  item.endTs   = e;
  item.elapsedMs = newElapsed;
  item.amount  = rate * (newElapsed/3600000);
  item.tag     = (editTag.value||"").trim();
  saveHistoryStore();
  renderHistory();
  updateTotals();
  editBackdrop.classList.remove("show");
  editingId = null;
  vibrate(12);
  playSound(820,70);
  syncOverlays();
}

/* ===== Overlays gating ===== */
function anyOverlayOpen(){
  return (
    menuPanel.classList.contains("show") ||
    historyPanel.classList.contains("show") ||
    goalsPanel.classList.contains("show") ||
    statsBackdrop.classList.contains("show") ||
    settingsBackdrop.classList.contains("show") ||
    saveBackdrop.classList.contains("show") ||
    editBackdrop.classList.contains("show") ||
    confirmBackdrop.classList.contains("show") ||
    startAtBackdrop.classList.contains("show") ||
    stopAtBackdrop.classList.contains("show") ||
    exportBackdrop.classList.contains("show") ||
    expensesPanel.classList.contains("show") ||
    inboxPanel.classList.contains("show") ||
    predictionPanel.classList.contains("show") ||
    billForecastPanel.classList.contains("show") ||
    calcPanel.classList.contains("show")
  );
}
function isMainScreen(){
  return !anyOverlayOpen();
}
function setMainButtonsVisible(show){
  const disp = show ? "inline-flex" : "none";
  menuBtn.style.display    = disp;
  historyBtn.style.display = disp;
  statsBtn.style.display   = disp;
}
function refreshInboxBtnVisibility(){
  inboxBtn.style.display = isMainScreen() ? "inline-flex" : "none";
}
function syncOverlays(){
  const open = anyOverlayOpen();
  blocker.style.display = open ? "block" : "none";
  const histOpen = historyPanel.classList.contains("show");
  setMainButtonsVisible(!histOpen);
  refreshInboxBtnVisibility();
}

/* Observe overlays for changes (so blocker stays in sync) */
[
  menuPanel, historyPanel, goalsPanel, statsBackdrop, settingsBackdrop,
  saveBackdrop, editBackdrop, confirmBackdrop, startAtBackdrop, stopAtBackdrop,
  exportBackdrop, expensesPanel, inboxPanel, predictionPanel, billForecastPanel,
  calcPanel
].forEach(el=>{
  if (!el) return;
  new MutationObserver(syncOverlays).observe(el,{attributes:true,attributeFilter:["class","style"]});
});

/* ===== UI Wiring (click handlers) ===== */
startBtn.onclick  = () => startTimer();
stopBtn.onclick   = () => stopTimer(false);
clearBtn.onclick  = () => clearTimer();

historyBtn.onclick = ()=>{
  updateTotals();
  historyPanel.classList.toggle("show");
  syncOverlays();
};
closeHistory.onclick = ()=>{
  historyPanel.classList.remove("show");
  syncOverlays();
};

discardBtn.onclick = ()=>{
  saveBackdrop.classList.remove("show");
  syncOverlays();
};
saveBtn.onclick = saveHistory;

editCancel.onclick = ()=>{
  editBackdrop.classList.remove("show");
  editingId = null;
  syncOverlays();
};
editSave.onclick = applyEdit;

confirmNo.onclick = ()=>{
  confirmBackdrop.classList.remove("show");
  pendingDeleteId=null;
  syncOverlays();
};
confirmYes.onclick = ()=>{
  if (pendingDeleteId){
    history = history.filter(h=>String(h.id)!==String(pendingDeleteId));
    saveHistoryStore();
    renderHistory();
    updateTotals();
    vibrate(14);
    playSound(520,70);
  }
  pendingDeleteId=null;
  confirmBackdrop.classList.remove("show");
  syncOverlays();
};

settingsBtnFloat.onclick = ()=>{
  themeSelect.value = prefs.theme;
  soundToggle.checked   = prefs.sound;
  hapticsToggle.checked = prefs.haptics;
  settingsBackdrop.classList.add("show");
  syncOverlays();
};
settingsClose.onclick = ()=>{
  settingsBackdrop.classList.remove("show");
  syncOverlays();
};
settingsSave.onclick = ()=>{
  prefs.theme   = themeSelect.value==="light" ? "light" : "dark";
  prefs.sound   = !!soundToggle.checked;
  prefs.haptics = !!hapticsToggle.checked;
  applyTheme();
  savePrefs();
  settingsBackdrop.classList.remove("show");
  vibrate(10);
  playSound(800,70);
  syncOverlays();
};

/* close modals when clicking on the dark area */
[
  settingsBackdrop, saveBackdrop, editBackdrop, confirmBackdrop,
  startAtBackdrop, stopAtBackdrop, exportBackdrop, statsBackdrop
].forEach(el=>{
  el.addEventListener("click", e=>{
    if (e.target===el){
      el.classList.remove("show");
      syncOverlays();
    }
  });
});
/* Menu + navigation */
function toggleMenu(force){
  const open = typeof force==="boolean" ? force : !menuPanel.classList.contains("show");
  menuPanel.classList.toggle("show", open);
  syncOverlays();
}
menuBtn.onclick  = ()=> toggleMenu(true);
closeMenu.onclick = ()=> toggleMenu(false);

menuGoals.onclick = ()=>{
  toggleMenu(false);
  goalsPanel.classList.add("show");
  syncOverlays();
};
goalsClose.onclick = ()=>{
  goalsPanel.classList.remove("show");
  syncOverlays();
};

menuSummary.onclick = ()=>{
  toggleMenu(false);
  alert("Summary view coming soon.");
};
menuCalc.onclick = ()=>{
  toggleMenu(false);
  calcPanel.classList.add("show");
  syncOverlays();
};
calcClose.onclick = ()=>{
  calcPanel.classList.remove("show");
  syncOverlays();
};
menuExpenses.onclick = ()=>{
  toggleMenu(false);
  openExpenses();
};
menuPrediction.onclick = ()=>{
  toggleMenu(false);
  openPredictionPanel();
};
menuBillForecast.onclick = ()=>{
  toggleMenu(false);
  openBillForecast();
};

/* Inbox */
function openInbox(){
  if (!isMainScreen()) return;
  inboxPanel.classList.add("show");
  syncOverlays();
}
function closeInboxPanel(){
  inboxPanel.classList.remove("show");
  syncOverlays();
}
inboxBtn.onclick = ()=> openInbox();
closeInbox.onclick = ()=> closeInboxPanel();

/* Start / Stop at */
startAtBtn.onclick = ()=>{
  startAtInput.value = toLocalInput(Date.now());
  startAtBackdrop.classList.add("show");
  syncOverlays();
};
startAtCancel.onclick = ()=>{
  startAtBackdrop.classList.remove("show");
  syncOverlays();
};
startAtSave.onclick = ()=>{
  const v = startAtInput.value;
  if (!v){ alert("Pick a valid time."); return; }
  const ts = fromLocalInput(v);
  const now = Date.now();
  if (!isFinite(ts)){ alert("Invalid time."); return; }

  if (ts <= now){
    startWallTs = ts;
    elapsed = now - ts;
    startTime = now - elapsed;
    running = true;
    startInterval();
    scheduledStartTs = null;
    updateDisplays(elapsed);
    vibrate(10);
    playSound(1200,80);
  }else{
    scheduledStartTs = ts;
    startWallTs = ts;
    elapsed = 0;
    running = false;
    if (interval){ clearInterval(interval); interval=null; }
    updateDisplays(0);
    vibrate(8);
    playSound(900,70);
  }

  saveState();
  startAtBackdrop.classList.remove("show");
  syncOverlays();
};

stopAtBtn.onclick = ()=>{
  stopAtInput.value = toLocalInput(Date.now());
  stopAtBackdrop.classList.add("show");
  syncOverlays();
};
stopAtCancel.onclick = ()=>{
  stopAtBackdrop.classList.remove("show");
  syncOverlays();
};
stopAtSave.onclick = ()=>{
  const v = stopAtInput.value;
  if (!v){ alert("Pick a valid time."); return; }
  if (!startWallTs){ alert("No active session to stop."); return; }
  const ts = fromLocalInput(v);
  const now = Date.now();
  if (!isFinite(ts)){ alert("Invalid time."); return; }

  if (ts <= now){
    finalizeActiveBreak();
    running = false;
    if (interval){ clearInterval(interval); interval=null; }
    endWallTs = ts;
    elapsed = Math.max(0, endWallTs - startWallTs);
    updateDisplays(elapsed);
    saveState();
    saveBackdrop.classList.add("show");
    vibrate(16);
    playSound(650,90);
    scheduledStopTs = null;
    syncOverlays();
  }else{
    scheduledStopTs = ts;
    vibrate(8);
    playSound(820,70);
    saveState();
    stopAtBackdrop.classList.remove("show");
    syncOverlays();
  }
};

exportClose.onclick = ()=>{
  exportBackdrop.classList.remove("show");
  syncOverlays();
};

/* Break buttons */
takeBreakBtn.onclick = ()=>{
  if (onBreak) return;
  if (running){
    running = false;
    if (interval){ clearInterval(interval); interval=null; }
  }
  onBreak = true;
  breakStartTs = Date.now();
  showBreak();
  startBreakTicker();
  breakSummary.classList.remove("show");
  breakSummary.textContent = "";
  saveState();
  vibrate(12);
  playSound(520,80);
};
endBreakBtn.onclick = ()=>{
  if (!onBreak) return;
  const now = Date.now();
  const dur = now - breakStartTs;
  sessionBreakMs += Math.max(0,dur);
  onBreak = false;
  if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
  breakDisplay.classList.remove("show");
  breakSummary.textContent = "Break taken: " + humanShort(sessionBreakMs);
  breakSummary.classList.add("show");
  startTime = now - elapsed;
  running = true;
  startInterval();
  saveState();
  vibrate(14);
  playSound(880,80);
};

/* ===== Calculator Logic ===== */
let calcState = {
  current: "0",
  previous: null,
  operation: null,
  clearNext: false
};

function calcUpdateDisplay() {
  calcDisplay.textContent = calcState.current;
}

function calcInput(num) {
  if (calcState.clearNext) {
    calcState.current = "0";
    calcState.clearNext = false;
  }
  if (num === "." && calcState.current.includes(".")) return;
  if (calcState.current === "0" && num !== ".") {
    calcState.current = num;
  } else {
    calcState.current += num;
  }
  calcUpdateDisplay();
}

function calcOperate(op) {
  if (calcState.previous !== null && !calcState.clearNext) {
    calcEquals();
  }
  calcState.previous = calcState.current;
  calcState.operation = op;
  calcState.clearNext = true;
}

function calcEquals() {
  if (calcState.previous === null || calcState.operation === null) return;
  const prev = parseFloat(calcState.previous);
  const curr = parseFloat(calcState.current);
  let result;
  switch (calcState.operation) {
    case "+": result = prev + curr; break;
    case "-": result = prev - curr; break;
    case "*": result = prev * curr; break;
    case "/": result = prev / curr; break;
    default: return;
  }
  calcState.current = String(result);
  calcState.previous = null;
  calcState.operation = null;
  calcState.clearNext = true;
  calcUpdateDisplay();
}

function calcClear() {
  calcState.current = "0";
  calcState.previous = null;
  calcState.operation = null;
  calcState.clearNext = false;
  calcUpdateDisplay();
}

function calcClearEntry() {
  calcState.current = "0";
  calcState.clearNext = false; // Allow re-entry on same operation
  calcUpdateDisplay();
}

document.querySelectorAll("[data-num]").forEach(btn => {
  btn.onclick = () => calcInput(btn.dataset.num);
});
document.querySelectorAll("[data-op]").forEach(btn => {
  btn.onclick = () => calcOperate(btn.dataset.op);
});
document.getElementById("calcEq").onclick = calcEquals;
document.getElementById("calcC").onclick = calcClear;
document.getElementById("calcCE").onclick = calcClearEntry;


/* ===== Expenses ===== */
const CATEGORY_KEYWORDS = [
  {cat:"Groceries", words:["walmart","target","aldi","kroger","publix","safeway","food lion","trader joe","whole foods","grocery"]},
  {cat:"Restaurants", words:["restaurant","diner","cafe","bistro","grill","pizza","taco","sub","burger","mcdonald","kfc","chick-fil-a","chipotle","popeyes","wendy","burger king","domino"]},
  {cat:"Bars & Nightlife", words:["bar","pub","brew","taproom","saloon","club","night"]},
  {cat:"Subscriptions", words:["netflix","spotify","hulu","disney","max","apple tv","prime","youtube","xbox","playstation","adobe","icloud"]},
  {cat:"Bills & Utilities", words:["electric","power","water","gas co","utility","internet","fiber","mobile","phone","comcast","xfinity","verizon","att","spectrum"]},
  {cat:"Auto & Gas", words:["shell","bp","chevron","exxon","7-eleven","speedway","marathon","gas","oil change","jiffy lube"]},
  {cat:"Healthcare", words:["pharmacy","walgreens","cvs","rite aid","clinic","dental","hospital","urgent care"]},
  {cat:"Entertainment", words:["cinema","theater","concert","ticketmaster","amc","regal","event"]},
  {cat:"Shopping", words:["amazon","walmart.com","best buy","ebay","mall","outlet"]},
  {cat:"Travel", words:["airlines","hotel","airbnb","lyft","uber","booking","expedia","delta","united","southwest"]}
];

function guessCategory(merchant){
  const q = (merchant||"").toLowerCase();
  for (const row of CATEGORY_KEYWORDS){
    if (row.words.some(w=>q.includes(w))) return row.cat;
  }
  return "Other";
}

function openExpenses(){
  xpDate.value = new Date().toISOString().slice(0,10);
  expensesPanel.classList.add("show");
  renderExpensesUI();
  syncOverlays();
}
function closeExpensesPanel(){
  expensesPanel.classList.remove("show");
  syncOverlays();
}
closeExpenses.onclick = ()=> closeExpensesPanel();

xpMerchant.addEventListener("blur", ()=>{
  if (!xpCategory.value || xpCategory.value==="Other"){
    xpCategory.value = guessCategory(xpMerchant.value);
  }
});

xpAddBtn.onclick = ()=>{
  const amt   = +(+xpAmount.value||0).toFixed(2);
  const dateS = xpDate.value;
  const merch = (xpMerchant.value||"").trim();
  const cat   = xpCategory.value || guessCategory(merch);
  const note  = (xpNote.value||"").trim();
  if (!(amt>0) || !dateS){
    alert("Enter amount and date.");
    return;
  }
  const ts = new Date(dateS+"T12:00:00").getTime();
  const item = {
    id: Date.now().toString(36)+Math.random().toString(36).slice(2,6),
    ts,
    amount:amt,
    merchant: merch || "Unknown",
    category: cat,
    note
  };
  expenses.unshift(item);
  saveExpenses();
  xpAmount.value="";
  xpMerchant.value="";
  xpNote.value="";
  renderExpensesUI();
  vibrate(12);
  playSound(980,80);
};
xpImportBtn.onclick = ()=>{
  const raw = prompt("Paste lines:\nYYYY-MM-DD, Merchant, Amount[, Category]");
  if (!raw) return;
  const lines = raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  let count=0;
  for (const line of lines){
    const parts = line.split(",").map(s=>s.trim());
    if (parts.length<3) continue;
    const [d,m,a,c] = parts;
    const ts = new Date(d+"T12:00:00").getTime();
    const amount = +(+a||0).toFixed(2);
    if (!(isFinite(ts) && amount>0)) continue;
    const cat = c || guessCategory(m);
    expenses.unshift({
      id: Date.now().toString(36)+Math.random().toString(36).slice(2,5),
      ts, amount, merchant:m, category:cat, note:""
    });
    count++;
  }
  if (!count){
    alert("No valid rows found.");
    return;
  }
  saveExpenses();
  renderExpensesUI();
  vibrate(18);
  playSound(1100,80);
};
xpClearMonthBtn.onclick = ()=>{
  const now = new Date();
  const m0 = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
  const m1 = new Date(now.getFullYear(), now.getMonth()+1, 1).getTime();
  if (!confirm("Delete all expenses for this month?")) return;
  const before = expenses.length;
  expenses = expenses.filter(e=>!(e.ts>=m0 && e.ts<m1));
  saveExpenses();
  renderExpensesUI();
  alert(`Removed ${before-expenses.length} item(s).`);
};

function monthSeries(n=6){
  const out=[];
  const now = new Date();
  for (let i=n-1;i>=0;i--){
    const y = now.getFullYear();
    const m = now.getMonth()-i;
    const d0 = new Date(y,m,1).getTime();
    const d1 = new Date(y,m+1,1).getTime();
    const sum = expenses.filter(e=>e.ts>=d0 && e.ts<d1).reduce((a,b)=>a+b.amount,0);
    const label = new Date(y,m,1).toLocaleString(undefined,{month:"short"});
    out.push({label,sum});
  }
  return out;
}

function renderExpensesUI(){
  const now = new Date();
  const m0 = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
  const m1 = new Date(now.getFullYear(), now.getMonth()+1, 1).getTime();
  const monthItems = expenses.filter(e=>e.ts>=m0 && e.ts<m1);
  const total = monthItems.reduce((a,b)=>a+b.amount,0);

  const catMap={};
  for (const e of monthItems){
    catMap[e.category] = (catMap[e.category]||0)+e.amount;
  }
  const catEntries = Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const top = catEntries[0] || ["—",0];

  xpMonthSpend.textContent = fmtMoney(total);

  const planned = Object.values(budgets).reduce((a,b)=>a+(+b||0),0) || 0;
  if (planned>0){
    const pct = Math.min(9999, Math.max(0, total/planned*100)).toFixed(0);
    let cls="budget-ok";
    if (total>planned) cls="budget-bad";
    else if (total>planned*0.8) cls="budget-warn";
    xpBudgetHint.innerHTML = `Planned: ${fmtMoney(planned)} • <span class="${cls}">${pct}%</span> of budget`;
  }else{
    xpBudgetHint.textContent = "No budget set";
  }

  xpTopCat.textContent = top[0];
  xpTopCatShare.textContent = top[1]
    ? `${fmtMoney(top[1])} (${(top[1]/Math.max(1,total)*100).toFixed(1)}%)`
    : "—";

  xpList.innerHTML = "";
  monthItems.sort((a,b)=>b.ts-a.ts).forEach(e=>{
    const div = document.createElement("div");
    div.className = "xp-item";
    div.innerHTML = `
      <div>
        <div class="m">${e.merchant} • <span class="c">${e.category}</span></div>
        <div class="c">${humanDate(e.ts)}${e.note ? " • "+e.note : ""}</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <div class="amt">-${fmtMoney(e.amount)}</div>
        <div class="xp-row-actions">
          <button class="btn-mini edit" data-xp-edit="${e.id}">Edit</button>
          <button class="btn-mini danger" data-xp-del="${e.id}">Del</button>
        </div>
      </div>
    `;
    xpList.appendChild(div);
  });

  xpList.querySelectorAll("[data-xp-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-xp-del");
      expenses = expenses.filter(x=>x.id!==id);
      saveExpenses();
      renderExpensesUI();
    };
  });
  xpList.querySelectorAll("[data-xp-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-xp-edit");
      const it = expenses.find(x=>x.id===id);
      if (!it) return;
      const nd = prompt("Edit date (YYYY-MM-DD):", new Date(it.ts).toISOString().slice(0,10)); if (!nd) return;
      const nm = prompt("Edit merchant:", it.merchant); if (nm===null) return;
      const na = prompt("Edit amount:", String(it.amount)); if (na===null) return;
      const nc = prompt("Edit category:", it.category) || it.category;
      const nn = prompt("Edit note:", it.note||"") || "";
      const ts = new Date(nd+"T12:00:00").getTime();
      const amt = +(+na||0).toFixed(2);
      if (!(isFinite(ts) && amt>0)){ alert("Invalid values."); return; }
      it.ts = ts;
      it.merchant = nm.trim()||"Unknown";
      it.amount = amt;
      it.category = nc;
      it.note = nn;
      saveExpenses();
      renderExpensesUI();
    };
  });

  renderExpensesCharts(catEntries, monthSeries());
  renderSuggestions(catEntries, monthItems);
  updateBillForecast();
}

function renderExpensesCharts(catEntries, series){
  if (xpPie) xpPie.destroy();
  const labels = catEntries.map(([k])=>k);
  const data = catEntries.map(([,v])=>v);
  const pieCtx = xpPieCanvas.getContext("2d");
  xpPie = new Chart(pieCtx,{
    type:"doughnut",
    data:{
      labels,
      datasets:[{
        data,
        backgroundColor:[
          "#22c55e","#2dd4bf","#60a5fa","#a78bfa","#f59e0b",
          "#ef4444","#22d3ee","#10b981","#f97316","#eab308","#f472b6"
        ],
        borderColor:"#020617",
        borderWidth:2
      }]
    },
    options:{
      cutout:"60%",
      plugins:{ legend:{ labels:{ color:"#e2e8f0" } } }
    }
  });

  if (xpTrend) xpTrend.destroy();
  const tctx = xpTrendCanvas.getContext("2d");
  const labels2 = series.map(x=>x.label);
  const sums = series.map(x=>+x.sum.toFixed(2));
  const g = tctx.createLinearGradient(0,0,0,170);
  g.addColorStop(0,"rgba(239,68,68,0.4)");
  g.addColorStop(1,"rgba(239,68,68,0.06)");
  xpTrend = new Chart(tctx,{
    type:"line",
    data:{
      labels:labels2,
      datasets:[{
        label:"Monthly spend",
        data:sums,
        borderColor:"#ef4444",
        backgroundColor:g,
        tension:.3,
        pointRadius:3,
        pointBackgroundColor:"#f87171",
        fill:true
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        tooltip:{ callbacks:{ label:ctx=>fmtMoney(ctx.raw) } }
      },
      scales:{
        x:{ ticks:{ color:"#e2e8f0" } },
        y:{ ticks:{ color:"#e2e8f0" }, beginAtZero:true }
      }
    }
  });
}

function renderSuggestions(catEntries, monthItems){
  xpSuggestions.innerHTML = "";
  if (!monthItems.length){
    xpSuggestions.innerHTML = "<li>Add a few expenses to see insights.</li>";
    return;
  }
  const add = text=>{
    const li=document.createElement("li");
    li.textContent=text;
    xpSuggestions.appendChild(li);
  };
  const total = monthItems.reduce((a,b)=>a+b.amount,0);
  const top = catEntries[0];
  if (top){
    const share=(top[1]/Math.max(1,total)*100).toFixed(1);
    add(`${top[0]} is ${share}% of your spending this month. Decide one small cut in this category.`);
  }
  const byMerchant={};
  for (const e of monthItems){
    const key=e.merchant.toLowerCase();
    byMerchant[key]=(byMerchant[key]||0)+e.amount;
  }
  const topMerch = Object.entries(byMerchant).sort((a,b)=>b[1]-a[1])[0];
  if (topMerch && topMerch[1]>total*0.25){
    add(`One place (${topMerch[0]}) is taking a big chunk (${fmtMoney(topMerch[1])}). See if you can trim it.`);
  }
}

/* ===== Stats & charts ===== */
function rangeDays(n){
  const arr=[];
  const now = new Date();
  now.setHours(0,0,0,0);
  for (let i=n-1;i>=0;i--){
    arr.push(+now - i*86400000);
  }
  return arr;
}

function renderStats(){
  const now = Date.now();
  const d0 = startOfDay(now);
  const w0 = startOfWeek(now);
  const m0 = startOfMonth(now);

  const today = sumEntriesBetween(d0, d0+86400000);
  const week  = sumEntriesBetween(w0, w0+7*86400000);
  const month = sumEntriesBetween(m0, new Date(new Date().getFullYear(), new Date().getMonth()+1,1).getTime());

  const todayLive  = currentSessionContributionSince(d0).amount;
  const weekLive   = currentSessionContributionSince(w0).amount;
  const monthLive  = currentSessionContributionSince(m0).amount;

  todayEarned.textContent = fmtMoney(today.amount + todayLive);
  weekEarned.textContent  = fmtMoney(week.amount + weekLive);
  monthEarned.textContent = fmtMoney(month.amount + monthLive);

  const days = rangeDays(7);
  const labels = days.map(ts=>new Date(ts).toLocaleDateString(undefined,{weekday:"short"}));
  const earningsData=[];
  const hoursData=[];
  const tagMap={};

  for (const dayStart of days){
    const dayEnd = dayStart + 86400000;
    const {amount, ms} = sumEntriesBetween(dayStart, dayEnd);
    const live = currentSessionContributionSince(dayStart).amount;
    earningsData.push(amount + live);
    hoursData.push(ms/3600000);

    history.filter(h=>h.endTs>=dayStart && h.endTs<dayEnd && h.tag).forEach(h=>{
      tagMap[h.tag] = (tagMap[h.tag]||0) + (h.amount||0);
    });
  }

  // charts
  if (earningsChart) earningsChart.destroy();
  const ectx = document.getElementById("earningsChart").getContext("2d");
  earningsChart = new Chart(ectx,{
    type:"bar",
    data:{ labels, datasets:[{ label:"Earnings", data:earningsData, backgroundColor:"#22c55e" }]},
    options:{
      plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:ctx=>fmtMoney(ctx.raw) } } },
      scales:{ x:{ticks:{color:"#e2e8f0"}}, y:{ticks:{color:"#e2e8f0"}, beginAtZero:true} }
    }
  });

  if (hoursChart) hoursChart.destroy();
  const hctx = document.getElementById("hoursChart").getContext("2d");
  hoursChart = new Chart(hctx,{
    type:"bar",
    data:{ labels, datasets:[{ label:"Hours", data:hoursData, backgroundColor:"#60a5fa" }]},
    options:{
      plugins:{ legend:{display:false} },
      scales:{ x:{ticks:{color:"#e2e8f0"}}, y:{ticks:{color:"#e2e8f0"}, beginAtZero:true} }
    }
  });

  // tag effectiveness donut
  const tagEntries = Object.entries(tagMap).sort((a,b)=>b[1]-a[1]);
  if (breakChart) breakChart.destroy();
  const bctx = document.getElementById("breakChart").getContext("2d");
  breakChart = new Chart(bctx,{
    type:"doughnut",
    data:{
      labels:tagEntries.map(([k])=>k),
      datasets:[{
        data:tagEntries.map(([,v])=>v),
        backgroundColor:["#22c55e","#22d3ee","#60a5fa","#a78bfa","#f97316","#f97373","#eab308","#10b981"]
      }]
    },
    options:{
      cutout:"60%",
      plugins:{ legend:{ labels:{ color:"#e2e8f0" } } }
    }
  });

  // trend & averages
  const totalEarn = earningsData.reduce((a,b)=>a+b,0);
  const avgDay = totalEarn / (earningsData.length||1);
  avgDayEl.textContent = fmtMoney(avgDay);
  const avgRate = (() => {
    const totalMs = history.reduce((a,b)=>a+(b.elapsedMs||0),0);
    if (!totalMs) return 0;
    const totalAmt = history.reduce((a,b)=>a+(b.amount||0),0);
    return totalAmt/(totalMs/3600000);
  })();
  avgRateEl.textContent = `${avgRate.toFixed(2)}/hr`;

  const last = earningsData[earningsData.length-1]||0;
  const first= earningsData[0]||0;
  const diff = last-first;
  if (Math.abs(diff) < first*0.1) trendEl.textContent = "Stable";
  else if (diff>0) trendEl.textContent = "Rising";
  else trendEl.textContent = "Cooling off";
}

statsBtn.onclick = ()=>{
  statsBackdrop.classList.add("show");
  renderStats();
  syncOverlays();
};
statsClose.onclick = ()=>{
  statsBackdrop.classList.remove("show");
  syncOverlays();
};

/* ===== Goals UI updates ===== */
function updateGoalBar(bar, valuesEl, actual, target){
  const pct = !target ? 0 : Math.min(100, Math.round((actual/target)*100));
  bar.style.width = pct + "%";
  bar.dataset.pct = String(pct);
  valuesEl.textContent = `${fmtMoney(actual)} / ${fmtMoney(target)} (${pct}%)`;
}
function refreshGoals(){
  const now = Date.now();
  const yearStart = new Date(new Date().getFullYear(),0,1).getTime();
  const monthStart = startOfMonth(now);
  const weekStart  = startOfWeek(now);
  const dayStart   = startOfDay(now);

  const y = sumEntriesBetween(yearStart, now).amount + currentSessionContributionSince(yearStart).amount;
  const m = sumEntriesBetween(monthStart, now).amount + currentSessionContributionSince(monthStart).amount;
  const w = sumEntriesBetween(weekStart, now).amount + currentSessionContributionSince(weekStart).amount;
  const d = sumEntriesBetween(dayStart, now).amount + currentSessionContributionSince(dayStart).amount;

  updateGoalBar(yearlyBar,  yearlyValues,  y, goals.yearly);
  updateGoalBar(monthlyBar, monthlyValues, m, goals.monthly);
  updateGoalBar(weeklyBar,  weeklyValues,  w, goals.weekly);
  updateGoalBar(dailyBar,   dailyValues,   d, goals.daily);
}

yearlySave.onclick = ()=>{
  goals.yearly = +(+yearlyInput.value||0);
  saveGoals();
  refreshGoals();
};
monthlySave.onclick = ()=>{
  goals.monthly = +(+monthlyInput.value||0);
  saveGoals();
  refreshGoals();
};
weeklySave.onclick = ()=>{
  goals.weekly = +(+weeklyInput.value||0);
  saveGoals();
  refreshGoals();
};
dailySave.onclick = ()=>{
  goals.daily = +(+dailyInput.value||0);
  saveGoals();
  refreshGoals();
};

/* ===== Predictions ===== */
function estimateDailyPace(){
  const now = Date.now();
  const todayStart = startOfDay(now);
  const daysBack = 14;
  let total = 0;
  let count = 0;

  for (let i=0;i<daysBack;i++){
    const dayStart = todayStart - i*86400000;
    const dayEnd   = dayStart + 86400000;
    const {amount} = sumEntriesBetween(dayStart, dayEnd);
    const live = currentSessionContributionSince(dayStart).amount;
    const dayTotal = amount + live;
    if (dayTotal>0){
      total += dayTotal;
      count++;
    }
  }
  if (!count){
    const yearStart = new Date(new Date().getFullYear(),0,1).getTime();
    const {amount} = sumEntriesBetween(yearStart, now);
    const live = currentSessionContributionSince(yearStart).amount;
    const daysSoFar =
      Math.max(1, Math.round((todayStart - yearStart)/86400000)+1);
    return (amount+live)/daysSoFar;
  }
  return total/count;
}

function getPayPeriodInfo(nowTs){
  const d=new Date(nowTs);
  const y=d.getFullYear();
  const m=d.getMonth();
  const day=d.getDate();

  const days=[];
  if (paydays.day1) days.push(paydays.day1);
  if (paydays.day2 && paydays.day2!==paydays.day1) days.push(paydays.day2);
  
  // Your request: 1st-15th, 15th-1st
  // We will model this as paydays on the 1st and 15th.
  // The logic will find the *next* payday and *previous* payday.
  if (!days.length) {
    days.push(1, 15);
  }
  days.sort((a,b)=>a-b);

  let prevTs=null, nextTs=null;
  
  // Find previous payday TS
  const currentMonthPaydays = days.map(pd => new Date(y, m, pd).getTime()).filter(ts => ts <= nowTs);
  if (currentMonthPaydays.length > 0) {
    prevTs = Math.max(...currentMonthPaydays);
  } else {
    // Look in previous month
    const prevMonth = new Date(y, m, 0); // Last day of previous month
    const prevMonthDays = days.map(pd => new Date(prevMonth.getFullYear(), prevMonth.getMonth(), pd).getTime());
    prevTs = Math.max(...prevMonthDays);
  }

  // Find next payday TS
  const futureMonthPaydays = days.map(pd => new Date(y, m, pd).getTime()).filter(ts => ts > nowTs);
  if (futureMonthPaydays.length > 0) {
    nextTs = Math.min(...futureMonthPaydays);
  } else {
    // Look in next month
    const nextMonth = new Date(y, m + 1, 1);
    const nextMonthDays = days.map(pd => new Date(nextMonth.getFullYear(), nextMonth.getMonth(), pd).getTime());
    nextTs = Math.min(...nextMonthDays);
  }

  // The pay period *starts* the day *after* the last payday
  const startTs = startOfDay(prevTs) + 86400000;
  // The pay period *ends* on the day *of* the next payday
  const endTs   = startOfDay(nextTs) + (86400000 - 1); // End of day on next payday

  return {startTs, endTs, nextPaydayTs: nextTs};
}

function computePredictions(){
  if (!predDailyValue) return;
  const now = Date.now();
  const today = new Date(now);
  const todayStart = startOfDay(now);
  const year = today.getFullYear();
  const yearStart = new Date(year,0,1).getTime();
  const dec31 = new Date(year,11,31);
  dec31.setHours(23,59,59,999);
  const dec31Start = startOfDay(dec31.getTime());
  const remainingDaysToYearEnd =
    Math.max(0, Math.round((dec31Start - todayStart)/86400000)+1);

  if (predDateRange){
    const fmt = new Intl.DateTimeFormat(undefined,{day:"numeric",month:"long"});
    predDateRange.textContent =
      `Today: ${fmt.format(today)} • Forecast through ${fmt.format(dec31)} ${year}`;
  }
  
  // --- Date Range Calculations ---
  // Weekly: Mon X - Sun Y
  const weekStartTs = startOfWeek(now);
  const weekEndTs = weekStartTs + (6 * 86400000); // 6 days after Mon is Sun
  predWeeklyDates.textContent = `${formatShortDate(weekStartTs)} – ${formatShortDate(weekEndTs)}`;
  
  // Bi-Weekly: Based on paydays
  const payInfo = getPayPeriodInfo(now);
  predBiWeeklyDates.textContent = `${formatShortDate(payInfo.startTs)} – ${formatShortDate(payInfo.endTs)}`;
  
  // Monthly: Month 1 - Month 30/31
  const monthStartTs = startOfMonth(now);
  const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0); // Last day of current month
  predMonthlyDates.textContent = `${formatShortDate(monthStartTs)} – ${formatShortDate(monthEnd.getTime())}`;
  
  // Yearly: Jan 1 - Dec 31
  predYearlyDates.textContent = `${formatShortDate(yearStart)} – ${formatShortDate(dec31.getTime())}`;
  
  // --- Value Calculations ---
  const dailyPace = estimateDailyPace();
  const clampDays = n => Math.max(0, Math.min(n, remainingDaysToYearEnd));

  const dailyForecast   = dailyPace;
  const weeklyForecast  = dailyPace * 7; // Full 7 day forecast
  const monthlyForecast = dailyPace * clampDays(today.getDate() <= 15 ? 30 : 30.44 / 2); // Simple avg
  
  let biWeeklyForecast = 0;
  if (payInfo){
    let startTs = payInfo.startTs;
    let endTs   = payInfo.endTs;
    const yearEndExclusive = dec31Start + 86400000;
    if (endTs>yearEndExclusive) endTs = yearEndExclusive;
    if (startTs>endTs) startTs=endTs;
    
    // Calculate days *remaining* in this pay period, including today
    const remainingInPeriod = Math.max(0, Math.round((endTs - todayStart) / 86400000) + 1);
    const daysInPeriod = Math.max(1, Math.round((endTs - startTs) / 86400000) + 1);
    
    // Get what's already earned this period
    const {amount: periodSoFar} = sumEntriesBetween(startTs, now);
    const livePeriod = currentSessionContributionSince(startTs).amount;
    
    // Forecast = (already earned) + (pace * remaining days)
    biWeeklyForecast = (periodSoFar + livePeriod) + (dailyPace * Math.max(0, remainingInPeriod - 1));
  } else {
    biWeeklyForecast = dailyPace * 14; // Fallback
  }

  const {amount:ytd} = sumEntriesBetween(yearStart, now);
  const liveYear = currentSessionContributionSince(yearStart).amount;
  const yearSoFar = ytd + liveYear;
  const yearForecast = yearSoFar + dailyPace * Math.max(0, remainingDaysToYearEnd-1);

  predDailyValue.textContent    = fmtMoney(dailyForecast||0);
  predWeeklyValue.textContent   = fmtMoney(weeklyForecast||0);
  predBiWeeklyValue.textContent = fmtMoney(biWeeklyForecast||0);
  predMonthlyValue.textContent  = fmtMoney(monthlyForecast||0);
  predYearlyValue.textContent   = fmtMoney(yearForecast||0);

  function setStatus(value, goal, goalEl, statusEl){
    if (!goal || goal<=0){
      goalEl.textContent = "Goal: —";
      statusEl.className = "pred-status neutral";
      statusEl.textContent = "No goal set";
      return;
    }
    goalEl.textContent = "Goal: " + fmtMoney(goal);
    const r = (value||0)/goal;
    if (r>=1){
      statusEl.className = "pred-status good";
      statusEl.textContent = "On or above target";
    }else if (r>=0.75){
      statusEl.className = "pred-status neutral";
      statusEl.textContent = "Close, keep pushing";
    }else{
      statusEl.className = "pred-status bad";
      statusEl.textContent = "Behind current target";
    }
  }

  setStatus(dailyForecast,   goals.daily,   predDailyGoal,   predDailyStatus);
  setStatus(weeklyForecast,  goals.weekly,  predWeeklyGoal,  predWeeklyStatus);
  setStatus(
    biWeeklyForecast,
    goals.weekly ? goals.weekly*2 : 0,
    predBiWeeklyGoal,
    predBiWeeklyStatus
  );
  setStatus(monthlyForecast, goals.monthly, predMonthlyGoal, predMonthlyStatus);
  setStatus(yearForecast,   goals.yearly,  predYearlyGoal,  predYearlyStatus);

  if (payInfo && predPaydayInfo){
    const nextLabel = formatShortDate(payInfo.nextPaydayTs);
    const d1 = paydays.day1 || 1;
    const d2 = paydays.day2 || 15;
    
    predPaydayInfo.textContent =
      `Paydays: ${d1} and ${d2}. Next: ${nextLabel}. Predictions reset after each payday.`;

  }else{
    updatePaydayInfoText();
  }
}

function openPredictionPanel(){
  predictionPanel.classList.add("show");
  computePredictions();
  syncOverlays();
}
predictionClose.onclick = ()=>{
  predictionPanel.classList.remove("show");
  syncOverlays();
};

/* ===== Bill Forecast ===== */
function updateBillForecast(){
  if (!billForecastPanel) return;
  const period = bfPeriod.value || "month";
  const dailyPace = estimateDailyPace();
  let income=0;
  if (period==="week") income = dailyPace*7;
  else if (period==="30d" || period==="month") income = dailyPace*30;
  else if (period==="year") income = dailyPace*365;
  else income = dailyPace*30;

  const fixedBills = parseFloat(bfFixedBills.value)||0;

  let variable=0;
  if (bfIncludeExpenses.checked){
    const series = monthSeries(3);
    const avgMonthly = series.reduce((a,b)=>a+(b.sum||0),0)/(series.length||1);
    if (period==="week") variable = avgMonthly/4;
    else if (period==="30d" || period==="month") variable = avgMonthly;
    else if (period==="year") variable = avgMonthly*12;
  }

  const totalBills = fixedBills + variable;
  const left = income - totalBills;

  bfIncome.textContent = fmtMoney(income);
  bfBills.textContent  = fmtMoney(totalBills);
  bfLeft.textContent   = fmtMoney(left);
  bfLeft.classList.toggle("good", left>=0);
  bfLeft.classList.toggle("bad", left<0);

  bfHints.innerHTML = "";
  const add = text=>{
    const li=document.createElement("li");
    li.textContent=text;
    bfHints.appendChild(li);
  };
  if (income<=0){
    add("Start a few sessions so I can learn your income pace.");
    return;
  }
  const billPct = totalBills/Math.max(1,income);
  if (billPct<=0.4) add("Bills are under 40% of income. Good breathing room.");
  else if (billPct<=0.6) add("Bills are 40–60% of income. Reasonable, but keep new subscriptions in check.");
  else add("Bills are above 60% of income. Consider cutting one or two non-essentials.");

  if (bfIncludeExpenses.checked && variable>0){
    add("Variable expenses included from your Expense history. Trim the loudest categories to increase leftover.");
  }else{
    add("Turn ON 'Include tracked Expenses' for a more realistic picture.");
  }

  if (left<0) add("You are forecast to be negative. Either increase income or cut some bills for this period.");
}
bfPeriod.addEventListener("change", updateBillForecast);
bfFixedBills.addEventListener("input", updateBillForecast);
bfIncludeExpenses.addEventListener("change", updateBillForecast);

function openBillForecast(){
  billForecastPanel.classList.add("show");
  updateBillForecast();
  syncOverlays();
}
billForecastClose.onclick = ()=>{
  billForecastPanel.classList.remove("show");
  syncOverlays();
};
/* ===== State save/load ===== */
function saveState(){
  const state = {
    running,
    startWallTs,
    endWallTs,
    elapsed,
    rate: parseFloat(rateInput.value)||0,
    scheduledStartTs,
    scheduledStopTs,
    onBreak,
    breakStartTs,
    sessionBreakMs
  };
  try{ localStorage.setItem(STORE_KEY_STATE, JSON.stringify(state)); }catch(e){}
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY_STATE);
    if (!raw) return;
    const s = JSON.parse(raw)||{};
    if (typeof s.rate==="number") rateInput.value = String(s.rate);
    running        = !!s.running;
    startWallTs    = typeof s.startWallTs==="number" ? s.startWallTs : null;
    endWallTs      = typeof s.endWallTs==="number"   ? s.endWallTs   : null;
    elapsed        = typeof s.elapsed==="number"     ? s.elapsed     : 0;
    scheduledStartTs = typeof s.scheduledStartTs==="number" ? s.scheduledStartTs : null;
    scheduledStopTs  = typeof s.scheduledStopTs==="number"  ? s.scheduledStopTs  : null;
    onBreak        = !!s.onBreak;
    breakStartTs   = typeof s.breakStartTs==="number" ? s.breakStartTs : null;
    sessionBreakMs = typeof s.sessionBreakMs==="number" ? s.sessionBreakMs : 0;

    if (onBreak && breakStartTs){
      showBreak();
      startBreakTicker();
    }

    if (running && startWallTs){
      const now = Date.now();
      elapsed = Math.max(0, now - startWallTs);
      startTime = now - elapsed;
      updateDisplays(elapsed);
      startInterval();
    }else{
      updateDisplays(elapsed);
    }
  }catch(e){}
}

/* ===== Boot ===== */
loadPrefs();
applyTheme();
loadGoals();
loadPaydays();
loadHistoryStore();
loadBudgets();
loadExpenses();
loadState();
renderHistory();
updateTotals();
applyPaydayInputsFromState();
refreshGoals();
renderExpensesUI();
computePredictions();
updateBillForecast();
syncOverlays();
calcUpdateDisplay(); // Init calculator display

/* save on unload/visibility change */
window.addEventListener("beforeunload", ()=>{
  saveState();
  savePrefs();
  saveGoals();
  saveBudgets();
  saveExpenses();
  savePaydays();
});
document.addEventListener("visibilitychange", ()=>{
  if (document.hidden){
    saveState();
    savePrefs();
    saveGoals();
    saveBudgets();
    saveExpenses();
    savePaydays();
  }
});

/* keep timer tick alive */
setInterval(tick, 1000/60);
</script>
</body>
</html>
