<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Earnings Timer â€” Neon Build</title>

<!-- ðŸ”„ Force fresh load -->
<script>
(function(){
  const APP_VERSION = "21";
  const KEY = "ver_guard_seen";
  try {
    const url  = new URL(location.href);
    const curr = url.searchParams.get("v");
    const seen = sessionStorage.getItem(KEY);
    if (curr !== APP_VERSION) {
      if (seen !== APP_VERSION) {
        sessionStorage.setItem(KEY, APP_VERSION);
        url.searchParams.set("v", APP_VERSION);
        location.replace(url.toString());
      }
    }
  } catch (e) {}
})();
</script>

<style>
  :root{
    --bg:#0b1020;
    --panel:#111931;
    --panel-2:#0f172a;
    --text:#f8fafc;
    --muted:#94a3b8;
    --green:#22c55e;
    --green-2:#16a34a;
    --cyan:#22d3ee;
    --blue:#60a5fa;
    --purple:#a78bfa;
    --amber:#f59e0b;
    --red:#ef4444;

    /* neon helpers */
    --glow-soft: 0 0 12px rgba(34,197,94,.35), 0 0 24px rgba(34,197,94,.2);
    --glow-cyan: 0 0 12px rgba(34,211,238,.35), 0 0 24px rgba(34,211,238,.2);
    --glow-purple: 0 0 12px rgba(167,139,250,.35), 0 0 24px rgba(167,139,250,.2);
  }

  /* ===== Base */
  body{font-family:Inter,system-ui,Arial,sans-serif;background:radial-gradient(1200px 800px at 20% 10%, #0c1534 0%, #0b1020 40%, #070c19 100%);color:var(--text);display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;overflow:hidden}
  .top{position:absolute;top:20px;left:20px;display:flex;align-items:center;gap:8px;z-index:5}
  .rate-wrap{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#1a2547,#121a35);border:1px solid #334155;border-radius:10px;padding:6px 8px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  input[type="number"]{width:110px;padding:6px 6px;border:none;outline:none;font-size:16px;text-align:right;background:transparent;color:var(--text)}

  .timer{font-size:3rem;margin-bottom:6px;text-shadow:0 0 12px rgba(96,165,250,.25)}
  .amount{font-size:3rem;color:var(--green);margin-bottom:10px;text-shadow:0 0 16px rgba(34,197,94,.4)}

  .break-timer{font-size:1.15rem;color:var(--red);margin-bottom:8px;display:none;text-shadow:0 0 12px rgba(239,68,68,.4)}
  .break-timer.show{display:block}
  .break-summary{font-size:.95rem;color:#eab308;background:linear-gradient(180deg,#3b3a1b,#2b2a12);border:1px solid #534f1a;padding:6px 10px;border-radius:999px;display:none;margin-bottom:10px;box-shadow:0 8px 18px rgba(0,0,0,.25)}
  .break-summary.show{display:inline-block}

  .buttons{display:flex;gap:10px;margin-bottom:10px}
  .buttons2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:min(460px,90vw)}
  .buttons2 button{width:100%}
  button{background:linear-gradient(180deg,#27457e,#1a2f59);border:1px solid #314978;color:#fff;padding:12px 24px;border-radius:12px;font-size:16px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.25);transition:transform .06s ease, box-shadow .12s ease, filter .12s ease}
  button:active{transform:translateY(1px);filter:brightness(.95)}
  #start{background:linear-gradient(180deg,#1f9b4a,#137a38);border-color:#198e41;box-shadow:0 10px 24px rgba(0,0,0,.25), 0 0 24px rgba(34,197,94,.25)}
  #stop{background:linear-gradient(180deg,#b91c1c,#7f1d1d);border-color:#991b1b}
  #clear{background:linear-gradient(180deg,#475569,#334155);border-color:#475569}

  /* Bottom floaters */
  #historyBtn,#statsBtn{position:fixed;bottom:20px;background:linear-gradient(180deg,#17233f,#0f1a35);color:#fff;border:1px solid #2a3a64;border-radius:30px;padding:12px 18px;font-size:16px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:background .2s, box-shadow .2s;z-index:25}
  #historyBtn:hover,#statsBtn:hover{background:#1b2a52}
  #historyBtn{left:50%;transform:translateX(-50%)}
  #historyBtn.flash{background:#14532d !important;box-shadow:0 0 0 6px rgba(34,197,94,.25)}
  .book{width:18px;height:18px;fill:#eab308}

  #statsBtn{right:20px;box-shadow:var(--glow-soft)}
  #statsBtn svg{width:20px;height:20px}
  #statsBtn path{stroke:var(--green)}

  /* Menu button */
  #menuBtn{position:fixed;bottom:20px;left:20px;background:linear-gradient(180deg,#17233f,#0f1a35);color:#fff;border:1px solid #2a3a64;border-radius:30px;padding:12px 18px;font-size:16px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:background .2s, box-shadow .2s;z-index:25}
  #menuBtn:hover{background:#1b2a52}
  .hamburger svg{width:18px;height:18px}

  /* Menu panel */
  #menuPanel{position:fixed;top:0;left:-75%;width:75%;height:100%;max-width:420px;background:linear-gradient(180deg,#0e172d,#0a1326);border-right:2px solid #2b3f6f;border-radius:0 12px 12px 0;transition:left .3s;display:flex;flex-direction:column;z-index:30;box-shadow:0 0 40px rgba(0,0,0,.45)}
  #menuPanel.show{left:0}
  #menuHeader{background:#0b1224;padding:12px 16px;border-radius:0 12px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #2b3f6f}
  #menuHeader .title{display:inline-flex;align-items:center;gap:8px}
  #menuHeader h3{margin:0;font-size:18px}
  #closeMenu{background:#dc2626;border:none;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px}
  #menuContent{padding:12px 16px;display:flex;flex-direction:column;gap:10px}
  .menu-item{background:linear-gradient(180deg,#0f1a34,#0b1224);border:1px solid #2a3a64;border-radius:12px;padding:12px 14px;font-size:15px;color:#e2e8f0;display:flex;justify-content:space-between;align-items:center;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.25)}
  .menu-item .r{opacity:.7}
  #settingsBtn{position:absolute;right:20px;bottom:20px;background:#0ea5e9;border:1px solid #0284c7;color:#0b1020;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer;box-shadow:var(--glow-cyan)}
  #settingsBtn:hover{filter:brightness(1.05)}

  /* Goals full-screen */
  #goalsPanel{position:fixed;inset:0;background:radial-gradient(1200px 800px at 80% 0%, #0e1b3a 0%, #0b1224 50%, #09101f 100%);display:none;flex-direction:column;z-index:40}
  #goalsPanel.show{display:flex}
  #goalsHeader{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #2b3f6f;background:#0b1224}
  #goalsHeader h3{margin:0;font-size:18px}
  #goalsClose{background:#64748b;border:none;color:#fff;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer}
  #goalsBody{padding:12px 16px;display:flex;flex-direction:column;gap:16px;overflow:auto;flex:1}
  .goal-card{background:linear-gradient(180deg,#0f172a,#0c1426);border:1px solid #2b3f6f;border-radius:14px;padding:14px;box-shadow:0 12px 24px rgba(0,0,0,.28)}
  .goal-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .goal-title{font-weight:800}
  .goal-values{font-size:13px;color:var(--muted)}

  /* Liquid bar */
  .goal-bar{height:18px;background:linear-gradient(180deg,#0a1326,#0c1833);border:1px solid #23345e;border-radius:999px;overflow:hidden;position:relative;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04)}
  .goal-fill{
    height:100%;width:0%;
    background:
      radial-gradient(18px 12px at 20% 50%, rgba(255,255,255,.25), rgba(255,255,255,0) 70%) repeat-x,
      radial-gradient(18px 12px at 60% 50%, rgba(255,255,255,.2),  rgba(255,255,255,0) 70%) repeat-x,
      linear-gradient(90deg,#0ea75a 0%,#22c55e 40%,#86efac 100%);
    background-size: 60px 100%, 90px 100%, auto;
    background-position: var(--wave1,0px) 0, var(--wave2,0px) 0, 0 0;
    filter:saturate(1.25);
    box-shadow:0 0 18px rgba(34,197,94,.55),0 0 38px rgba(34,197,94,.28),inset 0 0 10px rgba(255,255,255,.12);
    transition:width .05s linear;position:relative;will-change:width,background-position;
  }
  .goal-fill::after{
    content:"";position:absolute;top:-60%;bottom:-60%;width:100px;left:-100px;
    background:radial-gradient(60px 140px at 0% 50%, rgba(255,255,255,.35), rgba(255,255,255,0) 70%);
    mix-blend-mode:screen;filter:blur(.5px);animation:shimmer 1.6s ease-in-out infinite;
  }
  @keyframes shimmer{0%{left:-100px;opacity:0}30%{opacity:.5}60%{left:20px;opacity:.25}100%{left:140px;opacity:0}}
  /* Pulse when near completion */
  .goal-fill[data-pct="90"],.goal-fill[data-pct="91"],.goal-fill[data-pct="92"],.goal-fill[data-pct="93"],.goal-fill[data-pct="94"],.goal-fill[data-pct="95"],.goal-fill[data-pct="96"],.goal-fill[data-pct="97"],.goal-fill[data-pct="98"],.goal-fill[data-pct="99"],.goal-fill[data-pct="100"]{
    animation:nearDonePulse 1.2s ease-in-out infinite;
  }
  @keyframes nearDonePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.25)}}

  .goal-edit{display:flex;align-items:center;gap:8px;margin-top:10px}
  .goal-edit label{font-size:13px;color:var(--muted)}
  .goal-edit input{flex:1;background:#0b1224;border:1px solid #2b3f6f;border-radius:10px;padding:10px 12px;color:var(--text)}
  .goal-edit button{background:linear-gradient(180deg,#22c55e,#13a24a);border:1px solid #15803d;color:#05210f;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:var(--glow-soft)}

  /* History panel */
  #historyPanel{position:fixed;bottom:-75%;left:0;width:100%;max-height:75%;background:linear-gradient(180deg,#0f172a,#0b1224);color:var(--text);border-top:2px solid #2b3f6f;border-radius:12px 12px 0 0;padding:0;transition:bottom .3s;display:flex;flex-direction:column;z-index:20;box-shadow:0 -8px 28px rgba(0,0,0,.4)}
  #historyPanel.show{bottom:0}
  #historyHeader{background:#0b1224;padding:12px 16px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #2b3f6f}
  #historyHeader .title{display:inline-flex;align-items:center;gap:8px}
  #historyHeader h3{margin:0;font-size:18px}
  #closeHistory{background:#dc2626;border:none;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px}
  #totals{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:12px 16px;border-bottom:1px solid #2b3f6f}
  .card{background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #2b3f6f;border-radius:12px;padding:12px}
  .card .k{font-size:12px;color:var(--muted)}
  .card .v{font-size:18px;font-weight:800;color:var(--green);text-shadow:0 0 12px rgba(34,197,94,.35)}
  #historyList{list-style:none;padding:12px 16px;margin:0;overflow-y:auto;flex-grow:1}
  #historyList li{background:linear-gradient(180deg,#0f172a,#101b36);border:1px solid #2b3f6f;border-radius:12px;padding:10px 12px;margin-bottom:10px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;box-shadow:0 8px 18px rgba(0,0,0,.25)}
  .meta{font-size:13px;color:var(--muted);margin-bottom:6px}
  .dur{font-size:15px;font-weight:bold}
  .amt{color:var(--green);font-weight:bold;font-size:16px;text-shadow:0 0 12px rgba(34,197,94,.35)}
  .tag{display:inline-block;margin-top:6px;font-size:12px;color:#eab308;background:#3b3a1b;border:1px solid #534f1a;padding:2px 6px;border-radius:999px}
  .row-actions{display:flex;flex-direction:column;gap:6px}
  .btn-small{background:#1a274a;border:1px solid #2a3a64;color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer}
  .btn-danger{background:#7f1d1d;border-color:#b91c1c}
  .btn-export{background:#0ea5e9;border-color:#0284c7;box-shadow:var(--glow-cyan)}
  .break-highlight{color:#ef4444;font-weight:800;text-shadow:0 0 10px rgba(239,68,68,.4)}

  /* Popups */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:40;opacity:0;transition:opacity .25s ease}
  .backdrop.show{display:flex;opacity:1}
  .modal{background:linear-gradient(180deg,#0f172a,#0c1427);border:1px solid #2b3f6f;border-radius:14px;padding:16px;width:340px;max-width:92vw;box-shadow:0 12px 32px rgba(0,0,0,.45)}
  .modal h3{margin:0 0 10px;text-align:center}
  .field{display:flex;align-items:center;gap:8px;background:#0b1224;border:1px solid #2b3f6f;border-radius:10px;padding:8px 10px;margin-top:8px}
  .field input, .field select{flex:1;background:transparent;border:none;outline:none;color:var(--text)}
  .actions{display:flex;gap:10px;margin-top:14px}
  .actions button{flex:1;padding:10px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
  #discardBtn{background:#6b7280}
  #saveBtn{background:#22c55e}
  input[type="datetime-local"]{background:transparent;border:none;outline:none;color:var(--text)}
  #editCancel{background:#6b7280}
  #editSave{background:#22c55e}
  #confirmYes{background:#dc2626}
  #confirmNo{background:#6b7280}
  .setting-row{display:flex;align-items:center;justify-content:space-between;background:#0f172a;border:1px solid #2b3f6f;border-radius:10px;padding:10px 12px;margin-top:10px}

  /* Stats Dashboard (center modal) */
  #statsBackdrop{position:fixed;inset:0;background:rgba(3,6,14,.75);display:none;align-items:center;justify-content:center;z-index:50;opacity:0;transition:opacity .25s ease}
  #statsBackdrop.show{display:flex;opacity:1}
  #statsModal{background:linear-gradient(180deg,#0f172a,#0c1426);border:1px solid #2b3f6f;border-radius:18px;padding:20px;width:95%;max-width:820px;max-height:90vh;overflow-y:auto;box-shadow:0 40px 80px rgba(0,0,0,.5)}
  .stats-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #2b3f6f;padding-bottom:8px;margin-bottom:12px}
  .stats-header h3{margin:0;font-size:20px}
  .stats-close{background:#22c55e;border:none;color:#0f172a;padding:8px 12px;border-radius:8px;font-weight:bold;cursor:pointer}
  .stat-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
  .stat-card{
    background:radial-gradient(200px 120px at 70% -20%, rgba(34,211,238,.18), transparent 60%), linear-gradient(180deg,#0f172a,#0b1224);
    border:1px solid #2b3f6f;border-radius:12px;padding:12px;box-shadow:0 16px 28px rgba(0,0,0,.35);
  }
  .stat-title{font-size:13px;color:var(--muted)}
  .stat-value{font-size:22px;font-weight:800;color:var(--green);text-shadow:0 0 16px rgba(34,197,94,.5)}
  .stat-card:nth-child(2) .stat-value{color:var(--cyan);text-shadow:0 0 16px rgba(34,211,238,.45)}
  .stat-card:nth-child(3) .stat-value{color:var(--purple);text-shadow:0 0 16px rgba(167,139,250,.45)}

  canvas{background:linear-gradient(180deg,#0b1224,#0f172a);border:1px solid #2b3f6f;border-radius:14px;margin-bottom:14px;box-shadow:0 12px 28px rgba(0,0,0,.35), 0 0 24px rgba(96,165,250,.15)}

  .analytics-info{
    background:linear-gradient(180deg,#0f172a,#0c1426);
    border:1px solid #2b3f6f;border-radius:12px;padding:12px;font-size:14px;color:#dbeafe;
    box-shadow:0 12px 28px rgba(0,0,0,.35);
  }
  .analytics-info p{margin:6px 0}
  .analytics-info span{font-weight:800;text-shadow:0 0 12px rgba(255,255,255,.15)}
  #avgRate{color:var(--green)}
  #avgDay{color:var(--cyan)}
  #trend{color:var(--purple)}

  /* Light theme quick overrides */
  body.light{background:#f5f7fb;color:#0f172a}
  body.light .stat-card, body.light #statsModal, body.light .goal-card, body.light .modal, body.light #historyPanel, body.light .menu-item{background:#ffffff;border-color:#e5e7eb}
  body.light #historyList li{background:#ffffff;border-color:#e5e7eb}
  body.light .field{background:#ffffff;border-color:#e5e7eb}
  body.light .goal-bar{background:#eef2ff;border-color:#c7d2fe}
</style>
</head>
<body>

<div class="top">
  <span>Amount ($/hr):</span>
  <div class="rate-wrap">
    <input id="rate" type="number" value="25" step="0.01" min="0">
  </div>
</div>

<!-- Displays -->
<div class="timer" id="timeDisplay">00:00:00.00</div>
<div class="amount" id="moneyDisplay">$0.00</div>
<div class="break-timer" id="breakDisplay">Break: 00:00:00</div>
<div class="break-summary" id="breakSummary"></div>

<!-- Main controls -->
<div class="buttons">
  <button id="start">Start</button>
  <button id="stop">Stop</button>
  <button id="clear">Clear</button>
</div>

<!-- Scheduling & Break -->
<div class="buttons2">
  <button id="startAtBtn">Start At</button>
  <button id="stopAtBtn">Stop At</button>
  <button id="takeBreakBtn">Take Break</button>
  <button id="endBreakBtn">End Break</button>
</div>

<!-- Floating -->
<button id="menuBtn" aria-controls="menuPanel" aria-expanded="false">
  <span class="hamburger" aria-hidden="true">
    <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">
      <path d="M4 7h16"></path><path d="M4 12h16"></path><path d="M4 17h16"></path>
    </svg>
  </span>
  Menu
</button>

<button id="historyBtn" aria-live="polite">
  <svg class="book" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22V4.5zM6.5 4A.5.5 0 0 0 6 4.5v15a.5.5 0 0 0 .5.5H18V4H6.5z"/>
  </svg>
  History
</button>

<button id="statsBtn" title="View Stats">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M4 21h16M6 17V9m4 8V5m4 12v-7m4 7V3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  Stats
</button>

<!-- Menu Panel -->
<div id="menuPanel" aria-hidden="true" role="dialog" aria-labelledby="menuTitle">
  <div id="menuHeader">
    <div class="title">
      <span class="hamburger" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">
          <path d="M4 7h16"></path><path d="M4 12h16"></path><path d="M4 17h16"></path>
        </svg>
      </span>
      <h3 id="menuTitle">Menu</h3>
    </div>
    <button id="closeMenu">Close</button>
  </div>
  <div id="menuContent">
    <div class="menu-item" id="menuGoals"><span>Goals</span><span class="r">â€º</span></div>
    <div class="menu-item" id="menuSummary"><span>Summary</span><span class="r">â€º</span></div>
    <div class="menu-item" id="menuCalc"><span>Calculator</span><span class="r">â€º</span></div>
    <div class="menu-item" id="menuExpenses"><span>Expenses</span><span class="r">â€º</span></div>
  </div>
  <button id="settingsBtn" aria-controls="settingsBackdrop">Settings</button>
</div>

<!-- Goals -->
<div id="goalsPanel" aria-hidden="true" role="dialog" aria-labelledby="goalsTitle">
  <div id="goalsHeader">
    <h3 id="goalsTitle">Goals</h3>
    <button id="goalsClose">Back</button>
  </div>
  <div id="goalsBody">
    <div class="goal-card">
      <div class="goal-top"><div class="goal-title">Yearly Target</div><div class="goal-values" id="yearlyValues">$0 / $0 (0%)</div></div>
      <div class="goal-bar"><div id="yearlyBar" class="goal-fill"></div></div>
      <div class="goal-edit"><label for="yearlyInput">Set target</label><input id="yearlyInput" type="number" min="0" step="0.01" placeholder="e.g. 50000"><button id="yearlySave">Save</button></div>
    </div>
    <div class="goal-card">
      <div class="goal-top"><div class="goal-title">Monthly Target</div><div class="goal-values" id="monthlyValues">$0 / $0 (0%)</div></div>
      <div class="goal-bar"><div id="monthlyBar" class="goal-fill"></div></div>
      <div class="goal-edit"><label for="monthlyInput">Set target</label><input id="monthlyInput" type="number" min="0" step="0.01" placeholder="e.g. 4000"><button id="monthlySave">Save</button></div>
    </div>
    <div class="goal-card">
      <div class="goal-top"><div class="goal-title">Weekly Target</div><div class="goal-values" id="weeklyValues">$0 / $0 (0%)</div></div>
      <div class="goal-bar"><div id="weeklyBar" class="goal-fill"></div></div>
      <div class="goal-edit"><label for="weeklyInput">Set target</label><input id="weeklyInput" type="number" min="0" step="0.01" placeholder="e.g. 1000"><button id="weeklySave">Save</button></div>
    </div>
    <div class="goal-card">
      <div class="goal-top"><div class="goal-title">Daily Target</div><div class="goal-values" id="dailyValues">$0 / $0 (0%)</div></div>
      <div class="goal-bar"><div id="dailyBar" class="goal-fill"></div></div>
      <div class="goal-edit"><label for="dailyInput">Set target</label><input id="dailyInput" type="number" min="0" step="0.01" placeholder="e.g. 200"><button id="dailySave">Save</button></div>
    </div>
  </div>
</div>

<!-- History -->
<div id="historyPanel" aria-hidden="true">
  <div id="historyHeader">
    <div class="title">
      <svg class="book" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22V4.5zM6.5 4A.5.5 0 0 0 6 4.5v15a.5.5 0 0 0 .5.5H18V4H6.5z"/>
      </svg>
      <h3>History</h3>
    </div>
    <button id="closeHistory">Close</button>
  </div>
  <div id="totals">
    <div class="card"><div class="k">This week</div><div class="v" id="weekTotal">$0.00</div></div>
    <div class="card"><div class="k">This month</div><div class="v" id="monthTotal">$0.00</div></div>
  </div>
  <ul id="historyList"></ul>
</div>

<!-- Save / Edit / Confirm / Settings / StartAt / StopAt / Export / Stats -->
<div id="saveBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="saveTitle">
  <div class="modal">
    <h3 id="saveTitle">Save this session?</h3>
    <div class="field"><span style="font-size:14px;color:#94a3b8;">Tag</span><input id="tagInput" type="text" placeholder="Optional tag"></div>
    <div class="actions"><button id="discardBtn">No</button><button id="saveBtn">Yes, Save</button></div>
  </div>
</div>

<div id="editBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="editTitle">
  <div class="modal">
    <h3 id="editTitle">Edit entry</h3>
    <div class="field"><label style="width:80px;color:#94a3b8">Start</label><input id="editStart" type="datetime-local"></div>
    <div class="field"><label style="width:80px;color:#94a3b8">End</label><input id="editEnd" type="datetime-local"></div>
    <div class="field"><span style="font-size:14px;color:#94a3b8;">Tag</span><input id="editTag" type="text" placeholder="Edit tag"></div>
    <div class="actions"><button id="editCancel">Cancel</button><button id="editSave">Save changes</button></div>
  </div>
</div>

<div id="confirmBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
  <div class="modal">
    <h3 id="confirmTitle">Delete this entry?</h3>
    <div class="actions"><button id="confirmNo">No</button><button id="confirmYes">Yes</button></div>
  </div>
</div>

<div id="settingsBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal">
    <h3 id="settingsTitle">Settings</h3>
    <div class="setting-row"><div>Theme</div><div class="field" style="margin:0;"><select id="themeSelect" aria-label="Theme"><option value="dark">Dark</option><option value="light">Light</option></select></div></div>
    <div class="setting-row"><div>Sound</div><label class="switch"><input type="checkbox" id="soundToggle"><span class="slider"></span></label></div>
    <div class="setting-row"><div>Haptic feedback</div><label class="switch"><input type="checkbox" id="hapticsToggle"><span class="slider"></span></label></div>
    <div class="actions" style="margin-top:16px;"><button id="settingsClose" style="background:#6b7280;">Close</button><button id="settingsSave" style="background:#22c55e;">Save</button></div>
  </div>
</div>

<div id="startAtBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="startAtTitle">
  <div class="modal">
    <h3 id="startAtTitle">Start At</h3>
    <div class="field"><label style="width:90px;color:#94a3b8">Date/Time</label><input id="startAtInput" type="datetime-local"></div>
    <div class="actions"><button id="startAtCancel" style="background:#6b7280;">Cancel</button><button id="startAtSave" style="background:#22c55e;">Set</button></div>
  </div>
</div>

<div id="stopAtBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="stopAtTitle">
  <div class="modal">
    <h3 id="stopAtTitle">Stop At</h3>
    <div class="field"><label style="width:90px;color:#94a3b8">Date/Time</label><input id="stopAtInput" type="datetime-local"></div>
    <div class="actions"><button id="stopAtCancel" style="background:#6b7280;">Cancel</button><button id="stopAtSave" style="background:#22c55e;">Set</button></div>
  </div>
</div>

<div id="exportBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="exportTitle">
  <div class="modal">
    <h3 id="exportTitle">Export</h3>
    <p style="text-align:center;margin:8px 0 0;">Coming soon.</p>
    <div class="actions" style="margin-top:12px;"><button id="exportClose" style="background:#22c55e;">OK</button></div>
  </div>
</div>

<div id="statsBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
  <div id="statsModal">
    <div class="stats-header">
      <h3 id="statsTitle">Performance Dashboard</h3>
      <button class="stats-close" id="statsClose">Close</button>
    </div>
    <div class="stat-summary">
      <div class="stat-card"><div class="stat-title">Today</div><div class="stat-value" id="todayEarned">$0.00</div></div>
      <div class="stat-card"><div class="stat-title">This Week</div><div class="stat-value" id="weekEarned">$0.00</div></div>
      <div class="stat-card"><div class="stat-title">This Month</div><div class="stat-value" id="monthEarned">$0.00</div></div>
    </div>
    <canvas id="earningsChart" height="170"></canvas>
    <canvas id="hoursChart" height="170"></canvas>
    <div class="analytics-info">
      <p>Average hourly rate: <span id="avgRate">$0/hr</span></p>
      <p>Average daily earnings (7d): <span id="avgDay">$0</span></p>
      <p>Trend insight: <span id="trend">Stable</span></p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  /* ========= State ========= */
  let startTime = 0, elapsed = 0, running = false, interval = null;
  let startWallTs = null, endWallTs = null;

  let history = [];
  let editingId = null;
  let pendingDeleteId = null;

  let scheduledStartTs = null;
  let scheduledStopTs = null;

  let onBreak = false;
  let breakStartTs = null;
  let breakTicker = null;
  let sessionBreakMs = 0;

  let prefs = { theme:'dark', sound:true, haptics:true };
  let goals = { yearly:0, monthly:0, weekly:0, daily:0 };

  const STORE_KEY_STATE   = 'earningsTimer_state_v7';
  const STORE_KEY_HISTORY = 'earningsTimer_history_v2';
  const STORE_KEY_PREFS   = 'earningsTimer_prefs_v1';
  const STORE_KEY_GOALS   = 'earningsTimer_goals_v1';

  /* ========= Elements ========= */
  const timeDisplay   = document.getElementById('timeDisplay');
  const moneyDisplay  = document.getElementById('moneyDisplay');
  const breakDisplay  = document.getElementById('breakDisplay');
  const breakSummary  = document.getElementById('breakSummary');

  const rateInput = document.getElementById('rate');
  const startBtn = document.getElementById('start');
  const stopBtn  = document.getElementById('stop');
  const clearBtn = document.getElementById('clear');

  const startAtBtn = document.getElementById('startAtBtn');
  const stopAtBtn  = document.getElementById('stopAtBtn');
  const takeBreakBtn = document.getElementById('takeBreakBtn');
  const endBreakBtn  = document.getElementById('endBreakBtn');

  const historyBtn   = document.getElementById('historyBtn');
  const historyPanel = document.getElementById('historyPanel');
  const closeHistory = document.getElementById('closeHistory');
  const historyList  = document.getElementById('historyList');
  const weekTotalEl  = document.getElementById('weekTotal');
  const monthTotalEl = document.getElementById('monthTotal');

  const saveBackdrop  = document.getElementById('saveBackdrop');
  const discardBtn    = document.getElementById('discardBtn');
  const saveBtn       = document.getElementById('saveBtn');
  const tagInput      = document.getElementById('tagInput');

  const editBackdrop = document.getElementById('editBackdrop');
  const editStart = document.getElementById('editStart');
  const editEnd   = document.getElementById('editEnd');
  const editTag   = document.getElementById('editTag');
  const editCancel= document.getElementById('editCancel');
  const editSave  = document.getElementById('editSave');

  const confirmBackdrop = document.getElementById('confirmBackdrop');
  const confirmYes = document.getElementById('confirmYes');
  const confirmNo  = document.getElementById('confirmNo');

  const menuBtn = document.getElementById('menuBtn');
  const menuPanel = document.getElementById('menuPanel');
  const closeMenu = document.getElementById('closeMenu');
  const settingsBtn = document.getElementById('settingsBtn');

  const menuGoals   = document.getElementById('menuGoals');
  const menuSummary = document.getElementById('menuSummary');
  const menuCalc    = document.getElementById('menuCalc');
  const menuExpenses= document.getElementById('menuExpenses');

  const settingsBackdrop = document.getElementById('settingsBackdrop');
  const settingsClose = document.getElementById('settingsClose');
  const settingsSave  = document.getElementById('settingsSave');
  const themeSelect = document.getElementById('themeSelect');
  const soundToggle = document.getElementById('soundToggle');
  const hapticsToggle = document.getElementById('hapticsToggle');

  const startAtBackdrop = document.getElementById('startAtBackdrop');
  const startAtInput    = document.getElementById('startAtInput');
  const startAtCancel   = document.getElementById('startAtCancel');
  const startAtSave     = document.getElementById('startAtSave');

  const stopAtBackdrop = document.getElementById('stopAtBackdrop');
  const stopAtInput    = document.getElementById('stopAtInput');
  const stopAtCancel   = document.getElementById('stopAtCancel');
  const stopAtSave     = document.getElementById('stopAtSave');

  const exportBackdrop = document.getElementById('exportBackdrop');
  const exportClose = document.getElementById('exportClose');

  const goalsPanel   = document.getElementById('goalsPanel');
  const goalsClose   = document.getElementById('goalsClose');
  const yearlyValues = document.getElementById('yearlyValues');
  const monthlyValues= document.getElementById('monthlyValues');
  const weeklyValues = document.getElementById('weeklyValues');
  const dailyValues  = document.getElementById('dailyValues');
  const yearlyBar = document.getElementById('yearlyBar');
  const monthlyBar= document.getElementById('monthlyBar');
  const weeklyBar = document.getElementById('weeklyBar');
  const dailyBar  = document.getElementById('dailyBar');
  const yearlyInput = document.getElementById('yearlyInput');
  const monthlyInput= document.getElementById('monthlyInput');
  const weeklyInput = document.getElementById('weeklyInput');
  const dailyInput  = document.getElementById('dailyInput');
  const yearlySave  = document.getElementById('yearlySave');
  const monthlySave = document.getElementById('monthlySave');
  const weeklySave  = document.getElementById('weeklySave');
  const dailySave   = document.getElementById('dailySave');

  const statsBtn = document.getElementById('statsBtn');
  const statsBackdrop = document.getElementById('statsBackdrop');
  const statsClose = document.getElementById('statsClose');
  const todayEarned = document.getElementById('todayEarned');
  const weekEarned = document.getElementById('weekEarned');
  const monthEarned = document.getElementById('monthEarned');
  const avgRateEl = document.getElementById('avgRate');
  const avgDayEl = document.getElementById('avgDay');
  const trendEl = document.getElementById('trend');

  let earningsChart = null;
  let hoursChart = null;

  /* ========= Helpers ========= */
  const pad2 = n => String(n).padStart(2,'0');
  function fmtMoney(n){ return `$${(n||0).toFixed(2)}`; }
  function formatMain(ms){
    const total = Math.max(0, ms|0);
    const h = Math.floor(total/3600000);
    const m = Math.floor((total%3600000)/60000);
    const s = Math.floor((total%60000)/1000);
    const c = Math.floor((total%1000)/10);
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}.${pad2(c)}`;
  }
  function toLocalInput(ts){ const d = new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function fromLocalInput(val){ return new Date(val.replace(' ', 'T')).getTime(); }

  const startOfDay   = ts => { const d = new Date(ts); d.setHours(0,0,0,0); return d.getTime(); };
  const startOfWeek  = ts => { const d=new Date(ts); const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x.getTime(); };
  const startOfMonth = ts => { const d=new Date(ts); const x=new Date(d.getFullYear(), d.getMonth(), 1); x.setHours(0,0,0,0); return x.getTime(); };
  const startOfYear  = ts => { const d=new Date(ts); const x=new Date(d.getFullYear(), 0, 1); x.setHours(0,0,0,0); return x.getTime(); };

  function dayStart(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return +d; }
  function rangeDays(n){ const arr=[]; const now=dayStart(Date.now()); for(let i=n-1;i>=0;i--){ arr.push(now - i*86400000); } return arr; }

  function vibrate(ms=20){ if (!prefs.haptics) return; if (navigator.vibrate){ try{ navigator.vibrate(ms); }catch{} } }
  let audioCtx = null;
  function playSound(freq=880, durMs=70){
    if (!prefs.sound) return;
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine'; o.frequency.value = freq; g.gain.value = 0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      const t = audioCtx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.15, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + durMs/1000);
      o.start(); o.stop(t + durMs/1000 + 0.01);
    }catch{}
  }

  /* ========= Persistence ========= */
  function savePrefs(){ try{ localStorage.setItem(STORE_KEY_PREFS, JSON.stringify(prefs)); }catch{} }
  function loadPrefs(){
    try{
      const raw = localStorage.getItem(STORE_KEY_PREFS);
      if (!raw) return;
      const obj = JSON.parse(raw)||{};
      prefs.theme = obj.theme === 'light' ? 'light' : 'dark';
      prefs.sound = obj.sound !== false;
      prefs.haptics = obj.haptics !== false;
    }catch{}
  }
  function saveGoals(){ try{ localStorage.setItem(STORE_KEY_GOALS, JSON.stringify(goals)); }catch{} }
  function loadGoals(){
    try{
      const raw = localStorage.getItem(STORE_KEY_GOALS);
      if (!raw) return;
      const g = JSON.parse(raw)||{};
      goals.yearly  = +g.yearly  || 0;
      goals.monthly = +g.monthly || 0;
      goals.weekly  = +g.weekly  || 0;
      goals.daily   = +g.daily   || 0;
    }catch{}
  }
  function applyTheme(){ document.body.classList.toggle('light', prefs.theme === 'light'); }

  function saveHistoryStore(){ try{ localStorage.setItem(STORE_KEY_HISTORY, JSON.stringify(history)); }catch(e){} }
  function loadHistoryStore(){
    try{
      const raw = localStorage.getItem(STORE_KEY_HISTORY);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) history = arr;
    }catch(e){}
  }

  /* ========= Live contribution for stats ========= */
  function currentSessionContributionSince(tsFloorMs){
    if (!running || onBreak || !startWallTs) return {amount:0, ms:0};
    const rate = parseFloat(rateInput.value)||0;
    const now = Date.now();
    const start = Math.max(startWallTs, tsFloorMs);
    if (now <= start) return {amount:0, ms:0};
    const ms = now - start;
    return {amount: rate*(ms/3600000), ms};
  }
  function sumEntriesBetween(startMs, endMs){
    let ms=0, amount=0, sessions=0, breakMs=0;
    for (const h of history){
      if (h.endTs >= startMs && h.endTs < endMs){
        ms += h.elapsedMs||0;
        amount += h.amount||0;
        sessions += 1;
        breakMs += h.breakMs||0;
      }
    }
    return {ms, amount, sessions, breakMs};
  }
  function sumRangeSince(rangeStart){
    const rate = parseFloat(rateInput.value)||0;
    const now = Date.now();
    let total = history.filter(h=>h.endTs>=rangeStart).reduce((a,b)=>a+(b.amount||0),0);
    if (running && !onBreak && startWallTs){
      const contribMs = Math.max(0, now - Math.max(startWallTs, rangeStart));
      total += rate * (contribMs/3600000);
    }
    return total;
  }

  /* ========= App update loop ========= */
  function update(){
    const now = Date.now();

    // animate liquid waves in goal bars every frame
    const w1 = (now/22)%60; const w2 = (now/37)%90;
    [yearlyBar, monthlyBar, weeklyBar, dailyBar].forEach(el=>{
      if (!el) return;
      el.style.setProperty('--wave1', `${w1}px`);
      el.style.setProperty('--wave2', `${w2}px`);
    });

    // scheduled start/stop
    if (scheduledStartTs && now >= scheduledStartTs && !running && !onBreak){
      scheduledStartTs = null; startTimer();
    }
    if (scheduledStopTs && now >= scheduledStopTs && running){
      finalizeActiveBreak();
      scheduledStopTs = null;
      running = false;
      clearInterval(interval); interval = null;
      endWallTs = now;
      saveState();
      saveBackdrop.classList.add('show');
      vibrate(16); playSound(600, 90);
    }

    if (running){
      elapsed = now - startTime;
      endWallTs = now;
      updateDisplays(elapsed);
      if (now % 500 < 20) saveState();
    }
  }

  function updateDisplays(elapsedMs){
    const rate = parseFloat(rateInput.value)||0;
    const earned = (rate * (elapsedMs / 3600000));
    timeDisplay.textContent = formatMain(elapsedMs);
    moneyDisplay.textContent = fmtMoney(earned);
  }

  function startInterval(){ if (interval) clearInterval(interval); interval = setInterval(update, 16); } // ~60fps

  /* ========= Timer controls ========= */
  function startTimer(){
    if (running) return;
    running = true;
    const now = Date.now();
    if (!startWallTs) startWallTs = now;
    startTime = now - elapsed;
    startInterval();
    saveState();
    vibrate(12); playSound(1200, 80);
  }

  function finalizeActiveBreak(){
    if (onBreak){
      const now = Date.now();
      const dur = now - breakStartTs;
      sessionBreakMs += Math.max(0, dur);
      onBreak = false;
      if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
      breakDisplay.classList.remove('show');
      breakSummary.textContent = `Break taken: ${humanShort(sessionBreakMs)}`;
      breakSummary.classList.add('show');
    }
  }

  function stopTimer(){
    if (!running) return;
    finalizeActiveBreak();
    running = false;
    clearInterval(interval); interval = null;
    endWallTs = Date.now();
    saveState();
    saveBackdrop.classList.add('show');
    vibrate(16); playSound(600, 90);
  }

  function clearTimer(){
    if (running){
      alert('Stop the timer first to clear the display.');
      vibrate(8); playSound(400, 60);
      return;
    }
    elapsed = 0; startWallTs = null; endWallTs = null;
    timeDisplay.textContent = "00:00:00.00";
    moneyDisplay.textContent = "$0.00";
    if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
    onBreak = false; breakStartTs = null;
    sessionBreakMs = 0;
    breakDisplay.classList.remove('show');
    breakSummary.classList.remove('show');
    breakSummary.textContent = "";
    saveState();
    vibrate(10); playSound(500, 60);
  }

  function flashHistoryBtn(){ historyBtn.classList.add('flash'); setTimeout(()=>historyBtn.classList.remove('flash'), 1000); }

  function updateTotals(){
    const now = Date.now(), w0=startOfWeek(now), m0=startOfMonth(now);
    const weekSum = history.filter(h=>h.endTs>=w0).reduce((a,b)=>a+(b.amount||0),0);
    const monthSum = history.filter(h=>h.endTs>=m0).reduce((a,b)=>a+(b.amount||0),0);
    weekTotalEl.textContent = fmtMoney(weekSum);
    monthTotalEl.textContent = fmtMoney(monthSum);
  }

  /* ========= History render ========= */
  function humanShort(ms){
    const t = Math.max(0, ms|0);
    const h = Math.floor(t/3600000);
    const m = Math.floor((t%3600000)/60000);
    const s = Math.floor((t%60000)/1000);
    if (h) return `${h}h ${m}m`;
    if (m) return `${m}m ${s}s`;
    return `${s}s`;
  }

  function renderHistory(){
    historyList.innerHTML = "";
    history.forEach(item=>{
      const startStr = new Date(item.startTs).toLocaleString();
      const endStr = new Date(item.endTs).toLocaleString();
      const li = document.createElement('li');
      li.innerHTML = `
        <div>
          <div class="meta">Start: ${startStr} â€¢ End: ${endStr}${item.tag ? ` â€¢ #${item.tag}` : ''}</div>
          <div class="dur">Duration: ${formatMain(item.elapsedMs)}</div>
          ${item.breakMs ? `<div class="meta"><span class="break-highlight">Break</span>: ${humanShort(item.breakMs)}</div>` : ''}
          <div class="amt">${fmtMoney(item.amount)}</div>
          ${item.tag ? `<div class="tag">#${item.tag}</div>` : ''}
        </div>
        <div class="row-actions">
          <button class="btn-small btn-danger" data-del="${item.id}">Delete</button>
          <button class="btn-small" data-edit="${item.id}">Edit</button>
          <button class="btn-small btn-export" data-export="${item.id}">Export</button>
        </div>
      `;
      historyList.appendChild(li);
    });

    historyList.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick = ()=>{
        pendingDeleteId = btn.getAttribute('data-del');
        confirmBackdrop.classList.add('show');
      };
    });

    historyList.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-edit');
        const entry = history.find(h=>String(h.id)===String(id));
        if (!entry) return;
        editingId = entry.id;
        editStart.value = toLocalInput(entry.startTs);
        editEnd.value = toLocalInput(entry.endTs);
        editTag.value = entry.tag || '';
        editBackdrop.classList.add('show');
      };
    });

    historyList.querySelectorAll('[data-export]').forEach(btn=>{
      btn.onclick = ()=>{ exportBackdrop.classList.add('show'); };
    });
  }

  function saveHistory(){
    const rate = parseFloat(rateInput.value)||0;
    if (!startWallTs) startWallTs = Date.now() - elapsed;
    if (!endWallTs) endWallTs = Date.now();
    const durationMs = Math.max(0, endWallTs - startWallTs);

    if (durationMs > 0){
      const now = new Date(endWallTs);
      const entry = {
        id: now.getTime().toString()+Math.random().toString(36).slice(2,6),
        startTs: startWallTs,
        endTs: endWallTs,
        elapsedMs: durationMs,
        amount: +(rate * (durationMs/3600000)).toFixed(2),
        tag: (tagInput.value||'').trim(),
        breakMs: sessionBreakMs || 0
      };
      history.unshift(entry);
      saveHistoryStore();
      tagInput.value = '';
      renderHistory(); updateTotals(); flashHistoryBtn(); vibrate(20); playSound(900, 80);
    }

    // Reset session visuals
    saveBackdrop.classList.remove('show');
    elapsed = 0; startWallTs = null; endWallTs = null;
    sessionBreakMs = 0;
    if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
    onBreak = false; breakStartTs = null;
    breakDisplay.classList.remove('show');
    breakSummary.classList.remove('show');
    breakSummary.textContent = "";
    updateDisplays(0);
    saveState();
  }

  function applyEdit(){
    if (!editingId) return;
    const entry = history.find(h=>h.id===editingId);
    if (!entry) return;

    const s = editStart.value, e = editEnd.value;
    if (!s || !e) { alert('Provide both start and end.'); return; }
    const startTs = fromLocalInput(s), endTs = fromLocalInput(e);
    if (!(isFinite(startTs)&&isFinite(endTs)) || endTs < startTs){ alert('End must be after Start.'); return; }
    const rate = parseFloat(rateInput.value)||0;
    const dur = endTs - startTs;
    entry.startTs = startTs; entry.endTs = endTs; entry.elapsedMs = dur;
    entry.amount = +(rate * (dur/3600000)).toFixed(2);
    entry.tag = (editTag.value||'').trim();

    saveHistoryStore();
    editingId = null;
    editBackdrop.classList.remove('show');
    renderHistory(); updateTotals(); vibrate(15); playSound(800, 70);
  }

  /* ========= Break stopwatch ========= */
  function showBreak(){ breakDisplay.classList.add('show'); }
  function startBreakTicker(){
    if (breakTicker) clearInterval(breakTicker);
    breakDisplay.textContent = `Break: 00:00:00`;
    breakTicker = setInterval(()=>{
      const ms = Date.now() - breakStartTs;
      const h = Math.floor(ms/3600000), m = Math.floor((ms%3600000)/60000), s = Math.floor((ms%60000)/1000);
      breakDisplay.textContent = `Break: ${pad2(h)}:${pad2(m)}:${pad2(s)}`;
    }, 250);
  }

  /* ========= Goals screen ========= */
  let goalsRAF = null;
  function openGoals(){
    yearlyInput.value  = goals.yearly  ? String(goals.yearly)  : '';
    monthlyInput.value = goals.monthly ? String(goals.monthly) : '';
    weeklyInput.value  = goals.weekly  ? String(goals.weekly)  : '';
    dailyInput.value   = goals.daily   ? String(goals.daily)   : '';

    goalsPanel.classList.add('show');
    goalsPanel.setAttribute('aria-hidden','false');

    const tick = ()=>{
      renderGoalBars();
      goalsRAF = requestAnimationFrame(tick);
    };
    if (!goalsRAF) goalsRAF = requestAnimationFrame(tick);
  }
  function closeGoals(){
    goalsPanel.classList.remove('show');
    goalsPanel.setAttribute('aria-hidden','true');
    if (goalsRAF){ cancelAnimationFrame(goalsRAF); goalsRAF = null; }
  }
  function clampPct(n){ return Math.max(0, Math.min(100, n)); }
  function renderGoalBars(){
    const now = Date.now();
    const year0  = (new Date(new Date(now).getFullYear(),0,1)).getTime();
    const month0 = (new Date(new Date(now).getFullYear(),new Date(now).getMonth(),1)).getTime();
    const week0  = startOfWeek(now);
    const day0   = startOfDay(now);

    const yVal = sumRangeSince(year0);
    const mVal = sumRangeSince(month0);
    const wVal = sumRangeSince(week0);
    const dVal = sumRangeSince(day0);

    const yT = goals.yearly  || 0;
    const mT = goals.monthly || 0;
    const wT = goals.weekly  || 0;
    const dT = goals.daily   || 0;

    const yPct = yT ? clampPct((yVal / yT) * 100) : 0;
    const mPct = mT ? clampPct((mVal / mT) * 100) : 0;
    const wPct = wT ? clampPct((wVal / wT) * 100) : 0;
    const dPct = dT ? clampPct((dVal / dT) * 100) : 0;

    yearlyBar.style.width  = `${yPct}%`;  yearlyBar.dataset.pct  = String(Math.floor(yPct));
    monthlyBar.style.width = `${mPct}%`;  monthlyBar.dataset.pct = String(Math.floor(mPct));
    weeklyBar.style.width  = `${wPct}%`;  weeklyBar.dataset.pct  = String(Math.floor(wPct));
    dailyBar.style.width   = `${dPct}%`;  dailyBar.dataset.pct   = String(Math.floor(dPct));

    yearlyValues.textContent  = `${fmtMoney(yVal)} / ${fmtMoney(yT)} (${Math.floor(yPct)}%)`;
    monthlyValues.textContent = `${fmtMoney(mVal)} / ${fmtMoney(mT)} (${Math.floor(mPct)}%)`;
    weeklyValues.textContent  = `${fmtMoney(wVal)} / ${fmtMoney(wT)} (${Math.floor(wPct)}%)`;
    dailyValues.textContent   = `${fmtMoney(dVal)} / ${fmtMoney(dT)} (${Math.floor(dPct)}%)`;
  }

  /* ========= Stats ========= */
  const glowPlugin = {
    id:'glow',
    afterDatasetsDraw(chart, args, opts){
      const ctx = chart.ctx; ctx.save();
      chart.data.datasets.forEach((ds, i)=>{
        const meta = chart.getDatasetMeta(i);
        if (!meta.data) return;
        ctx.shadowColor = (ds.borderColor || 'rgba(255,255,255,.5)');
        ctx.shadowBlur = 16; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
        meta.data.forEach(pt=>{
          ctx.beginPath();
          ctx.arc(pt.x, pt.y, 3.5, 0, Math.PI*2);
          ctx.fillStyle = Array.isArray(ds.pointBackgroundColor) ? ds.pointBackgroundColor[0] : (ds.pointBackgroundColor || ds.backgroundColor || '#fff');
          ctx.fill();
        });
      });
      ctx.restore();
    }
  };
  Chart.register(glowPlugin);

  function gradient(ctx, area, from, to){
    const g = ctx.createLinearGradient(0, area.bottom, 0, area.top);
    g.addColorStop(0, from);
    g.addColorStop(1, to);
    return g;
  }

  function openStats(){ renderStats(); statsBackdrop.classList.add('show'); }
  function closeStats(){ statsBackdrop.classList.remove('show'); }
  statsBtn.onclick = openStats;
  statsClose.onclick = closeStats;
  statsBackdrop.addEventListener('click',(e)=>{ if (e.target===statsBackdrop) closeStats(); });

  function labelsFromDates(days){
    return days.map(ts=>["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(ts).getDay()]);
  }

  function renderStats(){
    const now = Date.now();
    const d0 = startOfDay(now), w0 = startOfWeek(now), m0 = startOfMonth(now);

    const todayFixed = sumEntriesBetween(d0, d0+86400000);
    const todayLive = currentSessionContributionSince(d0);
    const todayAmount = todayFixed.amount + todayLive.amount;

    const weekFixed = sumEntriesBetween(w0, w0 + 7*86400000);
    const weekLive = currentSessionContributionSince(w0);
    const weekAmount = weekFixed.amount + weekLive.amount;

    const mEnd = new Date(new Date(m0).getFullYear(), new Date(m0).getMonth()+1, 1).getTime();
    const monthFixed = sumEntriesBetween(m0, mEnd);
    const monthLive = currentSessionContributionSince(m0);
    const monthAmount = monthFixed.amount + monthLive.amount;

    todayEarned.textContent = fmtMoney(todayAmount);
    weekEarned.textContent  = fmtMoney(weekAmount);
    monthEarned.textContent = fmtMoney(monthAmount);

    const last7 = rangeDays(7);
    const earningsSeries = last7.map(d=>{
      const fx = sumEntriesBetween(d, d+86400000);
      const live = (d===startOfDay(now)) ? currentSessionContributionSince(d) : {amount:0,ms:0};
      return +(fx.amount + live.amount).toFixed(2);
    });
    const hoursSeries = last7.map(d=>{
      const fx = sumEntriesBetween(d, d+86400000);
      const live = (d===startOfDay(now)) ? currentSessionContributionSince(d) : {amount:0, ms:0};
      return +(((fx.ms + live.ms)/3600000).toFixed(2));
    });

    const total7 = earningsSeries.reduce((a,b)=>a+b,0);
    const hours7 = hoursSeries.reduce((a,b)=>a+b,0);
    const avgRate = hours7>0 ? (total7/hours7) : 0;
    const avgDay = total7/7;
    avgRateEl.textContent = fmtMoney(avgRate) + "/hr";
    avgDayEl.textContent = fmtMoney(avgDay);
    const trendUp = earningsSeries[6] >= earningsSeries[5];
    trendEl.textContent = trendUp ? "Uptrend" : "Slight dip";

    renderCharts(labelsFromDates(last7), earningsSeries, hoursSeries);
  }

  function renderCharts(labels, earnings, hours){
    const ectx = document.getElementById('earningsChart').getContext('2d');
    const hctx = document.getElementById('hoursChart').getContext('2d');

    if (earningsChart) earningsChart.destroy();
    if (hoursChart) hoursChart.destroy();

    const eArea = {top:0,bottom:170};
    const hArea = {top:0,bottom:170};

    const earningsBg = gradient(ectx, eArea, 'rgba(34,197,94,0.08)','rgba(34,197,94,0.45)');
    const earningsBar = 'rgba(34,197,94,0.9)';
    const hoursLine = '#60a5fa';
    const hoursFill = gradient(hctx, hArea, 'rgba(96,165,250,0.08)','rgba(96,165,250,0.35)');

    // Bar with per-column colors for extra flair
    const barColors = earnings.map((v,i)=> i===labels.length-1 ? 'rgba(34,197,94,1)' :
      ['#22c55e','#2dd4bf','#60a5fa','#a78bfa','#f59e0b','#ef4444','#22d3ee'][i%7]);

    earningsChart = new Chart(ectx, {
      type:'bar',
      data:{ labels, datasets:[{ 
        label:'Earnings ($)',
        data:earnings,
        backgroundColor: barColors,
        borderColor:'#0ea5e9',
        borderWidth:1.2,
        hoverBackgroundColor: barColors,
      }]},
      options:{
        responsive:true,
        plugins:{
          legend:{display:false},
          tooltip:{callbacks:{label:(ctx)=>`$${ctx.raw.toFixed(2)}`}}
        },
        scales:{
          x:{ticks:{color:'#e2e8f0'}},
          y:{ticks:{color:'#e2e8f0'}, beginAtZero:true}
        }
      },
      plugins:[{id:'panelGlow', afterDraw(c){ const ctx=c.ctx; ctx.save(); ctx.shadowColor='rgba(34,197,94,.35)'; ctx.shadowBlur=16; ctx.restore(); }},'glow']
    });

    hoursChart = new Chart(hctx, {
      type:'line',
      data:{ labels, datasets:[{
        label:'Hours Worked',
        data:hours,
        fill:true,
        borderColor:hoursLine,
        backgroundColor:hoursFill,
        tension:.35,
        pointRadius:3,
        pointHoverRadius:4,
        pointBackgroundColor:'#38bdf8'
      }]},
      options:{
        responsive:true,
        plugins:{
          legend:{display:false},
          tooltip:{callbacks:{label:(ctx)=>`${ctx.raw.toFixed(2)} h`}}
        },
        scales:{
          x:{ticks:{color:'#e2e8f0'}},
          y:{ticks:{color:'#e2e8f0'}, beginAtZero:true}
        }
      },
      plugins:['glow']
    });
  }

  /* ========= UI events ========= */
  document.getElementById('exportClose').onclick = ()=>{ exportBackdrop.classList.remove('show'); };

  startBtn.onclick = startTimer;
  stopBtn.onclick  = stopTimer;
  clearBtn.onclick = clearTimer;

  function toggleMenu(forceOpen){
    const willOpen = typeof forceOpen === 'boolean' ? forceOpen : !menuPanel.classList.contains('show');
    menuPanel.classList.toggle('show', willOpen);
    menuPanel.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
    menuBtn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
  }
  menuBtn.onclick = ()=> toggleMenu();
  closeMenu.onclick = ()=> toggleMenu(false);

  menuGoals.onclick    = ()=>{ toggleMenu(false); openGoals(); };
  menuSummary.onclick  = ()=>{ alert('Summary: coming next.'); };
  menuCalc.onclick     = ()=>{ alert('Calculator: coming next.'); };
  menuExpenses.onclick = ()=>{ alert('Expenses: coming next.'); };

  goalsClose.onclick = ()=> closeGoals();
  yearlySave.onclick = ()=>{ goals.yearly  = Math.max(0, +yearlyInput.value  || 0); saveGoals(); vibrate(8); };
  monthlySave.onclick= ()=>{ goals.monthly = Math.max(0, +monthlyInput.value || 0); saveGoals(); vibrate(8); };
  weeklySave.onclick = ()=>{ goals.weekly  = Math.max(0, +weeklyInput.value  || 0); saveGoals(); vibrate(8); };
  dailySave.onclick  = ()=>{ goals.daily   = Math.max(0, +dailyInput.value   || 0); saveGoals(); vibrate(8); };

  historyBtn.onclick = ()=>{
    updateTotals();
    historyPanel.classList.toggle('show');
    historyPanel.setAttribute('aria-hidden', historyPanel.classList.contains('show')?'false':'true');
  };
  closeHistory.onclick = ()=>{
    historyPanel.classList.remove('show');
    historyPanel.setAttribute('aria-hidden','true');
  };

  discardBtn.onclick = ()=>{ saveBackdrop.classList.remove('show'); vibrate(8); playSound(350, 50); };
  saveBtn.onclick = saveHistory;

  editCancel.onclick = ()=>{ editBackdrop.classList.remove('show'); editingId=null; };
  editSave.onclick = applyEdit;

  confirmNo.onclick = ()=>{ confirmBackdrop.classList.remove('show'); pendingDeleteId=null; };
  confirmYes.onclick = ()=>{
    if (pendingDeleteId){
      history = history.filter(h=>String(h.id)!==String(pendingDeleteId));
      saveHistoryStore();
      renderHistory(); updateTotals(); vibrate(15); playSound(500, 60);
    }
    pendingDeleteId = null;
    confirmBackdrop.classList.remove('show');
  };

  function openSettings(){ themeSelect.value=prefs.theme; soundToggle.checked=prefs.sound; hapticsToggle.checked=prefs.haptics; settingsBackdrop.classList.add('show'); }
  settingsBtn.onclick = openSettings;
  settingsClose.onclick = ()=>{ settingsBackdrop.classList.remove('show'); };
  settingsSave.onclick = ()=>{
    prefs.theme = themeSelect.value === 'light' ? 'light' : 'dark';
    prefs.sound = !!soundToggle.checked;
    prefs.haptics = !!hapticsToggle.checked;
    applyTheme(); savePrefs();
    settingsBackdrop.classList.remove('show');
    vibrate(8); playSound(700, 70);
  };
  settingsBackdrop.addEventListener('click', (e)=>{ if (e.target===settingsBackdrop) settingsBackdrop.classList.remove('show'); });

  startAtBtn.onclick = ()=>{ startAtInput.value = toLocalInput(Date.now()); startAtBackdrop.classList.add('show'); };
  startAtCancel.onclick = ()=>{ startAtBackdrop.classList.remove('show'); };
  startAtSave.onclick = ()=>{
    const val = startAtInput.value; if (!val){ alert('Pick a valid date/time.'); return; }
    const ts = fromLocalInput(val); const now = Date.now();
    if (ts <= now){
      startWallTs = ts; elapsed = now - ts; startTime = now - elapsed; running = true;
      startInterval(); vibrate(12); playSound(1200, 80);
      scheduledStartTs = null; saveState(); updateDisplays(elapsed);
    } else {
      scheduledStartTs = ts; startWallTs = ts; elapsed = 0; running = false;
      if (interval){ clearInterval(interval); interval=null; } updateDisplays(0);
      vibrate(8); playSound(900, 70); saveState();
    }
    startAtBackdrop.classList.remove('show');
  };

  stopAtBtn.onclick = ()=>{ stopAtInput.value = toLocalInput(Date.now()); stopAtBackdrop.classList.add('show'); };
  stopAtCancel.onclick = ()=>{ stopAtBackdrop.classList.remove('show'); };
  stopAtSave.onclick = ()=>{
    const val = stopAtInput.value; if (!val){ alert('Pick a valid date/time.'); return; }
    if (!startWallTs){ alert('No active session to stop.'); return; }
    const ts = fromLocalInput(val); const now = Date.now();
    if (ts <= now){
      finalizeActiveBreak();
      running = false; if (interval){ clearInterval(interval); interval=null; }
      endWallTs = ts; elapsed = Math.max(0, endWallTs - startWallTs); updateDisplays(elapsed);
      saveState(); saveBackdrop.classList.add('show'); vibrate(16); playSound(600, 90);
      scheduledStopTs = null;
    } else {
      scheduledStopTs = ts; vibrate(8); playSound(800, 70); saveState();
    }
    stopAtBackdrop.classList.remove('show');
  };

  takeBreakBtn.onclick = ()=>{
    if (onBreak) return;
    if (running){ running = false; if (interval){ clearInterval(interval); interval=null; } }
    onBreak = true;
    breakStartTs = Date.now();
    showBreak();
    startBreakTicker();
    breakSummary.classList.remove('show');
    breakSummary.textContent = "";
    saveState();
    vibrate(12); playSound(500, 90);
  };

  endBreakBtn.onclick = ()=>{
    if (!onBreak) return;
    const now = Date.now();
    const dur = now - breakStartTs;
    sessionBreakMs += Math.max(0, dur);
    onBreak = false;
    if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
    breakDisplay.classList.remove('show');
    breakSummary.textContent = `Break taken: ${humanShort(sessionBreakMs)}`;
    breakSummary.classList.add('show');
    // resume main timer
    startTime = now - elapsed;
    running = true;
    startInterval();
    saveState();
    vibrate(14); playSound(900, 80);
  };

  [startAtBackdrop, stopAtBackdrop, exportBackdrop, confirmBackdrop, editBackdrop, saveBackdrop].forEach(el=>{
    el.addEventListener('click', (e)=>{ if (e.target===el) el.classList.remove('show'); });
  });

  window.addEventListener('beforeunload', ()=>{ saveState(); savePrefs(); saveGoals(); });
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden){ saveState(); savePrefs(); saveGoals(); } });

  /* ========= Boot ========= */
  function saveState(){
    const state = {
      running, startWallTs, endWallTs, elapsed,
      rate: parseFloat(rateInput.value)||0,
      lastSaved: Date.now(),
      scheduledStartTs, scheduledStopTs,
      onBreak, breakStartTs, sessionBreakMs
    };
    try{ localStorage.setItem(STORE_KEY_STATE, JSON.stringify(state)); }catch{}
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORE_KEY_STATE);
      if (!raw) return;
      const s = JSON.parse(raw)||{};
      if (typeof s.rate === 'number') rateInput.value = String(s.rate);
      running = !!s.running;
      startWallTs = typeof s.startWallTs === 'number' ? s.startWallTs : null;
      endWallTs   = typeof s.endWallTs   === 'number' ? s.endWallTs   : null;
      elapsed     = typeof s.elapsed     === 'number' ? s.elapsed     : 0;
      scheduledStartTs = typeof s.scheduledStartTs === 'number' ? s.scheduledStartTs : null;
      scheduledStopTs  = typeof s.scheduledStopTs  === 'number' ? s.scheduledStopTs  : null;
      onBreak = !!s.onBreak;
      breakStartTs = typeof s.breakStartTs === 'number' ? s.breakStartTs : null;
      sessionBreakMs = typeof s.sessionBreakMs === 'number' ? s.sessionBreakMs : 0;

      if (onBreak && breakStartTs){ showBreak(); startBreakTicker(); }
      if (running && startWallTs){
        const now = Date.now();
        elapsed = Math.max(0, now - startWallTs);
        startTime = now - elapsed;
        update();
        startInterval();
      }else{
        updateDisplays(elapsed);
      }
    }catch(e){}
  }

  loadPrefs(); applyTheme();
  loadGoals();
  loadHistoryStore(); renderHistory(); updateTotals();
  loadState();
  setInterval(update, 16); // smooth 60fps updates for glow/liquid/metrics
</script>
</body>
</html>