<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Earnings Timer ‚Äî Persistent Background & Stop-Only</title>

<!-- üîÑ Force fresh load (loop-safe). Bump APP_VERSION each release. -->
<script>
(function(){
  const APP_VERSION = "8";            // ‚Üê bumped for this release
  const KEY = "ver_guard_seen";
  try {
    const url  = new URL(location.href);
    const curr = url.searchParams.get("v");
    const seen = sessionStorage.getItem(KEY);

    if (curr !== APP_VERSION) {
      if (seen !== APP_VERSION) {
        sessionStorage.setItem(KEY, APP_VERSION);
        url.searchParams.set("v", APP_VERSION);
        location.replace(url.toString());
      }
    }
  } catch (e) {}
})();
</script>

<style>
  /* ===== Base (Dark) ===== */
  body{font-family:Arial, sans-serif;background:#0f172a;color:#f8fafc;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;overflow:hidden}
  .top{position:absolute;top:20px;left:20px;display:flex;align-items:center;gap:8px}
  label{font-size:16px;font-weight:bold}
  .rate-wrap{display:flex;align-items:center;gap:8px;background:#374151;border:1px solid #4b5563;border-radius:8px;padding:6px 8px}
  input[type="number"]{width:110px;padding:6px 6px;border:none;outline:none;font-size:16px;text-align:right;background:transparent;color:#f8fafc}

  .timer{font-size:3rem;margin-bottom:6px}
  .amount{font-size:3rem;color:#22c55e;margin-bottom:16px}

  /* Break timer under main timer */
  .break-timer{font-size:1.1rem;color:#ef4444;margin-bottom:14px;display:none}
  .break-timer.show{display:block}
  .break-timer.paused{opacity:.85}

  .buttons{display:flex;gap:10px;margin-bottom:10px}
  .buttons2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:min(420px,90vw)}
  .buttons2 button{width:100%}

  button{background:#2563eb;border:none;color:#fff;padding:12px 24px;border-radius:10px;font-size:16px;cursor:pointer}
  #stop{background:#dc2626}
  #clear{background:#6b7280}

  /* History button (center bottom) */
  #historyBtn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;border:none;border-radius:30px;padding:12px 18px;font-size:16px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:background .2s, box-shadow .2s;z-index:25}
  #historyBtn:hover{background:#334155}
  #historyBtn.flash{background:#22c55e !important;box-shadow:0 0 0 6px rgba(34,197,94,.25)}
  .book{width:18px;height:18px;fill:#8b5a2b}

  /* Menu button (bottom-left) */
  #menuBtn{position:fixed;bottom:20px;left:20px;background:#1e293b;color:#fff;border:none;border-radius:30px;padding:12px 18px;font-size:16px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:background .2s, box-shadow .2s;z-index:25}
  #menuBtn:hover{background:#334155}
  .hamburger{width:18px;height:18px;display:inline-block}
  .hamburger svg{width:18px;height:18px}

  /* Menu side panel */
  #menuPanel{position:fixed;top:0;left:-75%;width:75%;height:100%;background:#1e293b;border-right:2px solid #334155;border-radius:0 12px 12px 0;transition:left .3s;display:flex;flex-direction:column;z-index:30}
  #menuPanel.show{left:0}
  #menuHeader{background:#0f172a;padding:12px 16px;border-radius:0 12px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #334155}
  #menuHeader .title{display:inline-flex;align-items:center;gap:8px}
  #menuHeader h3{margin:0;font-size:18px}
  #closeMenu{background:#dc2626;border:none;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px}
  #menuContent{padding:12px 16px;display:flex;flex-direction:column;gap:10px}
  .menu-item{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:10px 12px;font-size:14px;color:#e2e8f0;display:flex;justify-content:space-between;align-items:center}
  .menu-item button.link{background:#334155;border:1px solid #465368;color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer}

  /* Settings button inside menu (bottom-right) */
  #settingsBtn{position:absolute;right:20px;bottom:20px;background:#0ea5e9;border:1px solid #0891b2;color:#fff;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
  #settingsBtn:hover{background:#0284c7}

  /* History panel */
  #historyPanel{position:fixed;bottom:-75%;left:0;width:100%;max-height:75%;background:#1e293b;color:#f8fafc;border-top:2px solid #334155;border-radius:12px 12px 0 0;padding:0;transition:bottom .3s;display:flex;flex-direction:column;z-index:20}
  #historyPanel.show{bottom:0}
  #historyHeader{background:#0f172a;padding:12px 16px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #334155}
  #historyHeader .title{display:inline-flex;align-items:center;gap:8px}
  #historyHeader h3{margin:0;font-size:18px}
  #closeHistory{background:#dc2626;border:none;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px}

  #totals{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:12px 16px;border-bottom:1px solid #334155}
  .card{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:10px 12px}
  .card .k{font-size:12px;color:#94a3b8}
  .card .v{font-size:18px;font-weight:800;color:#22c55e}

  #historyList{list-style:none;padding:12px 16px;margin:0;overflow-y:auto;flex-grow:1}
  #historyList li{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:10px 12px;margin-bottom:10px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .meta{font-size:13px;color:#94a3b8;margin-bottom:6px}
  .dur{font-size:15px;font-weight:bold}
  .amt{color:#22c55e;font-weight:bold;font-size:16px}
  .tag{display:inline-block;margin-top:6px;font-size:12px;color:#eab308;background:#3b3a1b;border:1px solid #534f1a;padding:2px 6px;border-radius:999px}
  .row-actions{display:flex;flex-direction:column;gap:6px}
  .btn-small{background:#334155;border:1px solid #465368;color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer}
  .btn-danger{background:#7f1d1d;border-color:#b91c1c}

  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:40}
  .modal{background:#1e293b;border-radius:12px;padding:16px;width:340px}
  .modal h3{margin:0 0 10px;text-align:center}
  .field{display:flex;align-items:center;gap:8px;background:#0f172a;border:1px solid #334155;border-radius:8px;padding:8px 10px;margin-top:8px}
  .field input, .field select{flex:1;background:transparent;border:none;outline:none;color:#f8fafc}
  .actions{display:flex;gap:10px;margin-top:14px}
  .actions button{flex:1;padding:10px;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
  #discardBtn{background:#6b7280}
  #saveBtn{background:#22c55e}

  #editBackdrop .field label{font-size:12px;color:#94a3b8;width:80px}
  input[type="datetime-local"]{background:transparent;border:none;outline:none;color:#f8fafc}
  #editCancel{background:#6b7280}
  #editSave{background:#22c55e}

  /* Confirm delete modal */
  #confirmYes{background:#dc2626}
  #confirmNo{background:#6b7280}

  /* Settings modal */
  #settingsBackdrop .modal{width:360px}
  .setting-row{display:flex;align-items:center;justify-content:space-between;background:#0f172a;border:1px solid #334155;border-radius:10px;padding:10px 12px;margin-top:10px}
  .setting-row .label{font-size:14px;color:#e2e8f0}

  /* Toggle switch */
  .switch{position:relative;width:46px;height:26px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;inset:0;background:#6b7280;border-radius:999px;transition:.2s}
  .slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s}
  input:checked + .slider{background:#22c55e}
  input:checked + .slider:before{transform:translateX(20px)}

  /* ===== Light theme overrides ===== */
  body.light{background:#f8fafc;color:#0f172a}
  body.light .rate-wrap{background:#e5e7eb;border-color:#cbd5e1}
  body.light input[type="number"]{color:#0f172a}
  body.light #menuBtn, body.light #historyBtn{background:#e2e8f0;color:#0f172a}
  body.light #menuBtn:hover, body.light #historyBtn:hover{background:#cbd5e1}
  body.light #menuPanel{background:#ffffff;border-color:#e5e7eb}
  body.light #menuHeader{background:#f1f5f9;border-bottom-color:#e5e7eb}
  body.light #menuContent .menu-item{background:#f8fafc;border-color:#e5e7eb;color:#0f172a}
  body.light #historyPanel{background:#ffffff;border-top-color:#e5e7eb}
  body.light #historyHeader{background:#f1f5f9;border-bottom-color:#e5e7eb}
  body.light .card{background:#f8fafc;border-color:#e5e7eb}
  body.light #historyList li{background:#f8fafc;border-color:#e5e7eb}
  body.light .meta{color:#475569}
  body.light .tag{color:#854d0e;background:#fef3c7;border-color:#f59e0b}
  body.light .btn-small{background:#e2e8f0;border-color:#cbd5e1;color:#0f172a}
  body.light .modal{background:#ffffff}
  body.light .field{background:#f8fafc;border-color:#e5e7eb}
  body.light input[type="datetime-local"], body.light .field input, body.light .field select{color:#0f172a}
</style>
</head>
<body>

<div class="top">
  <span>Amount ($/hr):</span>
  <div class="rate-wrap">
    <input id="rate" type="number" value="25" step="0.01" min="0">
  </div>
</div>

<!-- Updated default to HH:MM:SS.ms -->
<div class="timer" id="timeDisplay">00:00:00.00</div>
<div class="amount" id="moneyDisplay">$0.00</div>

<!-- Red break timer -->
<div class="break-timer" id="breakDisplay">Break: 00:00</div>

<div class="buttons">
  <button id="start">Start</button>
  <button id="stop">Stop</button>
  <button id="clear">Clear</button>
</div>

<!-- New scheduling & break controls -->
<div class="buttons2">
  <button id="startAtBtn">Start At</button>
  <button id="stopAtBtn">Stop At</button>
  <button id="takeBreakBtn">Take Break</button>
  <button id="endBreakBtn">End Break</button>
</div>

<!-- Menu button (bottom-left) -->
<button id="menuBtn" aria-controls="menuPanel" aria-expanded="false">
  <span class="hamburger" aria-hidden="true">
    <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">
      <path d="M4 7h16"></path>
      <path d="M4 12h16"></path>
      <path d="M4 17h16"></path>
    </svg>
  </span>
  Menu
</button>

<!-- History button (bottom-center) -->
<button id="historyBtn" aria-live="polite">
  <svg class="book" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22V4.5zM6.5 4A.5.5 0 0 0 6 4.5v15a.5.5 0 0 0 .5.5H18V4H6.5z"/>
  </svg>
  History
</button>

<!-- Slide-in Menu Panel -->
<div id="menuPanel" aria-hidden="true" role="dialog" aria-labelledby="menuTitle">
  <div id="menuHeader">
    <div class="title">
      <span class="hamburger" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">
          <path d="M4 7h16"></path>
          <path d="M4 12h16"></path>
          <path d="M4 17h16"></path>
        </svg>
      </span>
      <h3 id="menuTitle">Menu</h3>
    </div>
    <button id="closeMenu">Close</button>
  </div>
  <div id="menuContent">
    <div class="menu-item">Settings shortcut: adjust your $/hr at the top-left. <button class="link" id="settingsRowBtn">Open Settings</button></div>
    <div class="menu-item">Tips: tap Stop to save, then tag your session. History totals update automatically.</div>
    <div class="menu-item">Coming soon: export, themes, and whatever else you dream up at 2 a.m.</div>
  </div>
  <button id="settingsBtn" aria-controls="settingsBackdrop">Settings</button>
</div>

<div id="historyPanel" aria-hidden="true">
  <div id="historyHeader">
    <div class="title">
      <svg class="book" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22V4.5zM6.5 4A.5.5 0 0 0 6 4.5v15a.5.5 0 0 0 .5.5H18V4H6.5z"/>
      </svg>
      <h3>History</h3>
    </div>
    <button id="closeHistory">Close</button>
  </div>

  <div id="totals">
    <div class="card"><div class="k">This week</div><div class="v" id="weekTotal">$0.00</div></div>
    <div class="card"><div class="k">This month</div><div class="v" id="monthTotal">$0.00</div></div>
  </div>

  <ul id="historyList"></ul>
</div>

<!-- Save Popup -->
<div id="saveBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="saveTitle">
  <div class="modal">
    <h3 id="saveTitle">Save this session?</h3>
    <div class="field">
      <span style="font-size:14px;color:#94a3b8;">Tag</span>
      <input id="tagInput" type="text" placeholder="Optional tag">
    </div>
    <div class="actions">
      <button id="discardBtn">No</button>
      <button id="saveBtn">Yes, Save</button>
    </div>
  </div>
</div>

<!-- Edit Popup -->
<div id="editBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="editTitle">
  <div class="modal">
    <h3 id="editTitle">Edit entry</h3>
    <div class="field"><label>Start</label><input id="editStart" type="datetime-local"></div>
    <div class="field"><label>End</label><input id="editEnd" type="datetime-local"></div>
    <div class="field">
      <span style="font-size:14px;color:#94a3b8;">Tag</span>
      <input id="editTag" type="text" placeholder="Edit tag">
    </div>
    <div class="actions">
      <button id="editCancel">Cancel</button>
      <button id="editSave">Save changes</button>
    </div>
  </div>
</div>

<!-- Confirm Delete Popup -->
<div id="confirmBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
  <div class="modal">
    <h3 id="confirmTitle">Delete this entry?</h3>
    <div class="actions">
      <button id="confirmNo">No</button>
      <button id="confirmYes">Yes</button>
    </div>
  </div>
</div>

<!-- Settings Popup -->
<div id="settingsBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal">
    <h3 id="settingsTitle">Settings</h3>

    <div class="setting-row">
      <div class="label">Theme</div>
      <div class="field" style="margin:0;">
        <select id="themeSelect" aria-label="Theme">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>
    </div>

    <div class="setting-row">
      <div class="label">Sound</div>
      <label class="switch">
        <input type="checkbox" id="soundToggle">
        <span class="slider"></span>
      </label>
    </div>

    <div class="setting-row">
      <div class="label">Haptic feedback</div>
      <label class="switch">
        <input type="checkbox" id="hapticsToggle">
        <span class="slider"></span>
      </label>
    </div>

    <div class="actions" style="margin-top:16px;">
      <button id="settingsClose" style="background:#6b7280;">Close</button>
      <button id="settingsSave" style="background:#22c55e;">Save</button>
    </div>
  </div>
</div>

<!-- Start At Popup -->
<div id="startAtBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="startAtTitle">
  <div class="modal">
    <h3 id="startAtTitle">Start At</h3>
    <div class="field"><label style="width:90px;color:#94a3b8">Date/Time</label><input id="startAtInput" type="datetime-local"></div>
    <div class="actions">
      <button id="startAtCancel" style="background:#6b7280;">Cancel</button>
      <button id="startAtSave" style="background:#22c55e;">Set</button>
    </div>
  </div>
</div>

<!-- Stop At Popup -->
<div id="stopAtBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="stopAtTitle">
  <div class="modal">
    <h3 id="stopAtTitle">Stop At</h3>
    <div class="field"><label style="width:90px;color:#94a3b8">Date/Time</label><input id="stopAtInput" type="datetime-local"></div>
    <div class="actions">
      <button id="stopAtCancel" style="background:#6b7280;">Cancel</button>
      <button id="stopAtSave" style="background:#22c55e;">Set</button>
    </div>
  </div>
</div>

<!-- Break Setup Popup -->
<div id="breakBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="breakTitle">
  <div class="modal">
    <h3 id="breakTitle">Take Break</h3>
    <div class="field"><label style="width:120px;color:#94a3b8">Minutes</label><input id="breakMinutes" type="number" min="1" step="1" value="15"></div>
    <div class="actions">
      <button id="breakCancel" style="background:#6b7280;">Cancel</button>
      <button id="breakStart" style="background:#22c55e;">Start Break</button>
    </div>
  </div>
</div>

<script>
  // ====== State ======
  let startTime = 0, elapsed = 0, running = false, interval = null;
  let startWallTs = null, endWallTs = null;
  // entries: { id, startTs, endTs, elapsedMs, amount, tag? }
  let history = [];
  let editingId = null;
  let pendingDeleteId = null;

  // Schedules
  let scheduledStartTs = null;
  let scheduledStopTs = null;

  // Breaks
  let onBreak = false;
  let breakEndTs = null;
  let breakInterval = null;
  let lastBreakSnapshot = null; // remaining ms when frozen

  // Preferences
  let prefs = { theme:'dark', sound:true, haptics:true };

  // Storage keys
  const STORE_KEY_STATE   = 'earningsTimer_state_v3';
  const STORE_KEY_HISTORY = 'earningsTimer_history_v2';
  const STORE_KEY_PREFS   = 'earningsTimer_prefs_v1';

  // ====== Elements ======
  const timeDisplay   = document.getElementById('timeDisplay');
  const moneyDisplay  = document.getElementById('moneyDisplay');
  const breakDisplay  = document.getElementById('breakDisplay');

  const rateInput = document.getElementById('rate');
  const startBtn = document.getElementById('start');
  const stopBtn  = document.getElementById('stop');
  const clearBtn = document.getElementById('clear');

  const startAtBtn = document.getElementById('startAtBtn');
  const stopAtBtn  = document.getElementById('stopAtBtn');
  const takeBreakBtn = document.getElementById('takeBreakBtn');
  const endBreakBtn  = document.getElementById('endBreakBtn');

  const historyBtn   = document.getElementById('historyBtn');
  const historyPanel = document.getElementById('historyPanel');
  const closeHistory = document.getElementById('closeHistory');
  const historyList  = document.getElementById('historyList');
  const weekTotalEl  = document.getElementById('weekTotal');
  const monthTotalEl = document.getElementById('monthTotal');

  const saveBackdrop  = document.getElementById('saveBackdrop');
  const discardBtn    = document.getElementById('discardBtn');
  const saveBtn       = document.getElementById('saveBtn');
  const tagInput      = document.getElementById('tagInput');

  const editBackdrop = document.getElementById('editBackdrop');
  const editStart = document.getElementById('editStart');
  const editEnd   = document.getElementById('editEnd');
  const editTag   = document.getElementById('editTag');
  const editCancel= document.getElementById('editCancel');
  const editSave  = document.getElementById('editSave');

  const confirmBackdrop = document.getElementById('confirmBackdrop');
  const confirmYes = document.getElementById('confirmYes');
  const confirmNo  = document.getElementById('confirmNo');

  // Menu & settings
  const menuBtn = document.getElementById('menuBtn');
  const menuPanel = document.getElementById('menuPanel');
  const closeMenu = document.getElementById('closeMenu');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsRowBtn = document.getElementById('settingsRowBtn');

  const settingsBackdrop = document.getElementById('settingsBackdrop');
  const settingsClose = document.getElementById('settingsClose');
  const settingsSave  = document.getElementById('settingsSave');
  const themeSelect = document.getElementById('themeSelect');
  const soundToggle = document.getElementById('soundToggle');
  const hapticsToggle = document.getElementById('hapticsToggle');

  // Start/Stop At modals
  const startAtBackdrop = document.getElementById('startAtBackdrop');
  const startAtInput    = document.getElementById('startAtInput');
  const startAtCancel   = document.getElementById('startAtCancel');
  const startAtSave     = document.getElementById('startAtSave');

  const stopAtBackdrop = document.getElementById('stopAtBackdrop');
  const stopAtInput    = document.getElementById('stopAtInput');
  const stopAtCancel   = document.getElementById('stopAtCancel');
  const stopAtSave     = document.getElementById('stopAtSave');

  // Break modal
  const breakBackdrop = document.getElementById('breakBackdrop');
  const breakMinutes  = document.getElementById('breakMinutes');
  const breakCancel   = document.getElementById('breakCancel');
  const breakStart    = document.getElementById('breakStart');

  // ====== Helpers ======
  function savePrefs(){
    try{ localStorage.setItem(STORE_KEY_PREFS, JSON.stringify(prefs)); }catch{}
  }
  function loadPrefs(){
    try{
      const raw = localStorage.getItem(STORE_KEY_PREFS);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (obj && typeof obj === 'object'){
        prefs.theme = obj.theme === 'light' ? 'light' : 'dark';
        prefs.sound = obj.sound !== false;
        prefs.haptics = obj.haptics !== false;
      }
    }catch{}
  }
  function applyTheme(){ document.body.classList.toggle('light', prefs.theme === 'light'); }
  function updateSettingsUI(){
    themeSelect.value = prefs.theme;
    soundToggle.checked = !!prefs.sound;
    hapticsToggle.checked = !!prefs.haptics;
  }

  function vibrate(ms=20){
    if (!prefs.haptics) return;
    if (navigator.vibrate) { try{ navigator.vibrate(ms); }catch{} }
  }

  // Tiny beep
  let audioCtx = null;
  function playSound(freq=880, durMs=70){
    if (!prefs.sound) return;
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = freq;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      const t = audioCtx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.15, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + durMs/1000);
      o.start();
      o.stop(t + durMs/1000 + 0.01);
    }catch{}
  }

  function fmtMoney(n){ return `$${n.toFixed(2)}`; }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function fmtMMSS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${pad2(m)}:${pad2(r)}`;
  }

  // ‚úÖ HH:MM:SS.ms
  function formatTime(ms){
    const totalMs = Math.max(0, ms|0);
    const hours = Math.floor(totalMs / 3600000);
    const minutes = Math.floor((totalMs % 3600000) / 60000);
    const seconds = Math.floor((totalMs % 60000) / 1000);
    const centis = Math.floor((totalMs % 1000) / 10);
    return `${pad2(hours)}:${pad2(minutes)}:${pad2(seconds)}.${pad2(centis)}`;
  }

  function toLocalInput(ts){
    const d = new Date(ts); const pad=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function fromLocalInput(val){ return new Date(val.replace(' ', 'T')).getTime(); }

  // ====== Persistence ======
  function saveState(){
    const state = {
      running,
      startWallTs,
      endWallTs,
      elapsed,
      rate: parseFloat(rateInput.value)||0,
      lastSaved: Date.now(),
      scheduledStartTs,
      scheduledStopTs,
      onBreak,
      breakEndTs,
      lastBreakSnapshot
    };
    try{ localStorage.setItem(STORE_KEY_STATE, JSON.stringify(state)); }catch{}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORE_KEY_STATE);
      if (!raw) return;
      const s = JSON.parse(raw);
      if (typeof s.rate === 'number') rateInput.value = String(s.rate);

      running = !!s.running;
      startWallTs = typeof s.startWallTs === 'number' ? s.startWallTs : null;
      endWallTs   = typeof s.endWallTs   === 'number' ? s.endWallTs   : null;
      elapsed     = typeof s.elapsed     === 'number' ? s.elapsed     : 0;

      scheduledStartTs = typeof s.scheduledStartTs === 'number' ? s.scheduledStartTs : null;
      scheduledStopTs  = typeof s.scheduledStopTs  === 'number' ? s.scheduledStopTs  : null;

      onBreak = !!s.onBreak;
      breakEndTs = typeof s.breakEndTs === 'number' ? s.breakEndTs : null;
      lastBreakSnapshot = typeof s.lastBreakSnapshot === 'number' ? s.lastBreakSnapshot : null;

      if (onBreak){
        showBreak();
        if (breakEndTs && Date.now() < breakEndTs){
          startBreakTicker();
        }else{
          freezeBreakDisplay();
        }
      }

      if (running && startWallTs){
        const now = Date.now();
        elapsed = Math.max(0, now - startWallTs);
        startTime = now - elapsed;
        update();
        startInterval();
      }else{
        updateDisplays(elapsed);
      }
    }catch(e){}
  }

  function saveHistoryStore(){
    try{ localStorage.setItem(STORE_KEY_HISTORY, JSON.stringify(history)); }catch(e){}
  }
  function loadHistoryStore(){
    try{
      const raw = localStorage.getItem(STORE_KEY_HISTORY);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) history = arr;
    }catch(e){}
  }

  // ====== Update Loop & UI ======
  function update(){
    const now = Date.now();

    // Handle scheduled start
    if (scheduledStartTs && now >= scheduledStartTs && !running && !onBreak){
      scheduledStartTs = null;
      startTimer();
    }

    // Handle scheduled stop
    if (scheduledStopTs && now >= scheduledStopTs && running){
      scheduledStopTs = null;
      // Force stop at the scheduled moment
      running = false;
      clearInterval(interval); interval = null;
      endWallTs = now; // now is >= scheduled
      saveState();
      saveBackdrop.style.display = "flex";
      vibrate(16); playSound(600, 90);
    }

    if (running){
      elapsed = now - startTime;
      endWallTs = now;
      updateDisplays(elapsed);
      if (now % 500 < 20) saveState();
    }
  }

  function updateDisplays(elapsedMs){
    const rate = parseFloat(rateInput.value)||0;
    const earned = (rate * (elapsedMs / 3600000));
    timeDisplay.textContent = formatTime(elapsedMs);
    moneyDisplay.textContent = fmtMoney(earned);
  }

  function startInterval(){
    if (interval) clearInterval(interval);
    interval = setInterval(update, 33); // ~30 FPS
  }

  function startTimer(){
    if (running) return;
    running = true;
    const now = Date.now();
    if (!startWallTs) startWallTs = now;
    startTime = now - elapsed; // respect any prior elapsed (e.g., set by Start At past)
    startInterval();
    saveState();
    vibrate(12);
    playSound(1200, 80);
  }

  function stopTimer(){
    if (!running) return;
    running = false;
    clearInterval(interval);
    interval = null;
    endWallTs = Date.now();
    saveState();
    saveBackdrop.style.display = "flex";
    vibrate(16);
    playSound(600, 90);
  }

  function clearTimer(){
    if (running){
      alert('Stop the timer first to clear the display.');
      vibrate(8);
      playSound(400, 60);
      return;
    }
    elapsed = 0; startWallTs = null; endWallTs = null;
    timeDisplay.textContent = "00:00:00.00";
    moneyDisplay.textContent = "$0.00";
    saveState();
    vibrate(10);
    playSound(500, 60);
  }

  function flashHistoryBtn(){
    historyBtn.classList.add('flash');
    setTimeout(()=>historyBtn.classList.remove('flash'), 1000);
  }

  function startOfWeek(ts){ const d=new Date(ts); const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x.getTime(); }
  function startOfMonth(ts){ const d=new Date(ts); const x=new Date(d.getFullYear(), d.getMonth(), 1); x.setHours(0,0,0,0); return x.getTime(); }
  function updateTotals(){
    const now = Date.now(), w0=startOfWeek(now), m0=startOfMonth(now);
    const weekSum = history.filter(h=>h.endTs>=w0).reduce((a,b)=>a+(b.amount||0),0);
    const monthSum = history.filter(h=>h.endTs>=m0).reduce((a,b)=>a+(b.amount||0),0);
    weekTotalEl.textContent = fmtMoney(weekSum);
    monthTotalEl.textContent = fmtMoney(monthSum);
  }

  function renderHistory(){
    historyList.innerHTML = "";
    history.forEach(item=>{
      const startStr = new Date(item.startTs).toLocaleString();
      const endStr = new Date(item.endTs).toLocaleString();
      const li = document.createElement('li');
      li.innerHTML = `
        <div>
          <div class="meta">Start: ${startStr} ‚Ä¢ End: ${endStr}${item.tag ? ` ‚Ä¢ #${item.tag}` : ''}</div>
          <div class="dur">Duration: ${formatTime(item.elapsedMs)}</div>
          <div class="amt">${fmtMoney(item.amount)}</div>
          ${item.tag ? `<div class="tag">#${item.tag}</div>` : ''}
        </div>
        <div class="row-actions">
          <button class="btn-small btn-danger" data-del="${item.id}">Delete</button>
          <button class="btn-small" data-edit="${item.id}">Edit</button>
        </div>
      `;
      historyList.appendChild(li);
    });

    historyList.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick = ()=>{
        pendingDeleteId = btn.getAttribute('data-del');
        confirmBackdrop.style.display = "flex";
      };
    });

    historyList.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-edit');
        const entry = history.find(h=>String(h.id)===String(id));
        if (!entry) return;
        editingId = entry.id;
        editStart.value = toLocalInput(entry.startTs);
        editEnd.value = toLocalInput(entry.endTs);
        editTag.value = entry.tag || '';
        editBackdrop.style.display = "flex";
      };
    });
  }

  function saveHistory(){
    const rate = parseFloat(rateInput.value)||0;
    if (!startWallTs) startWallTs = Date.now() - elapsed;
    if (!endWallTs) endWallTs = Date.now();
    const durationMs = Math.max(0, endWallTs - startWallTs);
    if (durationMs > 0){
      const now = new Date(endWallTs);
      const entry = {
        id: now.getTime().toString()+Math.random().toString(36).slice(2,6),
        startTs: startWallTs,
        endTs: endWallTs,
        elapsedMs: durationMs,
        amount: +(rate * (durationMs/3600000)).toFixed(2),
        tag: (tagInput.value||'').trim()
      };
      history.unshift(entry);
      saveHistoryStore();
      tagInput.value = '';
      renderHistory(); updateTotals(); flashHistoryBtn(); vibrate(20); playSound(900, 80);
    }
    saveBackdrop.style.display = "none";
    elapsed = 0; startWallTs = null; endWallTs = null;
    updateDisplays(0);
    saveState();
  }

  function applyEdit(){
    if (!editingId) return;
    const entry = history.find(h=>h.id===editingId);
    if (!entry) return;

    const s = editStart.value, e = editEnd.value;
    if (!s || !e) { alert('Provide both start and end.'); return; }
    const startTs = fromLocalInput(s), endTs = fromLocalInput(e);
    if (!(isFinite(startTs)&&isFinite(endTs)) || endTs < startTs){ alert('End must be after Start.'); return; }
    const rate = parseFloat(rateInput.value)||0;
    const dur = endTs - startTs;
    entry.startTs = startTs; entry.endTs = endTs; entry.elapsedMs = dur;
    entry.amount = +(rate * (dur/3600000)).toFixed(2);
    entry.tag = (editTag.value||'').trim();

    saveHistoryStore();
    editingId = null;
    editBackdrop.style.display = "none";
    renderHistory(); updateTotals(); vibrate(15); playSound(800, 70);
  }

  // ===== Break UI =====
  function showBreak(){
    breakDisplay.classList.add('show');
    breakDisplay.classList.remove('paused');
  }
  function hideBreak(){ // not used, but here if you ever want it
    breakDisplay.classList.remove('show');
    breakDisplay.classList.remove('paused');
  }
  function setBreakText(ms){ breakDisplay.textContent = `Break: ${fmtMMSS(ms)}`; }
  function startBreakTicker(){
    if (breakInterval) clearInterval(breakInterval);
    breakInterval = setInterval(()=>{
      const remaining = Math.max(0, breakEndTs - Date.now());
      setBreakText(remaining);
      if (remaining <= 0){
        clearInterval(breakInterval); breakInterval = null;
        vibrate(25); playSound(500, 120);
        // Stay on break until user presses End Break
        setBreakText(0);
      }
    }, 200);
  }
  function freezeBreakDisplay(){
    if (breakInterval){ clearInterval(breakInterval); breakInterval = null; }
    breakDisplay.classList.add('paused');
    const remaining = typeof lastBreakSnapshot === 'number'
      ? lastBreakSnapshot
      : Math.max(0, (breakEndTs||Date.now()) - Date.now());
    setBreakText(remaining);
  }

  // ====== Events ======
  startBtn.onclick = startTimer;
  stopBtn.onclick  = stopTimer;
  clearBtn.onclick = clearTimer;

  historyBtn.onclick = ()=>{
    updateTotals();
    historyPanel.classList.toggle('show');
    historyPanel.setAttribute('aria-hidden', historyPanel.classList.contains('show')?'false':'true');
  };
  closeHistory.onclick = ()=>{
    historyPanel.classList.remove('show');
    historyPanel.setAttribute('aria-hidden','true');
  };

  discardBtn.onclick = ()=>{ saveBackdrop.style.display = "none"; vibrate(8); playSound(350, 50); };
  saveBtn.onclick = saveHistory;

  editCancel.onclick = ()=>{ editBackdrop.style.display = "none"; editingId=null; };
  editSave.onclick = applyEdit;

  confirmNo.onclick = ()=>{ confirmBackdrop.style.display = "none"; pendingDeleteId=null; };
  confirmYes.onclick = ()=>{
    if (pendingDeleteId){
      history = history.filter(h=>String(h.id)!==String(pendingDeleteId));
      saveHistoryStore();
      renderHistory(); updateTotals(); vibrate(15); playSound(500, 60);
    }
    pendingDeleteId = null;
    confirmBackdrop.style.display = "none";
  };

  rateInput.addEventListener('change', ()=>{ saveState(); if (!running) updateDisplays(elapsed); });

  // Menu open/close
  function toggleMenu(forceOpen){
    const willOpen = typeof forceOpen === 'boolean' ? forceOpen : !menuPanel.classList.contains('show');
    menuPanel.classList.toggle('show', willOpen);
    menuPanel.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
    menuBtn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
  }
  menuBtn.onclick = ()=> toggleMenu();
  closeMenu.onclick = ()=> toggleMenu(false);

  // Settings
  function openSettings(){ updateSettingsUI(); settingsBackdrop.style.display='flex'; }
  settingsBtn.onclick = openSettings;
  if (settingsRowBtn) settingsRowBtn.onclick = openSettings;
  settingsClose.onclick = ()=>{ settingsBackdrop.style.display='none'; };
  settingsSave.onclick = ()=>{
    prefs.theme = themeSelect.value === 'light' ? 'light' : 'dark';
    prefs.sound = !!soundToggle.checked;
    prefs.haptics = !!hapticsToggle.checked;
    applyTheme();
    savePrefs();
    settingsBackdrop.style.display = 'none';
    vibrate(8);
    playSound(700, 70);
  };
  settingsBackdrop.addEventListener('click', (e)=>{ if (e.target===settingsBackdrop) settingsBackdrop.style.display='none'; });

  // Start At
  startAtBtn.onclick = ()=>{
    startAtInput.value = toLocalInput(Date.now());
    startAtBackdrop.style.display = 'flex';
  };
  startAtCancel.onclick = ()=>{ startAtBackdrop.style.display = 'none'; };
  startAtSave.onclick = ()=>{
    const val = startAtInput.value;
    if (!val){ alert('Pick a valid date/time.'); return; }
    const ts = fromLocalInput(val);
    const now = Date.now();

    if (ts <= now){
      // Backfill start
      startWallTs = ts;
      elapsed = now - ts;
      startTime = now - elapsed;
      running = true;
      startInterval();
      vibrate(12); playSound(1200, 80);
      scheduledStartTs = null;
      saveState();
      updateDisplays(elapsed);
    } else {
      // Schedule future start
      scheduledStartTs = ts;
      // Prepare so when it starts, elapsed begins from ts
      startWallTs = ts;
      elapsed = 0;
      running = false;
      if (interval){ clearInterval(interval); interval=null; }
      updateDisplays(0);
      vibrate(8); playSound(900, 70);
      saveState();
    }
    startAtBackdrop.style.display = 'none';
  };

  // Stop At
  stopAtBtn.onclick = ()=>{
    stopAtInput.value = toLocalInput(Date.now());
    stopAtBackdrop.style.display = 'flex';
  };
  stopAtCancel.onclick = ()=>{ stopAtBackdrop.style.display = 'none'; };
  stopAtSave.onclick = ()=>{
    const val = stopAtInput.value;
    if (!val){ alert('Pick a valid date/time.'); return; }
    if (!startWallTs){ alert('No active session to stop.'); return; }
    const ts = fromLocalInput(val);
    const now = Date.now();

    if (ts <= now){
      // Stop immediately at past time
      running = false;
      if (interval){ clearInterval(interval); interval=null; }
      endWallTs = ts;
      elapsed = Math.max(0, endWallTs - startWallTs);
      updateDisplays(elapsed);
      saveState();
      saveBackdrop.style.display = 'flex';
      vibrate(16); playSound(600, 90);
      scheduledStopTs = null;
    } else {
      // Schedule future stop while continuing to run
      scheduledStopTs = ts;
      vibrate(8); playSound(800, 70);
      saveState();
    }
    stopAtBackdrop.style.display = 'none';
  };

  // Break flow
  takeBreakBtn.onclick = ()=>{
    if (onBreak){ return; }
    breakMinutes.value = breakMinutes.value || 15;
    breakBackdrop.style.display = 'flex';
  };
  breakCancel.onclick = ()=>{ breakBackdrop.style.display='none'; };
  breakStart.onclick = ()=>{
    const mins = Math.max(1, parseInt(breakMinutes.value||'15',10));
    breakBackdrop.style.display = 'none';

    // Pause work timer
    if (running){
      running = false;
      if (interval){ clearInterval(interval); interval=null; }
      // keep elapsed as-is; when resuming we'll continue from here
    }

    onBreak = true;
    breakEndTs = Date.now() + mins*60*1000;
    lastBreakSnapshot = null;

    showBreak();
    setBreakText(breakEndTs - Date.now());
    startBreakTicker();

    vibrate(12); playSound(500, 90);
    saveState();
  };

  endBreakBtn.onclick = ()=>{
    if (!onBreak){
      // If not currently on break but you want the red timer to stay frozen, do nothing.
      return;
    }
    // Freeze the display with remaining time (or zero)
    lastBreakSnapshot = Math.max(0, (breakEndTs||Date.now()) - Date.now());
    freezeBreakDisplay();

    onBreak = false;
    // Resume main timer
    const now = Date.now();
    // When resuming, startTime should be now - elapsed
    startTime = now - elapsed;
    running = true;
    startInterval();

    vibrate(14); playSound(900, 80);
    saveState();
  };

  // Close backdrops on outside click
  [startAtBackdrop, stopAtBackdrop, breakBackdrop].forEach(el=>{
    el.addEventListener('click', (e)=>{ if (e.target===el) el.style.display='none'; });
  });

  window.addEventListener('beforeunload', ()=>{ saveState(); savePrefs(); });
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden){ saveState(); savePrefs(); } });

  // ====== Boot ======
  loadPrefs(); applyTheme();
  loadHistoryStore(); renderHistory(); updateTotals();
  loadState();

  // Kick a slow tick to catch schedules even if main timer is idle
  setInterval(()=>{
    // Trigger update even when not running so scheduled start/stop still fire
    update();
  }, 250);
</script>
</body>
</html>