<!DOCTYPE html>  
<html lang="en">  
<head>  
<meta charset="UTF-8" />  
<meta name="viewport" content="width=device-width,initial-scale=1" />  
<title>Earnings Timer ‚Äî Neon Build</title>  

<script>  
(function(){  
  const APP_VERSION = "36"; /* Pro UI Fixes + Intro */  
  const KEY = "ver_guard_seen";  
  try {  
    const url  = new URL(location.href);  
    const curr = url.searchParams.get("v");  
    const seen = sessionStorage.getItem(KEY);  
    if (curr !== APP_VERSION) {  
      if (seen !== APP_VERSION) {  
        sessionStorage.setItem(KEY, APP_VERSION);  
        url.searchParams.set("v", APP_VERSION);  
        location.replace(url.toString());  
      }  
    }  
  } catch (e) {}  
})();  
</script>  

<style>  
  :root{  
    --bg:#0b1020; --panel:#111931; --panel-2:#0f172a; --text:#f8fafc; --muted:#94a3b8;  
    --green:#22c55e; --green-2:#16a34a; --cyan:#22d3ee; --blue:#60a5fa; --purple:#a78bfa; --amber:#f59e0b; --red:#ef4444;  
    --glow-soft: 0 0 12px rgba(34,197,94,.35), 0 0 24px rgba(34,197,94,.2);  
    --glow-cyan: 0 0 12px rgba(34,211,238,.35), 0 0 24px rgba(34,211,238,.2);  
    --glow-purple: 0 0 12px rgba(167,139,250,.35), 0 0 24px rgba(167,139,250,.2);  
  }  

  *{box-sizing:border-box}  

  body{  
    font-family:Inter,system-ui,Arial,sans-serif;  
    background:radial-gradient(1200px 800px at 20% 10%, #0c1534 0%, #0b1020 40%, #070c19 100%);  
    color:var(--text);  
    display:flex;flex-direction:column;align-items:center;justify-content:center;  
    height:100vh;margin:0;overflow:hidden  
  }  
  
  /* --- NEW: Intro Splash Screen --- */
  #introOverlay {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: opacity 0.5s ease;
  }
  #introOverlay.hide {
    opacity: 0;
    pointer-events: none;
  }
  #introTitle {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--cyan);
    text-shadow: var(--glow-cyan);
    animation: pulse-text 1.5s ease-in-out infinite;
  }
  #introSubtitle {
    font-size: 1rem;
    color: var(--muted);
    margin-top: 8px;
    animation: pulse-text 1.5s ease-in-out infinite;
    animation-delay: 0.1s;
  }
  @keyframes pulse-text {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }


  .top{position:absolute;top:20px;left:20px;display:flex;align-items:center;gap:8px;z-index:5}  
  
  /* NEW: Top Right Buttons */
  .top-right-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 5;
  }
  .header-icon-btn {
    background: linear-gradient(180deg, #17233f, #0f1a35);
    color: #fff;
    border: 1px solid #2a3a64;
    border-radius: 50%; /* Circle */
    width: 44px;
    height: 44px;
    padding: 0;
    font-size: 14px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background .2s;
    position: relative; /* For the badge */
  }
  .header-icon-btn:hover { background: #1b2a52; }
  .header-icon-btn svg { width: 22px; height: 22px; stroke: #e5e7eb; }
  
  /* NEW: Inbox Badge */
  .header-icon-btn.has-new-message::after {
    content: '1';
    position: absolute;
    top: -2px;
    right: -2px;
    width: 20px;
    height: 20px;
    background: var(--red);
    border-radius: 50%;
    border: 2px solid var(--panel-2);
    box-shadow: 0 0 10px var(--red);
    font-size: 11px;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    animation: pulse-red 1.5s infinite;
  }
  
  @keyframes pulse-red {
    0% { transform: scale(0.9); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(0.9); opacity: 1; }
  }


  .rate-wrap{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#1a2547,#121a35);border:1px solid #334155;border-radius:10px;padding:6px 8px;box-shadow:0 6px 18px rgba(0,0,0,.25)}  

  input[type="number"]{width:110px;padding:6px 6px;border:none;outline:none;font-size:16px;text-align:right;background:transparent;color:var(--text)}  
  /* Make all number inputs consistent */
  input[type="number"], input[type="datetime-local"], input[type="date"], input[type="text"], select, textarea {
    width: 100%;
    background: #0b1224;
    border: 1px solid #2b3f6f;
    border-radius: 10px;
    padding: 10px 12px;
    color: var(--text);
    font-size: 15px;
  }
  input[type="number"]{text-align:left;width:auto;} /* Override for general */
  .rate-wrap input[type="number"]{width:110px; padding:6px 6px; font-size:16px; text-align:right; background:transparent; border:none;} /* Restore specificity */


  .timer{font-size:3rem;margin-bottom:6px;text-shadow:0 0 12px rgba(96,165,250,.25)}  
  .amount{font-size:3rem;color:var(--green);margin-bottom:10px;text-shadow:0 0 16px rgba(34,197,94,.4)}  

  .break-timer{font-size:1.15rem;color:var(--red);margin-bottom:8px;display:none;text-shadow:0 0 12px rgba(239,68,68,.4)}  
  .break-timer.show{display:block}  

  .break-summary{font-size:.95rem;color:#eab308;background:linear-gradient(180deg,#3b3a1b,#2b2a12);border:1px solid #534f1a;padding:6px 10px;border-radius:999px;display:none;margin-bottom:10px;box-shadow:0 8px 18px rgba(0,0,0,.25)}  
  .break-summary.show{display:inline-block}  

  .buttons{display:flex;gap:10px;margin-bottom:10px}  
  .buttons2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:min(460px,90vw)}  
  .buttons2 button{width:100%}  

  button{  
    background:linear-gradient(180deg,#27457e,#1a2f59);  
    border:1px solid #314978;  
    color:#fff;  
    padding:12px 24px;  
    border-radius:12px;  
    font-size:16px;  
    cursor:pointer;  
    box-shadow:0 8px 20px rgba(0,0,0,.25);  
    transition:transform .06s ease, box-shadow .12s ease, filter .12s ease  
  }  
  button:active{transform:translateY(1px);filter:brightness(.95)}  

  #start{  
    background:linear-gradient(180deg,#1f9b4a,#137a38);  
    border-color:#198e41;  
    box-shadow:0 10px 24px rgba(0,0,0,.25), 0 0 24px rgba(34,197,94,.25)  
  }  
  #stop{background:linear-gradient(180deg,#b91c1c,#7f1d1d);border-color:#991b1b}  
  #clear{background:linear-gradient(180deg,#475569,#334155);border-color:#475569}  

  #historyBtn,#statsBtn{  
    position:fixed;bottom:20px;  
    background:linear-gradient(180deg,#17233f,#0f1a35);  
    color:#fff;border:1px solid #2a3a64;border-radius:30px;  
    padding:12px 18px;font-size:16px;cursor:pointer;  
    display:inline-flex;align-items:center;gap:8px;  
    transition:background .2s, box-shadow .2s;  
    z-index:25  
  }  
  #historyBtn:hover,#statsBtn:hover{background:#1b2a52}  
  #historyBtn{left:50%;transform:translateX(-50%)}  
  #historyBtn.flash{background:#14532d !important;box-shadow:0 0 0 6px rgba(34,197,94,.25)}  

  .book{width:18px;height:18px;fill:#eab308}  

  #statsBtn{right:20px;box-shadow:var(--glow-soft)}  
  #statsBtn svg{width:20px;height:20px}  
  #statsBtn path{stroke:var(--green)}  

  #menuBtn{  
    position:fixed;bottom:20px;left:20px;  
    background:linear-gradient(180deg,#17233f,#0f1a35);  
    color:#fff;border:1px solid #2a3a64;border-radius:30px;  
    padding:12px 18px;font-size:16px;cursor:pointer;  
    display:inline-flex;align-items:center;gap:8px;  
    transition:background .2s, box-shadow .2s;  
    z-index:25  
  }  
  #menuBtn:hover{background:#1b2a52}  
  .hamburger svg{width:18px;height:18px}  

  #menuPanel{  
    position:fixed;top:0;left:-75%;width:75%;height:100%;max-width:420px;  
    background:linear-gradient(180deg,#0e172d,#0a1326);  
    border-right:2px solid #2b3f6f;border-radius:0 12px 12px 0;  
    transition:left .3s;display:flex;flex-direction:column;  
    z-index:30;box-shadow:0 0 40px rgba(0,0,0,.45)  
  }  
  #menuPanel.show{left:0}  

  #menuHeader{  
    background:#0b1224;padding:12px 16px;border-radius:0 12px 0 0;  
    display:flex;justify-content:space-between;align-items:center;  
    border-bottom:1px solid #2b3f6f  
  }  
  #menuHeader .title{display:inline-flex;align-items:center;gap:8px}  
  #menuHeader h3{margin:0;font-size:18px}  
  #closeMenu{background:#dc2626;border:none;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px}  

  #menuContent{padding:12px 16px;display:flex;flex-direction:column;gap:10px}  

  .menu-item{  
    background:linear-gradient(180deg,#0f1a34,#0b1224);  
    border:1px solid #2a3a64;border-radius:12px;  
    padding:12px 14px;font-size:15px;color:#e2e8f0;  
    display:flex;justify-content:space-between;align-items:center;  
    cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.25)  
  }  
  .menu-item .r{opacity:.7}  

  #settingsBtnFloat{  
    position:absolute;right:20px;bottom:20px;  
    background:#0ea5e9;border:1px solid #0284c7;color:#ffffff; /* FIXED */
    border-radius:10px;padding:10px 14px;font-size:14px;  
    cursor:pointer;box-shadow:var(--glow-cyan)  
  }  
  #settingsBtnFloat:hover{filter:brightness(1.05)}  

  #goalsPanel{  
    position:fixed;inset:0;  
    background:radial-gradient(1200px 800px at 80% 0%, #0e1b3a 0%, #0b1224 50%, #09101f 100%);  
    display:none;flex-direction:column;z-index:40  
  }  
  #goalsPanel.show{display:flex}  

  #goalsHeader{  
    display:flex;align-items:center;justify-content:space-between;  
    padding:12px 16px;border-bottom:1px solid #2b3f6f;background:#0b1224  
  }  
  #goalsHeader h3{margin:0;font-size:18px}  
  #goalsClose{background:#64748b;border:none;color:#fff;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer}  

  #goalsBody{  
    padding:12px 16px;display:flex;flex-direction:column;gap:16px;  
    overflow:auto;flex:1  
  }  

  .goal-card{  
    background:linear-gradient(180deg,#0f172a,#0c1426);  
    border:1px solid #2b3f6f;border-radius:14px;padding:14px;  
    box-shadow:0 12px 24px rgba(0,0,0,.28)  
  }  
  .goal-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}  
  .goal-title{font-weight:800}  
  .goal-values{font-size:13px;color:var(--muted)}  

  .goal-bar{  
    height:18px;background:linear-gradient(180deg,#0a1326,#0c1833);  
    border:1px solid #23345e;border-radius:999px;overflow:hidden;  
    position:relative;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04)  
  }  

  .goal-fill{  
    height:100%;width:0%;  
    background:  
      radial-gradient(18px 12px at 20% 50%, rgba(255,255,255,.25), rgba(255,255,255,0) 70%) repeat-x,  
      radial-gradient(18px 12px at 60% 50%, rgba(255,255,255,.2),  rgba(255,255,255,0) 70%) repeat-x,  
      linear-gradient(90deg,#0ea75a 0%,#22c55e 40%,#86efac 100%);  
    background-size: 60px 100%, 90px 100%, auto;  
    background-position: var(--wave1,0px) 0, var(--wave2,0px) 0, 0 0;  
    filter:saturate(1.25);  
    box-shadow:0 0 18px rgba(34,197,94,.55),0 0 38px rgba(34,197,94,.28),inset 0 0 10px rgba(255,255,255,.12);  
    transition:width .05s linear;position:relative;will-change:width,background-position;  
  }  

  .goal-fill::after{  
    content:"";position:absolute;top:-60%;bottom:-60%;width:100px;left:-100px;  
    background:radial-gradient(60px 140px at 0% 50%, rgba(255,255,255,.35), rgba(255,255,255,0) 70%);  
    mix-blend-mode:screen;filter:blur(.5px);animation:shimmer 1.6s ease-in-out infinite;  
  }  

  @keyframes shimmer{  
    0%{left:-100px;opacity:0}  
    30%{opacity:.5}  
    60%{left:20px;opacity:.25}  
    100%{left:140px;opacity:0}  
  }  

  .goal-fill[data-pct="90"],.goal-fill[data-pct="91"],.goal-fill[data-pct="92"],.goal-fill[data-pct="93"],.goal-fill[data-pct="94"],.goal-fill[data-pct="95"],.goal-fill[data-pct="96"],.goal-fill[data-pct="97"],.goal-fill[data-pct="98"],.goal-fill[data-pct="99"],.goal-fill[data-pct="100"]{  
    animation:nearDonePulse 1.2s ease-in-out infinite;  
  }  

  @keyframes nearDonePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.25)}}  

  .goal-edit{display:flex;align-items:center;gap:8px;margin-top:10px}  
  .goal-edit label{font-size:13px;color:var(--muted);flex-shrink:0;}  
  .goal-edit input{flex:1;min-width:50px;}  
  .goal-edit button{background:linear-gradient(180deg,#22c55e,#13a24a);border:1px solid #15803d;color:#05210f;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:var(--glow-soft)}  

  /* üìà Prediction Panel (uses Goals + History) */  
  #predictionPanel{  
    position:fixed;inset:0;  
    background:radial-gradient(1200px 800px at 10% 0%, #102044 0%, #050814 55%, #030712 100%);  
    display:none;flex-direction:column;z-index:41;  
  }  
  #predictionPanel.show{display:flex}  

  #predictionHeader{  
    display:flex;align-items:center;justify-content:space-between;  
    padding:12px 16px;border-bottom:1px solid #2b3f6f;background:#020617;  
  }  
  #predictionHeader h3{margin:0;font-size:18px}  
  #predictionClose{background:#64748b;border:none;color:#fff;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer}  

  /* NEW: Prediction Body (List Layout) */
  #predictionBody{  
    padding:12px 16px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:12px;  
  }  

  .pred-list-card {
    background: linear-gradient(180deg, #020617, #020617);
    border-radius: 14px;
    border: 1px solid #1f2937;
    padding: 14px;
    box-shadow: 0 14px 26px rgba(0, 0, 0, 0.55);
  }
  .pred-list-top {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
  }
  .pred-list-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: .06em;
  }
  .pred-list-dates {
    font-size: 11px;
    color: var(--cyan);
    opacity: 0.8;
  }
  .pred-list-value {
    font-size: 28px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 6px;
  }
  .pred-list-goal {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .pred-list-prev {
    font-size: 12px;
    color: var(--muted);
    border-top: 1px solid var(--border);
    padding-top: 8px;
  }
  .pred-list-prev.good { color: var(--green); }
  .pred-list-prev.bad { color: var(--red); }
  
  /* Payday Card specific styles */
  .pred-list-card.payday .pred-list-title {
    color: var(--amber);
  }
  .pred-list-card.payday .pred-list-value {
    color: var(--amber);
  }
  .pred-pay-inputs { 
    display:flex; 
    gap:10px; 
    margin: 10px 0; 
  }
  .pred-pay-inputs label { font-size: 13px; color: var(--muted); flex: 1; }
  .pred-pay-inputs input { width:100%; text-align:center; padding: 8px; font-size:14px; }
  .pred-pay-hint { font-size:12px; color:var(--muted); margin-top:4px; }
  
  .pred-footer {
    font-size: 12px;
    color: var(--muted);
    margin-top: 8px;
    text-align: center;
  }

  /* NEW: Calculator Panel */
  #calcPanel {
    position: fixed; inset: 0;
    background: radial-gradient(1200px 800px at 20% 0%, #0e1b3a 0%, #0b1224 50%, #09101f 100%);
    display: none; flex-direction: column; z-index: 42;
  }
  #calcPanel.show { display: flex; }
  #calcHeader {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; border-bottom: 1px solid #2b3f6f; background: #0b1224;
  }
  #calcHeader h3 { margin: 0; font-size: 18px; }
  #calcClose { background: #64748b; border: none; color: #fff; border-radius: 8px; padding: 8px 12px; font-size: 14px; cursor: pointer; }
  #calcBody {
    padding: 12px 16px; display: flex; flex-direction: column; gap: 16px;
    overflow: auto; flex: 1;
  }
  .calc-card {
    background: linear-gradient(180deg, #0f172a, #0c1426);
    border: 1px solid #2b3f6f; border-radius: 14px; padding: 14px;
    box-shadow: 0 12px 24px rgba(0, 0, 0, .28);
  }
  .calc-card h4 { margin: 0 0 4px; color: var(--cyan); }
  .calc-example { font-size: 12px; color: var(--muted); font-style: italic; margin-bottom: 10px; }
  .calc-field { display:flex; flex-direction:column; gap: 6px; margin-bottom: 12px; }
  .calc-field label { font-size: 13px; color: var(--muted); }
  .calc-field input { width: 100%; }
  .calc-result { font-size: 18px; font-weight: 800; color: var(--green); margin-top: 8px;}

  /* NEW: Heatmap Panel */
  #heatmapPanel {
    position: fixed; inset: 0;
    background: radial-gradient(1200px 800px at 20% 0%, #09101f 0%, #0b1224 50%, #0e1b3a 100%);
    display: none; flex-direction: column; z-index: 43;
  }
  #heatmapPanel.show { display: flex; }
  #heatmapHeader {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; border-bottom: 1px solid #2b3f6f; background: #0b1224;
  }
  #heatmapHeader h3 { margin: 0; font-size: 18px; }
  #heatmapClose { background: #64748b; border: none; color: #fff; border-radius: 8px; padding: 8px 12px; font-size: 14px; cursor: pointer; }
  
  /* NEW: Heatmap Body Layout */
  #heatmapBody {
    padding: 12px 16px; display: flex; flex-direction: column; gap: 10px;
    overflow: auto; flex: 1;
  }
  .heatmap-month-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px;
    background: var(--panel-2);
    border: 1px solid var(--border);
    border-radius: 10px;
  }
  .heatmap-month-nav h4 {
    margin: 0;
    font-size: 16px;
    color: var(--cyan);
    text-shadow: 0 0 8px var(--cyan);
  }
  .heatmap-month-nav button {
    background: #1e293b;
    border: 1px solid #334155;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 16px;
  }
  
  .heatmap-legend {
    display: flex; gap: 10px; align-items: center; justify-content: center; font-size: 12px; color: var(--muted);
    flex-shrink: 0;
    margin-top: 5px;
  }
  .legend-box { width: 12px; height: 12px; border-radius: 3px; }
  .legend-box.good { background: var(--green); box-shadow: 0 0 8px var(--green); }
  .legend-box.bad { background: var(--red); box-shadow: 0 0 8px var(--red); }
  .legend-box.neutral { background: var(--blue); box-shadow: 0 0 8px var(--blue); }

  .heatmap-grid-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    font-size: 12px;
    color: var(--muted);
    text-align: center;
    margin-top: 10px;
  }
  #heatmapGrid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }
  .heatmap-day {
    width: 100%;
    aspect-ratio: 1 / 1;
    min-height: 70px;
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 8px;
    font-size: 11px;
    color: var(--muted);
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
    padding: 5px;
    transition: all .2s;
    opacity: 0.6;
  }
  .heatmap-day.other-month {
    opacity: 0.3;
    background: var(--bg);
  }
  .heatmap-day.spacer {
    background: transparent;
    border: none;
    opacity: 0;
  }
  .heatmap-day.has-data {
    cursor: pointer;
    opacity: 1;
  }
  .heatmap-day.has-data:hover {
    transform: scale(1.05);
    border-color: var(--cyan);
    z-index: 10;
  }
  .heatmap-day-amt {
    font-size: 13px;
    font-weight: 700;
    margin-top: 4px;
  }

  .heatmap-day.good {
    background: #113423;
    border-color: #166534;
    color: #a7f3d0;
  }
  .heatmap-day.good .heatmap-day-amt { color: var(--green); }
  
  .heatmap-day.bad {
    background: #3f1212;
    border-color: #991b1b;
    color: #fecaca;
  }
  .heatmap-day.bad .heatmap-day-amt { color: var(--red); }

  .heatmap-day.neutral {
    background: #1e293b;
    border-color: #334155;
    color: #cbd5e1;
  }
  .heatmap-day.neutral .heatmap-day-amt { color: var(--blue); }
  

  #historyPanel{  
    position:fixed;bottom:-75%;left:0;width:100%;max-height:75%;  
    background:linear-gradient(180deg,#0f172a,#0b1224);  
    color:var(--text);border-top:2px solid #2b3f6f;border-radius:12px 12px 0 0;  
    padding:0;transition:bottom .3s;display:flex;flex-direction:column;  
    z-index:40;box-shadow:0 -8px 28px rgba(0,0,0,.4)  
  }  
  #historyPanel.show{bottom:0}  

  #historyHeader{  
    background:#0b1224;padding:12px 16px;border-radius:12px 12px 0 0;  
    display:flex;justify-content:space-between;align-items:center;  
    border-bottom:1px solid #2b3f6f  
  }  
  #historyHeader .title{display:inline-flex;align-items:center;gap:8px}  
  #historyHeader h3{margin:0;font-size:18px}  
  /* NEW: Export Button Style */
  .btn-export-header {
    background: #0ea5e9;
    border: 1px solid #0284c7;
    color: #ffffff; /* FIXED */
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--glow-cyan);
  }
  #closeHistory{background:#dc2626;border:none;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px}  

  #totals{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:12px 16px;border-bottom:1px solid #2b3f6f}  

  .card{background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #2b3f6f;border-radius:12px;padding:12px}  
  .card .k{font-size:12px;color:var(--muted)}  
  .card .v{font-size:18px;font-weight:800;color:var(--green);text-shadow:0 0 12px rgba(34,197,94,.35)}  

  #historyList{list-style:none;padding:12px 16px;margin:0;overflow-y:auto;flex-grow:1}  

  #historyList li{  
    background:linear-gradient(180deg,#0f172a,#101b36);  
    border:1px solid #2b3f6f;border-radius:12px;  
    padding:10px 12px;margin-bottom:10px;  
    display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;  
    box-shadow:0 8px 18px rgba(0,0,0,.25)  
  }  

  .meta{font-size:13px;color:var(--muted);margin-bottom:6px}  
  .dur{font-size:15px;font-weight:bold}  
  .amt{color:var(--green);font-weight:bold;font-size:16px;text-shadow:0 0 12px rgba(34,197,94,.35)}  
  .tag{display:inline-block;margin-top:6px;font-size:12px;color:#eab308;background:#3b3a1b;border:1px solid #534f1a;padding:2px 6px;border-radius:999px}  

  .row-actions{display:flex;flex-direction:column;gap:6px}  
  .btn-small{background:#1a274a;border:1px solid #2a3a64;color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer}  
  .btn-danger{background:#7f1d1d;border-color:#b91c1c}  

  .backdrop{  
    position:fixed;inset:0;background:rgba(0,0,0,.6);  
    display:none;align-items:center;justify-content:center;  
    z-index:50;opacity:0;transition:opacity .25s ease  
  }  
  .backdrop.show{display:flex;opacity:1}  

  .modal{  
    background:linear-gradient(180deg,#0f172a,#0c1427);  
    border:1px solid #2b3f6f;border-radius:14px;  
    padding:16px;width:340px;max-width:92vw;  
    box-shadow:0 12px 32px rgba(0,0,0,.45)  
  }  
  .modal h3{margin:0 0 10px;text-align:center}  

  .field{  
    display:flex;align-items:center;gap:8px;  
    background:#0b1224;border:1px solid #2b3f6f;  
    border-radius:10px;padding:8px 10px;margin-top:8px  
  }  
  .field input { border:none; padding:0; } /* override for modal fields */

  .actions{display:flex;gap:10px;margin-top:14px}  
  .actions button{flex:1;padding:10px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}  

  #discardBtn{background:#6b7280}  
  #saveBtn{background:#22c55e}  

  input[type="datetime-local"]{background:transparent;border:none;outline:none;color:var(--text)}  

  #editCancel{background:#6b7280}  
  #editSave{background:#22c55e}  

  #confirmYes{background:#dc2626}  
  #confirmNo{background:#6b7280}  

  .setting-row{  
    display:flex;align-items:center;justify-content:space-between;  
    background:#0f172a;border:1px solid #2b3f6f;  
    border-radius:10px;padding:10px 12px;margin-top:10px  
  }  
  .setting-row .field { margin:0; padding:0; background:none; border:none; }
  .setting-row .field select { padding: 8px 10px; }

  #statsBackdrop{  
    position:fixed;inset:0;background:rgba(3,6,14,.75);  
    display:none;align-items:center;justify-content:center;  
    z-index:50;opacity:0;transition:opacity .25s ease  
  }  
  #statsBackdrop.show{display:flex;opacity:1}  

  #statsModal{  
    background:linear-gradient(180deg,#0f172a,#0c1426);  
    border:1px solid #2b3f6f;border-radius:18px;  
    padding:20px;width:95%;max-width:820px;max-height:90vh;  
    overflow-y:auto;box-shadow:0 40px 80px rgba(0,0,0,.5)  
  }  

  .stats-header{  
    display:flex;justify-content:space-between;align-items:center;  
    border-bottom:1px solid #2b3f6f;padding-bottom:8px;margin-bottom:12px  
  }  
  .stats-header h3{margin:0;font-size:20px}  
  .stats-close{background:#22c55e;border:none;color:#0f172a;padding:8px 12px;border-radius:8px;font-weight:bold;cursor:pointer}  

  .stat-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}  

  .stat-card{  
    background:radial-gradient(200px 120px at 70% -20%, rgba(34,211,238,.18), transparent 60%),  
               linear-gradient(180deg,#0f172a,#0b1224);  
    border:1px solid #2b3f6f;border-radius:12px;padding:12px;  
    box-shadow:0 16px 28px rgba(0,0,0,.35)  
  }  

  .stat-title{font-size:13px;color:var(--muted)}  
  .stat-value{font-size:22px;font-weight:800;color:var(--green);text-shadow:0 0 16px rgba(34,197,94,.5)}  
  .stat-card:nth-child(2) .stat-value{color:var(--cyan);text-shadow:0 0 16px rgba(34,211,238,.45)}  
  .stat-card:nth-child(3) .stat-value{color:var(--purple);text-shadow:0 0 16px rgba(167,139,250,.45)}  

  canvas{  
    background:linear-gradient(180deg,#0b1224,#0f172a);  
    /* border:1px solid #2b3f6f; */ /* REMOVED FRAME */
    border: none;
    border-radius:14px;margin-bottom:14px;  
    box-shadow:0 12px 28px rgba(0,0,0,.35), 0 0 24px rgba(96,165,250,.15)  
  }  

  /* ‚¨áÔ∏è Repurposed from ‚ÄúBreak Analytics‚Äù ‚Üí Tag Effectiveness */  
  .break-section{margin:12px 0 16px 0;background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #2b3f6f;border-radius:14px;padding:14px;box-shadow:0 0 15px rgba(34,197,94,.2)}  
  .break-title{font-size:18px;font-weight:800;color:var(--green);text-align:center;margin:0 0 8px 0;text-shadow:0 0 12px rgba(34,197,94,.5);letter-spacing:.3px}  
  .break-summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;text-align:center}  
  .break-summary-grid div{background:#0f172a;border:1px solid #2b3f6f;border-radius:12px;padding:10px;box-shadow:0 0 10px rgba(34,197,94,.18)}  
  .break-summary-grid span{display:block;color:var(--green);font-weight:800;font-size:16px;margin-top:4px}  
  
  /* --- Analytics Info Text (FIXED) --- */
  .analytics-info p {
    color: var(--text);
    text-align: center;
    font-size: 14px;
    color: var(--muted);
  }
  .analytics-info span {
    color: var(--text);
    font-weight: 600;
  }

  /* --- NEW: Light Mode Overrides --- */
  body.light {
    --bg: #f3f4f6;
    --panel: #ffffff;
    --panel-2: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    background: #e5e7eb;
    color: var(--text);
  }
  body.light .rate-wrap { background: #e5e7eb; border-color: #d1d5db; }
  body.light button { background: #e0e7ff; border-color: #c7d2fe; color: #3730a3; }
  body.light button:active { filter: brightness(0.95); }
  body.light #start { background: #22c55e; border-color: #16a34a; color: #ffffff; }
  body.light #stop { background: #ef4444; border-color: #dc2626; color: #ffffff; }
  body.light #clear { background: #9ca3af; border-color: #6b7280; color: #ffffff; }
  body.light #historyBtn, body.light #statsBtn, body.light #menuBtn, body.light .header-icon-btn {
    background: var(--panel); border-color: #d1d5db; color: var(--text); box-shadow: 0 4px 12px rgba(0,0,0,.08);
  }
  body.light .hamburger svg path { stroke: var(--text); }
  body.light #statsBtn path { stroke: var(--green); }
  body.light .header-icon-btn svg { stroke: var(--text); }

  body.light #menuPanel { background: #f9fafb; border-right-color: #d1d5db; }
  body.light #menuHeader { background: #f3f4f6; border-bottom-color: #d1d5db; }
  body.light .menu-item { background: var(--panel); border-color: #e5e7eb; color: var(--text); } /* FIXED */
  body.light #settingsBtnFloat { background: #0ea5e9; border-color: #0284c7; color: #ffffff; } /* FIXED */
  body.light #goalsPanel, body.light #calcPanel, body.light #heatmapPanel { background: #f3f4f6; }
  body.light #goalsHeader, body.light #calcHeader, body.light #heatmapHeader { background: #ffffff; border-bottom-color: #e5e7eb; }
  body.light .goal-card, body.light .calc-card { background: var(--panel); border-color: #e5e7eb; }
  body.light input, body.light select, body.light textarea {
    background: #f9fafb; border-color: #d1d5db; color: var(--text);
  }
  body.light input[type="number"] { color: var(--text); }
  body.light .rate-wrap input[type="number"] { background: transparent; border: none; }
  body.light .goal-bar { background: #e5e7eb; border-color: #d1d5db; }
  body.light #predictionPanel { background: #f3f4f6; }
  body.light #predictionHeader { background: #ffffff; border-bottom-color: #e5e7eb; }
  body.light .pred-list-card { background: var(--panel); border-color: #e5e7eb; }
  body.light #historyPanel { background: #f9fafb; border-top-color: #d1d5db; }
  body.light #historyHeader { background: #ffffff; border-bottom-color: #e5e7eb; }
  body.light .card { background: var(--panel); border-color: #e5e7eb; }
  body.light #historyList li { background: var(--panel); border-color: #e5e7eb; }
  body.light .backdrop { background: rgba(17, 24, 39, 0.6); }
  body.light .modal { background: #ffffff; border-color: #e5e7eb; }
  body.light .field { background: #f3f4f6; border-color: #e5e7eb; }
  body.light .field input { background: transparent; border: none; color: var(--text); }
  body.light .setting-row { background: #f9fafb; border-color: #e5e7eb; }
  body.light #statsBackdrop { background: rgba(229, 231, 235, 0.75); }
  body.light #statsModal { background: #f9fafb; border-color: #e5e7eb; }
  body.light .stat-card { background: var(--panel); border-color: #e5e7eb; }
  body.light canvas { background: #ffffff; border-color: #e5e7eb; }
  body.light .break-section { background: var(--panel); border-color: #e5e7eb; }
  body.light .break-summary-grid div { background: #f3f4f6; border-color: #e5e7eb; }
  body.light #inboxBtn.has-new-message::after { border-color: var(--panel); }
  body.light #inboxPanel { background: #f9fafb; border-left-color: #d1d5db; }
  body.light #inboxHeader { background: #ffffff; border-bottom-color: #e5e7eb; }
  body.light .inbox-empty { background: var(--panel); border-color: #e5e7eb; }
  body.light .inbox-message { background: var(--panel); border-color: #e5e7eb; }
  body.light #expensesPanel { background: #f9fafb; border-left-color: #d1d5db; }
  body.light #expensesHeader { background: #ffffff; border-bottom-color: #e5e7eb; }
  body.light .xp-form, body.light .xp-card, body.light .xp-list, body.light .xp-chart { background: var(--panel); border-color: #e5e7eb; }
  body.light .xp-item { border-color: #e5e7eb; }
  body.light #billForecastPanel { background: #f3f4f6; border-left-color: #d1d5db; }
  body.light #billForecastHeader { background: #ffffff; border-bottom-color: #e5e7eb; }
  body.light .bf-section, body.light .bf-card { background: var(--panel); border-color: #e5e7eb; }
  
  body.light .heatmap-month-nav { background: var(--panel); border-color: #e5e7eb; }
  body.light .heatmap-month-nav button { background: #e5e7eb; border-color: #d1d5db; }
  
  body.light #heatmapGrid { background: transparent; border-color: transparent; }
  body.light .heatmap-month { background: #ffffff; border-color: #e5e7eb; }
  body.light .heatmap-day { background: #f3f4f6; border-color: #e5e7eb; color: var(--muted); }
  body.light .heatmap-day.good { background: #dcfce7; border-color: #bbf7d0; color: #15803d; }
  body.light .heatmap-day.bad { background: #fee2e2; border-color: #fecaca; color: #b91c1c; }
  body.light .heatmap-day.neutral { background: #dbeafe; border-color: #bfdbfe; color: #1e40af; }
  
  body.light .pred-status.good { color: #15803d; background: #dcfce7; border-color: #a7f3d0; }
  body.light .pred-status.bad { color: #991b1b; background: #fee2e2; border-color: #fca5a5; }
  body.light .pred-status.neutral { color: #6b7280; background: #f3f4f6; border-color: #e5e7eb; }
  
  body.light .btn-export-header { color: #ffffff; } /* FIXED */
  body.light #settingsBtnFloat { color: #ffffff; } /* FIXED */

  #inboxPanel{  
    position:fixed;top:0;right:-75%;width:75%;max-width:420px;height:100%;  
    background:linear-gradient(180deg,#0e172d,#0a1326);  
    border-left:2px solid #2b3f6f;border-radius:12px 0 0 12px;  
    transition:right .3s;display:flex;flex-direction:column;z-index:45  
  }  
  #inboxPanel.show{right:0}  

  #inboxHeader{  
    background:#0b1224;padding:12px 16px;border-bottom:1px solid #2b3f6f;  
    display:flex;justify-content:space-between;align-items:center;  
    border-radius:12px 0 0 0  
  }  
  #inboxHeader h3{margin:0;font-size:18px}  
  #closeInbox{background:#64748b;border:none;color:#fff;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer}  

  #inboxBody{flex:1;overflow:auto;padding:16px}  
  .inbox-empty{color:#94a3b8;font-size:15px;opacity:.9;text-align:center;background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #2b3f6f;border-radius:12px;padding:14px 18px;box-shadow:0 12px 24px rgba(0,0,0,.28)}  

  .inbox-message {
    background: linear-gradient(180deg,#0f1a34,#0b1224);
    border: 1px solid #2a3a64;
    border-radius: 12px;
    padding: 12px 14px;
    font-size: 14px;
    color: #e2e8f0;
    margin-bottom: 10px;
    box-shadow: 0 8px 18px rgba(0,0,0,.25);
  }
  .inbox-message .inbox-meta {
    font-size: 11px;
    color: var(--cyan);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: .05em;
  }
  .inbox-message.good .inbox-meta { color: var(--green); }
  .inbox-message.bad .inbox-meta { color: var(--red); }
  body.light .inbox-message { background: var(--panel); border-color: #e5e7eb; }

  #expensesPanel{  
    position:fixed;top:0;right:-75%;width:75%;max-width:520px;height:100%;  
    background:linear-gradient(180deg,#0e172d,#0a1326);  
    border-left:2px solid #2b3f6f;border-radius:12px 0 0 12px;  
    transition:right .3s;display:flex;flex-direction:column;  
    z-index:46;box-shadow:0 0 40px rgba(0,0,0,.45)  
  }  
  #expensesPanel.show{right:0}  

  #expensesHeader{  
    background:#0b1224;padding:12px 16px;border-bottom:1px solid #2b3f6f;  
    display:flex;align-items:center;justify-content:space-between;  
    border-radius:12px 0 0 0  
  }  
  #expensesHeader h3{margin:0;font-size:18px}  
  #closeExpenses{background:#64748b;border:none;color:#fff;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer}  

  #expensesBody{flex:1;overflow:auto;padding:12px 16px;display:flex;flex-direction:column;gap:12px}  

  .xp-form{  
    display:grid;grid-template-columns:1fr 1fr;gap:10px;  
    background:linear-gradient(180deg,#0f172a,#0b1224);  
    border:1px solid #2b3f6f;border-radius:12px;padding:12px  
  }  
  .xp-form .full{grid-column:1/-1}  
  .xp-form label{font-size:12px;color:var(--muted); margin-bottom: 4px; display:block;}  
  .xp-form input,.xp-form select,.xp-form textarea{width:100%;} /* removed redundant styles */
  .xp-form textarea{min-height:64px;resize:vertical}  

  .xp-actions{display:flex;gap:10px}  
  .xp-primary{background:#22c55e;border:1px solid #15803d;color:#05210f;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer;box-shadow:var(--glow-soft)}  
  .xp-secondary{background:#0ea5e9;border:1px solid #0284c7;border-radius:10px;padding:10px 12px;cursor:pointer;box-shadow:var(--glow-cyan)}  

  .xp-cards{display:flex;gap:10px}  
  .xp-card{flex:1;background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #2b3f6f;border-radius:12px;padding:12px}  
  .xp-card .k{font-size:12px;color:var(--muted)}  
  .xp-card .v{font-size:18px;font-weight:800}  

  .xp-list{background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #2b3f6f;border-radius:12px;padding:12px}  
  .xp-item{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border:1px solid #2b3f6f;border-radius:10px;margin-bottom:8px}  
  .xp-item .m{font-weight:700}  
  .xp-item .c{font-size:12px;color:var(--muted)}  
  .xp-item .amt{font-weight:800;color:#ef4444}  
  .xp-row-actions{display:flex;gap:6px}  

  .btn-mini{background:#1a274a;border:1px solid #2a3a64;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}  
  .btn-mini.danger{background:#7f1d1d;border-color:#b91c1c}  
  .btn-mini.edit{background:#15803d;border-color:#166534}  

  .xp-chart{background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #2b3f6f;border-radius:12px;padding:12px}  
  .xp-note{font-size:12px;color:var(--muted)}  

  .budget-ok{color:#22c55e}  
  .budget-warn{color:#f59e0b}  
  .budget-bad{color:#ef4444}  

  /* üí∏ Bill Forecast Panel (new) */  
  #billForecastPanel{  
    position:fixed;top:0;right:-75%;width:75%;max-width:520px;height:100%;  
    background:linear-gradient(180deg,#020617,#020617);  
    border-left:2px solid #1f2937;border-radius:12px 0 0 12px;  
    transition:right .3s;display:flex;flex-direction:column;  
    z-index:47;box-shadow:0 0 40px rgba(0,0,0,.55);  
  }  
  #billForecastPanel.show{right:0}  

  #billForecastHeader{  
    background:#020617;padding:12px 16px;border-bottom:1px solid #1f2937;  
    display:flex;align-items:center;justify-content:space-between;  
    border-radius:12px 0 0 0;  
  }  
  #billForecastHeader h3{margin:0;font-size:18px}  
  #billForecastClose{background:#64748b;border:none;color:#fff;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer}  

  #billForecastBody{  
    flex:1;overflow:auto;padding:12px 16px;display:flex;flex-direction:column;gap:12px;  
  }  

  .bf-section{  
    background:linear-gradient(180deg,#020617,#020617);  
    border-radius:12px;border:1px solid #1f2937;  
    padding:12px;  
  }  
  .bf-section h4{margin:0 0 6px;font-size:14px}  
  .bf-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}  
  .bf-row label{font-size:12px;color:var(--muted); display:flex; flex-direction:column; gap:4px; flex:1;}  
  .bf-row select,.bf-row input[type="number"]{  
    /* styles moved to global */
  }  
  .bf-toggle{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px;margin-top:6px}  

  .bf-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:4px}  

  .bf-card{  
    background:linear-gradient(180deg,#020617,#020617);  
    border:1px solid #1f2937;border-radius:12px;  
    padding:10px;  
  }  
  .bf-card .k{font-size:12px;color:var(--muted)}  
  .bf-card .v{font-size:18px;font-weight:800;margin-top:2px}  

  .bf-left.good{color:#4ade80}  
  .bf-left.bad{color:#fca5a5}  

  #bfHints{font-size:12px;color:var(--muted);padding-left:18px;margin:4px 0 0}  

  /* üîí Global blocker to disable background when any overlay is open */  
  #globalBlocker{position:fixed; inset:0; background:transparent; display:none; z-index:19; pointer-events:auto;}  
</style>  

</head>  
<body>  

<div id="introOverlay">
  <div id="introTitle">Smart Hours</div>
  <div id="introSubtitle">created by Dillan Swanepoel</div>
</div>

<div id="calcPanel" aria-hidden="true" role="dialog" aria-labelledby="calcTitle">  
  <div id="calcHeader">  
    <h3 id="calcTitle">Calculator</h3>  
    <button id="calcClose">Back</button>  
  </div>  
  <div id="calcBody">  
    <div class="calc-card">  
      <h4>Earnings for Hours</h4>
      <p class="calc-example">How much will I make if I work X hours?</p>
      <div class="calc-field" style="margin-top:10px;">  
        <label for="calcHours">Hours to Work</label>  
        <input id="calcHours" type="number" step="0.1" min="0" placeholder="e.g. 8">  
      </div>  
      <div class="calc-field">  
        <label for="calcRate1">Hourly Rate ($/hr)</label>  
        <input id="calcRate1" type="number" step="0.01" min="0" placeholder="e.g. 25">  
      </div>  
      <div class="calc-result" id="calcResult1">Total: $0.00</div>  
    </div>  
    <div class="calc-card">  
      <h4>Hours for Target</h4>
      <p class="calc-example">How many hours must I work to make $X?</p>
      <div class="calc-field" style="margin-top:10px;">  
        <label for="calcTarget">Target Amount ($)</label>  
        <input id="calcTarget" type="number" step="1" min="0" placeholder="e.g. 1000">  
      </div>  
      <div class="calc-field">  
        <label for="calcRate2">Hourly Rate ($/hr)</label>  
        <input id="calcRate2" type="number" step="0.01" min="0" placeholder="e.g. 25">  
      </div>  
      <div class="calc-result" id="calcResult2">Hours Needed: 0.00</div>  
    </div>
    <div class="calc-card">  
      <h4>Time to Reach Goal</h4>
      <p class="calc-example">How long to reach my goal at my current pace?</p>
      <div class="calc-field" style="margin-top:10px;">  
        <label for="calcGoalAmount">Goal Amount ($)</label>  
        <input id="calcGoalAmount" type="number" step="1" min="0" placeholder="e.g. 5000">  
      </div>  
      <div class="calc-field">  
        <label for="calcPace">Avg. Earnings per Day ($)</label>  
        <input id="calcPace" type="number" step="0.01" min="0" placeholder="Uses your 7-day avg.">  
      </div>  
      <div class="calc-result" id="calcResult3">Days Needed: 0</div>  
    </div>
  </div>  
</div>

<div id="heatmapPanel" aria-hidden="true" role="dialog" aria-labelledby="heatmapTitle">  
  <div id="heatmapHeader">  
    <h3 id="heatmapTitle">Calendar Heatmap</h3>  
    <button id="heatmapClose">Back</button>  
  </div>  
  <div id="heatmapBody">  
    <div class="heatmap-month-nav">
      <button id="heatmapPrev">‚Äπ</button>
      <h4 id="heatmapMonthTitle">November 2025</h4>
      <button id="heatmapNext">‚Ä∫</button>
    </div>
    <div class="heatmap-legend">
      <div class="legend-box bad"></div> Low Day
      <div class="legend-box neutral"></div> Avg Day
      <div class="legend-box good"></div> Good Day
    </div>
    <div class="heatmap-grid-header">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div id="heatmapGrid">
      </div>
  </div>  
</div>

<div id="globalBlocker" aria-hidden="true"></div>  

<div class="top">  
  <span>Amount ($/hr):</span>  
  <div class="rate-wrap"><input id="rate" type="number" value="25" step="0.01" min="0"></div>  
</div>  

<div class="top-right-controls">
  <button id="plusBtn" class="header-icon-btn" title="Coming Soon">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
    </svg>
  </button>
  <button id="inboxBtn" class="header-icon-btn" aria-controls="inboxPanel" aria-expanded="false" title="Inbox">  
    <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
    </svg>
  </button>
</div>

<div class="timer" id="timeDisplay">00:00:00.00</div>  
<div class="amount" id="moneyDisplay">$0.00</div>  
<div class="break-timer" id="breakDisplay">Break: 00:00:00</div>  
<div class="break-summary" id="breakSummary"></div>  

<div class="buttons">  
  <button id="start">Start</button>  
  <button id="stop">Stop</button>  
  <button id="clear">Clear</button>  
</div>  

<div class="buttons2">  
  <button id="startAtBtn">Start At</button>  
  <button id="stopAtBtn">Stop At</button>  
  <button id="takeBreakBtn">Take Break</button>  
  <button id="endBreakBtn">End Break</button>  
</div>  

<button id="menuBtn" aria-controls="menuPanel" aria-expanded="false">  
  <span class="hamburger" aria-hidden="true">  
    <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">  
      <path d="M4 7h16"></path><path d="M4 12h16"></path><path d="M4 17h16"></path>  
    </svg>  
  </span>  
  Menu  
</button>  

<button id="historyBtn" aria-live="polite">  
  <svg class="book" viewBox="0 0 24 24" aria-hidden="true">  
    <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22V4.5zM6.5 4A.5.5 0 0 0 6 4.5v15a.5.5 0 0 0 .5.5H18V4H6.5z"/>  
  </svg>  
  History  
</button>

<button id="statsBtn" title="View Stats">  
  <svg viewBox="0 0 24 24" aria-hidden="true">  
    <path d="M4 21h16M6 17V9m4 8V5m4 12v-7m4 7V3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>  
  </svg>  
  Stats  
</button>  

<div id="menuPanel" aria-hidden="true" role="dialog" aria-labelledby="menuTitle">  
  <div id="menuHeader">  
    <div class="title">  
      <span class="hamburger" aria-hidden="true">  
        <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">  
          <path d="M4 7h16"></path><path d="M4 12h16"></path><path d="M4 17h16"></path>  
        </svg>  
      </span>  
      <h3 id="menuTitle">Menu</h3>  
    </div>  
    <button id="closeMenu">Close</button>  
  </div>
<div id="menuContent">  
    <div class="menu-item" id="menuDashboard"><span>Dashboard</span><span class="r">‚Ä∫</span></div>
    <div class="menu-item" id="menuGoals"><span>Goals</span><span class="r">‚Ä∫</span></div>  
    <div class="menu-item" id="menuSummary"><span>Summary</span><span class="r">‚Ä∫</span></div>  
    <div class="menu-item" id="menuCalc"><span>Calculator</span><span class="r">‚Ä∫</span></div>  
    <div class="menu-item" id="menuExpenses"><span>Expenses</span><span class="r">‚Ä∫</span></div>  
    <div class="menu-item" id="menuPrediction"><span>Predictions</span><span class="r">‚Ä∫</span></div>  
    <div class="menu-item" id="menuBillForecast"><span>Bill Forecast</span><span class="r">‚Ä∫</span></div>  
    <div class="menu-item" id="menuHeatmap"><span>Calendar Heatmap</span><span class="r">‚Ä∫</span></div> 
    <div class="menu-item" id="menuWorkMap"><span>Work Map</span><span class="r">‚Ä∫</span></div> 
  </div>  

  <button id="settingsBtnFloat" aria-controls="settingsBackdrop">Settings</button>  
</div>  

<div id="goalsPanel" aria-hidden="true" role="dialog" aria-labelledby="goalsTitle">  
  <div id="goalsHeader">  
    <h3 id="goalsTitle">Goals</h3>  
    <button id="goalsClose">Back</button>  
  </div>  
  <div id="goalsBody">  
    <div class="goal-card">  
      <div class="goal-top"><div class="goal-title">Yearly Target</div><div class="goal-values" id="yearlyValues">$0 / $0 (0%)</div></div>  
      <div class="goal-bar"><div id="yearlyBar" class="goal-fill"></div></div>  
      <div class="goal-edit"><label for="yearlyInput">Set target</label><input id="yearlyInput" type="number" min="0" step="0.01" placeholder="e.g. 50000"><button id="yearlySave">Save</button></div>  
    </div>  
    <div class="goal-card">  
      <div class="goal-top"><div class="goal-title">Monthly Target</div><div class="goal-values" id="monthlyValues">$0 / $0 (0%)</div></div>  
      <div class="goal-bar"><div id="monthlyBar" class="goal-fill"></div></div>  
      <div class="goal-edit"><label for="monthlyInput">Set target</label><input id="monthlyInput" type="number" min="0" step="0.01" placeholder="e.g. 4000"><button id="monthlySave">Save</button></div>  
    </div>  
    <div class="goal-card">  
      <div class="goal-top"><div class="goal-title">Weekly Target</div><div class="goal-values" id="weeklyValues">$0 / $0 (0%)</div></div>  
      <div class="goal-bar"><div id="weeklyBar" class="goal-fill"></div></div>  
      <div class="goal-edit"><label for="weeklyInput">Set target</label><input id="weeklyInput" type="number" min="0" step="0.01" placeholder="e.g. 1000"><button id="weeklySave">Save</button></div>  
    </div>  
    <div class="goal-card">  
      <div class="goal-top"><div class="goal-title">Daily Target</div><div class="goal-values" id="dailyValues">$0 / $0 (0%)</div></div>  
      <div class="goal-bar"><div id="dailyBar" class="goal-fill"></div></div>  
      <div class="goal-edit"><label for="dailyInput">Set target</label><input id="dailyInput" type="number" min="0" step="0.01" placeholder="e.g. 200"><button id="dailySave">Save</button></div>  
    </div>  
  </div>  
</div>  

<div id="predictionPanel" aria-hidden="true" role="dialog" aria-labelledby="predictionTitle">  
  <div id="predictionHeader">  
    <h3 id="predictionTitle">Predictions</h3>  
    <button id="predictionClose">Back</button>  
  </div>  
  <div id="predictionBody">  
    
    <div class="pred-list-card">
      <div class="pred-list-top">
        <div class="pred-list-title">This Week</div>
        <div class="pred-list-dates" id="predWeeklyDates">Nov 10 ‚Äì Nov 16</div>
      </div>
      <div class="pred-list-value" id="predWeeklyValue">$0.00</div>
      <div class="pred-list-goal" id="predWeeklyGoal">Goal: $0.00</div>
      <div class="pred-list-prev" id="predWeeklyPrev">Previous Week: $0.00</div>
    </div>
    
    <div class="pred-list-card">
      <div class="pred-list-top">
        <div class="pred-list-title">This Bi-Weekly</div>
        <div class="pred-list-dates" id="predBiWeeklyDates">Nov 2 ‚Äì Nov 15</div>
      </div>
      <div class="pred-list-value" id="predBiWeeklyValue">$0.00</div>
      <div class="pred-list-goal" id="predBiWeeklyGoal">Goal: $0.00</div>
      <div class="pred-list-prev" id="predBiWeeklyPrev">Previous Period: $0.00</div>
    </div>
    
    <div class="pred-list-card">
      <div class="pred-list-top">
        <div class="pred-list-title">This Month</div>
        <div class="pred-list-dates" id="predMonthlyDates">Nov 1 ‚Äì Nov 30</div>
      </div>
      <div class="pred-list-value" id="predMonthlyValue">$0.00</div>
      <div class="pred-list-goal" id="predMonthlyGoal">Goal: $0.00</div>
      <div class="pred-list-prev" id="predMonthlyPrev">Previous Month: $0.00</div>
    </div>
    
    <div class="pred-list-card">
      <div class="pred-list-top">
        <div class="pred-list-title">This Year</div>
        <div class="pred-list-dates" id="predYearlyDates">Jan 1 ‚Äì Dec 31, 2025</div>
      </div>
      <div class="pred-list-value" id="predYearlyValue">$0.00</div>
      <div class="pred-list-goal" id="predYearlyGoal">Goal: $0.00</div>
      <div class="pred-list-prev" id="predYearlyPrev">Previous Year: $0.00</div>
    </div>
    
    <div class="pred-list-card payday">
      <div class="pred-list-top">
        <div class="pred-list-title">Next Payday</div>
        <div class="pred-list-dates" id="predPaydayDates">Nov 1 ‚Äì Nov 15</div>
      </div>
      <div class="pred-list-value" id="predPaydayValue">$0.00</div>
      <div class="pred-pay-inputs">
        <label>Day 1 <input type="number" id="payday1" min="1" max="31" step="1" placeholder="1"></label>
        <label>Day 2 <input type="number" id="payday2" min="1" max="31" step="1" placeholder="15"></label>
      </div>
      <div class="pred-pay-hint">Predictions reset after each payday.</div>
    </div>
    
  </div>  
</div>  

<div id="historyPanel" aria-hidden="true">  
  <div id="historyHeader">  
    <div class="title">  
      <svg class="book" viewBox="0 0 24 24" aria-hidden="true">  
        <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22V4.5zM6.5 4A.5.5 0 0 0 6 4.5v15a.5.5 0 0 0 .5.5H18V4H6.5z"/>  
      </svg>  
      <h3>History</h3>  
    </div>  
    <div style="display:flex; gap: 8px;">
      <button id="exportBtn" class="btn-export-header">Export</button>
      <button id="closeHistory">Close</button>
    </div>
  </div>  
  <div id="totals">  
    <div class="card"><div class="k">This week</div><div class="v" id="weekTotal">$0.00</div></div>  
    <div class="card"><div class="k">This month</div><div class="v" id="monthTotal">$0.00</div></div>  
  </div>  
  <ul id="historyList"></ul>  
</div>  

<div id="inboxPanel" aria-hidden="true" role="dialog" aria-labelledby="inboxTitle">  
  <div id="inboxHeader"><h3 id="inboxTitle">What's New</h3><button id="closeInbox">Close</button></div>  
  <div id="inboxBody">
    
    <div class="inbox-message good">
      <div class="inbox-meta">Update: Pro UI & Features</div>
      <div>This update adds major features and fixes!
        <ul style="margin: 8px 0 0 20px; padding: 0; list-style-type: disc;">
          <li><b>Prediction Overhaul:</b> This panel now tracks your *current* earnings for each period (Week, Month, etc.) and shows your previous period's total.</li>
          <li><b>Calendar Heatmap:</b> A new "one-month-at-a-time" view to spot earning patterns.</li>
          <li><b>Light Mode Fixed:</b> The light theme is now clean and fully usable.</li>
          <li><b>Pro Alerts:</b> "Coming Soon" alerts are now cleaner and match the UI.</li>
          <li><b>Export Fixed:</b> CSV export no longer crashes the app.</li>
        </ul>
      </div>
    </div>

  </div>  
</div>  

<div id="expensesPanel" aria-hidden="true" role="dialog" aria-labelledby="expensesTitle">  
  <div id="expensesHeader"><h3 id="expensesTitle">Expenses</h3><button id="closeExpenses">Close</button></div>  
  <div id="expensesBody">  
    <div class="xp-form">  
      <div><label for="xpAmount">Amount</label><input id="xpAmount" type="number" step="0.01" min="0" placeholder="e.g. 14.99"></div>  
      <div><label for="xpDate">Date</label><input id="xpDate" type="date"></div>  
      <div><label for="xpMerchant">Merchant</label><input id="xpMerchant" type="text" placeholder="e.g. McDonald's"></div>  
      <div><label for="xpCategory">Category</label>  
        <select id="xpCategory">  
          <option>Auto & Gas</option><option>Groceries</option><option>Restaurants</option><option>Bars & Nightlife</option>  
          <option>Subscriptions</option><option>Shopping</option><option>Bills & Utilities</option><option>Healthcare</option>  
          <option>Entertainment</option><option>Travel</option><option>Other</option>  
        </select>  
      </div>  
      <div class="full"><label for="xpNote">Note</label><textarea id="xpNote" placeholder="Optional note"></textarea></div>  
      <div class="full xp-actions">  
        <button id="xpAddBtn" class="xp-primary">Add Expense</button>  
        <button id="xpImportBtn" class="xp-secondary" title="Paste: 2025-10-08, Walmart, 42.11, Groceries">Quick Import</button>  
        <button id="xpClearMonthBtn" class="btn-mini danger" style="margin-left:auto">Clear Current Month</button>  
      </div>  
    </div>  
 <div class="xp-cards">  
      <div class="xp-card"><div class="k">This Month</div><div class="v" id="xpMonthSpend">$0.00</div><div class="xp-note" id="xpBudgetHint">No budget set</div></div>  
      <div class="xp-card"><div class="k">Top Category</div><div class="v" id="xpTopCat">‚Äî</div><div class="xp-note" id="xpTopCatShare">‚Äî</div></div>  
    </div>  

    <div class="xp-chart"><h4 style="margin:0 0 8px">Category Breakdown</h4><canvas id="xpPie" height="180"></canvas><div class="xp-note">Shows where the month‚Äôs money actually went.</div></div>  
    <div class="xp-chart"><h4 style="margin:0 0 8px">Monthly Trend</h4><canvas id="xpTrend" height="180"></canvas><div class="xp-note">Last 6 months.</div></div>  
    <div class="xp-list"><h4 style="margin:0 0 8px">Entries</h4><div id="xpList"></div></div>  
    <div class="xp-list"><h4 style="margin:0 0 8px">Suggestions</h4><ul id="xpSuggestions" style="margin:0;padding-left:18px"></ul></div>  
  </div>  
</div>  

<div id="billForecastPanel" aria-hidden="true" role="dialog" aria-labelledby="billForecastTitle">  
  <div id="billForecastHeader">  
    <h3 id="billForecastTitle">Bill Forecast</h3>  
    <button id="billForecastClose">Close</button>  
  </div>  
  <div id="billForecastBody">  
    <div class="bf-section">  
      <h4>Forecast settings</h4>  
      <div class="bf-row">  
        <label>Period  
          <select id="bfPeriod">  
            <option value="month">This month</option>  
            <option value="week">This week</option>
            <option value="biweek">Next 2 weeks</option>
            <option value="year">This year</option>  
          </select>  
        </label>  
        <label>Extra fixed bills  
          <input id="bfFixedBills" type="number" step="0.01" min="0" placeholder="e.g. 650.00" />  
        </label>  
      </div>  
      <label class="bf-toggle">  
        <input type="checkbox" id="bfIncludeExpenses" checked />  
        Include tracked Expenses data  
      </label>  
      <p style="font-size:11px;color:var(--muted);margin:6px 0 0;">  
        Uses your recent earnings pace + budgets to estimate how much you‚Äôll have left after bills.  
      </p>  
    </div>  

    <div class="bf-section">  
      <h4>Forecast</h4>  
      <div class="bf-cards">  
        <div class="bf-card">  
          <div class="k">Projected income</div>  
          <div class="v" id="bfIncome">$0.00</div>  
        </div>  
        <div class="bf-card">  
          <div class="k">Expected bills</div>  
          <div class="v" id="bfBills">$0.00</div>  
        </div>  
        <div class="bf-card">  
          <div class="k">Left after bills</div>  
          <div class="v" bf-left" id="bfLeft">$0.00</div>  
        </div>  
      </div>  
      <ul id="bfHints"></ul>  
    </div>  
  </div>  
</div>  

<div id="saveBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="saveTitle">  
  <div class="modal">  
    <h3 id="saveTitle">Save this session?</h3>  
    <div class="field"><span style="font-size:14px;color:#94a3b8;">Tag</span><input id="tagInput" type="text" placeholder="Optional tag"></div>  
    <div class="actions"><button id="discardBtn">No</button><button id="saveBtn">Yes, Save</button></div>  
  </div>  
</div>  

<div id="editBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="editTitle">  
  <div class="modal">  
    <h3 id="editTitle">Edit entry</h3>  
    <div class="field"><label style="width:80px;color:#94a3b8">Start</label><input id="editStart" type="datetime-local"></div>  
    <div class="field"><label style="width:80px;color:#94a3b8">End</label><input id="editEnd" type="datetime-local"></div>  
    <div class="field"><span style="font-size:14px;color:#94a3b8;">Tag</span><input id="editTag" type="text" placeholder="Edit tag"></div>  
    <div class="actions"><button id="editCancel">Cancel</button><button id="editSave">Save changes</button></div>  
  </div>  
</div>  

<div id="confirmBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">  
  <div class="modal"><h3 id="confirmTitle">Delete this entry?</h3><div class="actions"><button id="confirmNo">No</button><button id="confirmYes">Yes</button></div></div>  
</div>  

<div id="alertBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="alertTitle">  
  <div class="modal">
    <h3 id="alertTitle" style="color: var(--cyan);">Feature Coming Soon</h3>
    <p id="alertMessage" style="text-align: center; color: var(--muted); margin: 10px 0;">This feature is currently in development.</p>
    <div class="actions" style="margin-top: 14px;">
      <button id="alertClose" style="background:#22c55e; flex: 1;">OK</button>
    </div>
  </div>  
</div>

<div id="settingsBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">  
  <div class="modal">  
    <h3 id="settingsTitle">Settings</h3>  
    <div class="setting-row"><div>Theme</div><div class="field"><select id="themeSelect" aria-label="Theme"><option value="dark">Dark</option><option value="light">Light</option></select></div></div>  
    <div class="setting-row"><div>Sound</div><label class="switch"><input type="checkbox" id="soundToggle"><span class="slider"></span></label></div>  
    <div class="setting-row"><div>Haptic feedback</div><label class="switch"><input type="checkbox" id="hapticsToggle"><span class="slider"></span></label></div>  
    <div class="actions" style="margin-top:16px;"><button id="settingsClose" style="background:#6b7280;">Close</button><button id="settingsSave" style="background:#22c55e;">Save</button></div>  
  </div>  
</div>
<div id="startAtBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="startAtTitle">  
  <div class="modal">  
    <h3 id="startAtTitle">Start At</h3>  
    <div class="field">
      <label style="width:90px;color:#94a3b8">Date/Time</label>
      <input id="startAtInput" type="datetime-local">
    </div>  
    <div class="actions">
      <button id="startAtCancel" style="background:#6b7280;">Cancel</button>
      <button id="startAtSave" style="background:#22c55e;">Set</button>
    </div>  
  </div>  
</div>  

<div id="stopAtBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="stopAtTitle">  
  <div class="modal">  
    <h3 id="stopAtTitle">Stop At</h3>  
    <div class="field">
      <label style="width:90px;color:#94a3b8">Date/Time</label>
      <input id="stopAtInput" type="datetime-local">
    </div>  
    <div class="actions">
      <button id="stopAtCancel" style="background:#6b7280;">Cancel</button>
      <button id="stopAtSave" style="background:#22c55e;">Set</button>
    </div>  
  </div>  
</div>  

<div id="exportBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="exportTitle">  
  <div class="modal">
    <h3 id="exportTitle">Export Data</h3>
    <div class="setting-row" style="margin-top: 10px;">
      <div style="font-size: 14px;">Data</div>
      <div class="field" style="margin: 0; padding: 0;">
        <select id="exportDataType">
          <option value="history">Earnings History</option>
          <option value="expenses" disabled>Expenses (Coming Soon)</option>
        </select>
      </div>
    </div>
    <div class="setting-row">
      <div style="font-size: 14px;">Format</div>
      <div class="field" style="margin: 0; padding: 0;">
        <select id="exportFormat">
          <option value="csv">CSV (for Excel, Sheets)</option>
        </select>
      </div>
    </div>
    <p style="font-size: 12px; color: var(--muted); text-align: center; margin-top: 10px;">
      A file will be downloaded to your device.
    </p>
    <div class="actions" style="margin-top: 14px;">
      <button id="exportCancel" style="background:#6b7280;">Cancel</button>
      <button id="exportDownload" style="background:#22c55e;">Download</button>
    </div>
  </div>  
</div>  

<div id="statsBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="statsTitle">  
  <div id="statsModal">  
    <div class="stats-header">
      <h3 id="statsTitle">Performance Dashboard</h3>
      <button class="stats-close" id="statsClose">Close</button>
    </div>  

    <div class="stat-summary">  
      <div class="stat-card">
        <div class="stat-title">Today</div>
        <div class="stat-value" id="todayEarned">$0.00</div>
      </div>  
      <div class="stat-card">
        <div class="stat-title">This Week</div>
        <div class="stat-value" id="weekEarned">$0.00</div>
      </div>  
      <div class="stat-card">
        <div class="stat-title">This Month</div>
        <div class="stat-value" id="monthEarned">$0.00</div>
      </div>  
    </div>  

    <canvas id="earningsChart" height="170"></canvas>  
    <canvas id="hoursChart" height="170"></canvas>  

    <div class="break-section">  
      <p class="break-title">Tag Effectiveness (7d)</p>  
      <canvas id="breakChart" height="200"></canvas>  
      <div class="break-summary-grid" style="margin-top:12px;text-align:center;">  
        <div>Top Tag<span id="topTag" style="display:block;margin-top:4px;">‚Äî</span></div>  
        <div>Unique Tags<span id="tagCount" style="display:block;margin-top:4px;">0</span></div>  
        <div>Top Share<span id="topShare" style="display:block;margin-top:4px;">0%</span></div>  
      </div>  
    </div>  

    <div class="analytics-info">  
      <p>Average hourly rate: <span id="avgRate">$0/hr</span></p>  
      <p>Average daily earnings (7d): <span id="avgDay">$0</span></p>  
      <p>Trend insight: <span id="trend">Stable</span></p>  
    </div>  
  </div>  
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>  

<script>  
  /* ========= State ========= */  
  let startTime = 0, elapsed = 0, running = false, interval = null;  
  let startWallTs = null, endWallTs = null;  

  let history = [];  
  let editingId = null;  
  let pendingDeleteId = null;  

  let scheduledStartTs = null;  
  let scheduledStopTs = null;  

  let onBreak = false;  
  let breakStartTs = null;  
  let breakTicker = null;  
  let sessionBreakMs = 0;  

  let prefs = { theme:'dark', sound:true, haptics:true, payday1: 1, payday2: 15 };  
  let goals = { yearly:0, monthly:0, weekly:0, daily:0 };  
  
  let heatmapState = {
    currentDate: new Date() // NEW: For heatmap navigation
  };

  let expenses = [];  
  let budgets = {  
    'Groceries': 600, 'Restaurants': 300, 'Bars & Nightlife': 150,  
    'Subscriptions': 80, 'Shopping': 250, 'Bills & Utilities': 400,  
    'Auto & Gas': 220, 'Healthcare': 120, 'Entertainment': 120,  
    'Travel': 0, 'Other': 100  
  };  

  /* VITAL: Do not change these keys. This ensures user data is preserved. */
  const STORE_KEY_STATE     = 'earningsTimer_state_v7';  
  const STORE_KEY_HISTORY   = 'earningsTimer_history_v2';  
  const STORE_KEY_PREFS     = 'earningsTimer_prefs_v1';  
  const STORE_KEY_GOALS     = 'earningsTimer_goals_v1';  
  const STORE_KEY_EXPENSES  = 'earningsTimer_expenses_v1';  
  const STORE_KEY_BUDGETS   = 'earningsTimer_budgets_v1';  
  const STORE_KEY_UPDATE_SEEN = 'earningsTimer_update_v35_seen'; // NEW: For update notification

  /* ========= Elements ========= */  
  const timeDisplay   = document.getElementById('timeDisplay');  
  const moneyDisplay  = document.getElementById('moneyDisplay');  
  const breakDisplay  = document.getElementById('breakDisplay');  
  const breakSummary  = document.getElementById('breakSummary');  

  const rateInput = document.getElementById('rate');  
  const startBtn = document.getElementById('start');  
  const stopBtn  = document.getElementById('stop');  
  const clearBtn = document.getElementById('clear');  

  const startAtBtn = document.getElementById('startAtBtn');  
  const stopAtBtn  = document.getElementById('stopAtBtn');  
  const takeBreakBtn = document.getElementById('takeBreakBtn');  
  const endBreakBtn  = document.getElementById('endBreakBtn');  

  const historyBtn   = document.getElementById('historyBtn');  
  const historyPanel = document.getElementById('historyPanel');  
  const closeHistory = document.getElementById('closeHistory');  
  const historyList  = document.getElementById('historyList');  
  const weekTotalEl  = document.getElementById('weekTotal');  
  const monthTotalEl = document.getElementById('monthTotal');  
  const exportBtn    = document.getElementById('exportBtn'); // NEW

  const saveBackdrop  = document.getElementById('saveBackdrop');  
  const discardBtn    = document.getElementById('discardBtn');  
  const saveBtn       = document.getElementById('saveBtn');  
  const tagInput      = document.getElementById('tagInput');  

  const editBackdrop = document.getElementById('editBackdrop');  
  const editStart = document.getElementById('editStart');  
  const editEnd   = document.getElementById('editEnd');  
  const editTag   = document.getElementById('editTag');  
  const editCancel= document.getElementById('editCancel');  
  const editSave  = document.getElementById('editSave');  

  const confirmBackdrop = document.getElementById('confirmBackdrop');  
  const confirmYes = document.getElementById('confirmYes');  
  const confirmNo  = document.getElementById('confirmNo');  
  
  const alertBackdrop = document.getElementById('alertBackdrop');
  const alertClose = document.getElementById('alertClose');

  const menuBtn = document.getElementById('menuBtn');  
  const menuPanel = document.getElementById('menuPanel');  
  const closeMenu = document.getElementById('closeMenu');  
  const settingsBtnFloat = document.getElementById('settingsBtnFloat');  
  
  const menuDashboard    = document.getElementById('menuDashboard');
  const menuGoals        = document.getElementById('menuGoals');  
  const menuSummary      = document.getElementById('menuSummary');  
  const menuCalc         = document.getElementById('menuCalc');  
  const menuExpenses     = document.getElementById('menuExpenses');  
  const menuPrediction   = document.getElementById('menuPrediction');  
  const menuBillForecast = document.getElementById('menuBillForecast');  
  const menuHeatmap      = document.getElementById('menuHeatmap'); 
  const menuWorkMap      = document.getElementById('menuWorkMap'); 

  const calcPanel = document.getElementById('calcPanel');
  const calcClose = document.getElementById('calcClose');
  const calcHours = document.getElementById('calcHours');
  const calcRate1 = document.getElementById('calcRate1');
  const calcResult1 = document.getElementById('calcResult1');
  const calcTarget = document.getElementById('calcTarget');
  const calcRate2 = document.getElementById('calcRate2');
  const calcResult2 = document.getElementById('calcResult2');
  const calcGoalAmount = document.getElementById('calcGoalAmount');
  const calcPace = document.getElementById('calcPace');
  const calcResult3 = document.getElementById('calcResult3');
  
  // NEW Heatmap Elements
  const heatmapPanel = document.getElementById('heatmapPanel');
  const heatmapClose = document.getElementById('heatmapClose');
  const heatmapGrid  = document.getElementById('heatmapGrid');
  const heatmapMonthTitle = document.getElementById('heatmapMonthTitle');
  const heatmapPrev = document.getElementById('heatmapPrev');
  const heatmapNext = document.getElementById('heatmapNext');

  const settingsBackdrop = document.getElementById('settingsBackdrop');  
  const settingsClose = document.getElementById('settingsClose');  
  const settingsSave  = document.getElementById('settingsSave');  
  const themeSelect = document.getElementById('themeSelect');  
  const soundToggle = document.getElementById('soundToggle');  
  const hapticsToggle = document.getElementById('hapticsToggle');  

  const startAtBackdrop = document.getElementById('startAtBackdrop');  
  const startAtInput    = document.getElementById('startAtInput');  
  const startAtCancel   = document.getElementById('startAtCancel');  
  const startAtSave     = document.getElementById('startAtSave');  

  const stopAtBackdrop = document.getElementById('stopAtBackdrop');  
  const stopAtInput    = document.getElementById('stopAtInput');  
  const stopAtCancel   = document.getElementById('stopAtCancel');  
  const stopAtSave     = document.getElementById('stopAtSave');  

  const exportBackdrop = document.getElementById('exportBackdrop');  
  const exportCancel = document.getElementById('exportCancel');
  const exportDownload = document.getElementById('exportDownload');

  const goalsPanel   = document.getElementById('goalsPanel');  
  const goalsClose   = document.getElementById('goalsClose');  
  const yearlyValues = document.getElementById('yearlyValues');  
  const monthlyValues= document.getElementById('monthlyValues');  
  const weeklyValues = document.getElementById('weeklyValues');  
  const dailyValues  = document.getElementById('dailyValues');  
  const yearlyBar = document.getElementById('yearlyBar');  
  const monthlyBar= document.getElementById('monthlyBar');  
  const weeklyBar = document.getElementById('weeklyBar');  
  const dailyBar  = document.getElementById('dailyBar');  
  const yearlyInput = document.getElementById('yearlyInput');  
  const monthlyInput= document.getElementById('monthlyInput');  
  const weeklyInput = document.getElementById('weeklyInput');  
  const dailyInput  = document.getElementById('dailyInput');  
  const yearlySave  = document.getElementById('yearlySave');  
  const monthlySave = document.getElementById('monthlySave');  
  const weeklySave  = document.getElementById('weeklySave');  
  const dailySave   = document.getElementById('dailySave');  

  const statsBtn = document.getElementById('statsBtn');  
  const statsBackdrop = document.getElementById('statsBackdrop');  
  const statsClose = document.getElementById('statsClose');  
  const todayEarned = document.getElementById('todayEarned');  
  const weekEarned = document.getElementById('weekEarned');  
  const monthEarned = document.getElementById('monthEarned');  
  const avgRateEl = document.getElementById('avgRate');  
  const avgDayEl = document.getElementById('avgDay');  
  const trendEl = document.getElementById('trend');  
  const topTag = document.getElementById('topTag'); // ADDED
  const tagCount = document.getElementById('tagCount'); // ADDED
  const topShare = document.getElementById('topShare'); // ADDED

  const inboxBtn = document.getElementById('inboxBtn');  
  const plusBtn = document.getElementById('plusBtn');
  const inboxPanel = document.getElementById('inboxPanel');  
  const closeInbox = document.getElementById('closeInbox');  
  const inboxBody = document.getElementById('inboxBody');

  const expensesPanel = document.getElementById('expensesPanel');  
  const closeExpenses = document.getElementById('closeExpenses');  
  const xpAmount = document.getElementById('xpAmount');  
  const xpDate = document.getElementById('xpDate');  
  const xpMerchant = document.getElementById('xpMerchant');  
  const xpCategory = document.getElementById('xpCategory');  
  const xpNote = document.getElementById('xpNote');  
  const xpAddBtn = document.getElementById('xpAddBtn');  
  const xpImportBtn = document.getElementById('xpImportBtn');  
  const xpList = document.getElementById('xpList');  
  const xpMonthSpend = document.getElementById('xpMonthSpend');  
  const xpBudgetHint = document.getElementById('xpBudgetHint');  
  const xpTopCat = document.getElementById('xpTopCat');  
  const xpTopCatShare = document.getElementById('xpTopCatShare');  
  const xpPieCanvas = document.getElementById('xpPie');  
  const xpTrendCanvas = document.getElementById('xpTrend');  
  const xpSuggestions = document.getElementById('xpSuggestions');  
  const xpClearMonthBtn = document.getElementById('xpClearMonthBtn');  

  const predictionPanel = document.getElementById('predictionPanel');  
  const predictionClose = document.getElementById('predictionClose');  
  
  const payday1Input = document.getElementById('payday1');
  const payday2Input = document.getElementById('payday2');
  const predPaydayValue = document.getElementById('predPaydayValue');
  const predPaydayDates = document.getElementById('predPaydayDates');

  const predWeeklyValue  = document.getElementById('predWeeklyValue');  
  const predWeeklyGoal   = document.getElementById('predWeeklyGoal');  
  const predWeeklyPrev   = document.getElementById('predWeeklyPrev');  
  const predWeeklyDates = document.getElementById('predWeeklyDates');

  const predBiWeeklyValue  = document.getElementById('predBiWeeklyValue');  
  const predBiWeeklyGoal   = document.getElementById('predBiWeeklyGoal');  
  const predBiWeeklyPrev   = document.getElementById('predBiWeeklyPrev');  
  const predBiWeeklyDates = document.getElementById('predBiWeeklyDates');

  const predMonthlyValue  = document.getElementById('predMonthlyValue');  
  const predMonthlyGoal   = document.getElementById('predMonthlyGoal');  
  const predMonthlyPrev   = document.getElementById('predMonthlyPrev');  
  const predMonthlyDates = document.getElementById('predMonthlyDates');

  const predYearlyValue  = document.getElementById('predYearlyValue');  
  const predYearlyGoal   = document.getElementById('predYearlyGoal');  
  const predYearlyPrev   = document.getElementById('predYearlyPrev');  
  const predYearlyDates = document.getElementById('predYearlyDates');

  const billForecastPanel  = document.getElementById('billForecastPanel');  
  const billForecastClose  = document.getElementById('billForecastClose');  
  const bfPeriod           = document.getElementById('bfPeriod');  
  const bfFixedBills       = document.getElementById('bfFixedBills');  
  const bfIncludeExpenses  = document.getElementById('bfIncludeExpenses');  
  const bfIncome           = document.getElementById('bfIncome');  
  const bfBills            = document.getElementById('bfBills');  
  const bfLeft             = document.getElementById('bfLeft');  
  const bfHints            = document.getElementById('bfHints');  

  const blocker = document.getElementById('globalBlocker');  
  const introOverlay = document.getElementById('introOverlay');

  let earningsChart = null;  
  let hoursChart = null;  
  let breakChart = null;  
  let xpPie = null;  
  let xpTrend = null;  

  /* ========= Helpers ========= */  
  const pad2 = n => String(n).padStart(2,'0');  

  function fmtMoney(n){  
    return `$${(n||0).toFixed(2)}`;  
  }  
  
  function fmtMoneyShort(n) {
    if (n >= 1000) {
      return `$${(n/1000).toFixed(1)}K`; // Use 1 decimal for short
    }
    return fmtMoney(n);
  }

  function formatMain(ms){  
    const total = Math.max(0, ms|0);  
    const h = Math.floor(total/3600000);  
    const m = Math.floor((total%3600000)/60000);  
    const s = Math.floor((total%60000)/1000);  
    const c = Math.floor((total%1000)/10);  
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}.${pad2(c)}`;  
  }  

  function toLocalInput(ts){  
    const d = new Date(ts);  
    const pad=n=>String(n).padStart(2,'0');  
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;  
  }  

  function fromLocalInput(val){  
    return new Date(val.replace(' ', 'T')).getTime();  
  }  
  
  /* Date helpers */
  const fmtDate = (d, exclYear=false) => {
    const opts = { month: 'short', day: 'numeric' };
    if (!exclYear) opts.year = 'numeric';
    return new Date(d).toLocaleDateString('en-US', opts);
  };
  
  const dayMS = 86400000;
  const startOfDay   = ts => { const d = new Date(ts); d.setHours(0,0,0,0); return d.getTime(); };  
  const startOfWeek  = ts => { const d=new Date(ts); const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x.getTime(); };  
  const startOfMonth = ts => { const d=new Date(ts); const x=new Date(d.getFullYear(), d.getMonth(), 1); x.setHours(0,0,0,0); return x.getTime(); };  
  const startOfYear  = ts => { const d=new Date(ts); const x=new Date(d.getFullYear(), 0, 1); x.setHours(0,0,0,0); return x.getTime(); };
  const endOfYear    = ts => { const d=new Date(ts); const x=new Date(d.getFullYear(), 11, 31); x.setHours(23,59,59,999); return x.getTime(); };

  function humanDate(ts){  
    const d=new Date(ts);  
    return d.toLocaleDateString();  
  }  

  function rangeDays(n){  
    const arr=[];  
    const now=new Date();  
    now.setHours(0,0,0,0);  
    for(let i=n-1;i>=0;i--){  
      arr.push(+now - i*dayMS);  
    }  
    return arr;  
  }  

  function vibrate(ms=20){  
    if (!prefs.haptics) return;  
    if (navigator.vibrate){  
      try{ navigator.vibrate(ms); }catch{}  
    }  
  }  

  let audioCtx = null;  
  function playSound(freq=880, durMs=70){  
    if (!prefs.sound) return;  
    try{  
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();  
      const o = audioCtx.createOscillator();  
      const g = audioCtx.createGain();  
      o.type = 'sine';  
      o.frequency.value = freq;  
      g.gain.value = 0.0001;  
      o.connect(g);  
      g.connect(audioCtx.destination);  
      const t = audioCtx.currentTime;  
      g.gain.exponentialRampToValueAtTime(0.15, t + 0.01);  
      g.gain.exponentialRampToValueAtTime(0.0001, t + durMs/1000);  
      o.start();  
      o.stop(t + durMs/1000 + 0.01);  
    }catch{}  
  }  

  /* ========= Persistence ========= */  
  function savePrefs(){  
    try{ localStorage.setItem(STORE_KEY_PREFS, JSON.stringify(prefs)); }catch{}  
  }
  function loadPrefs(){  
    try{  
      const raw = localStorage.getItem(STORE_KEY_PREFS);  
      if (!raw) return;  
      const obj = JSON.parse(raw)||{};  
      prefs.theme = obj.theme === 'light' ? 'light' : 'dark';  
      prefs.sound = obj.sound !== false;  
      prefs.haptics = obj.haptics !== false;  
      prefs.payday1 = obj.payday1 || 1;
      prefs.payday2 = obj.payday2 || 15;
    }catch{}  
  }  

  function saveGoals(){  
    try{ localStorage.setItem(STORE_KEY_GOALS, JSON.stringify(goals)); }catch{}  
  }  

  function loadGoals(){  
    try{  
      const raw = localStorage.getItem(STORE_KEY_GOALS);  
      if (!raw) return;  
      const g = JSON.parse(raw)||{};  
      goals.yearly  = +g.yearly  || 0;  
      goals.monthly = +g.monthly || 0;  
      goals.weekly  = +g.weekly  || 0;  
      goals.daily   = +g.daily   || 0;  
    }catch{}  
  }  

  /* --- NEW: Chart Defaults --- */
  function updateChartDefaults() {
    const isLight = prefs.theme === 'light';
    const tickColor = isLight ? '#6b7280' : '#94a3b8'; // --muted
    const gridColor = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(148, 163, 184, 0.2)';
    const legendColor = isLight ? '#111827' : '#f8fafc'; // --text
    
    Chart.defaults.color = tickColor;
    Chart.defaults.borderColor = gridColor;
    Chart.defaults.plugins.legend.labels.color = legendColor;
  }
  
  function applyTheme(){  
    document.body.classList.toggle('light', prefs.theme === 'light');
    updateChartDefaults(); // Update chart colors on theme change
  }  

  function saveHistoryStore(){  
    try{ localStorage.setItem(STORE_KEY_HISTORY, JSON.stringify(history)); }catch(e){}  
  }  

  function loadHistoryStore(){  
    try{  
      const raw = localStorage.getItem(STORE_KEY_HISTORY);  
      if (!raw) return;  
      const arr = JSON.parse(raw);  
      if (Array.isArray(arr)) history = arr;  
    }catch(e){}  
  }  

  function saveExpenses(){  
    try{ localStorage.setItem(STORE_KEY_EXPENSES, JSON.stringify(expenses)); }catch(e){}  
  }  

  function loadExpenses(){  
    try{  
      const raw = localStorage.getItem(STORE_KEY_EXPENSES);  
      if (!raw) return;  
      const arr = JSON.parse(raw)||[];  
      if (Array.isArray(arr)) expenses = arr;  
    }catch(e){}  
  }  

  function saveBudgets(){  
    try{ localStorage.setItem(STORE_KEY_BUDGETS, JSON.stringify(budgets)); }catch(e){}  
  }  

  function loadBudgets(){  
    try{  
      const raw = localStorage.getItem(STORE_KEY_BUDGETS);  
      if (!raw) return;  
      const obj = JSON.parse(raw)||{};  
      budgets = Object.assign(budgets, obj);  
    }catch(e){}  
  }  

  /* ========= Live contribution ========= */  
  function currentSessionContributionSince(tsFloorMs){  
    if (!running || onBreak || !startWallTs) return {amount:0, ms:0};  
    const rate = parseFloat(rateInput.value)||0;  
    const now = Date.now();  
    const start = Math.max(startWallTs, tsFloorMs);  
    if (now <= start) return {amount:0, ms:0};  
    const ms = now - start;  
    return {amount: rate*(ms/3600000), ms};  
  }  

  function sumEntriesBetween(startMs, endMs){  
    let ms=0, amount=0, sessions=0, breakMs=0;  
    for (const h of history){  
      // Only count entries that *ended* within the period
      if (h.endTs >= startMs && h.endTs < endMs){  
        ms += h.elapsedMs||0;  
        amount += h.amount||0;  
        sessions += 1;  
        breakMs += h.breakMs||0;  
      }  
    }  
    return {ms, amount, sessions, breakMs};  
  }  
  
  function sumRangeSince(rangeStart, rangeEnd = Date.now()){  
    const rate = parseFloat(rateInput.value)||0;  
    const now = Math.min(Date.now(), rangeEnd);
    
    // Sum all *saved* history that ended in this range
    let total = history
      .filter(h => h.endTs >= rangeStart && h.endTs < rangeEnd)
      .reduce((a,b) => a + (b.amount||0), 0);  
    
    // Add *live* contribution if the session is running
    if (running && !onBreak && startWallTs && now < rangeEnd){  
      const contribStart = Math.max(startWallTs, rangeStart);
      if (now > contribStart) {
        const contribMs = Math.max(0, now - contribStart);  
        total += rate * (contribMs/3600000);  
      }
    }  
    return total;  
  }

  function update(){  
    const now = Date.now();  
    const w1 = (now/22)%60;  
    const w2 = (now/37)%90;  

    [yearlyBar, monthlyBar, weeklyBar, dailyBar].forEach(el=>{  
      if (!el) return;  
      el.style.setProperty('--wave1', `${w1}px`);  
      el.style.setProperty('--wave2', `${w2}px`);  
    });  

    if (scheduledStartTs && now >= scheduledStartTs && !running && !onBreak){  
      scheduledStartTs = null;  
      startTimer();  
    }  

    if (scheduledStopTs && now >= scheduledStopTs && running){  
      finalizeActiveBreak();  
      scheduledStopTs = null;  
      running = false;  
      clearInterval(interval);  
      interval = null;  
      endWallTs = now;  
      saveState();  
      saveBackdrop.classList.add('show');  
      vibrate(16);  
      playSound(600, 90);  
    }  

    if (running){  
      elapsed = now - startTime;  
      endWallTs = now;  
      updateDisplays(elapsed);  
      if (now % 500 < 20) saveState();  
    }  
  }  

  function updateDisplays(elapsedMs){  
    const rate = parseFloat(rateInput.value)||0;  
    const earned = (rate * (elapsedMs / 3600000));  
    timeDisplay.textContent = formatMain(elapsedMs);  
    moneyDisplay.textContent = fmtMoney(earned);  
  }  

  function startInterval(){  
    if (interval) clearInterval(interval);  
    interval = setInterval(update, 16);  
  }  

  function startTimer(){  
    if (running) return;  
    running = true;  
    const now = Date.now();  
    if (!startWallTs) startWallTs = now;  
    startTime = now - elapsed;  
    startInterval();  
    saveState();  
    vibrate(12);  
    playSound(1200, 80);  
  }  

  function finalizeActiveBreak(){  
    if (onBreak){  
      const now = Date.now();  
      const dur = now - breakStartTs;  
      sessionBreakMs += Math.max(0, dur);  
      onBreak = false;  
      if (breakTicker){  
        clearInterval(breakTicker);  
        breakTicker=null;  
      }  
      breakDisplay.classList.remove('show');  
      breakSummary.textContent = `Break taken: ${humanShort(sessionBreakMs)}`;  
      breakSummary.classList.add('show');  
    }  
  }  

  function stopTimer(){  
    if (!running) return;  
    finalizeActiveBreak();  
    running = false;  
    clearInterval(interval);  
    interval = null;  
    endWallTs = Date.now();  
    saveState();  
    saveBackdrop.classList.add('show');  
    vibrate(16);  
    playSound(600, 90);  
  }  

  function clearTimer(){  
    if (running){  
      alert('Stop the timer first to clear the display.');  
      vibrate(8);  
      playSound(400, 60);  
      return;  
    }  
    elapsed = 0;  
    startWallTs = null;  
    endWallTs = null;  
    timeDisplay.textContent = "00:00:00.00";  
    moneyDisplay.textContent = "$0.00";  
    if (breakTicker){  
      clearInterval(breakTicker);  
      breakTicker=null;  
    }  
    onBreak = false;  
    breakStartTs = null;  
    sessionBreakMs = 0;  
    breakDisplay.classList.remove('show');  
    breakSummary.classList.remove('show');  
    breakSummary.textContent = "";  
    saveState();  
    vibrate(10);  
    playSound(500, 60);  
  }  

  function flashHistoryBtn(){  
    historyBtn.classList.add('flash');  
    setTimeout(()=>historyBtn.classList.remove('flash'), 1000);  
  }  

  function updateTotals(){  
    const now = Date.now();  
    const w0 = startOfWeek(now);  
    const m0 = startOfMonth(now);  
    const weekSum = sumRangeSince(w0);
    const monthSum = sumRangeSince(m0);
    weekTotalEl.textContent = fmtMoney(weekSum);  
    monthTotalEl.textContent = fmtMoney(monthSum);  
    computePredictions();  
  }  

  function humanShort(ms){  
    const t = Math.max(0, ms|0);  
    const h = Math.floor(t/3600000);  
    const m = Math.floor((t%3600000)/60000);  
    const s = Math.floor((t%60000)/1000);  
    if (h) return `${h}h ${m}m`;  
    if (m) return `${m}m ${s}s`;  
    return `${s}s`;  
  }  

  function renderHistory(){  
    historyList.innerHTML = "";  
    history.sort((a,b) => b.startTs - a.startTs).forEach(item=>{  
      const startStr = new Date(item.startTs).toLocaleString();  
      const endStr = new Date(item.endTs).toLocaleString();  
      const li = document.createElement('li');  
      li.innerHTML = `  
        <div>  
          <div class="meta">Start: ${startStr} ‚Ä¢ End: ${endStr}${item.tag ? ` ‚Ä¢ #${item.tag}` : ''}</div>  
          <div class="dur">Duration: ${formatMain(item.elapsedMs)}</div>  
          ${item.breakMs ? `<div class="meta"><span class="break-highlight">Break</span>: ${humanShort(item.breakMs)}</div>` : ''}  
          <div class="amt">${fmtMoney(item.amount)}</div>  
          ${item.tag ? `<div class="tag">#${item.tag}</div>` : ''}  
        </div>  
        <div class="row-actions">  
          <button class="btn-small btn-danger" data-del="${item.id}">Delete</button>
          <button class="btn-small" data-edit="${item.id}">Edit</button>  
        </div>  
      `;  
      historyList.appendChild(li);  
    });  

    historyList.querySelectorAll('[data-del]').forEach(btn=>{  
      btn.onclick = ()=>{  
        pendingDeleteId = btn.getAttribute('data-del');  
        confirmBackdrop.classList.add('show');  
      };  
    }); 

    historyList.querySelectorAll('[data-edit]').forEach(btn=>{  
      btn.onclick = ()=>{  
        const id = btn.getAttribute('data-edit');  
        const entry = history.find(h=>String(h.id)===String(id));  
        if (!entry) return;  
        editingId = entry.id;  
        editStart.value = toLocalInput(entry.startTs);  
        editEnd.value = toLocalInput(entry.endTs);  
        editTag.value = entry.tag || '';  
        editBackdrop.classList.add('show');  
      };  
    });  

    computePredictions();  
  }  

  function saveHistory(){  
    const rate = parseFloat(rateInput.value)||0;  
    if (!startWallTs) startWallTs = Date.now() - elapsed;  
    if (!endWallTs) endWallTs = Date.now();  
    
    // Use elapsed, not a new wall-clock calc, to respect manual start/stop times
    const durationMs = elapsed; 

    if (durationMs > 0){  
      const now = new Date(endWallTs);  
      const entry = {  
        id: now.getTime().toString()+Math.random().toString(36).slice(2,6),  
        startTs: startWallTs,  
        endTs: endWallTs,  
        elapsedMs: durationMs,  
        amount: +(rate * (durationMs/3600000)).toFixed(2),  
        tag: (tagInput.value||'').trim(),  
        breakMs: sessionBreakMs || 0  
      };  
      history.unshift(entry);  
      saveHistoryStore();  
      tagInput.value = '';  
      renderHistory();  
      updateTotals();  
      flashHistoryBtn();  
      vibrate(20);  
      playSound(900, 80);  
    }  

    saveBackdrop.classList.remove('show');  
    elapsed = 0;  
    startWallTs = null;  
    endWallTs = null;  
    sessionBreakMs = 0;  
    if (breakTicker){  
      clearInterval(breakTicker);  
      breakTicker=null;  
    }  
    onBreak = false;  
    breakStartTs = null;  
    breakDisplay.classList.remove('show');  
    breakSummary.classList.remove('show');  
    breakSummary.textContent = "";  
    updateDisplays(0);  
    saveState();  
  }  

  function applyEdit(){  
    if (!editingId) return;  
    const entry = history.find(h=>h.id===editingId);  
    if (!entry) return;  

    const s = editStart.value, e = editEnd.value;  
    if (!s || !e) { alert('Provide both start and end.'); return; }  
    const startTs = fromLocalInput(s), endTs = fromLocalInput(e);  
    if (!(isFinite(startTs)&&isFinite(endTs)) || endTs < startTs){  
      alert('End must be after Start.');  
      return;  
    }  
    const rate = parseFloat(rateInput.value)||0;  
    const dur = endTs - startTs;  
    entry.startTs = startTs;  
    entry.endTs = endTs;  
    entry.elapsedMs = dur;  
    entry.amount = +(rate * (dur/3600000)).toFixed(2);  
    entry.tag = (editTag.value||'').trim();  

    saveHistoryStore();  
    editingId = null;  
    editBackdrop.classList.remove('show');  
    renderHistory();  
    updateTotals();  
    vibrate(15);  
    playSound(800, 70);  
  }  

  function showBreak(){  
    breakDisplay.classList.add('show');  
  }  

  function startBreakTicker(){  
    if (breakTicker) clearInterval(breakTicker);  
    breakDisplay.textContent = `Break: 00:00:00`;  
    breakTicker = setInterval(()=>{  
      const ms = Date.now() - breakStartTs;  
      const h = Math.floor(ms/3600000);  
      const m = Math.floor((ms%3600000)/60000);  
      const s = Math.floor((ms%60000)/1000);  
      breakDisplay.textContent = `Break: ${pad2(h)}:${pad2(m)}:${pad2(s)}`;  
    }, 250);  
  }  

  /* ===== Calculator (NEW) ===== */
  function openCalc() {
    calcRate1.value = rateInput.value;
    calcRate2.value = rateInput.value;
    calcHours.value = '';
    calcTarget.value = '';
    calcGoalAmount.value = '';
    
    const avgDay = estimateDailyPace();
    calcPace.placeholder = `Uses your 7-day avg. (${fmtMoney(avgDay)})`;
    calcPace.value = ''; // Clear it so placeholder shows

    updateCalc1();
    updateCalc2();
    updateCalc3();
    
    calcPanel.classList.add('show');
    calcPanel.setAttribute('aria-hidden', 'false');
    syncOverlays();
  }
  
  function closeCalc() {
    calcPanel.classList.remove('show');
    calcPanel.setAttribute('aria-hidden', 'true');
    syncOverlays();
  }

  function updateCalc1() {
    const hours = parseFloat(calcHours.value) || 0;
    const rate = parseFloat(calcRate1.value) || 0;
    calcResult1.textContent = `Total: ${fmtMoney(hours * rate)}`;
  }

  function updateCalc2() {
    const target = parseFloat(calcTarget.value) || 0;
    const rate = parseFloat(calcRate2.value) || 0;
    const hours = (rate > 0) ? (target / rate) : 0;
    calcResult2.textContent = `Hours Needed: ${hours.toFixed(2)}`;
  }
  
  function updateCalc3() {
    const goal = parseFloat(calcGoalAmount.value) || 0;
    let pace = parseFloat(calcPace.value) || 0;
    
    if (pace === 0) {
      pace = estimateDailyPace(); // Use placeholder if input is empty
    }
    
    const days = (pace > 0) ? (goal / pace) : 0;
    calcResult3.textContent = `Days Needed: ${days.toFixed(1)}`;
  }

  calcClose.onclick = closeCalc;
  calcHours.oninput = updateCalc1;
  calcRate1.oninput = updateCalc1;
  calcTarget.oninput = updateCalc2;
  calcRate2.oninput = updateCalc2;
  calcGoalAmount.oninput = updateCalc3;
  calcPace.oninput = updateCalc3;


  /* ===== Goals open/close + SAVE ===== */  
  let goalsRAF = null;  

  function openGoals(){  
    yearlyInput.value  = goals.yearly  ? String(goals.yearly)  : '';  
    monthlyInput.value = goals.monthly ? String(goals.monthly) : '';  
    weeklyInput.value  = goals.weekly  ? String(goals.weekly)  : '';  
    dailyInput.value   = goals.daily   ? String(goals.daily)   : '';  

    goalsPanel.classList.add('show');  
    goalsPanel.setAttribute('aria-hidden','false');  

    const tick = ()=>{  
      renderGoalBars();  
      goalsRAF = requestAnimationFrame(tick);  
    };  
    if (!goalsRAF) goalsRAF = requestAnimationFrame(tick);  
  }  

  function closeGoals(){  
    goalsPanel.classList.remove('show');  
    goalsPanel.setAttribute('aria-hidden','true');  
    if (goalsRAF){  
      cancelAnimationFrame(goalsRAF);  
      goalsRAF = null;  
    }  
  }  

  function clampPct(n){  
    return Math.max(0, Math.min(100, n));  
  }  

  function renderGoalBars(){  
    const now = Date.now();  
    const year0  = startOfYear(now);
    const month0 = startOfMonth(now);
    const week0  = startOfWeek(now);
    const day0   = startOfDay(now);

    const yVal = sumRangeSince(year0);  
    const mVal = sumRangeSince(month0);  
    const wVal = sumRangeSince(week0);  
    const dVal = sumRangeSince(day0);  

    const yT = goals.yearly  || 0;  
    const mT = goals.monthly || 0;  
    const wT = goals.weekly  || 0;  
    const dT = goals.daily   || 0;  

    const yPct = yT ? clampPct((yVal / yT) * 100) : 0;  
    const mPct = mT ? clampPct((mVal / mT) * 100) : 0;  
    const wPct = wT ? clampPct((wVal / wT) * 100) : 0;  
    const dPct = dT ? clampPct((dVal / dT) * 100) : 0;  

    yearlyBar.style.width  = `${yPct}%`;  
    monthlyBar.style.width = `${mPct}%`;  
    weeklyBar.style.width  = `${wPct}%`;  
    dailyBar.style.width   = `${dPct}%`;  

    yearlyBar.dataset.pct  = String(Math.floor(yPct));  
    monthlyBar.dataset.pct = String(Math.floor(mPct));  
    weeklyBar.dataset.pct  = String(Math.floor(wPct));  
    dailyBar.dataset.pct   = String(Math.floor(dPct));  

    yearlyValues.textContent  = `${fmtMoney(yVal)} / ${fmtMoney(yT)} (${Math.floor(yPct)}%)`;  
    monthlyValues.textContent = `${fmtMoney(mVal)} / ${fmtMoney(mT)} (${Math.floor(mPct)}%)`;  
    weeklyValues.textContent  = `${fmtMoney(wVal)} / ${fmtMoney(wT)} (${Math.floor(wPct)}%)`;  
    dailyValues.textContent   = `${fmtMoney(dVal)} / ${fmtMoney(dT)} (${Math.floor(dPct)}%)`;  

    computePredictions();  
  }  

  yearlySave.onclick  = ()=>{ goals.yearly  = +yearlyInput.value  || 0; saveGoals(); renderGoalBars(); vibrate(8); playSound(900,70); };  
  monthlySave.onclick = ()=>{ goals.monthly = +monthlyInput.value || 0; saveGoals(); renderGoalBars(); vibrate(8); playSound(900,70); };  
  weeklySave.onclick  = ()=>{ goals.weekly  = +weeklyInput.value  || 0; saveGoals(); renderGoalBars(); vibrate(8); playSound(900,70); };  
  dailySave.onclick   = ()=>{ goals.daily   = +dailyInput.value   || 0; saveGoals(); renderGoalBars(); vibrate(8); playSound(900,70); };  

  /* ===== Charts plugin ===== */  
  const glowPlugin = {  
    id:'glow',  
    afterDatasetsDraw(chart){  
      const ctx = chart.ctx;  
      ctx.save();  
      chart.data.datasets.forEach((ds, i)=>{  
        const meta = chart.getDatasetMeta(i);  
        if (!meta.data || prefs.theme === 'light') return; // No glow on light mode
        
        ctx.shadowColor = (ds.borderColor || 'rgba(255,255,255,.5)');  
        ctx.shadowBlur = 16;  
        ctx.shadowOffsetX=0;  
        ctx.shadowOffsetY=0;  
        meta.data.forEach(pt=>{  
          ctx.beginPath();  
          ctx.arc(pt.x, pt.y, 3.5, 0, Math.PI*2);  
          ctx.fillStyle = Array.isArray(ds.pointBackgroundColor) ? ds.pointBackgroundColor[0] : (ds.pointBackgroundColor || ds.backgroundColor || '#fff');  
          ctx.fill();  
        });  
      });  
      ctx.restore();  
    }  
  };  
  Chart.register(glowPlugin);  

  function gradient(ctx, area, from, to){  
    const g = ctx.createLinearGradient(0, area.bottom, 0, area.top);  
    g.addColorStop(0, from);  
    g.addColorStop(1, to);  
    return g;  
  }  

  function openStats(){  
    renderStats();  
    statsBackdrop.classList.add('show');  
    syncOverlays();  
  }  

  function closeStats(){  
    statsBackdrop.classList.remove('show');  
    syncOverlays();  
  }  

  statsBtn.onclick = openStats;  
  statsClose.onclick = closeStats;  
  statsBackdrop.addEventListener('click',(e)=>{ if (e.target===statsBackdrop) closeStats(); });  

  function labelsFromDates(days){  
    return days.map(ts=>["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(ts).getDay()]);  
  }  

  function colorForTag(tag, idx){  
    const base = (Array.from(tag||'Untagged').reduce((a,c)=>a+c.charCodeAt(0),0)+idx*37)%360;  
    return `hsl(${base}, 70%, 55%)`;  
  }  

  function renderStats(){  
    const now = Date.now();  
    const d0 = startOfDay(now);
    const w0 = startOfWeek(now);
    const m0 = startOfMonth(now);

    const todayAmount = sumRangeSince(d0);
    const weekAmount = sumRangeSince(w0);
    const monthAmount = sumRangeSince(m0);
    
    todayEarned.textContent = fmtMoney(todayAmount);  
    weekEarned.textContent  = fmtMoney(weekAmount);  
    monthEarned.textContent = fmtMoney(monthAmount);  

    const last7 = rangeDays(7);  
    const earningsSeries = last7.map(d=>{  
      const fx = sumEntriesBetween(d, d+dayMS);  
      const live = (d===d0) ? currentSessionContributionSince(d) : {amount:0,ms:0};  
      return +(fx.amount + live.amount).toFixed(2);  
    });  
    const hoursSeries = last7.map(d=>{  
      const fx = sumEntriesBetween(d, d+dayMS);  
      const live = (d===d0) ? currentSessionContributionSince(d) : {amount:0, ms:0};  
      return +(((fx.ms + live.ms)/3600000).toFixed(2));  
    });  

    const total7 = earningsSeries.reduce((a,b)=>a+b,0);  
    const hours7 = hoursSeries.reduce((a,b)=>a+b,0);  
    const avgRate = hours7>0 ? (total7/hours7) : 0;  
    const avgDay = total7/7;  
    avgRateEl.textContent = `${fmtMoney(avgRate)}/hr`;  
    avgDayEl.textContent = fmtMoney(avgDay);  
    trendEl.textContent = earningsSeries[6] >= earningsSeries[5] ? "Uptrend" : "Slight dip";  

    renderCharts(labelsFromDates(last7), earningsSeries, hoursSeries);  

    const tagMap = {};  
    for (const h of history){  
      if (h.endTs >= w0){  
        const key = (h.tag && h.tag.trim()) ? h.tag.trim() : 'Untagged';  
        tagMap[key] = (tagMap[key]||0) + (h.amount||0);  
      }  
    }  
    const tagEntries = Object.entries(tagMap).sort((a,b)=>b[1]-a[1]);  
    const labels = tagEntries.map(([k])=>k);  
    const data   = tagEntries.map(([,v])=>+v.toFixed(2));  
    const colors = [
      '#22d3ee', '#a78bfa', '#f59e0b', '#22c55e',
      '#ef4444', '#60a5fa', '#eab308', '#ec4899'
    ]; // NEW Donut Palette
    
    const top = tagEntries[0];  
    const sum = data.reduce((a,b)=>a+b,0) || 1;  
    topTag.textContent = top ? `#${top[0]}` : '‚Äî';  
    tagCount.textContent = String(labels.length);  
    topShare.textContent = top ? `${((top[1]/sum)*100).toFixed(1)}%` : '0%';  

    if (breakChart) breakChart.destroy();  
    const bctx = document.getElementById('breakChart').getContext('2d');  
    breakChart = new Chart(bctx, {  
      type:'doughnut',  
      data:{ labels, datasets:[{ 
        data, 
        backgroundColor:colors, 
        borderColor:'var(--bg)', 
        borderWidth:4, 
        hoverOffset:10 
      }]},  
      options:{  
        cutout:'68%',  
        plugins:{  
          legend:{  
            position:'top',  
            align:'center',  
            labels:{  
              // color:'var(--text)', // REMOVED: Now uses global default
              usePointStyle:true,  
              pointStyle:'rect',  
              boxWidth:12,  
              boxHeight:12,  
              padding:12  
            }  
          },  
          tooltip:{callbacks:{label:(ctx)=> `${ctx.label}: ${fmtMoney(ctx.raw||0)}`}}  
        },  
        animation:{animateRotate:true, animateScale:true}  
      }  
    });  

    computePredictions();  
  }  

  function renderCharts(labels, earnings, hours){  
    const ectx = document.getElementById('earningsChart').getContext('2d');  
    const hctx = document.getElementById('hoursChart').getContext('2d');  

    if (earningsChart) earningsChart.destroy();  
    if (hoursChart) hoursChart.destroy();  

    const eArea = {top:0,bottom:170}, hArea = {top:0,bottom:170};  
    const hoursFill = gradient(hctx, hArea, 'rgba(96,165,250,0.08)','rgba(96,165,250,0.35)');  
    const barColors = earnings.map((v,i)=>  
      i===labels.length-1 ? 'rgba(34,197,94,1)' :  
      ['#22c55e','#2dd4bf','#60a5fa','#a78bfa','#f59e0b','#ef4444','#22d3ee'][i%7]  
    );  
    
    // const gridColor = 'rgba(148, 163, 184, 0.2)'; // REMOVED: Use global default
    // const tickColor = 'var(--muted)'; // REMOVED: Use global default

    earningsChart = new Chart(ectx, {  
      type:'bar',  
      data:{  
        labels,  
        datasets:[{  
          label:'Earnings ($)',  
          data:earnings,  
          backgroundColor: barColors,  
          borderColor:'#0ea5e9',  
          borderWidth:0, // Removed frame
        }]  
      },  
      options:{  
        responsive:true,  
        plugins:{  
          legend:{display:false},  
          tooltip:{callbacks:{label:(ctx)=>'$'+ctx.raw.toFixed(2)}}  
        },  
        scales:{  
          x:{/*ticks:{color:tickColor}, grid: { color: gridColor }*/},  
          y:{/*ticks:{color:tickColor}, grid: { color: gridColor },*/ beginAtZero:true}  
        }  
      },  
      plugins:['glow']  
    });  

    hoursChart = new Chart(hctx, {  
      type:'line',  
      data:{  
        labels,  
        datasets:[{  
          label:'Hours Worked',  
          data:hours,  
          fill:true,  
          borderColor:'#60a5fa',  
          backgroundColor:hoursFill,  
          tension:.35,  
          pointRadius:3,  
          pointHoverRadius:4,  
          pointBackgroundColor:'#38bdf8'  
        }]  
      },  
      options:{  
        responsive:true,  
        plugins:{  
          legend:{display:false},  
          tooltip:{callbacks:{label:(ctx)=>`${ctx.raw.toFixed(2)} h`}}  
        },  
        scales:{  
          x:{/*ticks:{color:tickColor}, grid: { color: gridColor }*/},  
          y:{/*ticks:{color:tickColor}, grid: { color: gridColor },*/ beginAtZero:true}  
        }  
      },  
      plugins:['glow']  
    });  
  }  

  /* ===== Predictions (NEW LOGIC) ===== */  
  function estimateDailyPace(){  
    const last7 = rangeDays(7);  
    let sum = 0;  
    let count = 0;  
    last7.forEach(d=>{  
      const fx = sumEntriesBetween(d, d+dayMS);  
      if (fx.amount > 0){  
        sum += fx.amount;  
        count++;  
      }  
    });  
    if (count > 0) return sum / count;  
    const rate = parseFloat(rateInput.value)||0;  
    return rate * 8; // default to 8h/day if no history
  }
  
  function getTrend(current, previous) {
    if (previous > 0) {
      const pct = ((current / previous) - 1) * 100;
      const direction = pct >= 0 ? 'Up' : 'Down';
      return `${direction} ${Math.abs(pct).toFixed(0)}%`;
    }
    if (current > 0) return 'Up 100%'; // From 0 to something
    return '...'; // 0 to 0
  }
  
  function getNextPayday(now, p1, p2) {
    const d = new Date(now);
    const y = d.getFullYear();
    const m = d.getMonth();
    const currentDay = d.getDate();

    let p1ts = new Date(y, m, p1).getTime();
    let p2ts = p2 > 0 ? new Date(y, m, p2).getTime() : 0;
    
    // Ensure p1 and p2 are sorted
    if(p2 > 0 && p1ts > p2ts) [p1ts, p2ts] = [p2ts, p1ts];

    if (currentDay <= p1) return p1ts;
    if (p2 > 0 && currentDay <= p2) return p2ts;

    // Next month's p1
    return new Date(y, m + 1, p1).getTime();
  }

  function getPrevPayday(now, p1, p2) {
    const d = new Date(now);
    const y = d.getFullYear();
    const m = d.getMonth();
    const currentDay = d.getDate();

    let p1ts = new Date(y, m, p1).getTime();
    let p2ts = p2 > 0 ? new Date(y, m, p2).getTime() : 0;
    
    if(p2 > 0 && p1ts > p2ts) [p1ts, p2ts] = [p2ts, p1ts];
    
    if (currentDay > p2 && p2 > 0) return p2ts;
    if (currentDay > p1) return p1ts;

    // Last month's p2 (or p1 if no p2)
    if(p2 > 0) return new Date(y, m - 1, p2).getTime();
    return new Date(y, m - 1, p1).getTime();
  }

  function computePredictions(){  
    if (!predictionPanel) return;  

    const now = Date.now();
    const sWeek = startOfWeek(now);
    const sMonth = startOfMonth(now);
    const sYear = startOfYear(now);
    const eYear = endOfYear(now);
    
    // Bi-weekly is "current" cycle. If we're in 2nd week, it starts last week.
    const sBiWeek = (now - sWeek >= 7*dayMS) ? (sWeek - 7*dayMS) : sWeek;

    // --- Current Period Totals ---
    const weeklyPred  = sumRangeSince(sWeek, sWeek + 7*dayMS);
    const biWeeklyPred= sumRangeSince(sBiWeek, sBiWeek + 14*dayMS);
    const monthlyPred = sumRangeSince(sMonth, new Date(new Date(sMonth).getFullYear(), new Date(sMonth).getMonth()+1, 1).getTime());
    const yearlyPred  = sumRangeSince(sYear, eYear);
    
    // --- Previous Period Totals ---
    const prevWeekTotal = sumEntriesBetween(sWeek - 7*dayMS, sWeek).amount;
    const prevBiWeekTotal = sumEntriesBetween(sBiWeek - 14*dayMS, sBiWeek).amount;
    const prevMonthDate = new Date(sMonth);
    prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
    const prevMonthTotal = sumEntriesBetween(startOfMonth(prevMonthDate.getTime()), sMonth).amount;
    const prevYearDate = new Date(sYear);
    prevYearDate.setFullYear(prevYearDate.getFullYear() - 1);
    const prevYearTotal = sumEntriesBetween(startOfYear(prevYearDate.getTime()), sYear).amount;

    // --- Update UI ---
    predWeeklyValue.textContent = fmtMoney(weeklyPred);
    predWeeklyDates.textContent = `${fmtDate(sWeek, true)} ‚Äì ${fmtDate(sWeek + 6*dayMS, true)}`;
    predWeeklyGoal.textContent = `Goal: ${fmtMoney(goals.weekly)}`;
    predWeeklyPrev.textContent = `Previous Week: ${fmtMoney(prevWeekTotal)}`;
    
    predBiWeeklyValue.textContent = fmtMoney(biWeeklyPred);
    predBiWeeklyDates.textContent = `${fmtDate(sBiWeek, true)} ‚Äì ${fmtDate(sBiWeek + 13*dayMS, true)}`;
    predBiWeeklyGoal.textContent = `Goal: ${fmtMoney(goals.weekly * 2)}`;
    predBiWeeklyPrev.textContent = `Previous Period: ${fmtMoney(prevBiWeekTotal)}`;

    predMonthlyValue.textContent = fmtMoney(monthlyPred);
    predMonthlyDates.textContent = `${fmtDate(sMonth, true)} ‚Äì ${fmtDate(new Date(new Date(sMonth).getFullYear(), new Date(sMonth).getMonth()+1, 0).getTime(), true)}`;
    predMonthlyGoal.textContent = `Goal: ${fmtMoney(goals.monthly)}`;
    predMonthlyPrev.textContent = `Previous Month: ${fmtMoney(prevMonthTotal)}`;

    predYearlyValue.textContent = fmtMoney(yearlyPred);
    predYearlyDates.textContent = `${fmtDate(sYear)} ‚Äì ${fmtDate(eYear)}`;
    predYearlyGoal.textContent = `Goal: ${fmtMoney(goals.yearly)}`;
    predYearlyPrev.textContent = `Previous Year: ${fmtMoney(prevYearTotal)}`;
    
    // --- Payday ---
    const p1 = prefs.payday1;
    const p2 = prefs.payday2;
    payday1Input.value = p1;
    payday2Input.value = p2;

    const prevPay = getPrevPayday(now, p1, p2);
    const nextPay = getNextPayday(now, p1, p2);
    const paydayPred = sumRangeSince(prevPay, nextPay);
    
    predPaydayValue.textContent = fmtMoney(paydayPred);
    predPaydayDates.textContent = `${fmtDate(prevPay, true)} to ${fmtDate(nextPay, true)}`;
  }  

  function openPredictionPanel(){  
    computePredictions();  
    predictionPanel.classList.add('show');  
    predictionPanel.setAttribute('aria-hidden','false');  
    syncOverlays();  
  }  

  function closePredictionPanel(){  
    predictionPanel.classList.remove('show');  
    predictionPanel.setAttribute('aria-hidden','true');  
    syncOverlays();  
  }  

  predictionClose.onclick = closePredictionPanel;  
  payday1Input.addEventListener('change', () => { 
    prefs.payday1 = Math.max(1, Math.min(31, +payday1Input.value || 1));
    savePrefs();
    computePredictions();
  });
  payday2Input.addEventListener('change', () => { 
    prefs.payday2 = Math.max(1, Math.min(31, +payday2Input.value || 15));
    savePrefs();
    computePredictions();
  });


  function openBillForecast(){  
    billForecastPanel.classList.add('show');  
    billForecastPanel.setAttribute('aria-hidden','false');  
    updateBillForecast();  
    syncOverlays();  
  }  

  function closeBillForecast(){  
    billForecastPanel.classList.remove('show');  
    billForecastPanel.setAttribute('aria-hidden','true');  
    syncOverlays();  
  }  

  billForecastClose.onclick = closeBillForecast;  

  /* ===== Heatmap (NEW) ===== */
  function openHeatmap() {
    heatmapState.currentDate = new Date(); // Reset to current month
    renderHeatmap();
    heatmapPanel.classList.add('show');
    heatmapPanel.setAttribute('aria-hidden', 'false');
    syncOverlays();
  }

  function closeHeatmap() {
    heatmapPanel.classList.remove('show');
    heatmapPanel.setAttribute('aria-hidden', 'true');
    syncOverlays();
  }
  
  function renderHeatmap() {
    heatmapGrid.innerHTML = ''; // Clear only the grid
    
    const navDate = heatmapState.currentDate;
    const year = navDate.getFullYear();
    const month = navDate.getMonth(); // 0-11
    
    heatmapMonthTitle.textContent = navDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    
    // 1. Calculate daily totals
    const dailyTotals = {};
    for (const entry of history) {
      const day = startOfDay(entry.endTs);
      dailyTotals[day] = (dailyTotals[day] || 0) + entry.amount;
    }
    
    const validAmounts = Object.values(dailyTotals).filter(a => a > 0);
    
    // 2. Find average (mean) for *all* worked days (e.g., last 90)
    const ninetyDaysAgo = Date.now() - 90 * dayMS;
    const recentValidAmounts = Object.entries(dailyTotals)
      .filter(([ts, amt]) => ts >= ninetyDaysAgo && amt > 0)
      .map(([ts, amt]) => amt);

    let avg = 100; // Default average if no history
    if (recentValidAmounts.length > 0) {
      avg = recentValidAmounts.reduce((a,b) => a+b, 0) / recentValidAmounts.length;
    }
    const goodThreshold = avg * 1.5; // > 150% of avg
    const badThreshold = avg * 0.5;  // < 50% of avg
    
    // 3. Render calendar for specified month
    const firstDay = new Date(year, month, 1);
    const firstDayOfWeek = firstDay.getDay(); // 0 = Sun
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Add spacers for the first week
    for (let i = 0; i < firstDayOfWeek; i++) {
      heatmapGrid.appendChild(document.createElement('div')).className = 'heatmap-day spacer';
    }
    
    // Loop through all days of the month
    for (let i = 1; i <= daysInMonth; i++) {
      const day = document.createElement('div');
      day.className = 'heatmap-day';
      
      const dayKey = new Date(year, month, i).getTime();
      const amount = dailyTotals[dayKey];
      
      day.innerHTML = `<div>${i}</div>`;
      
      if (amount > 0) {
        day.classList.add('has-data');
        if (amount >= goodThreshold) {
          day.classList.add('good');
        } else if (amount <= badThreshold) {
          day.classList.add('bad');
        } else {
          day.classList.add('neutral');
        }
        day.title = `${fmtDate(dayKey)}: ${fmtMoney(amount)}`;
        day.innerHTML += `<div class="heatmap-day-amt">${fmtMoneyShort(amount)}</div>`;
      } else {
         day.title = `${fmtDate(dayKey)}: No earnings`;
      }
      
      // Gray out days in the future
      if (dayKey > Date.now()) {
        day.classList.add('other-month');
      }
      
      heatmapGrid.appendChild(day);
    }
  }

  heatmapClose.onclick = closeHeatmap;
  heatmapPrev.onclick = () => {
    heatmapState.currentDate.setMonth(heatmapState.currentDate.getMonth() - 1);
    renderHeatmap();
  };
  heatmapNext.onclick = () => {
    heatmapState.currentDate.setMonth(heatmapState.currentDate.getMonth() + 1);
    renderHeatmap();
  };


  /* ===== Export (NEW & FIXED) ===== */
  function exportHistoryToCSV() {
    const headers = "Start Time,End Time,Duration (HH:MM:SS),Amount,Tag";
    const rows = history.map(h => {
      const start = new Date(h.startTs).toLocaleString();
      const end = new Date(h.endTs).toLocaleString();
      const dur = formatMain(h.elapsedMs).split('.')[0]; // HH:MM:SS
      const amt = h.amount.toFixed(2);
      const tag = `"${(h.tag || '').replace(/"/g, '""')}"`; // Handle commas in tags
      return [start, end, dur, amt, tag].join(',');
    });
    
    const csvContent = [headers, ...rows].join("\n");
    
    // --- THIS IS THE FIX ---
    // 1. Create a Blob (a file-like object) with the CSV data.
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    
    // 2. Create a temporary URL for this Blob.
    const url = URL.createObjectURL(blob);
    
    // 3. Create a virtual link, set its properties, and click it.
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "earnings-history.csv");
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    
    // 4. Clean up the temporary URL
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }
  
  // NEW: Pro Alert Modal
  function showProAlert() {
    alertBackdrop.classList.add('show');
    syncOverlays();
  }
  alertClose.onclick = () => {
    alertBackdrop.classList.remove('show');
    syncOverlays();
  };

  exportBtn.onclick = showProAlert; // Hook to new alert
  exportCancel.onclick = () => {
    exportBackdrop.classList.remove('show');
    syncOverlays();
  };
  exportDownload.onclick = () => {
    showProAlert(); // Hook to new alert
    // const dataType = document.getElementById('exportDataType').value;
    // if (dataType === 'history') {
    //   exportHistoryToCSV(); // This is the function that is now disabled
    // }
    // exportBackdrop.classList.remove('show');
    // syncOverlays();
  };


  startBtn.onclick = startTimer;  
  stopBtn.onclick  = stopTimer;  
  clearBtn.onclick = clearTimer;  

  function toggleMenu(forceOpen){  
    const willOpen = typeof forceOpen === 'boolean' ? forceOpen : !menuPanel.classList.contains('show');  
    menuPanel.classList.toggle('show', willOpen);  
    menuPanel.setAttribute('aria-hidden', willOpen ? 'false' : 'true');  
    menuBtn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');  
    syncOverlays();  
  }  

  menuBtn.onclick = ()=> toggleMenu();  
  closeMenu.onclick = ()=> toggleMenu(false);  
  
  menuDashboard.onclick   = showProAlert;
  menuGoals.onclick       = ()=>{ toggleMenu(false); openGoals(); syncOverlays(); };  
  menuSummary.onclick     = showProAlert;
  menuCalc.onclick        = ()=>{ toggleMenu(false); openCalc(); };  
  menuExpenses.onclick    = ()=>{ toggleMenu(false); openExpenses(); syncOverlays(); };  
  menuPrediction.onclick  = ()=>{ toggleMenu(false); openPredictionPanel(); };  
  menuBillForecast.onclick= ()=>{ toggleMenu(false); openBillForecast(); };  
  menuHeatmap.onclick     = ()=>{ toggleMenu(false); openHeatmap(); }; // NEW
  menuWorkMap.onclick     = showProAlert; // NEW

  goalsClose.onclick = ()=> { closeGoals(); syncOverlays(); };  

  function setMainButtonsVisible(show){  
    const disp = show ? 'inline-flex' : 'none';  
    menuBtn.style.display = disp;  
    historyBtn.style.display = disp;  
    statsBtn.style.display = disp;  
  }  

  historyBtn.onclick = ()=>{  
    updateTotals();  
    historyPanel.classList.toggle('show');  
    historyPanel.setAttribute('aria-hidden', historyPanel.classList.contains('show')?'false':'true');  
    syncOverlays();  
  };  

  closeHistory.onclick = ()=>{  
    historyPanel.classList.remove('show');  
    historyPanel.setAttribute('aria-hidden','true');  
    syncOverlays();  
  };  

  discardBtn.onclick = ()=>{  
    saveBackdrop.classList.remove('show');  
    vibrate(8);  
    playSound(350, 50);  
    syncOverlays();  
  };  

  saveBtn.onclick = ()=>{  
    saveHistory();  
    syncOverlays();  
  };  

  editCancel.onclick = ()=>{  
    editBackdrop.classList.remove('show');  
    editingId=null;  
    syncOverlays();  
  };  

  editSave.onclick = ()=>{  
    applyEdit();  
    syncOverlays();  
  };  

  confirmNo.onclick = ()=>{  
    confirmBackdrop.classList.remove('show');  
    pendingDeleteId=null;  
    syncOverlays();  
  };  

  confirmYes.onclick = ()=>{  
    if (pendingDeleteId){  
      history = history.filter(h=>String(h.id)!==String(pendingDeleteId));  
      saveHistoryStore();  
      renderHistory();  
      updateTotals();  
      vibrate(15);  
      playSound(500, 60);  
    }  
    pendingDeleteId = null;  
    confirmBackdrop.classList.remove('show');  
    syncOverlays();  
  };  

  function openSettings(){  
    themeSelect.value=prefs.theme;  
    soundToggle.checked=prefs.sound;  
    hapticsToggle.checked=prefs.haptics;  
    settingsBackdrop.classList.add('show');  
    syncOverlays();  
  }  

  settingsBtnFloat.onclick = openSettings;  

  settingsClose.onclick = ()=>{  
    settingsBackdrop.classList.remove('show');  
    syncOverlays();  
  };  

  settingsSave.onclick = ()=>{  
    prefs.theme = themeSelect.value === 'light' ? 'light' : 'dark';  
    prefs.sound = !!soundToggle.checked;  
    prefs.haptics = !!hapticsToggle.checked;  
    applyTheme();  
    savePrefs();  
    settingsBackdrop.classList.remove('show');  
    vibrate(8);  
    playSound(700, 70);  
    syncOverlays();  
  };  

  settingsBackdrop.addEventListener('click', (e)=>{  
    if (e.target===settingsBackdrop){  
      settingsBackdrop.classList.remove('show');  
      syncOverlays();  
    }  
  });  

  startAtBtn.onclick = ()=>{  
    startAtInput.value = toLocalInput(Date.now());  
    startAtBackdrop.classList.add('show');  
    syncOverlays();  
  };  

  startAtCancel.onclick = ()=>{  
    startAtBackdrop.classList.remove('show');  
    syncOverlays();  
  };  

  startAtSave.onclick = ()=>{  
    const val = startAtInput.value;  
    if (!val){ alert('Pick a valid date/time.'); return; }  
    const ts = fromLocalInput(val);  
    const now = Date.now();  
    if (ts <= now){  
      startWallTs = ts;  
      elapsed = now - ts;  
      startTime = now - elapsed;  
      running = true;  
      startInterval();  
      vibrate(12);  
      playSound(1200, 80);  
      scheduledStartTs = null;  
      saveState();  
      updateDisplays(elapsed);  
    } else {  
      scheduledStartTs = ts;  
      startWallTs = ts;  
      elapsed = 0;  
      running = false;  
      if (interval){ clearInterval(interval); interval=null; }  
      updateDisplays(0);  
      vibrate(8);  
      playSound(900, 70);  
      saveState();  
    }  
    startAtBackdrop.classList.remove('show');  
    syncOverlays();  
  };  

  stopAtBtn.onclick = ()=>{  
    stopAtInput.value = toLocalInput(Date.now());  
    stopAtBackdrop.classList.add('show');  
    syncOverlays();  
  };  

  stopAtCancel.onclick = ()=>{  
    stopAtBackdrop.classList.remove('show');  
    syncOverlays();  
  };  

  stopAtSave.onclick = ()=>{  
    const val = stopAtInput.value;  
    if (!val){ alert('Pick a valid date/time.'); return; }  
    if (!startWallTs){ alert('No active session to stop.'); return; }  
    const ts = fromLocalInput(val);  
    const now = Date.now();  
    if (ts <= now){  
      finalizeActiveBreak();  
      running = false;  
      if (interval){ clearInterval(interval); interval=null; }  
      endWallTs = ts;  
      elapsed = Math.max(0, endWallTs - startWallTs);  
      updateDisplays(elapsed);  
      saveState();  
      saveBackdrop.classList.add('show');  
      vibrate(16);  
      playSound(600, 90);  
      scheduledStopTs = null;  
    } else {  
      scheduledStopTs = ts;  
      vibrate(8);  
      playSound(800, 70);  
      saveState();  
    }  
    stopAtBackdrop.classList.remove('show');  
    syncOverlays();  
  };  

  takeBreakBtn.onclick = ()=>{  
    if (onBreak) return;  
    if (running){  
      running = false;  
      if (interval){ clearInterval(interval); interval=null; }  
    }  
    onBreak = true;  
    breakStartTs = Date.now();  
    showBreak();  
    startBreakTicker();  
    breakSummary.classList.remove('show');  
    breakSummary.textContent = "";  
    saveState();  
    vibrate(12);  
    playSound(500, 90);  
  };  

  endBreakBtn.onclick = ()=>{  
    if (!onBreak) return;  
    const now = Date.now();  
    const dur = now - breakStartTs;  
    sessionBreakMs += Math.max(0, dur);  
    onBreak = false;  
    if (breakTicker){  
      clearInterval(breakTicker);  
      breakTicker=null;  
    }  
    breakDisplay.classList.remove('show');  
    breakSummary.textContent = `Break taken: ${humanShort(sessionBreakMs)}`;  
    breakSummary.classList.add('show');  
    startTime = now - elapsed;  
    running = true;  
    startInterval();  
    saveState();  
    vibrate(14);  
    playSound(900, 80);  
  };  

  [alertBackdrop, startAtBackdrop, stopAtBackdrop, exportBackdrop, confirmBackdrop, editBackdrop, saveBackdrop].forEach(el=>{  
    if(el) el.addEventListener('click', (e)=>{  
      if (e.target===el){  
        el.classList.remove('show');  
        syncOverlays();  
      }  
    });  
  });  

  /* ===== Inbox + overlay gating ===== */  

  function anyOverlayOpen(){  
    return (  
      menuPanel.classList.contains('show') ||  
      historyPanel.classList.contains('show') ||  
      goalsPanel.classList.contains('show') ||  
      statsBackdrop.classList.contains('show') ||  
      settingsBackdrop.classList.contains('show') ||  
      saveBackdrop.classList.contains('show') ||  
      editBackdrop.classList.contains('show') ||  
      confirmBackdrop.classList.contains('show') ||  
      startAtBackdrop.classList.contains('show') ||  
      stopAtBackdrop.classList.contains('show') ||  
      exportBackdrop.classList.contains('show') ||  
      expensesPanel.classList.contains('show') ||  
      inboxPanel.classList.contains('show') ||  
      predictionPanel.classList.contains('show') ||  
      billForecastPanel.classList.contains('show') ||
      heatmapPanel.classList.contains('show') || // NEW
      calcPanel.classList.contains('show') ||
      alertBackdrop.classList.contains('show') // NEW
    );  
  }  

  function isMainScreen(){  
    return !anyOverlayOpen();  
  }  

  function refreshInboxBtnVisibility(){  
    if(inboxBtn) inboxBtn.style.display = isMainScreen() ? 'inline-flex' : 'none';  
    if(plusBtn) plusBtn.style.display = isMainScreen() ? 'inline-flex' : 'none'; 
    if(inboxBtn) inboxBtn.setAttribute('aria-expanded', inboxPanel.classList.contains('show') ? 'true' : 'false');  
  }  

  function openInbox(){  
    if (!isMainScreen()) return;  
    inboxPanel.classList.add('show');  
    inboxPanel.setAttribute('aria-hidden','false');  
    inboxBtn.setAttribute('aria-expanded','true');  
    
    // Mark update as seen and remove dot
    inboxBtn.classList.remove('has-new-message');
    try {
      localStorage.setItem(STORE_KEY_UPDATE_SEEN, 'true');
    } catch(e) {}
    
    syncOverlays();  
  }  

  function closeInboxPanel(){  
    inboxPanel.classList.remove('show');  
    inboxPanel.setAttribute('aria-hidden','true');  
    inboxBtn.setAttribute('aria-expanded','false');  
    syncOverlays();  
  }  

  if(inboxBtn) inboxBtn.onclick = ()=>{  
    if (isMainScreen()) openInbox();  
  };  
  
  if(plusBtn) plusBtn.onclick = showProAlert;

  if(closeInbox) closeInbox.onclick = closeInboxPanel;  

  function observeOverlay(el){  
    if (!el) return;  
    new MutationObserver(()=>{  
      syncOverlays();  
    }).observe(el, { attributes:true, attributeFilter:['class','style'] });  
  }  

  [menuPanel, historyPanel, goalsPanel, statsBackdrop, settingsBackdrop,  
   saveBackdrop, editBackdrop, confirmBackdrop, startAtBackdrop, stopAtBackdrop,  
   exportBackdrop, expensesPanel, inboxPanel, predictionPanel, billForecastPanel,
   calcPanel, heatmapPanel, alertBackdrop] // NEW
   .forEach(observeOverlay);  

  function syncOverlays(){  
    const open = anyOverlayOpen();  
    if(blocker) blocker.style.display = open ? 'block' : 'none';  
    const histOpen = historyPanel.classList.contains('show');  
    setMainButtonsVisible(!histOpen);  
    refreshInboxBtnVisibility();  
  }  

  if(blocker) blocker.addEventListener('click', (e)=>{  
    e.stopPropagation();  
  });  

  /* ===== Expenses ===== */  
  const CATEGORY_KEYWORDS = [  
    {cat:'Groceries', words:['walmart','target','aldi','kroger','publix','safeway','food lion','trader joe','whole foods','grocery']},  
    {cat:'Restaurants', words:['restaurant','diner','cafe','bistro','grill','pizza','taco','sub','burger','mcdonald','kfc','chick-fil-a','chipotle','shake shack','popeyes','wendy','bk','domino']},  
    {cat:'Bars & Nightlife', words:['bar','pub','brew','taproom','saloon','club','night']},  
    {cat:'Subscriptions', words:['netflix','spotify','hulu','disney','max','apple tv','prime video','youtube','xbox','playstation','icloud','dropbox','adobe']},  
    {cat:'Bills & Utilities', words:['electric','power','water','gas co','utility','internet','fiber','mobile','phone','comcast','xfinity','att','verizon','spectrum']},  
    {cat:'Auto & Gas', words:['shell','bp','chevron','exxon','7-eleven','circle k','speedway','marathon','gas','oil change','jiffy lube']},  
    {cat:'Healthcare', words:['pharmacy','walgreens','cvs','rite aid','clinic','dental','hospital','urgent care']},  
    {cat:'Entertainment', words:['cinema','theater','concert','ticketmaster','amc','regal','event']},  
    {cat:'Shopping', words:['amazon','best buy','walmart.com','ebay','mall','outlet','foot locker','nike','adidas']},  
    {cat:'Travel', words:['airlines','hotel','airbnb','lyft','uber','booking','expedia','delta','united','southwest','american airlines']}  
  ];  

  function guessCategory(merchant){  
    const q = (merchant||'').toLowerCase();  
    for (const row of CATEGORY_KEYWORDS){  
      if (row.words.some(w=>q.includes(w))) return row.cat;  
    }  
    return 'Other';  
  }  

  function openExpenses(){  
    xpDate.value = new Date().toISOString().slice(0,10);  
    expensesPanel.classList.add('show');  
    expensesPanel.setAttribute('aria-hidden','false');  
    renderExpensesUI();  
    syncOverlays();  
  }  

  function closeExpensesPanel(){  
    expensesPanel.classList.remove('show');  
    expensesPanel.setAttribute('aria-hidden','true');  
    syncOverlays();  
  }  

  closeExpenses.onclick = closeExpensesPanel;  

  xpMerchant.addEventListener('blur', ()=>{  
    if (!xpCategory.value || xpCategory.value === 'Other'){  
      xpCategory.value = guessCategory(xpMerchant.value);  
    }  
  });  

  xpAddBtn.onclick = ()=>{  
    const amt = +(+xpAmount.value||0).toFixed(2);  
    const dateStr = xpDate.value;  
    const merch = (xpMerchant.value||'').trim();  
    const cat = xpCategory.value || guessCategory(merch);  
    const note = (xpNote.value||'').trim();  
    if (!(amt>0) || !dateStr){  
      alert('Enter amount and date.');  
      return;  
    }  
    const ts = new Date(dateStr+'T12:00:00').getTime();  
    const it = {  
      id: Date.now().toString(36)+Math.random().toString(36).slice(2,6),  
      ts,  
      amount:amt,  
      merchant: merch || 'Unknown',  
      category: cat,  
      note  
    };  
    expenses.unshift(it);  
    saveExpenses();  
    xpAmount.value='';  
    xpMerchant.value='';  
    xpNote.value='';  
    renderExpensesUI();  
    vibrate(12);  
    playSound(950, 70);  
  };  

  xpImportBtn.onclick = ()=>{  
    const lines = prompt('Paste lines: YYYY-MM-DD, Merchant, Amount[, Category]');  
    if (!lines) return;  
    const arr = lines.split(/\n+/).map(s=>s.trim()).filter(Boolean);  
    let imported = 0;  
    for (const line of arr){  
      const parts = line.split(',').map(s=>s.trim());  
      if (parts.length < 3) continue;  
      const [d, m, a, c] = parts;  
      const ts = new Date(d+'T12:00:00').getTime();  
      const amount = +(+a||0).toFixed(2);  
      if (!(isFinite(ts) && amount>0)) continue;  
      const cat = c || guessCategory(m);  
      expenses.unshift({  
        id: Date.now().toString(36)+Math.random().toString(36).slice(2,5),  
        ts,  
        amount,  
        merchant:m,  
        category:cat,  
        note:''  
      });  
      imported++;  
    }  
    if (imported) {  
      saveExpenses();  
      renderExpensesUI();  
      vibrate(20);  
      playSound(1100, 80);  
    } else {  
      alert('No valid rows found.');  
    }  
  };  

  xpClearMonthBtn.onclick = ()=>{  
    const now = new Date();  
    const m0 = new Date(now.getFullYear(), now.getMonth(), 1).getTime();  
    const m1 = new Date(now.getFullYear(), now.getMonth()+1, 1).getTime();  
    if (!confirm('Delete all expenses for the current month?')) return;  
    const before = expenses.length;  
    expenses = expenses.filter(e=> !(e.ts>=m0 && e.ts<m1));  
    saveExpenses();  
    renderExpensesUI();  
    alert(`Removed ${before - expenses.length} item(s).`);  
  };  

  function renderExpensesUI(){  
    const now = new Date();  
    const m0 = new Date(now.getFullYear(), now.getMonth(), 1).getTime();  
    const m1 = new Date(now.getFullYear(), now.getMonth()+1, 1).getTime();  

    const monthItems = expenses.filter(e=>e.ts>=m0 && e.ts<m1);  
    const total = monthItems.reduce((a,b)=>a+b.amount,0);  

    const catMap = {};  
    for (const e of monthItems){  
      catMap[e.category] = (catMap[e.category]||0) + e.amount;  
    }  
    const catEntries = Object.entries(catMap).sort((a,b)=>b[1]-a[1]);  
    const top = catEntries[0] || ['‚Äî',0];  

    xpMonthSpend.textContent = fmtMoney(total);  

    const planned = Object.values(budgets).reduce((a,b)=>a+(+b||0),0) || 0;  
    if (planned>0){  
      const pct = Math.min(9999, Math.max(0, total/planned*100)).toFixed(0);  
      const cls = total <= planned*0.8 ? 'budget-ok' : total <= planned ? 'budget-warn' : 'budget-bad';  
      xpBudgetHint.innerHTML = `Planned: ${fmtMoney(planned)} ‚Ä¢ <span class="${cls}">${pct}%</span> of budget`;  
    } else {  
      xpBudgetHint.textContent = 'No budget set';  
    }  

    xpTopCat.textContent = top[0];  
    xpTopCatShare.textContent = top[1]  
      ? `${fmtMoney(top[1])} (${(top[1]/Math.max(1,total)*100).toFixed(1)}%)`  
      : '‚Äî';  

    xpList.innerHTML = '';  
    monthItems.sort((a,b)=>b.ts-a.ts).forEach(e=>{  
      const row = document.createElement('div');  
      row.className = 'xp-item';  
      row.innerHTML = `  
        <div>  
          <div class="m">${e.merchant} ‚Ä¢ <span class="c">${e.category}</span></div>  
          <div class="c">${humanDate(e.ts)} ${e.note ? '‚Ä¢ '+e.note : ''}</div>  
        </div>  
        <div style="display:flex;align-items:center;gap:8px">  
          <div class="amt">-${fmtMoney(e.amount)}</div>  
          <div class="xp-row-actions">  
            <button class="btn-mini edit" data-xp-edit="${e.id}">Edit</button>  
            <button class="btn-mini danger" data-xp-del="${e.id}">Del</button>  
          </div>  
        </div>  
      `;  
      xpList.appendChild(row);  
    });  

    xpList.querySelectorAll('[data-xp-del]').forEach(btn=>{  
      btn.onclick = ()=>{  
        const id = btn.getAttribute('data-xp-del');  
        expenses = expenses.filter(x=>x.id!==id);  
        saveExpenses();  
        renderExpensesUI();  
      };  
    });  

    xpList.querySelectorAll('[data-xp-edit]').forEach(btn=>{  
      btn.onclick = ()=>{  
        const id = btn.getAttribute('data-xp-edit');  
        const it = expenses.find(x=>x.id===id);  
        if (!it) return;  
        const nd = prompt('Edit date (YYYY-MM-DD):', new Date(it.ts).toISOString().slice(0,10)); if (!nd) return;  
        const nm = prompt('Edit merchant:', it.merchant); if (nm===null) return;  
        const na = prompt('Edit amount:', String(it.amount)); if (na===null) return;  
        const nc = prompt('Edit category:', it.category) || it.category;  
        const nn = prompt('Edit note:', it.note ?? '') || '';  
        const ts = new Date(nd+'T12:00:00').getTime();  
        const amt = +(+na||0).toFixed(2);  
        if (!(isFinite(ts)&&amt>0)) {  
          alert('Invalid values.');  
          return;  
        }  
        it.ts = ts;  
        it.merchant = nm.trim()||'Unknown';  
        it.amount = amt;  
        it.category = nc;  
        it.note = nn;  
        saveExpenses();  
        renderExpensesUI();  
      };  
    });  

    renderExpensesCharts(catEntries, monthSeries());  
    renderSuggestions(catEntries, monthItems);  
    updateBillForecast();  
  }  

  function monthSeries(n=6){  
    const out = [];  
    const now = new Date();  
    for (let i=n-1;i>=0;i--){  
      const y = now.getFullYear();  
      const m = now.getMonth()-i;  
      const d0 = new Date(y, m, 1).getTime();  
      const d1 = new Date(y, m+1, 1).getTime();  
      const sum = expenses  
        .filter(e=>e.ts>=d0 && e.ts<d1)  
        .reduce((a,b)=>a+b.amount,0);  
      const label = new Date(y, m, 1).toLocaleString(undefined,{month:'short'});  
      out.push({label, sum});  
    }  
    return out;  
  }  

  function renderExpensesCharts(catEntries, series){  
    if (xpPie) xpPie.destroy();  
    const labels = catEntries.map(([k])=>k);  
    const data = catEntries.map(([,v])=>v);  
    const pieCtx = xpPieCanvas.getContext('2d');  
    xpPie = new Chart(pieCtx, {  
      type:'doughnut',  
      data:{  
        labels,  
        datasets:[{  
          data,  
          backgroundColor:[  
            '#22c55e','#2dd4bf','#60a5fa','#a78bfa','#f59e0b',  
            '#ef4444','#22d3ee','#10b981','#f472b6','#94a3b8','#eab308'  
          ],  
          borderColor:'var(--bg)',  
          borderWidth:2  
        }]  
      },  
      options:{  
        cutout:'60%',  
        plugins:{  
          legend:{labels:{color:'var(--text)'}}  
        }  
      }  
    });  

    if (xpTrend) xpTrend.destroy();  
    const tctx = xpTrendCanvas.getContext('2d');  
    const labels2 = series.map(x=>x.label);  
    const sums = series.map(x=>+x.sum.toFixed(2));  
    const area = {top:0,bottom:180};  
    const g = tctx.createLinearGradient(0, area.top, 0, area.bottom);  
    g.addColorStop(0,'rgba(239,68,68,0.35)');  
    g.addColorStop(1,'rgba(239,68,68,0.05)');  
    
    // const gridColor = 'rgba(148, 163, 184, 0.2)'; // REMOVED: Use global default
    // const tickColor = 'var(--muted)'; // REMOVED: Use global default
    
    xpTrend = new Chart(tctx, {  
      type:'line',  
      data:{  
        labels:labels2,  
        datasets:[{  
          label:'Monthly spend',  
          data:sums,  
          borderColor:'#ef4444',  
          backgroundColor:g,  
          fill:true,  
          tension:.35,  
          pointRadius:3,  
          pointBackgroundColor:'#f87171'  
        }]  
      },  
      options:{  
        plugins:{  
          legend:{display:false},  
          tooltip:{callbacks:{label:(ctx)=>fmtMoney(ctx.raw)}}  
        },  
        scales:{  
          x:{/*ticks:{color:tickColor}, grid: { color: gridColor } */},  
          y:{/*ticks:{color:tickColor}, grid: { color: gridColor },*/ beginAtZero:true}  
        }  
      },  
      plugins:['glow']  
    });  
  }  

  function renderSuggestions(catEntries, monthItems){  
    xpSuggestions.innerHTML = '';  
    if (!monthItems.length){  
      xpSuggestions.innerHTML = '<li>Add a few expenses to see insights.</li>';  
      return;  
    }  

    const total = monthItems.reduce((a,b)=>a+b.amount,0);  
    const byMerchant = {};  
    for (const e of monthItems){  
      const key=e.merchant.toLowerCase();  
      byMerchant[key]=(byMerchant[key]||0)+e.amount;  
    }  
    const topMerch = Object.entries(byMerchant).sort((a,b)=>b[1]-a[1])[0];  

    const add = s => {  
      const li=document.createElement('li');  
      li.textContent=s;  
      xpSuggestions.appendChild(li);  
    };
    const top = catEntries[0];  
    if (top){  
      const share = (top[1]/Math.max(1,total)*100).toFixed(1);  
      const b = (budgets[top[0]]||0);  
      if (b>0){  
        const cls = top[1] > b ? 'over' : 'within';  
        add(`${top[0]} is ${share}% of this month. You are ${cls} its budget (${fmtMoney(top[1])}/${fmtMoney(b)}).`);  
      } else {  
        add(`${top[0]} is ${share}% of this month. Consider setting a budget for it.`);  
      }  
    }  

    const subMerchants = ['netflix','spotify','hulu','disney','max','apple','adobe','xbox','playstation','icloud','youtube','patreon'];  
    const subs = monthItems.filter(e=>subMerchants.some(s=>e.merchant.toLowerCase().includes(s)));  
    if (subs.length){  
      const s = subs.map(e=>`${e.merchant} ${fmtMoney(e.amount)}`).join(', ');  
      add(`Recurring suspects: ${s}. Verify if you still use them.`);  
    }  

    const map = Object.fromEntries(catEntries);  
    const rest = map['Restaurants']||0;  
    const bars  = map['Bars & Nightlife']||0;  
    const groc  = map['Groceries']||0;  
    if (rest + bars > groc * 0.8 && (rest+bars) > 150){  
      add(`Dining/nightlife (${fmtMoney(rest+bars)}) is rivaling groceries (${fmtMoney(groc)}). Try 1‚Äì2 cook-at-home days.`);  
    }  

    const thisWeekStart = startOfWeek(Date.now());
    const lastWeekStart = thisWeekStart - 7*dayMS;  
    const thisWeek = expenses.filter(e=>e.ts>=thisWeekStart).reduce((a,b)=>a+b.amount,0);  
    const lastWeek = expenses.filter(e=>e.ts>=lastWeekStart && e.ts<thisWeekStart).reduce((a,b)=>a+b.amount,0);  
    if (lastWeek>0 && thisWeek > lastWeek*1.3 && thisWeek - lastWeek > 50){  
      add(`Spending is up ${((thisWeek/lastWeek-1)*100).toFixed(0)}% vs last week. Decide what to cut for the next 3 days.`);  
    }  

    if (topMerch && topMerch[1] > total*0.25){  
      add(`One place (${topMerch[0]}) is taking a big chunk this month (${fmtMoney(topMerch[1])}). See if you can trim that.`);  
    }  
  }  

  /* ===== Bill Forecasting Tool ===== */  
  function updateBillForecast(){  
    if (!billForecastPanel) return;  

    const period = bfPeriod.value || 'month';  
    const dailyPace = estimateDailyPace();  

    let income = 0;  
    if (period === 'week'){  
      income = dailyPace * 7;  
    } else if (period === 'biweek'){  
      income = dailyPace * 14;  
    } else if (period === 'month'){  
      income = dailyPace * 30;  
    } else if (period === 'year'){  
      income = dailyPace * 365;  
    } else {  
      income = dailyPace * 30;  
    }  

    const fixedBills = parseFloat(bfFixedBills.value)||0;  

    let variable = 0;  
    if (bfIncludeExpenses.checked){  
      const series = monthSeries(3);  
      const avgMonthly = series.reduce((a,b)=>a+(b.sum||0),0) / (series.length || 1);  
      if (period === 'week'){  
        variable = avgMonthly / 4;  
      } else if (period === 'biweek'){  
        variable = avgMonthly / 2;  
      } else if (period === 'month'){  
        variable = avgMonthly;  
      } else if (period === 'year'){  
        variable = avgMonthly * 12;  
      }  
    }  

    const totalBills = fixedBills + variable;  
    const left = income - totalBills;  

    bfIncome.textContent = fmtMoney(income);  
    bfBills.textContent  = fmtMoney(totalBills);  
    bfLeft.textContent   = fmtMoney(left);  
    bfLeft.classList.toggle('good', left >= 0);
    bfLeft.classList.toggle('bad', left < 0);

    bfHints.innerHTML = '';  
    const addHint = txt => {  
      const li = document.createElement('li');  
      li.textContent = txt;  
      bfHints.appendChild(li);  
    };  

    if (income <= 0){  
      addHint('Start a few sessions so I can learn your income pace.');  
      return;  
    }  

    const billPct = totalBills / Math.max(1,income);  
    if (billPct <= 0.4){  
      addHint('Bills are under 40% of income. Good breathing room.');  
    } else if (billPct <= 0.6){  
      addHint('Bills are between 40‚Äì60% of income. Reasonable, but watch new subscriptions.');  
    } else {  
      addHint('Bills are above 60% of income. Try dropping one or two non-essential costs.');  
    }  

    if (bfIncludeExpenses.checked && variable > 0){  
      addHint('Variable expenses are included. Track them in the Expenses tab and trim the loudest categories.');  
    } else {  
      addHint('Toggle ‚ÄúInclude tracked expenses‚Äù ON to see a fuller picture of your month.');  
    }  

    if (left < 0){  
      addHint('You are forecast to be negative for this period. Either raise your rate, add hours, or cut bills.');  
    } else if (left < income*0.2){  
      addHint('You will have a small cushion. Consider holding some of that for emergencies.');  
    } else {  
      addHint('Nice buffer. You can either save aggressively or relax a bit on small treats.');  
    }  
  }  

  bfPeriod.addEventListener('change', updateBillForecast);  
  bfFixedBills.addEventListener('input', updateBillForecast);  
  bfIncludeExpenses.addEventListener('change', updateBillForecast);  

  /* ===== State save/load ===== */  
  function saveState(){  
    const state = {  
      running,  
      startWallTs,  
      endWallTs,  
      elapsed,  
      rate: parseFloat(rateInput.value)||0,  
      lastSaved: Date.now(),  
      scheduledStartTs,  
      scheduledStopTs,  
      onBreak,  
      breakStartTs,  
      sessionBreakMs  
    };  
    try{  
      localStorage.setItem(STORE_KEY_STATE, JSON.stringify(state));  
    }catch{}  
  }  

  function loadState(){  
    try{  
      const raw = localStorage.getItem(STORE_KEY_STATE);  
      if (!raw) return;  
      const s = JSON.parse(raw)||{};  

      if (typeof s.rate === 'number') rateInput.value = String(s.rate);  
      running = !!s.running;  
      startWallTs = typeof s.startWallTs === 'number' ? s.startWallTs : null;  
      endWallTs   = typeof s.endWallTs   === 'number' ? s.endWallTs   : null;  
      elapsed     = typeof s.elapsed     === 'number' ? s.elapsed     : 0;  
      scheduledStartTs = typeof s.scheduledStartTs === 'number' ? s.scheduledStartTs : null;  
      scheduledStopTs  = typeof s.scheduledStopTs  === 'number' ? s.scheduledStopTs  : null;  
      onBreak      = !!s.onBreak;  
      breakStartTs = typeof s.breakStartTs === 'number' ? s.breakStartTs : null;  
      sessionBreakMs = typeof s.sessionBreakMs === 'number' ? s.sessionBreakMs : 0;  

      if (onBreak && breakStartTs){  
        showBreak();  
        startBreakTicker();  
      }  

      if (running && startWallTs){  
        const now = Date.now();  
        const lastSaved = s.lastSaved || now;
        const elapsedSince = now - lastSaved;
        
        // Recalculate elapsed based on wall clock, not saved state
        elapsed = Math.max(0, now - startWallTs);  
        startTime = now - elapsed;  
        
        update();  
        startInterval();  
      }else{  
        updateDisplays(elapsed);  
      }  
    }catch(e){}  
  }  

  /* ===== Boot ===== */  
  
  // Run intro animation
  setTimeout(() => {
    if (introOverlay) introOverlay.classList.add('hide');
  }, 2000);
  
  loadPrefs();  
  applyTheme(); // This will now also call updateChartDefaults()
  updateChartDefaults(); // Call it once on load
  
  // Check for Update Notification
  try {
    const seenUpdate = localStorage.getItem(STORE_KEY_UPDATE_SEEN);
    if (seenUpdate !== 'true') {
      inboxBtn.classList.add('has-new-message');
    }
  } catch(e) {}

  loadGoals();  
  loadHistoryStore();  
  renderHistory();  
  updateTotals();  

  loadBudgets();  
  loadExpenses();  
  loadState();  
  computePredictions(); 
  updateBillForecast();  
  syncOverlays();  
  
  // Set default rate on calc
  calcRate1.value = rateInput.value;
  calcRate2.value = rateInput.value;

  window.addEventListener('beforeunload', ()=>{  
    saveState();  
    savePrefs();  
    saveGoals();  
    saveBudgets();  
    saveExpenses();  
  });  

  document.addEventListener('visibilitychange', ()=>{  
    if (document.hidden){  
      saveState();  
      savePrefs();  
      saveGoals();  
      saveBudgets();  
      saveExpenses();  
    }  
  });  

  // Main update loop
  setInterval(()=>{  
    if(!document.hidden) {
      update();
    }
  }, 1000/60);  
  
  // Refresh predictions (and thus, trends) every 10 seconds
  setInterval(()=>{  
    if(isMainScreen() && !running) {
       computePredictions();
    }
  }, 10000);
</script>  

</body>  
</html>
