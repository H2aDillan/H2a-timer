<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Earnings Timer â€” Neon Build</title>

<!-- ðŸ”„ Force fresh load -->
<script>
(function(){
  const APP_VERSION = "25"; /* bump to force reload */
  const KEY = "ver_guard_seen";
  try {
    const url  = new URL(location.href);
    const curr = url.searchParams.get("v");
    const seen = sessionStorage.getItem(KEY);
    if (curr !== APP_VERSION) {
      if (seen !== APP_VERSION) {
        sessionStorage.setItem(KEY, APP_VERSION);
        url.searchParams.set("v", APP_VERSION);
        location.replace(url.toString());
      }
    }
  } catch (e) {}
})();
</script>

<style>
  :root{
    --bg:#0b1020;
    --panel:#111931;
    --panel-2:#0f172a;
    --text:#f8fafc;
    --muted:#94a3b8;
    --green:#22c55e;
    --green-2:#16a34a;
    --cyan:#22d3ee;
    --blue:#60a5fa;
    --purple:#a78bfa;
    --amber:#f59e0b;
    --red:#ef4444;
    --glow-soft: 0 0 12px rgba(34,197,94,.35), 0 0 24px rgba(34,197,94,.2);
    --glow-cyan: 0 0 12px rgba(34,211,238,.35), 0 0 24px rgba(34,211,238,.2);
    --glow-purple: 0 0 12px rgba(167,139,250,.35), 0 0 24px rgba(167,139,250,.2);
  }
  *{box-sizing:border-box}
  body{
    font-family:Inter,system-ui,Arial,sans-serif;
    background:radial-gradient(1200px 800px at 20% 10%, #0c1534 0%, #0b1020 40%, #070c19 100%);
    color:var(--text);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    height:100vh;margin:0;overflow:hidden;
  }

  .top{
    position:absolute;top:20px;left:20px;
    display:flex;align-items:center;gap:8px;z-index:5;
  }
  .rate-wrap{
    display:flex;align-items:center;gap:8px;
    background:linear-gradient(180deg,#1a2547,#121a35);
    border:1px solid #334155;border-radius:10px;
    padding:6px 8px;
    box-shadow:0 6px 18px rgba(0,0,0,.25);
  }
  input[type="number"]{
    width:110px;padding:6px 6px;border:none;outline:none;
    font-size:16px;text-align:right;background:transparent;color:var(--text);
  }

  .timer{
    font-size:3rem;margin-bottom:6px;
    text-shadow:0 0 12px rgba(96,165,250,.25);
  }
  .amount{
    font-size:3rem;color:var(--green);margin-bottom:10px;
    text-shadow:0 0 16px rgba(34,197,94,.4);
  }
  .break-timer{
    font-size:1.15rem;color:var(--red);margin-bottom:8px;
    display:none;text-shadow:0 0 12px rgba(239,68,68,.4);
  }
  .break-timer.show{display:block}
  .break-summary{
    font-size:.95rem;color:#eab308;
    background:linear-gradient(180deg,#3b3a1b,#2b2a12);
    border:1px solid #534f1a;padding:6px 10px;border-radius:999px;
    display:none;margin-bottom:10px;
    box-shadow:0 8px 18px rgba(0,0,0,.25);
  }
  .break-summary.show{display:inline-block}

  .buttons{display:flex;gap:10px;margin-bottom:10px}
  .buttons2{
    display:grid;grid-template-columns:repeat(2,1fr);gap:10px;
    width:min(460px,90vw);
  }
  .buttons2 button{width:100%}
  button{
    background:linear-gradient(180deg,#27457e,#1a2f59);
    border:1px solid #314978;color:#fff;
    padding:12px 24px;border-radius:12px;
    font-size:16px;cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,.25);
    transition:transform .06s ease, box-shadow .12s ease, filter .12s ease;
  }
  button:active{transform:translateY(1px);filter:brightness(.95)}
  #start{
    background:linear-gradient(180deg,#1f9b4a,#137a38);
    border-color:#198e41;
    box-shadow:0 10px 24px rgba(0,0,0,.25), 0 0 24px rgba(34,197,94,.25);
  }
  #stop{
    background:linear-gradient(180deg,#b91c1c,#7f1d1d);
    border-color:#991b1b;
  }
  #clear{
    background:linear-gradient(180deg,#475569,#334155);
    border-color:#475569;
  }

  #historyBtn,#statsBtn,#menuBtn{
    position:fixed;bottom:20px;
    background:linear-gradient(180deg,#17233f,#0f1a35);
    color:#fff;border:1px solid #2a3a64;
    border-radius:30px;padding:12px 18px;font-size:16px;
    cursor:pointer;display:inline-flex;align-items:center;gap:8px;
    transition:background .2s, box-shadow .2s;z-index:25;
  }
  #historyBtn:hover,#statsBtn:hover,#menuBtn:hover{background:#1b2a52}
  #historyBtn{left:50%;transform:translateX(-50%)}
  #historyBtn.flash{
    background:#14532d !important;
    box-shadow:0 0 0 6px rgba(34,197,94,.25);
  }
  .book{width:18px;height:18px;fill:#eab308}
  #statsBtn{
    right:20px;box-shadow:var(--glow-soft);
  }
  #statsBtn svg{width:20px;height:20px}
  #statsBtn path{stroke:var(--green)}
  #menuBtn{left:20px}
  .hamburger svg{width:18px;height:18px}

  /* Menu */
  #menuPanel{
    position:fixed;top:0;left:-75%;width:75%;height:100%;max-width:420px;
    background:linear-gradient(180deg,#0e172d,#0a1326);
    border-right:2px solid #2b3f6f;border-radius:0 12px 12px 0;
    transition:left .3s;display:flex;flex-direction:column;
    z-index:30;box-shadow:0 0 40px rgba(0,0,0,.45);
  }
  #menuPanel.show{left:0}
  #menuHeader{
    background:#0b1224;padding:12px 16px;border-radius:0 12px 0 0;
    display:flex;justify-content:space-between;align-items:center;
    border-bottom:1px solid #2b3f6f;
  }
  #menuHeader .title{display:inline-flex;align-items:center;gap:8px}
  #menuHeader h3{margin:0;font-size:18px}
  #closeMenu{
    background:#dc2626;border:none;color:#fff;
    border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px;
  }
  #menuContent{
    padding:12px 16px;
    display:flex;flex-direction:column;gap:10px;
  }
  .menu-item{
    background:linear-gradient(180deg,#0f1a34,#0b1224);
    border:1px solid #2a3a64;border-radius:12px;
    padding:12px 14px;font-size:15px;color:#e2e8f0;
    display:flex;justify-content:space-between;align-items:center;
    cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.25);
  }
  .menu-item .r{opacity:.7}
  #settingsBtnFloat{
    position:absolute;right:20px;bottom:20px;
    background:#0ea5e9;border:1px solid #0284c7;color:#0b1020;
    border-radius:10px;padding:10px 14px;font-size:14px;
    cursor:pointer;box-shadow:var(--glow-cyan);
  }

  /* Goals */
  #goalsPanel{
    position:fixed;inset:0;
    background:radial-gradient(1200px 800px at 80% 0%, #0e1b3a 0%, #0b1224 50%, #09101f 100%);
    display:none;flex-direction:column;z-index:40;
  }
  #goalsPanel.show{display:flex}
  #goalsHeader{
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 16px;border-bottom:1px solid #2b3f6f;background:#0b1224;
  }
  #goalsHeader h3{margin:0;font-size:18px}
  #goalsClose{
    background:#64748b;border:none;color:#fff;
    border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer;
  }
  #goalsBody{
    padding:12px 16px;display:flex;flex-direction:column;
    gap:16px;overflow:auto;flex:1;
  }
  .goal-card{
    background:linear-gradient(180deg,#0f172a,#0c1426);
    border:1px solid #2b3f6f;border-radius:14px;
    padding:14px;box-shadow:0 12px 24px rgba(0,0,0,.28);
  }
  .goal-top{
    display:flex;align-items:center;justify-content:space-between;
    margin-bottom:10px;
  }
  .goal-title{font-weight:800}
  .goal-values{font-size:13px;color:var(--muted)}
  .goal-bar{
    height:18px;background:linear-gradient(180deg,#0a1326,#0c1833);
    border:1px solid #23345e;border-radius:999px;
    overflow:hidden;position:relative;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04);
  }
  .goal-fill{
    height:100%;width:0%;
    background:
      radial-gradient(18px 12px at 20% 50%, rgba(255,255,255,.25), rgba(255,255,255,0) 70%) repeat-x,
      radial-gradient(18px 12px at 60% 50%, rgba(255,255,255,.2),  rgba(255,255,255,0) 70%) repeat-x,
      linear-gradient(90deg,#0ea75a 0%,#22c55e 40%,#86efac 100%);
    background-size: 60px 100%, 90px 100%, auto;
    background-position: var(--wave1,0px) 0, var(--wave2,0px) 0, 0 0;
    filter:saturate(1.25);
    box-shadow:0 0 18px rgba(34,197,94,.55),0 0 38px rgba(34,197,94,.28),inset 0 0 10px rgba(255,255,255,.12);
    transition:width .05s linear;position:relative;
  }
  .goal-fill::after{
    content:"";position:absolute;top:-60%;bottom:-60%;width:100px;left:-100px;
    background:radial-gradient(60px 140px at 0% 50%, rgba(255,255,255,.35), rgba(255,255,255,0) 70%);
    mix-blend-mode:screen;filter:blur(.5px);animation:shimmer 1.6s ease-in-out infinite;
  }
  @keyframes shimmer{
    0%{left:-100px;opacity:0}
    30%{opacity:.5}
    60%{left:20px;opacity:.25}
    100%{left:140px;opacity:0}
  }
  .goal-fill[data-pct="90"],
  .goal-fill[data-pct="91"],
  .goal-fill[data-pct="92"],
  .goal-fill[data-pct="93"],
  .goal-fill[data-pct="94"],
  .goal-fill[data-pct="95"],
  .goal-fill[data-pct="96"],
  .goal-fill[data-pct="97"],
  .goal-fill[data-pct="98"],
  .goal-fill[data-pct="99"],
  .goal-fill[data-pct="100"]{
    animation:nearDonePulse 1.2s ease-in-out infinite;
  }
  @keyframes nearDonePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.25)}}
  .goal-edit{
    display:flex;align-items:center;gap:8px;margin-top:10px;
  }
  .goal-edit label{font-size:13px;color:var(--muted)}
  .goal-edit input{
    flex:1;background:#0b1224;border:1px solid #2b3f6f;
    border-radius:10px;padding:10px 12px;color:var(--text);
  }
  .goal-edit button{
    background:linear-gradient(180deg,#22c55e,#13a24a);
    border:1px solid #15803d;color:#05210f;
    padding:10px 12px;border-radius:10px;font-weight:700;
    cursor:pointer;box-shadow:var(--glow-soft);
  }

  /* History */
  #historyPanel{
    position:fixed;bottom:-75%;left:0;width:100%;max-height:75%;
    background:linear-gradient(180deg,#0f172a,#0b1224);
    color:var(--text);border-top:2px solid #2b3f6f;
    border-radius:12px 12px 0 0;padding:0;
    transition:bottom .3s;display:flex;flex-direction:column;
    z-index:40;box-shadow:0 -8px 28px rgba(0,0,0,.4);
  }
  #historyPanel.show{bottom:0}
  #historyHeader{
    background:#0b1224;padding:12px 16px;border-radius:12px 12px 0 0;
    display:flex;justify-content:space-between;align-items:center;
    border-bottom:1px solid #2b3f6f;
  }
  #historyHeader .title{display:inline-flex;align-items:center;gap:8px}
  #historyHeader h3{margin:0;font-size:18px}
  #closeHistory{
    background:#dc2626;border:none;color:#fff;
    border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px;
  }
  #totals{
    display:grid;grid-template-columns:repeat(2,1fr);gap:10px;
    padding:12px 16px;border-bottom:1px solid #2b3f6f;
  }
  .card{
    background:linear-gradient(180deg,#0f172a,#0b1224);
    border:1px solid #2b3f6f;border-radius:12px;padding:12px;
  }
  .card .k{font-size:12px;color:var(--muted)}
  .card .v{
    font-size:18px;font-weight:800;color:var(--green);
    text-shadow:0 0 12px rgba(34,197,94,.35);
  }
  #historyList{
    list-style:none;padding:12px 16px;margin:0;
    overflow-y:auto;flex-grow:1;
  }
  #historyList li{
    background:linear-gradient(180deg,#0f172a,#101b36);
    border:1px solid #2b3f6f;border-radius:12px;
    padding:10px 12px;margin-bottom:10px;
    display:grid;grid-template-columns:1fr auto;
    gap:10px;align-items:center;
    box-shadow:0 8px 18px rgba(0,0,0,.25);
  }
  .meta{font-size:13px;color:var(--muted);margin-bottom:6px}
  .dur{font-size:15px;font-weight:bold}
  .amt{
    color:var(--green);font-weight:bold;font-size:16px;
    text-shadow:0 0 12px rgba(34,197,94,.35);
  }
  .tag{
    display:inline-block;margin-top:6px;font-size:12px;color:#eab308;
    background:#3b3a1b;border:1px solid #534f1a;
    padding:2px 6px;border-radius:999px;
  }
  .row-actions{display:flex;flex-direction:column;gap:6px}
  .btn-small{
    background:#1a274a;border:1px solid #2a3a64;color:#fff;
    padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer;
  }
  .btn-danger{background:#7f1d1d;border-color:#b91c1c}
  .btn-export{
    background:#0ea5e9;border-color:#0284c7;box-shadow:var(--glow-cyan);
  }

  .backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.6);
    display:none;align-items:center;justify-content:center;
    z-index:50;opacity:0;transition:opacity .25s ease;
  }
  .backdrop.show{display:flex;opacity:1}
  .modal{
    background:linear-gradient(180deg,#0f172a,#0c1427);
    border:1px solid #2b3f6f;border-radius:14px;
    padding:16px;width:340px;max-width:92vw;
    box-shadow:0 12px 32px rgba(0,0,0,.45);
  }
  .modal h3{margin:0 0 10px;text-align:center}
  .field{
    display:flex;align-items:center;gap:8px;
    background:#0b1224;border:1px solid #2b3f6f;
    border-radius:10px;padding:8px 10px;margin-top:8px;
  }
  .actions{display:flex;gap:10px;margin-top:14px}
  .actions button{
    flex:1;padding:10px;border:none;border-radius:10px;
    font-weight:bold;cursor:pointer;
  }

  /* Stats modal */
  #statsBackdrop{
    position:fixed;inset:0;background:rgba(3,6,14,.75);
    display:none;align-items:center;justify-content:center;
    z-index:50;opacity:0;transition:opacity .25s ease;
  }
  #statsBackdrop.show{display:flex;opacity:1}
  #statsModal{
    background:linear-gradient(180deg,#0f172a,#0c1426);
    border:1px solid #2b3f6f;border-radius:18px;
    padding:20px;width:95%;max-width:820px;
    max-height:90vh;overflow-y:auto;
    box-shadow:0 40px 80px rgba(0,0,0,.5);
  }
  .stats-header{
    display:flex;justify-content:space-between;align-items:center;
    border-bottom:1px solid #2b3f6f;padding-bottom:8px;margin-bottom:12px;
  }
  .stats-header h3{margin:0;font-size:20px}
  .stats-close{
    background:#22c55e;border:none;color:#0f172a;
    padding:8px 12px;border-radius:8px;font-weight:bold;cursor:pointer;
  }
  .stat-summary{
    display:grid;grid-template-columns:repeat(3,1fr);
    gap:12px;margin-bottom:12px;
  }
  .stat-card{
    background:radial-gradient(200px 120px at 70% -20%, rgba(34,211,238,.18), transparent 60%),
               linear-gradient(180deg,#0f172a,#0b1224);
    border:1px solid #2b3f6f;border-radius:12px;
    padding:12px;box-shadow:0 16px 28px rgba(0,0,0,.35);
  }
  .stat-title{font-size:13px;color:var(--muted)}
  .stat-value{
    font-size:22px;font-weight:800;color:var(--green);
    text-shadow:0 0 16px rgba(34,197,94,.5);
  }
  .stat-card:nth-child(2) .stat-value{
    color:var(--cyan);text-shadow:0 0 16px rgba(34,211,238,.45);
  }
  .stat-card:nth-child(3) .stat-value{
    color:var(--purple);text-shadow:0 0 16px rgba(167,139,250,.45);
  }
  canvas{
    background:linear-gradient(180deg,#0b1224,#0f172a);
    border:1px solid #2b3f6f;border-radius:14px;
    margin-bottom:14px;
    box-shadow:0 12px 28px rgba(0,0,0,.35), 0 0 24px rgba(96,165,250,.15);
  }

  .break-section{
    margin:12px 0 16px 0;
    background:linear-gradient(180deg,#0f172a,#0b1224);
    border:1px solid #2b3f6f;border-radius:14px;
    padding:14px;box-shadow:0 0 15px rgba(34,197,94,.2);
  }
  .break-title{
    font-size:18px;font-weight:800;color:var(--green);
    text-align:center;margin:0 0 8px 0;
    text-shadow:0 0 12px rgba(34,197,94,.5);letter-spacing:.3px;
  }
  .break-summary-grid{
    display:grid;grid-template-columns:repeat(3,1fr);
    gap:10px;margin-top:10px;text-align:center;
  }
  .break-summary-grid div{
    background:#0f172a;border:1px solid #2b3f6f;
    border-radius:12px;padding:10px;
    box-shadow:0 0 10px rgba(34,197,94,.18);
  }
  .break-summary-grid span{
    display:block;color:var(--green);font-weight:800;
    font-size:16px;margin-top:4px;
  }

  .analytics-info{
    font-size:13px;color:var(--muted);
    display:flex;flex-direction:column;gap:4px;
  }

  /* Inbox */
  #inboxBtn{
    position:fixed;top:20px;right:20px;
    background:linear-gradient(180deg,#17233f,#0f1a35);
    color:#fff;border:1px solid #2a3a64;
    border-radius:20px;padding:10px 14px;font-size:14px;
    cursor:pointer;display:inline-flex;align-items:center;gap:8px;
    transition:background .2s;z-index:35;
  }
  #inboxBtn:hover{background:#1b2a52}
  #inboxBtn svg{width:18px;height:18px}
  #inboxPanel{
    position:fixed;top:0;right:-75%;width:75%;max-width:420px;height:100%;
    background:linear-gradient(180deg,#0e172d,#0a1326);
    border-left:2px solid #2b3f6f;border-radius:12px 0 0 12px;
    transition:right .3s;display:flex;flex-direction:column;z-index:45;
  }
  #inboxPanel.show{right:0}
  #inboxHeader{
    background:#0b1224;padding:12px 16px;
    border-bottom:1px solid #2b3f6f;
    display:flex;justify-content:space-between;align-items:center;
    border-radius:12px 0 0 0;
  }
  #inboxHeader h3{margin:0;font-size:18px}
  #closeInbox{
    background:#64748b;border:none;color:#fff;
    border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer;
  }
  #inboxBody{
    flex:1;display:flex;align-items:center;justify-content:center;padding:16px;
  }
  .inbox-empty{
    color:#94a3b8;font-size:15px;opacity:.9;text-align:center;
    background:linear-gradient(180deg,#0f172a,#0b1224);
    border:1px solid #2b3f6f;border-radius:12px;
    padding:14px 18px;box-shadow:0 12px 24px rgba(0,0,0,.28);
  }

  /* Expenses */
  #expensesPanel{
    position:fixed;top:0;right:-75%;width:75%;max-width:520px;height:100%;
    background:linear-gradient(180deg,#0e172d,#0a1326);
    border-left:2px solid #2b3f6f;border-radius:12px 0 0 12px;
    transition:right .3s;display:flex;flex-direction:column;
    z-index:46;box-shadow:0 0 40px rgba(0,0,0,.45);
  }
  #expensesPanel.show{right:0}
  #expensesHeader{
    background:#0b1224;padding:12px 16px;
    border-bottom:1px solid #2b3f6f;
    display:flex;align-items:center;justify-content:space-between;
    border-radius:12px 0 0 0;
  }
  #expensesHeader h3{margin:0;font-size:18px}
  #closeExpenses{
    background:#64748b;border:none;color:#fff;
    border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer;
  }
  #expensesBody{
    flex:1;overflow:auto;padding:12px 16px;
    display:flex;flex-direction:column;gap:12px;
  }
  .xp-form{
    display:grid;grid-template-columns:1fr 1fr;gap:10px;
    background:linear-gradient(180deg,#0f172a,#0b1224);
    border:1px solid #2b3f6f;border-radius:12px;padding:12px;
  }
  .xp-form .full{grid-column:1/-1}
  .xp-form label{font-size:12px;color:var(--muted)}
  .xp-form input,.xp-form select,.xp-form textarea{
    width:100%;background:#0b1224;border:1px solid #2b3f6f;
    border-radius:10px;padding:10px 12px;color:var(--text);
  }
  .xp-form textarea{min-height:64px;resize:vertical}
  .xp-actions{display:flex;gap:10px}
  .xp-primary{
    background:#22c55e;border:1px solid #15803d;color:#05210f;
    border-radius:10px;padding:10px 12px;font-weight:800;
    cursor:pointer;box-shadow:var(--glow-soft);
  }
  .xp-secondary{
    background:#0ea5e9;border:1px solid #0284c7;
    border-radius:10px;padding:10px 12px;cursor:pointer;
    box-shadow:var(--glow-cyan);
  }
  .xp-cards{display:flex;gap:10px}
  .xp-card{
    flex:1;background:linear-gradient(180deg,#0f172a,#0b1224);
    border:1px solid #2b3f6f;border-radius:12px;padding:12px;
  }
  .xp-card .k{font-size:12px;color:var(--muted)}
  .xp-card .v{font-size:18px;font-weight:800}
  .xp-list{
    background:linear-gradient(180deg,#0f172a,#0b1224);
    border:1px solid #2b3f6f;border-radius:12px;padding:12px;
  }
  .xp-item{
    display:grid;grid-template-columns:1fr auto;gap:8px;
    padding:10px;border:1px solid #2b3f6f;border-radius:10px;
    margin-bottom:8px;
  }
  .xp-item .m{font-weight:700}
  .xp-item .c{font-size:12px;color:var(--muted)}
  .xp-item .amt{font-weight:800;color:#ef4444}
  .xp-row-actions{display:flex;gap:6px}
  .btn-mini{
    background:#1a274a;border:1px solid #2a3a64;
    border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer;
  }
  .btn-mini.danger{background:#7f1d1d;border-color:#b91c1c}
  .btn-mini.edit{background:#15803d;border-color:#166534}
  .xp-chart{
    background:linear-gradient(180deg,#0f172a,#0b1224);
    border:1px solid #2b3f6f;border-radius:12px;padding:12px;
  }
  .xp-note{font-size:12px;color:var(--muted)}
  .budget-ok{color:#22c55e}
  .budget-warn{color:#f59e0b}
  .budget-bad{color:#ef4444}

  /* Global blocker */
  #globalBlocker{
    position:fixed; inset:0; background:transparent;
    display:none; z-index:19; pointer-events:auto;
  }

  /* Light theme tweaks */
  body.light{background:#f5f7fb;color:#0f172a}
  body.light .stat-card,
  body.light #statsModal,
  body.light .goal-card,
  body.light .modal,
  body.light #historyPanel,
  body.light .menu-item,
  body.light .xp-form,
  body.light .xp-card,
  body.light .xp-list{
    background:#ffffff;border-color:#e5e7eb;
  }
  body.light #historyList li{
    background:#ffffff;border-color:#e5e7eb;
  }
  body.light .field{background:#ffffff;border-color:#e5e7eb}
  body.light .goal-bar{background:#eef2ff;border-color:#c7d2fe}

  /* Simple switch for settings (sound / haptics) */
  .switch{position:relative;display:inline-block;width:40px;height:22px}
  .switch input{display:none}
  .slider{
    position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;
    background:#4b5563;border-radius:999px;
    transition:.2s;
  }
  .slider:before{
    position:absolute;content:"";
    height:16px;width:16px;left:3px;top:3px;
    background:white;border-radius:999px;
    transition:.2s;
  }
  input:checked + .slider{background:#22c55e}
  input:checked + .slider:before{transform:translateX(18px)}

  /* Job Reminder + Predictions panels share base modal style */
  #jobReminderBackdrop .modal,
  #predictionBackdrop .modal{
    max-width:380px;
  }
  #predictionBody p{margin:4px 0;font-size:14px}
  #predictionValues{
    display:grid;grid-template-columns:1fr 1fr;gap:6px;
    margin-top:8px;
  }
  #predictionValues div{
    background:#0b1224;border:1px solid #2b3f6f;
    border-radius:10px;padding:8px 10px;font-size:13px;
  }
  #predictionValues span{display:block;font-weight:700;margin-top:3px}
</style>
</head>

<body>
  <!-- ðŸ”’ Invisible glass pane that intercepts clicks when overlays are open -->
  <div id="globalBlocker" aria-hidden="true"></div>

  <div class="top">
    <span>Amount ($/hr):</span>
    <div class="rate-wrap"><input id="rate" type="number" value="25" step="0.01" min="0"></div>
  </div>

  <div class="timer" id="timeDisplay">00:00:00.00</div>
  <div class="amount" id="moneyDisplay">$0.00</div>
  <div class="break-timer" id="breakDisplay">Break: 00:00:00</div>
  <div class="break-summary" id="breakSummary"></div>

  <div class="buttons">
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <button id="clear">Clear</button>
  </div>
  <div class="buttons2">
    <button id="startAtBtn">Start At</button>
    <button id="stopAtBtn">Stop At</button>
    <button id="takeBreakBtn">Take Break</button>
    <button id="endBreakBtn">End Break</button>
  </div>

  <button id="menuBtn" aria-controls="menuPanel" aria-expanded="false">
    <span class="hamburger" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">
        <path d="M4 7h16"></path><path d="M4 12h16"></path><path d="M4 17h16"></path>
      </svg>
    </span>
    Menu
  </button>

  <button id="historyBtn" aria-live="polite">
    <svg class="book" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22V4.5zM6.5 4A.5.5 0 0 0 6 4.5v15a.5.5 0 0 0 .5.5H18V4H6.5z"/>
    </svg>
    History
  </button>

  <button id="statsBtn" title="View Stats">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M4 21h16M6 17V9m4 8V5m4 12v-7m4 7V3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Stats
  </button>

  <button id="inboxBtn" aria-controls="inboxPanel" aria-expanded="false" title="Inbox">
    <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">
      <path d="M4 5h16v14H4z"></path><path d="M22 6l-10 7L2 6"></path>
    </svg>
    Inbox
  </button>

  <!-- Menu -->
  <div id="menuPanel" aria-hidden="true" role="dialog" aria-labelledby="menuTitle">
    <div id="menuHeader">
      <div class="title">
        <span class="hamburger" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round">
            <path d="M4 7h16"></path><path d="M4 12h16"></path><path d="M4 17h16"></path>
          </svg>
        </span>
        <h3 id="menuTitle">Menu</h3>
      </div>
      <button id="closeMenu">Close</button>
    </div>
    <div id="menuContent">
      <div class="menu-item" id="menuGoals"><span>Goals</span><span class="r">â€º</span></div>
      <div class="menu-item" id="menuSummary"><span>Summary</span><span class="r">â€º</span></div>
      <div class="menu-item" id="menuCalc"><span>Calculator</span><span class="r">â€º</span></div>
      <div class="menu-item" id="menuExpenses"><span>Expenses</span><span class="r">â€º</span></div>
      <div class="menu-item" id="menuJobReminder"><span>Job Reminder</span><span class="r">â€º</span></div>
      <div class="menu-item" id="menuPredictions"><span>Predictions</span><span class="r">â€º</span></div>
    </div>
    <button id="settingsBtnFloat" aria-controls="settingsBackdrop">Settings</button>
  </div>

  <!-- Goals -->
  <div id="goalsPanel" aria-hidden="true" role="dialog" aria-labelledby="goalsTitle">
    <div id="goalsHeader">
      <h3 id="goalsTitle">Goals</h3>
      <button id="goalsClose">Back</button>
    </div>
    <div id="goalsBody">
      <div class="goal-card">
        <div class="goal-top">
          <div class="goal-title">Yearly Target</div>
          <div class="goal-values" id="yearlyValues">$0 / $0 (0%)</div>
        </div>
        <div class="goal-bar"><div id="yearlyBar" class="goal-fill"></div></div>
        <div class="goal-edit">
          <label for="yearlyInput">Set target</label>
          <input id="yearlyInput" type="number" min="0" step="0.01" placeholder="e.g. 50000">
          <button id="yearlySave">Save</button>
        </div>
      </div>

      <div class="goal-card">
        <div class="goal-top">
          <div class="goal-title">Monthly Target</div>
          <div class="goal-values" id="monthlyValues">$0 / $0 (0%)</div>
        </div>
        <div class="goal-bar"><div id="monthlyBar" class="goal-fill"></div></div>
        <div class="goal-edit">
          <label for="monthlyInput">Set target</label>
          <input id="monthlyInput" type="number" min="0" step="0.01" placeholder="e.g. 4000">
          <button id="monthlySave">Save</button>
        </div>
      </div>

      <div class="goal-card">
        <div class="goal-top">
          <div class="goal-title">Weekly Target</div>
          <div class="goal-values" id="weeklyValues">$0 / $0 (0%)</div>
        </div>
        <div class="goal-bar"><div id="weeklyBar" class="goal-fill"></div></div>
        <div class="goal-edit">
          <label for="weeklyInput">Set target</label>
          <input id="weeklyInput" type="number" min="0" step="0.01" placeholder="e.g. 1000">
          <button id="weeklySave">Save</button>
        </div>
      </div>

      <div class="goal-card">
        <div class="goal-top">
          <div class="goal-title">Daily Target</div>
          <div class="goal-values" id="dailyValues">$0 / $0 (0%)</div>
        </div>
        <div class="goal-bar"><div id="dailyBar" class="goal-fill"></div></div>
        <div class="goal-edit">
          <label for="dailyInput">Set target</label>
          <input id="dailyInput" type="number" min="0" step="0.01" placeholder="e.g. 200">
          <button id="dailySave">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- History -->
  <div id="historyPanel" aria-hidden="true">
    <div id="historyHeader">
      <div class="title">
        <svg class="book" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v18H6.5A2.5 2.5 0 0 0 4 22V4.5zM6.5 4A.5.5 0 0 0 6 4.5v15a.5.5 0 0 0 .5.5H18V4H6.5z"/>
        </svg>
        <h3>History</h3>
      </div>
      <button id="closeHistory">Close</button>
    </div>
    <div id="totals">
      <div class="card"><div class="k">This week</div><div class="v" id="weekTotal">$0.00</div></div>
      <div class="card"><div class="k">This month</div><div class="v" id="monthTotal">$0.00</div></div>
    </div>
    <ul id="historyList"></ul>
  </div>

  <!-- Inbox -->
  <div id="inboxPanel" aria-hidden="true" role="dialog" aria-labelledby="inboxTitle">
    <div id="inboxHeader"><h3 id="inboxTitle">Inbox</h3><button id="closeInbox">Close</button></div>
    <div id="inboxBody"><div class="inbox-empty">no messages</div></div>
  </div>

  <!-- Expenses -->
  <div id="expensesPanel" aria-hidden="true" role="dialog" aria-labelledby="expensesTitle">
    <div id="expensesHeader"><h3 id="expensesTitle">Expenses</h3><button id="closeExpenses">Close</button></div>
    <div id="expensesBody">
      <div class="xp-form">
        <div>
          <label for="xpAmount">Amount</label>
          <input id="xpAmount" type="number" step="0.01" min="0" placeholder="e.g. 14.99">
        </div>
        <div>
          <label for="xpDate">Date</label>
          <input id="xpDate" type="date">
        </div>
        <div>
          <label for="xpMerchant">Merchant</label>
          <input id="xpMerchant" type="text" placeholder="e.g. McDonald's">
        </div>
        <div>
          <label for="xpCategory">Category</label>
          <select id="xpCategory">
            <option>Auto & Gas</option><option>Groceries</option><option>Restaurants</option>
            <option>Bars & Nightlife</option><option>Subscriptions</option><option>Shopping</option>
            <option>Bills & Utilities</option><option>Healthcare</option><option>Entertainment</option>
            <option>Travel</option><option>Other</option>
          </select>
        </div>
        <div class="full">
          <label for="xpNote">Note</label>
          <textarea id="xpNote" placeholder="Optional note"></textarea>
        </div>
        <div class="full xp-actions">
          <button id="xpAddBtn" class="xp-primary">Add Expense</button>
          <button id="xpImportBtn" class="xp-secondary" title="Paste: 2025-10-08, Walmart, 42.11, Groceries">Quick Import</button>
          <button id="xpClearMonthBtn" class="btn-mini danger" style="margin-left:auto">Clear Current Month</button>
        </div>
      </div>

      <div class="xp-cards">
        <div class="xp-card">
          <div class="k">This Month</div>
          <div class="v" id="xpMonthSpend">$0.00</div>
          <div class="xp-note" id="xpBudgetHint">No budget set</div>
        </div>
        <div class="xp-card">
          <div class="k">Top Category</div>
          <div class="v" id="xpTopCat">â€”</div>
          <div class="xp-note" id="xpTopCatShare">â€”</div>
        </div>
      </div>

      <div class="xp-chart">
        <h4 style="margin:0 0 8px">Category Breakdown</h4>
        <canvas id="xpPie" height="180"></canvas>
        <div class="xp-note">Shows where the monthâ€™s money actually went.</div>
      </div>
      <div class="xp-chart">
        <h4 style="margin:0 0 8px">Monthly Trend</h4>
        <canvas id="xpTrend" height="180"></canvas>
        <div class="xp-note">Last 6 months.</div>
      </div>
      <div class="xp-list">
        <h4 style="margin:0 0 8px">Entries</h4>
        <div id="xpList"></div>
      </div>
      <div class="xp-list">
        <h4 style="margin:0 0 8px">Suggestions</h4>
        <ul id="xpSuggestions" style="margin:0;padding-left:18px"></ul>
      </div>
    </div>
  </div>


  <!-- Save / Edit / Confirm -->
  <div id="saveBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="saveTitle">
    <div class="modal">
      <h3 id="saveTitle">Save this session?</h3>
      <div class="field">
        <span style="font-size:14px;color:#94a3b8;">Tag</span>
        <input id="tagInput" type="text" placeholder="Optional tag">
      </div>
      <div class="actions">
        <button id="discardBtn">No</button>
        <button id="saveBtn">Yes, Save</button>
      </div>
    </div>
  </div>

  <div id="editBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal">
      <h3 id="editTitle">Edit entry</h3>
      <div class="field">
        <label style="width:80px;color:#94a3b8">Start</label>
        <input id="editStart" type="datetime-local">
      </div>
      <div class="field">
        <label style="width:80px;color:#94a3b8">End</label>
        <input id="editEnd" type="datetime-local">
      </div>
      <div class="field">
        <span style="font-size:14px;color:#94a3b8;">Tag</span>
        <input id="editTag" type="text" placeholder="Edit tag">
      </div>
      <div class="actions">
        <button id="editCancel">Cancel</button>
        <button id="editSave">Save changes</button>
      </div>
    </div>
  </div>

  <div id="confirmBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal">
      <h3 id="confirmTitle">Delete this entry?</h3>
      <div class="actions">
        <button id="confirmNo">No</button>
        <button id="confirmYes">Yes</button>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settingsBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal">
      <h3 id="settingsTitle">Settings</h3>
      <div class="field" style="justify-content:space-between;margin-top:0;">
        <span>Theme</span>
        <select id="themeSelect" aria-label="Theme">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>
      <div class="field" style="justify-content:space-between;">
        <span>Sound</span>
        <label class="switch"><input type="checkbox" id="soundToggle"><span class="slider"></span></label>
      </div>
      <div class="field" style="justify-content:space-between;">
        <span>Haptic feedback</span>
        <label class="switch"><input type="checkbox" id="hapticsToggle"><span class="slider"></span></label>
      </div>
      <div class="actions" style="margin-top:16px;">
        <button id="settingsClose" style="background:#6b7280;">Close</button>
        <button id="settingsSave" style="background:#22c55e;">Save</button>
      </div>
    </div>
  </div>

  <!-- Start / Stop at -->
  <div id="startAtBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="startAtTitle">
    <div class="modal">
      <h3 id="startAtTitle">Start At</h3>
      <div class="field">
        <label style="width:90px;color:#94a3b8">Date/Time</label>
        <input id="startAtInput" type="datetime-local">
      </div>
      <div class="actions">
        <button id="startAtCancel" style="background:#6b7280;">Cancel</button>
        <button id="startAtSave" style="background:#22c55e;">Set</button>
      </div>
    </div>
  </div>

  <div id="stopAtBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="stopAtTitle">
    <div class="modal">
      <h3 id="stopAtTitle">Stop At</h3>
      <div class="field">
        <label style="width:90px;color:#94a3b8">Date/Time</label>
        <input id="stopAtInput" type="datetime-local">
      </div>
      <div class="actions">
        <button id="stopAtCancel" style="background:#6b7280;">Cancel</button>
        <button id="stopAtSave" style="background:#22c55e;">Set</button>
      </div>
    </div>
  </div>

  <!-- Export placeholder -->
  <div id="exportBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="exportTitle">
    <div class="modal">
      <h3 id="exportTitle">Export</h3>
      <p style="text-align:center;margin:8px 0 0;">Coming soon.</p>
      <div class="actions" style="margin-top:12px;">
        <button id="exportClose" style="background:#22c55e;">OK</button>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div id="statsBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
    <div id="statsModal">
      <div class="stats-header">
        <h3 id="statsTitle">Performance Dashboard</h3>
        <button class="stats-close" id="statsClose">Close</button>
      </div>
      <div class="stat-summary">
        <div class="stat-card">
          <div class="stat-title">Today</div>
          <div class="stat-value" id="todayEarned">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">This Week</div>
          <div class="stat-value" id="weekEarned">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">This Month</div>
          <div class="stat-value" id="monthEarned">$0.00</div>
        </div>
      </div>
      <canvas id="earningsChart" height="170"></canvas>
      <canvas id="hoursChart" height="170"></canvas>

      <div class="break-section">
        <p class="break-title">Tag Effectiveness (7d)</p>
        <canvas id="breakChart" height="200"></canvas>
        <div class="break-summary-grid" style="margin-top:12px">
          <div>Top Tag<span id="topTag">â€”</span></div>
          <div>Unique Tags<span id="tagCount">0</span></div>
          <div>Top Share<span id="topShare">0%</span></div>
        </div>
      </div>

      <div class="analytics-info">
        <p>Average hourly rate: <span id="avgRate">$0/hr</span></p>
        <p>Average daily earnings (7d): <span id="avgDay">$0</span></p>
        <p>Trend insight: <span id="trend">Stable</span></p>
      </div>
    </div>
  </div>

  <!-- Job Reminder (simple "coming soon") -->
  <div id="jobReminderBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="jobReminderTitle">
    <div class="modal">
      <h3 id="jobReminderTitle">Job Reminder</h3>
      <p style="font-size:14px;color:var(--muted);text-align:center;">
        Job reminder with alarms and tags is coming soon.<br>
        For now, you can use tags in History to mark different jobs.
      </p>
      <div class="actions" style="margin-top:12px;">
        <button id="jobReminderClose" style="background:#22c55e;">Close</button>
      </div>
    </div>
  </div>

  <!-- Predictions panel -->
  <div id="predictionBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="predictionTitle">
    <div class="modal">
      <h3 id="predictionTitle">Predictions</h3>
      <div id="predictionBody">
        <p style="font-size:13px;color:var(--muted);">
          Based on your recent earnings, hereâ€™s what youâ€™re on track to make
          if you keep a similar pace:
        </p>
        <div id="predictionValues">
          <div>Daily<span id="predDaily">$0.00</span></div>
          <div>Weekly<span id="predWeekly">$0.00</span></div>
          <div>Bi-weekly<span id="predBiWeekly">$0.00</span></div>
          <div>Monthly<span id="predMonthly">$0.00</span></div>
          <div style="grid-column:1/-1;">Yearly<span id="predYearly">$0.00</span></div>
        </div>
        <p id="predictionHint" style="margin-top:10px;font-size:13px;color:var(--muted);"></p>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button id="predictionClose" style="background:#22c55e;">Close</button>
      </div>
    </div>
  </div>

  <!-- Chart.js and main script (split into Part 2 + 3) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    /* ========= State ========= */
  let startTime = 0, elapsed = 0, running = false, interval = null;
  let startWallTs = null, endWallTs = null;

  let history = [];
  let editingId = null;
  let pendingDeleteId = null;

  let scheduledStartTs = null;
  let scheduledStopTs = null;

  let onBreak = false;
  let breakStartTs = null;
  let breakTicker = null;
  let sessionBreakMs = 0;

  let prefs = { theme:'dark', sound:true, haptics:true };
  let goals = { yearly:0, monthly:0, weekly:0, daily:0 };

  let expenses = [];
  let budgets = {
    'Groceries': 600, 'Restaurants': 300, 'Bars & Nightlife': 150,
    'Subscriptions': 80, 'Shopping': 250, 'Bills & Utilities': 400,
    'Auto & Gas': 220, 'Healthcare': 120, 'Entertainment': 120,
    'Travel': 0, 'Other': 100
  };

  const STORE_KEY_STATE     = 'earningsTimer_state_v7';
  const STORE_KEY_HISTORY   = 'earningsTimer_history_v2';
  const STORE_KEY_PREFS     = 'earningsTimer_prefs_v1';
  const STORE_KEY_GOALS     = 'earningsTimer_goals_v1';
  const STORE_KEY_EXPENSES  = 'earningsTimer_expenses_v1';
  const STORE_KEY_BUDGETS   = 'earningsTimer_budgets_v1';

  /* ========= Elements ========= */
  const timeDisplay   = document.getElementById('timeDisplay');
  const moneyDisplay  = document.getElementById('moneyDisplay');
  const breakDisplay  = document.getElementById('breakDisplay');
  const breakSummary  = document.getElementById('breakSummary');

  const rateInput = document.getElementById('rate');
  const startBtn = document.getElementById('start');
  const stopBtn  = document.getElementById('stop');
  const clearBtn = document.getElementById('clear');

  const startAtBtn = document.getElementById('startAtBtn');
  const stopAtBtn  = document.getElementById('stopAtBtn');
  const takeBreakBtn = document.getElementById('takeBreakBtn');
  const endBreakBtn  = document.getElementById('endBreakBtn');

  const historyBtn   = document.getElementById('historyBtn');
  const historyPanel = document.getElementById('historyPanel');
  const closeHistory = document.getElementById('closeHistory');
  const historyList  = document.getElementById('historyList');
  const weekTotalEl  = document.getElementById('weekTotal');
  const monthTotalEl = document.getElementById('monthTotal');

  const saveBackdrop  = document.getElementById('saveBackdrop');
  const discardBtn    = document.getElementById('discardBtn');
  const saveBtn       = document.getElementById('saveBtn');
  const tagInput      = document.getElementById('tagInput');

  const editBackdrop = document.getElementById('editBackdrop');
  const editStart = document.getElementById('editStart');
  const editEnd   = document.getElementById('editEnd');
  const editTag   = document.getElementById('editTag');
  const editCancel= document.getElementById('editCancel');
  const editSave  = document.getElementById('editSave');

  const confirmBackdrop = document.getElementById('confirmBackdrop');
  const confirmYes = document.getElementById('confirmYes');
  const confirmNo  = document.getElementById('confirmNo');

  const menuBtn = document.getElementById('menuBtn');
  const menuPanel = document.getElementById('menuPanel');
  const closeMenu = document.getElementById('closeMenu');
  const settingsBtnFloat = document.getElementById('settingsBtnFloat');

  const menuGoals      = document.getElementById('menuGoals');
  const menuSummary    = document.getElementById('menuSummary');
  const menuCalc       = document.getElementById('menuCalc');
  const menuExpenses   = document.getElementById('menuExpenses');
  const menuJobReminder= document.getElementById('menuJobReminder');
  const menuPredictions= document.getElementById('menuPredictions');

  const settingsBackdrop = document.getElementById('settingsBackdrop');
  const settingsClose = document.getElementById('settingsClose');
  const settingsSave  = document.getElementById('settingsSave');
  const themeSelect = document.getElementById('themeSelect');
  const soundToggle = document.getElementById('soundToggle');
  const hapticsToggle = document.getElementById('hapticsToggle');

  const startAtBackdrop = document.getElementById('startAtBackdrop');
  const startAtInput    = document.getElementById('startAtInput');
  const startAtCancel   = document.getElementById('startAtCancel');
  const startAtSave     = document.getElementById('startAtSave');

  const stopAtBackdrop = document.getElementById('stopAtBackdrop');
  const stopAtInput    = document.getElementById('stopAtInput');
  const stopAtCancel   = document.getElementById('stopAtCancel');
  const stopAtSave     = document.getElementById('stopAtSave');

  const exportBackdrop = document.getElementById('exportBackdrop');
  const exportClose = document.getElementById('exportClose');

  const goalsPanel   = document.getElementById('goalsPanel');
  const goalsClose   = document.getElementById('goalsClose');
  const yearlyValues = document.getElementById('yearlyValues');
  const monthlyValues= document.getElementById('monthlyValues');
  const weeklyValues = document.getElementById('weeklyValues');
  const dailyValues  = document.getElementById('dailyValues');
  const yearlyBar = document.getElementById('yearlyBar');
  const monthlyBar= document.getElementById('monthlyBar');
  const weeklyBar = document.getElementById('weeklyBar');
  const dailyBar  = document.getElementById('dailyBar');
  const yearlyInput = document.getElementById('yearlyInput');
  const monthlyInput= document.getElementById('monthlyInput');
  const weeklyInput = document.getElementById('weeklyInput');
  const dailyInput  = document.getElementById('dailyInput');
  const yearlySave  = document.getElementById('yearlySave');
  const monthlySave = document.getElementById('monthlySave');
  const weeklySave  = document.getElementById('weeklySave');
  const dailySave   = document.getElementById('dailySave');

  const statsBtn = document.getElementById('statsBtn');
  const statsBackdrop = document.getElementById('statsBackdrop');
  const statsClose = document.getElementById('statsClose');
  const todayEarned = document.getElementById('todayEarned');
  const weekEarned = document.getElementById('weekEarned');
  const monthEarned = document.getElementById('monthEarned');
  const avgRateEl = document.getElementById('avgRate');
  const avgDayEl = document.getElementById('avgDay');
  const trendEl = document.getElementById('trend');

  const inboxBtn = document.getElementById('inboxBtn');
  const inboxPanel = document.getElementById('inboxPanel');
  const closeInbox = document.getElementById('closeInbox');

  const expensesPanel = document.getElementById('expensesPanel');
  const closeExpenses = document.getElementById('closeExpenses');
  const xpAmount = document.getElementById('xpAmount');
  const xpDate = document.getElementById('xpDate');
  const xpMerchant = document.getElementById('xpMerchant');
  const xpCategory = document.getElementById('xpCategory');
  const xpNote = document.getElementById('xpNote');
  const xpAddBtn = document.getElementById('xpAddBtn');
  const xpImportBtn = document.getElementById('xpImportBtn');
  const xpList = document.getElementById('xpList');
  const xpMonthSpend = document.getElementById('xpMonthSpend');
  const xpBudgetHint = document.getElementById('xpBudgetHint');
  const xpTopCat = document.getElementById('xpTopCat');
  const xpTopCatShare = document.getElementById('xpTopCatShare');
  const xpPieCanvas = document.getElementById('xpPie');
  const xpTrendCanvas = document.getElementById('xpTrend');
  const xpSuggestions = document.getElementById('xpSuggestions');
  const xpClearMonthBtn = document.getElementById('xpClearMonthBtn');

  const jobReminderBackdrop = document.getElementById('jobReminderBackdrop');
  const jobReminderClose = document.getElementById('jobReminderClose');

  const predictionBackdrop = document.getElementById('predictionBackdrop');
  const predictionClose    = document.getElementById('predictionClose');
  const predDaily   = document.getElementById('predDaily');
  const predWeekly  = document.getElementById('predWeekly');
  const predBiWeekly= document.getElementById('predBiWeekly');
  const predMonthly = document.getElementById('predMonthly');
  const predYearly  = document.getElementById('predYearly');
  const predictionHint = document.getElementById('predictionHint');

  const blocker = document.getElementById('globalBlocker');

  let earningsChart = null;
  let hoursChart = null;
  let breakChart = null;
  let xpPie = null;
  let xpTrend = null;

  /* ========= Helpers ========= */
  const pad2 = n => String(n).padStart(2,'0');
  function fmtMoney(n){ return `$${(n||0).toFixed(2)}`; }
  function formatMain(ms){
    const total = Math.max(0, ms|0);
    const h = Math.floor(total/3600000);
    const m = Math.floor((total%3600000)/60000);
    const s = Math.floor((total%60000)/1000);
    const c = Math.floor((total%1000)/10);
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}.${pad2(c)}`;
  }
  function toLocalInput(ts){
    const d = new Date(ts);
    const pad=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function fromLocalInput(val){
    return new Date(val.replace(' ', 'T')).getTime();
  }

  const startOfDay   = ts => { const d = new Date(ts); d.setHours(0,0,0,0); return d.getTime(); };
  const startOfWeek  = ts => { const d=new Date(ts); const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x.getTime(); };
  const startOfMonth = ts => { const d=new Date(ts); const x=new Date(d.getFullYear(), d.getMonth(), 1); x.setHours(0,0,0,0); return x.getTime(); };
  function humanDate(ts){ const d=new Date(ts); return d.toLocaleDateString(); }
  function rangeDays(n){
    const arr=[]; const now=new Date(); now.setHours(0,0,0,0);
    for(let i=n-1;i>=0;i--){ arr.push(+now - i*86400000); }
    return arr;
  }
  function humanShort(ms){
    const t = Math.max(0, ms|0);
    const h = Math.floor(t/3600000);
    const m = Math.floor((t%3600000)/60000);
    const s = Math.floor((t%60000)/1000);
    if (h) return `${h}h ${m}m`;
    if (m) return `${m}m ${s}s`;
    return `${s}s`;
  }

  function vibrate(ms=20){
    if (!prefs.haptics) return;
    if (navigator.vibrate){
      try{ navigator.vibrate(ms); }catch{}
    }
  }
  let audioCtx = null;
  function playSound(freq=880, durMs=70){
    if (!prefs.sound) return;
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine'; o.frequency.value = freq; g.gain.value = 0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      const t = audioCtx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.15, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + durMs/1000);
      o.start(); o.stop(t + durMs/1000 + 0.01);
    }catch{}
  }

  /* ========= Persistence ========= */
  function savePrefs(){
    try{ localStorage.setItem(STORE_KEY_PREFS, JSON.stringify(prefs)); }catch{}
  }
  function loadPrefs(){
    try{
      const raw = localStorage.getItem(STORE_KEY_PREFS);
      if (!raw) return;
      const obj = JSON.parse(raw)||{};
      prefs.theme = obj.theme === 'light' ? 'light' : 'dark';
      prefs.sound = obj.sound !== false;
      prefs.haptics = obj.haptics !== false;
    }catch{}
  }
  function saveGoals(){
    try{ localStorage.setItem(STORE_KEY_GOALS, JSON.stringify(goals)); }catch{}
  }
  function loadGoals(){
    try{
      const raw = localStorage.getItem(STORE_KEY_GOALS);
      if (!raw) return;
      const g = JSON.parse(raw)||{};
      goals.yearly  = +g.yearly  || 0;
      goals.monthly = +g.monthly || 0;
      goals.weekly  = +g.weekly  || 0;
      goals.daily   = +g.daily   || 0;
    }catch{}
  }
  function applyTheme(){
    document.body.classList.toggle('light', prefs.theme === 'light');
  }

  function saveHistoryStore(){
    try{ localStorage.setItem(STORE_KEY_HISTORY, JSON.stringify(history)); }catch(e){}
  }
  function loadHistoryStore(){
    try{
      const raw = localStorage.getItem(STORE_KEY_HISTORY);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) history = arr;
    }catch(e){}
  }

  function saveExpenses(){
    try{ localStorage.setItem(STORE_KEY_EXPENSES, JSON.stringify(expenses)); }catch(e){}
  }
  function loadExpenses(){
    try{
      const raw = localStorage.getItem(STORE_KEY_EXPENSES);
      if (!raw) return;
      const arr = JSON.parse(raw)||[];
      if (Array.isArray(arr)) expenses = arr;
    }catch(e){}
  }
  function saveBudgets(){
    try{ localStorage.setItem(STORE_KEY_BUDGETS, JSON.stringify(budgets)); }catch(e){}
  }
  function loadBudgets(){
    try{
      const raw = localStorage.getItem(STORE_KEY_BUDGETS);
      if (!raw) return;
      const obj = JSON.parse(raw)||{};
      budgets = Object.assign(budgets, obj);
    }catch(e){}
  }

  /* ========= Live contribution ========= */
  function currentSessionContributionSince(tsFloorMs){
    if (!running || onBreak || !startWallTs) return {amount:0, ms:0};
    const rate = parseFloat(rateInput.value)||0;
    const now = Date.now();
    const start = Math.max(startWallTs, tsFloorMs);
    if (now <= start) return {amount:0, ms:0};
    const ms = now - start;
    return {amount: rate*(ms/3600000), ms};
  }
  function sumEntriesBetween(startMs, endMs){
    let ms=0, amount=0, sessions=0, breakMs=0;
    for (const h of history){
      if (h.endTs >= startMs && h.endTs < endMs){
        ms += h.elapsedMs||0;
        amount += h.amount||0;
        sessions += 1;
        breakMs += h.breakMs||0;
      }
    }
    return {ms, amount, sessions, breakMs};
  }
  function sumRangeSince(rangeStart){
    const rate = parseFloat(rateInput.value)||0;
    const now = Date.now();
    let total = history.filter(h=>h.endTs>=rangeStart).reduce((a,b)=>a+(b.amount||0),0);
    if (running && !onBreak && startWallTs){
      const contribMs = Math.max(0, now - Math.max(startWallTs, rangeStart));
      total += rate * (contribMs/3600000);
    }
    return total;
  }

  function update(){
    const now = Date.now();
    const w1 = (now/22)%60;
    const w2 = (now/37)%90;
    [yearlyBar, monthlyBar, weeklyBar, dailyBar].forEach(el=>{
      if (!el) return;
      el.style.setProperty('--wave1', `${w1}px`);
      el.style.setProperty('--wave2', `${w2}px`);
    });

    if (scheduledStartTs && now >= scheduledStartTs && !running && !onBreak){
      scheduledStartTs = null;
      startTimer();
    }
    if (scheduledStopTs && now >= scheduledStopTs && running){
      finalizeActiveBreak();
      scheduledStopTs = null;
      running = false;
      if (interval){ clearInterval(interval); interval=null; }
      endWallTs = now;
      saveState();
      saveBackdrop.classList.add('show');
      vibrate(16); playSound(600, 90);
    }

    if (running){
      elapsed = now - startTime;
      endWallTs = now;
      updateDisplays(elapsed);
      if (now % 500 < 20) saveState();
    }
  }

  function updateDisplays(elapsedMs){
    const rate = parseFloat(rateInput.value)||0;
    const earned = (rate * (elapsedMs / 3600000));
    timeDisplay.textContent = formatMain(elapsedMs);
    moneyDisplay.textContent = fmtMoney(earned);
  }
  function startInterval(){
    if (interval) clearInterval(interval);
    interval = setInterval(update, 16);
  }

  function startTimer(){
    if (running) return;
    running = true;
    const now = Date.now();
    if (!startWallTs) startWallTs = now;
    startTime = now - elapsed;
    startInterval();
    saveState();
    vibrate(12); playSound(1200, 80);
  }

  function finalizeActiveBreak(){
    if (onBreak){
      const now = Date.now();
      const dur = now - breakStartTs;
      sessionBreakMs += Math.max(0, dur);
      onBreak = false;
      if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
      breakDisplay.classList.remove('show');
      breakSummary.textContent = `Break taken: ${humanShort(sessionBreakMs)}`;
      breakSummary.classList.add('show');
    }
  }

  function stopTimer(){
    if (!running) return;
    finalizeActiveBreak();
    running = false;
    if (interval){ clearInterval(interval); interval = null; }
    endWallTs = Date.now();
    saveState();
    saveBackdrop.classList.add('show');
    vibrate(16); playSound(600, 90);
  }

  function clearTimer(){
    if (running){
      alert('Stop the timer first to clear the display.');
      vibrate(8); playSound(400, 60);
      return;
    }
    elapsed = 0; startWallTs = null; endWallTs = null;
    timeDisplay.textContent = "00:00:00.00";
    moneyDisplay.textContent = "$0.00";
    if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
    onBreak = false; breakStartTs = null;
    sessionBreakMs = 0;
    breakDisplay.classList.remove('show');
    breakSummary.classList.remove('show');
    breakSummary.textContent = "";
    saveState();
    vibrate(10); playSound(500, 60);
  }

  function flashHistoryBtn(){
    historyBtn.classList.add('flash');
    setTimeout(()=>historyBtn.classList.remove('flash'), 1000);
  }

  function updateTotals(){
    const now = Date.now(), w0=startOfWeek(now), m0=startOfMonth(now);
    const weekSum = history.filter(h=>h.endTs>=w0).reduce((a,b)=>a+(b.amount||0),0);
    const monthSum = history.filter(h=>h.endTs>=m0).reduce((a,b)=>a+(b.amount||0),0);
    weekTotalEl.textContent = fmtMoney(weekSum);
    monthTotalEl.textContent = fmtMoney(monthSum);
  }

  function renderHistory(){
    historyList.innerHTML = "";
    history.forEach(item=>{
      const startStr = new Date(item.startTs).toLocaleString();
      const endStr = new Date(item.endTs).toLocaleString();
      const li = document.createElement('li');
      li.innerHTML = `
        <div>
          <div class="meta">Start: ${startStr} â€¢ End: ${endStr}${item.tag ? ` â€¢ #${item.tag}` : ''}</div>
          <div class="dur">Duration: ${formatMain(item.elapsedMs)}</div>
          ${item.breakMs ? `<div class="meta"><span class="break-highlight">Break</span>: ${humanShort(item.breakMs)}</div>` : ''}
          <div class="amt">${fmtMoney(item.amount)}</div>
          ${item.tag ? `<div class="tag">#${item.tag}</div>` : ''}
        </div>
        <div class="row-actions">
          <button class="btn-small btn-danger" data-del="${item.id}">Delete</button>
          <button class="btn-small" data-edit="${item.id}">Edit</button>
          <button class="btn-small btn-export" data-export="${item.id}">Export</button>
        </div>
      `;
      historyList.appendChild(li);
    });

    historyList.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick = ()=>{
        pendingDeleteId = btn.getAttribute('data-del');
        confirmBackdrop.classList.add('show');
      };
    });

    historyList.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-edit');
        const entry = history.find(h=>String(h.id)===String(id));
        if (!entry) return;
        editingId = entry.id;
        editStart.value = toLocalInput(entry.startTs);
        editEnd.value = toLocalInput(entry.endTs);
        editTag.value = entry.tag || '';
        editBackdrop.classList.add('show');
      };
    });

    historyList.querySelectorAll('[data-export]').forEach(btn=>{
      btn.onclick = ()=>{ exportBackdrop.classList.add('show'); };
    });
  }

  function saveHistory(){
    const rate = parseFloat(rateInput.value)||0;
    if (!startWallTs) startWallTs = Date.now() - elapsed;
    if (!endWallTs) endWallTs = Date.now();
    const durationMs = Math.max(0, endWallTs - startWallTs);

    if (durationMs > 0){
      const now = new Date(endWallTs);
      const entry = {
        id: now.getTime().toString()+Math.random().toString(36).slice(2,6),
        startTs: startWallTs,
        endTs: endWallTs,
        elapsedMs: durationMs,
        amount: +(rate * (durationMs/3600000)).toFixed(2),
        tag: (tagInput.value||'').trim(),
        breakMs: sessionBreakMs || 0
      };
      history.unshift(entry);
      saveHistoryStore();
      tagInput.value = '';
      renderHistory();
      updateTotals();
      flashHistoryBtn();
      vibrate(20); playSound(900, 80);
    }

    saveBackdrop.classList.remove('show');
    elapsed = 0; startWallTs = null; endWallTs = null;
    sessionBreakMs = 0;
    if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
    onBreak = false; breakStartTs = null;
    breakDisplay.classList.remove('show');
    breakSummary.classList.remove('show');
    breakSummary.textContent = "";
    updateDisplays(0);
    saveState();
  }

  function applyEdit(){
    if (!editingId) return;
    const entry = history.find(h=>h.id===editingId);
    if (!entry) return;

    const s = editStart.value, e = editEnd.value;
    if (!s || !e) { alert('Provide both start and end.'); return; }
    const startTs = fromLocalInput(s), endTs = fromLocalInput(e);
    if (!(isFinite(startTs)&&isFinite(endTs)) || endTs < startTs){
      alert('End must be after Start.');
      return;
    }
    const rate = parseFloat(rateInput.value)||0;
    const dur = endTs - startTs;
    entry.startTs = startTs;
    entry.endTs = endTs;
    entry.elapsedMs = dur;
    entry.amount = +(rate * (dur/3600000)).toFixed(2);
    entry.tag = (editTag.value||'').trim();

    saveHistoryStore();
    editingId = null;
    editBackdrop.classList.remove('show');
    renderHistory();
    updateTotals();
    vibrate(15); playSound(800, 70);
  }

  function showBreak(){ breakDisplay.classList.add('show'); }
  function startBreakTicker(){
    if (breakTicker) clearInterval(breakTicker);
    breakDisplay.textContent = `Break: 00:00:00`;
    breakTicker = setInterval(()=>{
      const ms = Date.now() - breakStartTs;
      const h = Math.floor(ms/3600000),
            m = Math.floor((ms%3600000)/60000),
            s = Math.floor((ms%60000)/1000);
      breakDisplay.textContent = `Break: ${pad2(h)}:${pad2(m)}:${pad2(s)}`;
    }, 250);
  }

  /* ===== Goals open/close + SAVE FIX ===== */
  let goalsRAF = null;
  function openGoals(){
    yearlyInput.value  = goals.yearly  ? String(goals.yearly)  : '';
    monthlyInput.value = goals.monthly ? String(goals.monthly) : '';
    weeklyInput.value  = goals.weekly  ? String(goals.weekly)  : '';
    dailyInput.value   = goals.daily   ? String(goals.daily)   : '';

    goalsPanel.classList.add('show');
    goalsPanel.setAttribute('aria-hidden','false');

    const tick = ()=>{
      renderGoalBars();
      goalsRAF = requestAnimationFrame(tick);
    };
    if (!goalsRAF) goalsRAF = requestAnimationFrame(tick);
  }
  function closeGoals(){
    goalsPanel.classList.remove('show');
    goalsPanel.setAttribute('aria-hidden','true');
    if (goalsRAF){ cancelAnimationFrame(goalsRAF); goalsRAF = null; }
  }
  function clampPct(n){ return Math.max(0, Math.min(100, n)); }
  function renderGoalBars(){
    const now = Date.now();
    const year0  = (new Date(new Date(now).getFullYear(),0,1)).getTime();
    const month0 = (new Date(new Date(now).getFullYear(),new Date(now).getMonth(),1)).getTime();
    const week0  = (function(){
      const d=new Date(now); const x=new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return +x;
    })();
    const day0   = (function(d){ d=new Date(now); d.setHours(0,0,0,0); return +d; })();


    const yVal = sumRangeSince(year0);
    const mVal = sumRangeSince(month0);
    const wVal = sumRangeSince(week0);
    const dVal = sumRangeSince(day0);

    const yT = goals.yearly  || 0;
    const mT = goals.monthly || 0;
    const wT = goals.weekly  || 0;
    const dT = goals.daily   || 0;

    const yPct = yT ? clampPct((yVal / yT) * 100) : 0;
    const mPct = mT ? clampPct((mVal / mT) * 100) : 0;
    const wPct = wT ? clampPct((wVal / wT) * 100) : 0;
    const dPct = dT ? clampPct((dVal / dT) * 100) : 0;

    yearlyBar.style.width  = `${yPct}%`;  yearlyBar.dataset.pct  = String(Math.floor(yPct));
    monthlyBar.style.width = `${mPct}%`;  monthlyBar.dataset.pct = String(Math.floor(mPct));
    weeklyBar.style.width  = `${wPct}%`;  weeklyBar.dataset.pct  = String(Math.floor(wPct));
    dailyBar.style.width   = `${dPct}%`;  dailyBar.dataset.pct   = String(Math.floor(dPct));

    yearlyValues.textContent  = `${fmtMoney(yVal)} / ${fmtMoney(yT)} (${Math.floor(yPct)}%)`;
    monthlyValues.textContent = `${fmtMoney(mVal)} / ${fmtMoney(mT)} (${Math.floor(mPct)}%)`;
    weeklyValues.textContent  = `${fmtMoney(wVal)} / ${fmtMoney(wT)} (${Math.floor(wPct)}%)`;
    dailyValues.textContent   = `${fmtMoney(dVal)} / ${fmtMoney(dT)} (${Math.floor(dPct)}%)`;
  }
  yearlySave.onclick  = ()=>{ goals.yearly  = +yearlyInput.value  || 0; saveGoals(); renderGoalBars(); vibrate(8); playSound(900,70); };
  monthlySave.onclick = ()=>{ goals.monthly = +monthlyInput.value || 0; saveGoals(); renderGoalBars(); vibrate(8); playSound(900,70); };
  weeklySave.onclick  = ()=>{ goals.weekly  = +weeklyInput.value  || 0; saveGoals(); renderGoalBars(); vibrate(8); playSound(900,70); };
  dailySave.onclick   = ()=>{ goals.daily   = +dailyInput.value   || 0; saveGoals(); renderGoalBars(); vibrate(8); playSound(900,70); };

  /* ===== Charts plugin ===== */
  const glowPlugin = {
    id:'glow',
    afterDatasetsDraw(chart){
      const ctx = chart.ctx;
      ctx.save();
      chart.data.datasets.forEach((ds, i)=>{
        const meta = chart.getDatasetMeta(i);
        if (!meta.data) return;
        ctx.shadowColor = (ds.borderColor || 'rgba(255,255,255,.5)');
        ctx.shadowBlur = 16;
        ctx.shadowOffsetX=0;
        ctx.shadowOffsetY=0;
        meta.data.forEach(pt=>{
          ctx.beginPath();
          ctx.arc(pt.x, pt.y, 3.5, 0, Math.PI*2);
          ctx.fillStyle = Array.isArray(ds.pointBackgroundColor)
            ? ds.pointBackgroundColor[0]
            : (ds.pointBackgroundColor || ds.backgroundColor || '#fff');
          ctx.fill();
        });
      });
      ctx.restore();
    }
  };
  Chart.register(glowPlugin);

  function gradient(ctx, area, from, to){
    const g = ctx.createLinearGradient(0, area.bottom, 0, area.top);
    g.addColorStop(0, from); g.addColorStop(1, to);
    return g;
  }

  function openStats(){ renderStats(); statsBackdrop.classList.add('show'); syncOverlays(); }
  function closeStats(){ statsBackdrop.classList.remove('show'); syncOverlays(); }
  statsBtn.onclick = openStats;
  statsClose.onclick = closeStats;
  statsBackdrop.addEventListener('click',(e)=>{ if (e.target===statsBackdrop) closeStats(); });

  function labelsFromDates(days){
    return days.map(ts=>["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(ts).getDay()]);
  }

  // ðŸŽ¯ Tag color generator for legend squares
  function colorForTag(tag, idx){
    const base = (Array.from(tag||'Untagged').reduce((a,c)=>a+c.charCodeAt(0),0)+idx*37)%360;
    return `hsl(${base}, 70%, 55%)`;
  }

  function renderStats(){
    const now = Date.now();
    const d0 = (d=>{d=new Date(now); d.setHours(0,0,0,0); return +d;})();
    const w0 = (function(){
      const d=new Date(now); const x=new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return +x;
    })();
    const m0 = (d=>{d=new Date(now); d.setDate(1); d.setHours(0,0,0,0); return +d;})();

    const todayFixed = sumEntriesBetween(d0, d0+86400000);
    const todayLive = currentSessionContributionSince(d0);
    const todayAmount = todayFixed.amount + todayLive.amount;

    const weekFixed = sumEntriesBetween(w0, w0 + 7*86400000);
    const weekLive = currentSessionContributionSince(w0);
    const weekAmount = weekFixed.amount + weekLive.amount;

    const mEnd = new Date(new Date(m0).getFullYear(), new Date(m0).getMonth()+1, 1).getTime();
    const monthFixed = sumEntriesBetween(m0, mEnd);
    const monthLive = currentSessionContributionSince(m0);
    const monthAmount = monthFixed.amount + monthLive.amount;

    todayEarned.textContent = fmtMoney(todayAmount);
    weekEarned.textContent  = fmtMoney(weekAmount);
    monthEarned.textContent = fmtMoney(monthAmount);

    const last7 = rangeDays(7);
    const earningsSeries = last7.map(d=>{
      const fx = sumEntriesBetween(d, d+86400000);
      const live = (d===d0) ? currentSessionContributionSince(d) : {amount:0,ms:0};
      return +(fx.amount + live.amount).toFixed(2);
    });
    const hoursSeries = last7.map(d=>{
      const fx = sumEntriesBetween(d, d+86400000);
      const live = (d===d0) ? currentSessionContributionSince(d) : {amount:0, ms:0};
      return +(((fx.ms + live.ms)/3600000).toFixed(2));
    });

    const total7 = earningsSeries.reduce((a,b)=>a+b,0);
    const hours7 = hoursSeries.reduce((a,b)=>a+b,0);
    const avgRate = hours7>0 ? (total7/hours7) : 0;
    const avgDay = total7/7;
    avgRateEl.textContent = `${fmtMoney(avgRate)}/hr`;
    avgDayEl.textContent = fmtMoney(avgDay);
    trendEl.textContent = earningsSeries[6] >= earningsSeries[5] ? "Uptrend" : "Slight dip";

    renderCharts(labelsFromDates(last7), earningsSeries, hoursSeries);

    /* ðŸ¥¯ Tag donut: sum earnings by tag for current week */
    const tagMap = {};
    for (const h of history){
      if (h.endTs >= w0){
        const key = (h.tag && h.tag.trim()) ? h.tag.trim() : 'Untagged';
        tagMap[key] = (tagMap[key]||0) + (h.amount||0);
      }
    }
    const tagEntries = Object.entries(tagMap).sort((a,b)=>b[1]-a[1]);
    const labels = tagEntries.map(([k])=>k);
    const data   = tagEntries.map(([,v])=>+v.toFixed(2));
    const colors = labels.map((t,i)=>colorForTag(t,i));

    const top = tagEntries[0];
    const sum = data.reduce((a,b)=>a+b,0) || 1;
    document.getElementById('topTag').textContent = top ? `#${top[0]}` : 'â€”';
    document.getElementById('tagCount').textContent = String(labels.length);
    document.getElementById('topShare').textContent = top ? `${((top[1]/sum)*100).toFixed(1)}%` : '0%';

    if (breakChart) breakChart.destroy();
    const bctx = document.getElementById('breakChart').getContext('2d');
    breakChart = new Chart(bctx, {
      type:'doughnut',
      data:{ labels, datasets:[{
        data,
        backgroundColor:colors,
        borderColor:'#0b1224',
        borderWidth:2,
        hoverOffset:10
      }]},
      options:{
        cutout:'68%',
        plugins:{
          legend:{
            position:'top',
            align:'center',
            labels:{
              color:'#e2e8f0',
              usePointStyle:true,
              pointStyle:'rect',
              boxWidth:12,
              boxHeight:12,
              padding:12
            }
          },
          tooltip:{callbacks:{label:(ctx)=> `${ctx.label}: ${fmtMoney(ctx.raw||0)}`}}
        },
        animation:{animateRotate:true, animateScale:true}
      }
    });
  }

  function renderCharts(labels, earnings, hours){
    const ectx = document.getElementById('earningsChart').getContext('2d');
    const hctx = document.getElementById('hoursChart').getContext('2d');

    if (earningsChart) earningsChart.destroy();
    if (hoursChart) hoursChart.destroy();

    const eArea = {top:0,bottom:170}, hArea = {top:0,bottom:170};
    const hoursFill = gradient(hctx, hArea, 'rgba(96,165,250,0.08)','rgba(96,165,250,0.35)');
    const barColors = earnings.map((v,i)=> i===labels.length-1
      ? 'rgba(34,197,94,1)'
      : ['#22c55e','#2dd4bf','#60a5fa','#a78bfa','#f59e0b','#ef4444','#22d3ee'][i%7]);

    earningsChart = new Chart(ectx, {
      type:'bar',
      data:{
        labels,
        datasets:[{
          label:'Earnings ($)',
          data:earnings,
          backgroundColor: barColors,
          borderColor:'#0ea5e9',
          borderWidth:1.2,
          hoverBackgroundColor: barColors
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{display:false},
          tooltip:{callbacks:{label:(ctx)=>'$'+ctx.raw.toFixed(2)}}
        },
        scales:{
          x:{ticks:{color:'#e2e8f0'}},
          y:{ticks:{color:'#e2e8f0'}, beginAtZero:true}
        }
      },
      plugins:['glow']
    });

    hoursChart = new Chart(hctx, {
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'Hours Worked',
          data:hours,
          fill:true,
          borderColor:'#60a5fa',
          backgroundColor:hoursFill,
          tension:.35,
          pointRadius:3,
          pointHoverRadius:4,
          pointBackgroundColor:'#38bdf8'
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{display:false},
          tooltip:{callbacks:{label:(ctx)=>`${ctx.raw.toFixed(2)} h`}}
        },
        scales:{
          x:{ticks:{color:'#e2e8f0'}},
          y:{ticks:{color:'#e2e8f0'}, beginAtZero:true}
        }
      },
      plugins:['glow']
    });
  }

  /* ===== Predictions ===== */
  function openPredictions(){
    const last7 = rangeDays(7);
    const today0 = startOfDay(Date.now());
    const earningsSeries = last7.map(d=>{
      const fx = sumEntriesBetween(d, d+86400000);
      const live = (d===today0) ? currentSessionContributionSince(d) : {amount:0,ms:0};
      return +(fx.amount + live.amount).toFixed(2);
    });
    const total7 = earningsSeries.reduce((a,b)=>a+b,0);
    const avgDay = total7/7;

    predDaily.textContent    = fmtMoney(avgDay);
    predWeekly.textContent   = fmtMoney(avgDay*7);
    predBiWeekly.textContent = fmtMoney(avgDay*14);
    predMonthly.textContent  = fmtMoney(avgDay*30);
    predYearly.textContent   = fmtMoney(avgDay*365);

    if (avgDay > 0){
      predictionHint.textContent =
        `If you keep this 7-day pace, youâ€™ll hit about ${fmtMoney(avgDay*30)} per month.`;
    } else {
      predictionHint.textContent = 'Start a few work sessions to see realistic predictions.';
    }

    predictionBackdrop.classList.add('show');
    syncOverlays();
  }
  predictionClose.onclick = ()=>{
    predictionBackdrop.classList.remove('show');
    syncOverlays();
  };

  /* ===== Job Reminder (coming soon panel) ===== */
  function openJobReminder(){
    jobReminderBackdrop.classList.add('show');
    syncOverlays();
  }
  function closeJobReminder(){
    jobReminderBackdrop.classList.remove('show');
    syncOverlays();
  }
  if (jobReminderClose){
    jobReminderClose.onclick = closeJobReminder;
  }

  /* ===== Menu / Buttons wiring ===== */
  exportClose.onclick = ()=>{ exportBackdrop.classList.remove('show'); };

  startBtn.onclick = startTimer;
  stopBtn.onclick  = stopTimer;
  clearBtn.onclick = clearTimer;

  function toggleMenu(forceOpen){
    const willOpen = typeof forceOpen === 'boolean'
      ? forceOpen
      : !menuPanel.classList.contains('show');
    menuPanel.classList.toggle('show', willOpen);
    menuPanel.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
    menuBtn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
    syncOverlays();
  }
  menuBtn.onclick = ()=> toggleMenu();
  closeMenu.onclick = ()=> toggleMenu(false);

  menuGoals.onclick    = ()=>{ toggleMenu(false); openGoals(); };
  menuSummary.onclick  = ()=>{ toggleMenu(false); alert('Summary: coming soon.'); };
  menuCalc.onclick     = ()=>{ toggleMenu(false); alert('Calculator: coming soon.'); };
  menuExpenses.onclick = ()=>{ toggleMenu(false); openExpenses(); };
  if (menuJobReminder){
    menuJobReminder.onclick = ()=>{ toggleMenu(false); openJobReminder(); };
  }
  if (menuPredictions){
    menuPredictions.onclick = ()=>{ toggleMenu(false); openPredictions(); };
  }

  goalsClose.onclick = ()=>{ closeGoals(); };

  /* ðŸ”’ Hide Menu/History/Stats while History is open */
  function setMainButtonsVisible(show){
    const disp = show ? 'inline-flex' : 'none';
    menuBtn.style.display = disp;
    historyBtn.style.display = disp;
    statsBtn.style.display = disp;
  }

  historyBtn.onclick = ()=>{
    updateTotals();
    const on = !historyPanel.classList.contains('show');
    historyPanel.classList.toggle('show', on);
    historyPanel.setAttribute('aria-hidden', on ? 'false' : 'true');
    syncOverlays();
  };
  closeHistory.onclick = ()=>{
    historyPanel.classList.remove('show');
    historyPanel.setAttribute('aria-hidden','true');
    syncOverlays();
  };

  discardBtn.onclick = ()=>{
    saveBackdrop.classList.remove('show');
    vibrate(8); playSound(350, 50);
    syncOverlays();
  };
  saveBtn.onclick = ()=>{
    saveHistory();
    syncOverlays();
  };

  editCancel.onclick = ()=>{
    editBackdrop.classList.remove('show');
    editingId = null;
    syncOverlays();
  };
  editSave.onclick = ()=>{
    applyEdit();
    syncOverlays();
  };

  confirmNo.onclick = ()=>{
    confirmBackdrop.classList.remove('show');
    pendingDeleteId = null;
    syncOverlays();
  };
  confirmYes.onclick = ()=>{
    if (pendingDeleteId){
      history = history.filter(h=>String(h.id)!==String(pendingDeleteId));
      saveHistoryStore();
      renderHistory();
      updateTotals();
      vibrate(15); playSound(500, 60);
    }
    pendingDeleteId = null;
    confirmBackdrop.classList.remove('show');
    syncOverlays();
  };

  /* ===== Settings panel ===== */
  function openSettings(){
    themeSelect.value = prefs.theme;
    soundToggle.checked = prefs.sound;
    hapticsToggle.checked = prefs.haptics;
    settingsBackdrop.classList.add('show');
    syncOverlays();
  }
  settingsBtnFloat.onclick = openSettings;
  settingsClose.onclick = ()=>{
    settingsBackdrop.classList.remove('show');
    syncOverlays();
  };
  settingsSave.onclick = ()=>{
    prefs.theme = themeSelect.value === 'light' ? 'light' : 'dark';
    prefs.sound = !!soundToggle.checked;
    prefs.haptics = !!hapticsToggle.checked;
    applyTheme();
    savePrefs();
    settingsBackdrop.classList.remove('show');
    vibrate(8); playSound(700, 70);
    syncOverlays();
  };
  settingsBackdrop.addEventListener('click', (e)=>{
    if (e.target === settingsBackdrop){
      settingsBackdrop.classList.remove('show');
      syncOverlays();
    }
  });

  /* ===== Start At / Stop At scheduling ===== */
  startAtBtn.onclick = ()=>{
    startAtInput.value = toLocalInput(Date.now());
    startAtBackdrop.classList.add('show');
    syncOverlays();
  };
  startAtCancel.onclick = ()=>{
    startAtBackdrop.classList.remove('show');
    syncOverlays();
  };
  startAtSave.onclick = ()=>{
    const val = startAtInput.value;
    if (!val){ alert('Pick a valid date/time.'); return; }
    const ts = fromLocalInput(val);
    const now = Date.now();
    if (ts <= now){
      // backfill elapsed & start immediately
      startWallTs = ts;
      elapsed = now - ts;
      startTime = now - elapsed;
      running = true;
      startInterval();
      vibrate(12); playSound(1200, 80);
      scheduledStartTs = null;
      saveState();
      updateDisplays(elapsed);
    } else {
      // schedule for future
      scheduledStartTs = ts;
      startWallTs = ts;
      elapsed = 0;
      running = false;
      if (interval){ clearInterval(interval); interval = null; }
      updateDisplays(0);
      vibrate(8); playSound(900, 70);
      saveState();
    }
    startAtBackdrop.classList.remove('show');
    syncOverlays();
  };

  stopAtBtn.onclick = ()=>{
    stopAtInput.value = toLocalInput(Date.now());
    stopAtBackdrop.classList.add('show');
    syncOverlays();
  };
  stopAtCancel.onclick = ()=>{
    stopAtBackdrop.classList.remove('show');
    syncOverlays();
  };
  stopAtSave.onclick = ()=>{
    const val = stopAtInput.value;
    if (!val){ alert('Pick a valid date/time.'); return; }
    if (!startWallTs){ alert('No active session to stop.'); return; }
    const ts = fromLocalInput(val);
    const now = Date.now();
    if (ts <= now){
      finalizeActiveBreak();
      running = false;
      if (interval){ clearInterval(interval); interval = null; }
      endWallTs = ts;
      elapsed = Math.max(0, endWallTs - startWallTs);
      updateDisplays(elapsed);
      saveState();
      saveBackdrop.classList.add('show');
      vibrate(16); playSound(600, 90);
      scheduledStopTs = null;
    } else {
      scheduledStopTs = ts;
      vibrate(8); playSound(800, 70);
      saveState();
    }
    stopAtBackdrop.classList.remove('show');
    syncOverlays();
  };

  /* ===== Break controls ===== */
  takeBreakBtn.onclick = ()=>{
    if (onBreak) return;
    if (running){
      running = false;
      if (interval){ clearInterval(interval); interval=null; }
    }
    onBreak = true;
    breakStartTs = Date.now();
    showBreak();
    startBreakTicker();
    breakSummary.classList.remove('show');
    breakSummary.textContent = "";
    saveState();
    vibrate(12); playSound(500, 90);
  };

  endBreakBtn.onclick = ()=>{
    if (!onBreak) return;
    const now = Date.now();
    const dur = now - breakStartTs;
    sessionBreakMs += Math.max(0, dur);
    onBreak = false;
    if (breakTicker){ clearInterval(breakTicker); breakTicker=null; }
    breakDisplay.classList.remove('show');
    breakSummary.textContent = `Break taken: ${humanShort(sessionBreakMs)}`;
    breakSummary.classList.add('show');
    startTime = now - elapsed;
    running = true;
    startInterval();
    saveState();
    vibrate(14); playSound(900, 80);
  };

  /* ===== Inbox gating & overlays ===== */
  function anyOverlayOpen(){
    return (
      menuPanel.classList.contains('show') ||
      historyPanel.classList.contains('show') ||
      goalsPanel.classList.contains('show') ||
      statsBackdrop.classList.contains('show') ||
      settingsBackdrop.classList.contains('show') ||
      saveBackdrop.classList.contains('show') ||
      editBackdrop.classList.contains('show') ||
      confirmBackdrop.classList.contains('show') ||
      startAtBackdrop.classList.contains('show') ||
      stopAtBackdrop.classList.contains('show') ||
      exportBackdrop.classList.contains('show') ||
      expensesPanel.classList.contains('show') ||
      inboxPanel.classList.contains('show') ||
      jobReminderBackdrop.classList.contains('show') ||
      predictionBackdrop.classList.contains('show')
    );
  }
  function isMainScreen(){ return !anyOverlayOpen(); }

  function refreshInboxBtnVisibility(){
    inboxBtn.style.display = isMainScreen() ? 'inline-flex' : 'none';
    inboxBtn.setAttribute(
      'aria-expanded',
      inboxPanel.classList.contains('show') ? 'true' : 'false'
    );
  }

  function openInbox(){
    if (!isMainScreen()) return;
    inboxPanel.classList.add('show');
    inboxPanel.setAttribute('aria-hidden','false');
    inboxBtn.setAttribute('aria-expanded','true');
    syncOverlays();
  }
  function closeInboxPanel(){
    inboxPanel.classList.remove('show');
    inboxPanel.setAttribute('aria-hidden','true');
    inboxBtn.setAttribute('aria-expanded','false');
    syncOverlays();
  }
  inboxBtn.onclick = ()=>{ if (isMainScreen()) openInbox(); };
  closeInbox.onclick = closeInboxPanel;

  function observeOverlay(el){
    if (!el) return;
    new MutationObserver(()=>{ syncOverlays(); })
      .observe(el, { attributes:true, attributeFilter:['class','style'] });
  }
  [
    menuPanel, historyPanel, goalsPanel, statsBackdrop, settingsBackdrop,
    saveBackdrop, editBackdrop, confirmBackdrop, startAtBackdrop,
    stopAtBackdrop, exportBackdrop, expensesPanel, inboxPanel,
    jobReminderBackdrop, predictionBackdrop
  ].forEach(observeOverlay);

  function syncOverlays(){
    const open = anyOverlayOpen();
    blocker.style.display = open ? 'block' : 'none';
    const histOpen = historyPanel.classList.contains('show');
    setMainButtonsVisible(!histOpen);
    refreshInboxBtnVisibility();
  }
  blocker.addEventListener('click', (e)=>{ e.stopPropagation(); });

  /* ===== Expenses ===== */
  const CATEGORY_KEYWORDS = [
    {cat:'Groceries', words:['walmart','target','aldi','kroger','publix','safeway','food lion','trader joe','whole foods','grocery']},
    {cat:'Restaurants', words:['restaurant','diner','cafe','bistro','grill','pizza','taco','sub','burger','mcdonald','kfc','chick-fil-a','chipotle','shake shack','popeyes','wendy','bk','domino']},
    {cat:'Bars & Nightlife', words:['bar','pub','brew','taproom','saloon','club','night']},
    {cat:'Subscriptions', words:['netflix','spotify','hulu','disney','max','apple tv','prime video','youtube','xbox','playstation','icloud','dropbox','adobe']},
    {cat:'Bills & Utilities', words:['electric','power','water','gas co','utility','internet','fiber','mobile','phone','comcast','xfinity','att','verizon','spectrum']},
    {cat:'Auto & Gas', words:['shell','bp','chevron','exxon','7-eleven','circle k','speedway','marathon','gas','oil change','jiffy lube']},
    {cat:'Healthcare', words:['pharmacy','walgreens','cvs','rite aid','clinic','dental','hospital','urgent care']},
    {cat:'Entertainment', words:['cinema','theater','concert','ticketmaster','amc','regal','event']},
    {cat:'Shopping', words:['amazon','best buy','walmart.com','ebay','mall','outlet','foot locker','nike','adidas']},
    {cat:'Travel', words:['airlines','hotel','airbnb','lyft','uber','booking','expedia','delta','united','southwest','american airlines']}
  ];
  function guessCategory(merchant){
    const q = (merchant||'').toLowerCase();
    for (const row of CATEGORY_KEYWORDS){
      if (row.words.some(w=>q.includes(w))) return row.cat;
    }
    return 'Other';
  }

  function openExpenses(){
    xpDate.value = new Date().toISOString().slice(0,10);
    expensesPanel.classList.add('show');
    expensesPanel.setAttribute('aria-hidden','false');
    renderExpensesUI();
    syncOverlays();
  }
  function closeExpensesPanel(){
    expensesPanel.classList.remove('show');
    expensesPanel.setAttribute('aria-hidden','true');
    syncOverlays();
  }
  closeExpenses.onclick = closeExpensesPanel;

  xpMerchant.addEventListener('blur', ()=>{
    if (!xpCategory.value || xpCategory.value === 'Other'){
      xpCategory.value = guessCategory(xpMerchant.value);
    }
  });

  xpAddBtn.onclick = ()=>{
    const amt = +(+xpAmount.value||0).toFixed(2);
    const dateStr = xpDate.value;
    const merch = (xpMerchant.value||'').trim();
    const cat = xpCategory.value || guessCategory(merch);
    const note = (xpNote.value||'').trim();
    if (!(amt>0) || !dateStr){ alert('Enter amount and date.'); return; }
    const ts = new Date(dateStr+'T12:00:00').getTime();
    const it = {
      id: Date.now().toString(36)+Math.random().toString(36).slice(2,6),
      ts,
      amount:amt,
      merchant: merch || 'Unknown',
      category: cat,
      note
    };
    expenses.unshift(it);
    saveExpenses();
    xpAmount.value=''; xpMerchant.value=''; xpNote.value='';
    renderExpensesUI();
    vibrate(12); playSound(950, 70);
  };

  xpImportBtn.onclick = ()=>{
    const lines = prompt('Paste lines: YYYY-MM-DD, Merchant, Amount[, Category]');
    if (!lines) return;
    const arr = lines.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    let imported = 0;
    for (const line of arr){
      const parts = line.split(',').map(s=>s.trim());
      if (parts.length < 3) continue;
      const [d, m, a, c] = parts;
      const ts = new Date(d+'T12:00:00').getTime();
      const amount = +(+a||0).toFixed(2);
      if (!(isFinite(ts) && amount>0)) continue;
      const cat = c || guessCategory(m);
      expenses.unshift({
        id: Date.now().toString(36)+Math.random().toString(36).slice(2,5),
        ts,
        amount,
        merchant:m,
        category:cat,
        note:''
      });
      imported++;
    }
    if (imported){
      saveExpenses();
      renderExpensesUI();
      vibrate(20); playSound(1100, 80);
    } else {
      alert('No valid rows found.');
    }
  };

  xpClearMonthBtn.onclick = ()=>{
    const now = new Date();
    const m0 = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const m1 = new Date(now.getFullYear(), now.getMonth()+1, 1).getTime();
    if (!confirm('Delete all expenses for the current month?')) return;
    const before = expenses.length;
    expenses = expenses.filter(e=> !(e.ts>=m0 && e.ts<m1));
    saveExpenses();
    renderExpensesUI();
    alert(`Removed ${before - expenses.length} item(s).`);
  };

  function renderExpensesUI(){
    const now = new Date();
    const m0 = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const m1 = new Date(now.getFullYear(), now.getMonth()+1, 1).getTime();

    const monthItems = expenses.filter(e=>e.ts>=m0 && e.ts<m1);
    const total = monthItems.reduce((a,b)=>a+b.amount,0);

    const catMap = {};
    for (const e of monthItems){
      catMap[e.category] = (catMap[e.category]||0) + e.amount;
    }
    const catEntries = Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
    const top = catEntries[0] || ['â€”',0];

    xpMonthSpend.textContent = fmtMoney(total);
    const planned = Object.values(budgets).reduce((a,b)=>a+(+b||0),0) || 0;
    if (planned>0){
      const pct = Math.min(9999, Math.max(0, total/planned*100)).toFixed(0);
      const cls = total <= planned*0.8 ? 'budget-ok'
                : total <= planned ? 'budget-warn'
                : 'budget-bad';
      xpBudgetHint.innerHTML = `Planned: ${fmtMoney(planned)} â€¢ <span class="${cls}">${pct}%</span> of budget`;
    } else {
      xpBudgetHint.textContent = 'No budget set';
    }

    xpTopCat.textContent = top[0];
    xpTopCatShare.textContent = top[1]
      ? `${fmtMoney(top[1])} (${(top[1]/Math.max(1,total)*100).toFixed(1)}%)`
      : 'â€”';

    xpList.innerHTML = '';
    monthItems.sort((a,b)=>b.ts-a.ts).forEach(e=>{
      const row = document.createElement('div');
      row.className = 'xp-item';
      row.innerHTML = `
        <div>
          <div class="m">${e.merchant} â€¢ <span class="c">${e.category}</span></div>
          <div class="c">${humanDate(e.ts)} ${e.note ? 'â€¢ '+e.note : ''}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="amt">-${fmtMoney(e.amount)}</div>
          <div class="xp-row-actions">
            <button class="btn-mini edit" data-xp-edit="${e.id}">Edit</button>
            <button class="btn-mini danger" data-xp-del="${e.id}">Del</button>
          </div>
        </div>
      `;
      xpList.appendChild(row);
    });

    xpList.querySelectorAll('[data-xp-del]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-xp-del');
        expenses = expenses.filter(x=>x.id!==id);
        saveExpenses();
        renderExpensesUI();
      };
    });
    xpList.querySelectorAll('[data-xp-edit]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-xp-edit');
        const it = expenses.find(x=>x.id===id);
        if (!it) return;
        const nd = prompt('Edit date (YYYY-MM-DD):', new Date(it.ts).toISOString().slice(0,10)); if (!nd) return;
        const nm = prompt('Edit merchant:', it.merchant); if (nm===null) return;
        const na = prompt('Edit amount:', String(it.amount)); if (na===null) return;
        const nc = prompt('Edit category:', it.category) || it.category;
        const nn = prompt('Edit note:', it.note ?? '') || '';
        const ts = new Date(nd+'T12:00:00').getTime();
        const amt = +(+na||0).toFixed(2);
        if (!(isFinite(ts)&&amt>0)){ alert('Invalid values.'); return; }
        it.ts = ts;
        it.merchant = nm.trim()||'Unknown';
        it.amount = amt;
        it.category = nc;
        it.note = nn;
        saveExpenses();
        renderExpensesUI();
      };
    });

    renderExpensesCharts(catEntries, monthSeries());
    renderSuggestions(catEntries, monthItems);
  }

  function monthSeries(n=6){
    const out = [];
    const now = new Date();
    for (let i=n-1;i>=0;i--){
      const y = now.getFullYear();
      const m = now.getMonth()-i;
      const d0 = new Date(y, m, 1).getTime();
      const d1 = new Date(y, m+1, 1).getTime();
      const sum = expenses
        .filter(e=>e.ts>=d0 && e.ts<d1)
        .reduce((a,b)=>a+b.amount,0);
      const label = new Date(y, m, 1)
        .toLocaleString(undefined,{month:'short'});
      out.push({label, sum});
    }
    return out;
  }

  function renderExpensesCharts(catEntries, series){
    if (xpPie) xpPie.destroy();
    const labels = catEntries.map(([k])=>k);
    const data = catEntries.map(([,v])=>v);
    const pieCtx = xpPieCanvas.getContext('2d');
    xpPie = new Chart(pieCtx, {
      type:'doughnut',
      data:{
        labels,
        datasets:[{
          data,
          backgroundColor:[
            '#22c55e','#2dd4bf','#60a5fa','#a78bfa','#f59e0b',
            '#ef4444','#22d3ee','#10b981','#f472b6','#94a3b8','#eab308'
          ],
          borderColor:'#0b1224',
          borderWidth:2
        }]
      },
      options:{
        cutout:'60%',
        plugins:{
          legend:{labels:{color:'#e2e8f0'}}
        }
      }
    });

    if (xpTrend) xpTrend.destroy();
    const tctx = xpTrendCanvas.getContext('2d');
    const labels2 = series.map(x=>x.label);
    const sums = series.map(x=>+x.sum.toFixed(2));
    const area = {top:0,bottom:180};
    const g = tctx.createLinearGradient(0, area.top, 0, area.bottom);
    g.addColorStop(0,'rgba(239,68,68,0.35)');
    g.addColorStop(1,'rgba(239,68,68,0.05)');
    xpTrend = new Chart(tctx, {
      type:'line',
      data:{
        labels:labels2,
        datasets:[{
          label:'Monthly spend',
          data:sums,
          borderColor:'#ef4444',
          backgroundColor:g,
          fill:true,
          tension:.35,
          pointRadius:3,
          pointBackgroundColor:'#f87171'
        }]
      },
      options:{
        plugins:{
          legend:{display:false},
          tooltip:{callbacks:{label:(ctx)=>fmtMoney(ctx.raw)}}
        },
        scales:{
          x:{ticks:{color:'#e2e8f0'}},
          y:{ticks:{color:'#e2e8f0'}, beginAtZero:true}
        }
      },
      plugins:['glow']
    });
  }

  function renderSuggestions(catEntries, monthItems){
    xpSuggestions.innerHTML = '';
    if (!monthItems.length){
      xpSuggestions.innerHTML = '<li>Add a few expenses to see insights.</li>';
      return;
    }

    const total = monthItems.reduce((a,b)=>a+b.amount,0);
    const byMerchant = {};
    for (const e of monthItems){
      const key = e.merchant.toLowerCase();
      byMerchant[key] = (byMerchant[key]||0) + e.amount;
    }
    const topMerch = Object.entries(byMerchant)
      .sort((a,b)=>b[1]-a[1])[0];

    const add = s=>{
      const li = document.createElement('li');
      li.textContent = s;
      xpSuggestions.appendChild(li);
    };

    const top = catEntries[0];
    if (top){
      const share = (top[1]/Math.max(1,total)*100).toFixed(1);
      const b = (budgets[top[0]]||0);
      if (b>0){
        const cls = top[1] > b ? 'over' : 'within';
        add(`${top[0]} is ${share}% of this month. You are ${cls} its budget (${fmtMoney(top[1])}/${fmtMoney(b)}).`);
      } else {
        add(`${top[0]} is ${share}% of this month. Consider setting a budget for it.`);
      }
    }

    const subMerchants = [
      'netflix','spotify','hulu','disney','max','apple','adobe',
      'xbox','playstation','icloud','youtube','patreon'
    ];
    const subs = monthItems.filter(e=>
      subMerchants.some(s=>e.merchant.toLowerCase().includes(s))
    );
    if (subs.length){
      const s = subs.map(e=>`${e.merchant} ${fmtMoney(e.amount)}`).join(', ');
      add(`Recurring suspects: ${s}. Verify if you still use them.`);
    }

    const map = Object.fromEntries(catEntries);
    const rest = map['Restaurants']||0;
    const bars  = map['Bars & Nightlife']||0;
    const groc  = map['Groceries']||0;
    if (rest + bars > groc * 0.8 && (rest+bars) > 150){
      add(`Dining/nightlife (${fmtMoney(rest+bars)}) is rivaling groceries (${fmtMoney(groc)}). Try 1â€“2 cook-at-home days.`);
    }

    const thisWeekStart = (()=>{
      const d = new Date();
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const dow = x.getDay();
      x.setDate(x.getDate()-dow);
      x.setHours(0,0,0,0);
      return +x;
    })();
    const lastWeekStart = thisWeekStart - 7*86400000;
    const thisWeek = expenses
      .filter(e=>e.ts>=thisWeekStart)
      .reduce((a,b)=>a+b.amount,0);
    const lastWeek = expenses
      .filter(e=>e.ts>=lastWeekStart && e.ts<thisWeekStart)
      .reduce((a,b)=>a+b.amount,0);
    if (lastWeek>0 && thisWeek > lastWeek*1.3 && thisWeek - lastWeek > 50){
      add(`Spending is up ${((thisWeek/lastWeek-1)*100).toFixed(0)}% vs last week. Decide what to cut for the next 3 days.`);
    }
  }

  /* ===== Global state save/load ===== */
  function saveState(){
    const state = {
      running,
      startWallTs,
      endWallTs,
      elapsed,
      rate: parseFloat(rateInput.value)||0,
      lastSaved: Date.now(),
      scheduledStartTs,
      scheduledStopTs,
      onBreak,
      breakStartTs,
      sessionBreakMs
    };
    try{ localStorage.setItem(STORE_KEY_STATE, JSON.stringify(state)); }catch{}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORE_KEY_STATE);
      if (!raw) return;
      const s = JSON.parse(raw)||{};
      if (typeof s.rate === 'number') rateInput.value = String(s.rate);
      running = !!s.running;
      startWallTs = typeof s.startWallTs === 'number' ? s.startWallTs : null;
      endWallTs   = typeof s.endWallTs   === 'number' ? s.endWallTs   : null;
      elapsed     = typeof s.elapsed     === 'number' ? s.elapsed     : 0;
      scheduledStartTs = typeof s.scheduledStartTs === 'number' ? s.scheduledStartTs : null;
      scheduledStopTs  = typeof s.scheduledStopTs  === 'number' ? s.scheduledStopTs  : null;
      onBreak = !!s.onBreak;
      breakStartTs = typeof s.breakStartTs === 'number' ? s.breakStartTs : null;
      sessionBreakMs = typeof s.sessionBreakMs === 'number' ? s.sessionBreakMs : 0;

      if (onBreak && breakStartTs){
        showBreak();
        startBreakTicker();
      }
      if (running && startWallTs){
        const now = Date.now();
        elapsed = Math.max(0, now - startWallTs);
        startTime = now - elapsed;
        update();
        startInterval();
      } else {
        updateDisplays(elapsed);
      }
    }catch(e){}
  }

  /* ===== Initial boot ===== */
  loadPrefs(); applyTheme();
  loadGoals();
  loadHistoryStore(); renderHistory(); updateTotals();
  loadBudgets();
  loadExpenses();
  loadState();

  syncOverlays();

  window.addEventListener('beforeunload', ()=>{
    saveState(); savePrefs(); saveGoals(); saveBudgets(); saveExpenses();
  });
  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden){
      saveState(); savePrefs(); saveGoals(); saveBudgets(); saveExpenses();
    }
  });

  // main loop
  setInterval(()=>{ update(); syncOverlays(); }, 1000/60);
</script>
</body>
</html>
